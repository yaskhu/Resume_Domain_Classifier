import './async-DWBXLqlH.js';
import { d as attr_class, a as attr, c as bind_props } from './index-D1re1cuM.js';

var ri;(function(r){r.LOAD="LOAD",r.EXEC="EXEC",r.FFPROBE="FFPROBE",r.WRITE_FILE="WRITE_FILE",r.READ_FILE="READ_FILE",r.DELETE_FILE="DELETE_FILE",r.RENAME="RENAME",r.CREATE_DIR="CREATE_DIR",r.LIST_DIR="LIST_DIR",r.DELETE_DIR="DELETE_DIR",r.ERROR="ERROR",r.DOWNLOAD="DOWNLOAD",r.PROGRESS="PROGRESS",r.LOG="LOG",r.MOUNT="MOUNT",r.UNMOUNT="UNMOUNT";})(ri||(ri={}));var ai;(function(r){r.MEMFS="MEMFS",r.NODEFS="NODEFS",r.NODERAWFS="NODERAWFS",r.IDBFS="IDBFS",r.WORKERFS="WORKERFS",r.PROXYFS="PROXYFS";})(ai||(ai={}));const B=Number.isFinite||function(r){return typeof r=="number"&&isFinite(r)},Ar=Number.isSafeInteger||function(r){return typeof r=="number"&&Math.abs(r)<=Ir},Ir=Number.MAX_SAFE_INTEGER||9007199254740991;let G=(function(r){return r.NETWORK_ERROR="networkError",r.MEDIA_ERROR="mediaError",r.KEY_SYSTEM_ERROR="keySystemError",r.MUX_ERROR="muxError",r.OTHER_ERROR="otherError",r})({}),_=(function(r){return r.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",r.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",r.KEY_SYSTEM_NO_SESSION="keySystemNoSession",r.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",r.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",r.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",r.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",r.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",r.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",r.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",r.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",r.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",r.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",r.MANIFEST_LOAD_ERROR="manifestLoadError",r.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",r.MANIFEST_PARSING_ERROR="manifestParsingError",r.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",r.LEVEL_EMPTY_ERROR="levelEmptyError",r.LEVEL_LOAD_ERROR="levelLoadError",r.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",r.LEVEL_PARSING_ERROR="levelParsingError",r.LEVEL_SWITCH_ERROR="levelSwitchError",r.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",r.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",r.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",r.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",r.FRAG_LOAD_ERROR="fragLoadError",r.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",r.FRAG_DECRYPT_ERROR="fragDecryptError",r.FRAG_PARSING_ERROR="fragParsingError",r.FRAG_GAP="fragGap",r.REMUX_ALLOC_ERROR="remuxAllocError",r.KEY_LOAD_ERROR="keyLoadError",r.KEY_LOAD_TIMEOUT="keyLoadTimeOut",r.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",r.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",r.BUFFER_APPEND_ERROR="bufferAppendError",r.BUFFER_APPENDING_ERROR="bufferAppendingError",r.BUFFER_STALLED_ERROR="bufferStalledError",r.BUFFER_FULL_ERROR="bufferFullError",r.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",r.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",r.ASSET_LIST_LOAD_ERROR="assetListLoadError",r.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",r.ASSET_LIST_PARSING_ERROR="assetListParsingError",r.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",r.INTERNAL_EXCEPTION="internalException",r.INTERNAL_ABORTED="aborted",r.ATTACH_MEDIA_ERROR="attachMediaError",r.UNKNOWN="unknown",r})({}),y=(function(r){return r.MEDIA_ATTACHING="hlsMediaAttaching",r.MEDIA_ATTACHED="hlsMediaAttached",r.MEDIA_DETACHING="hlsMediaDetaching",r.MEDIA_DETACHED="hlsMediaDetached",r.MEDIA_ENDED="hlsMediaEnded",r.STALL_RESOLVED="hlsStallResolved",r.BUFFER_RESET="hlsBufferReset",r.BUFFER_CODECS="hlsBufferCodecs",r.BUFFER_CREATED="hlsBufferCreated",r.BUFFER_APPENDING="hlsBufferAppending",r.BUFFER_APPENDED="hlsBufferAppended",r.BUFFER_EOS="hlsBufferEos",r.BUFFERED_TO_END="hlsBufferedToEnd",r.BUFFER_FLUSHING="hlsBufferFlushing",r.BUFFER_FLUSHED="hlsBufferFlushed",r.MANIFEST_LOADING="hlsManifestLoading",r.MANIFEST_LOADED="hlsManifestLoaded",r.MANIFEST_PARSED="hlsManifestParsed",r.LEVEL_SWITCHING="hlsLevelSwitching",r.LEVEL_SWITCHED="hlsLevelSwitched",r.LEVEL_LOADING="hlsLevelLoading",r.LEVEL_LOADED="hlsLevelLoaded",r.LEVEL_UPDATED="hlsLevelUpdated",r.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",r.LEVELS_UPDATED="hlsLevelsUpdated",r.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",r.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",r.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",r.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",r.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",r.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",r.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",r.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",r.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",r.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",r.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",r.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",r.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",r.CUES_PARSED="hlsCuesParsed",r.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",r.INIT_PTS_FOUND="hlsInitPtsFound",r.FRAG_LOADING="hlsFragLoading",r.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",r.FRAG_LOADED="hlsFragLoaded",r.FRAG_DECRYPTED="hlsFragDecrypted",r.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",r.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",r.FRAG_PARSING_METADATA="hlsFragParsingMetadata",r.FRAG_PARSED="hlsFragParsed",r.FRAG_BUFFERED="hlsFragBuffered",r.FRAG_CHANGED="hlsFragChanged",r.FPS_DROP="hlsFpsDrop",r.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",r.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",r.ERROR="hlsError",r.DESTROYING="hlsDestroying",r.KEY_LOADING="hlsKeyLoading",r.KEY_LOADED="hlsKeyLoaded",r.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",r.BACK_BUFFER_REACHED="hlsBackBufferReached",r.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",r.ASSET_LIST_LOADING="hlsAssetListLoading",r.ASSET_LIST_LOADED="hlsAssetListLoaded",r.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",r.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",r.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",r.INTERSTITIAL_STARTED="hlsInterstitialStarted",r.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",r.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",r.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",r.INTERSTITIAL_ENDED="hlsInterstitialEnded",r.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",r.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",r.EVENT_CUE_ENTER="hlsEventCueEnter",r})({});var $e={AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},K={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class it{constructor(e,t=0,s=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=s;}sample(e,t){const s=Math.pow(this.alpha_,e);this.estimate_=t*(1-s)+s*this.estimate_,this.totalWeight_+=e;}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class Rr{constructor(e,t,s,i=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=s,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new it(e),this.fast_=new it(t),this.defaultTTFB_=i,this.ttfb_=new it(e);}update(e,t){const{slow_:s,fast_:i,ttfb_:n}=this;s.halfLife!==e&&(this.slow_=new it(e,s.getEstimate(),s.getTotalWeight())),i.halfLife!==t&&(this.fast_=new it(t,i.getEstimate(),i.getTotalWeight())),n.halfLife!==e&&(this.ttfb_=new it(e,n.getEstimate(),n.getTotalWeight()));}sample(e,t){e=Math.max(e,this.minDelayMs_);const s=8*t,i=e/1e3,n=s/i;this.fast_.sample(i,n),this.slow_.sample(i,n);}sampleTTFB(e){const t=e/1e3,s=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(s,Math.max(e,5));}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function Lr(r,e,t){return (e=_r(e))in r?Object.defineProperty(r,e,{value:t,enumerable:true,configurable:true,writable:true}):r[e]=t,r}function ie(){return ie=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)({}).hasOwnProperty.call(t,s)&&(r[s]=t[s]);}return r},ie.apply(null,arguments)}function oi(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(r);e&&(s=s.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,s);}return t}function ee(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?oi(Object(t),true).forEach(function(s){Lr(r,s,t[s]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):oi(Object(t)).forEach(function(s){Object.defineProperty(r,s,Object.getOwnPropertyDescriptor(t,s));});}return r}function br(r,e){if(typeof r!="object"||!r)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var s=t.call(r,e);if(typeof s!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return (e==="string"?String:Number)(r)}function _r(r){var e=br(r,"string");return typeof e=="symbol"?e:e+""}class be{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const s=`[${e}]:`;this.trace=Je,this.debug=t.debug.bind(null,s),this.log=t.log.bind(null,s),this.warn=t.warn.bind(null,s),this.info=t.info.bind(null,s),this.error=t.error.bind(null,s);}}const Je=function(){},Dr={trace:Je,debug:Je,log:Je,warn:Je,info:Je,error:Je};function Pr(){return ie({},Dr)}const Cr=Pr(),re=Cr;function Tt(r=true){return typeof self>"u"?void 0:(r||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function kr(r){return typeof self<"u"&&r===self.ManagedMediaSource}function ln(r,e){const t=Object.keys(r),s=Object.keys(e),i=t.length,n=s.length;return !i||!n||i===n&&!t.some(a=>s.indexOf(a)===-1)}function Se(r,e=false){if(typeof TextDecoder<"u"){const c=new TextDecoder("utf-8").decode(r);if(e){const h=c.indexOf("\0");return h!==-1?c.substring(0,h):c}return c.replace(/\0/g,"")}const t=r.length;let s,i,n,a="",o=0;for(;o<t;){if(s=r[o++],s===0&&e)return a;if(s===0||s===3)continue;switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a+=String.fromCharCode(s);break;case 12:case 13:i=r[o++],a+=String.fromCharCode((s&31)<<6|i&63);break;case 14:i=r[o++],n=r[o++],a+=String.fromCharCode((s&15)<<12|(i&63)<<6|(n&63)<<0);break}}return a}function xe(r){let e="";for(let t=0;t<r.length;t++){let s=r[t].toString(16);s.length<2&&(s="0"+s),e+=s;}return e}function wr(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var is={exports:{}},li;function Or(){return li||(li=1,(function(r,e){(function(t){var s=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,i=/^(?=([^\/?#]*))\1([^]*)$/,n=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(l,c,h){if(h=h||{},l=l.trim(),c=c.trim(),!c){if(!h.alwaysNormalize)return l;var u=o.parseURL(l);if(!u)throw new Error("Error trying to parse base URL.");return u.path=o.normalizePath(u.path),o.buildURLFromParts(u)}var d=o.parseURL(c);if(!d)throw new Error("Error trying to parse relative URL.");if(d.scheme)return h.alwaysNormalize?(d.path=o.normalizePath(d.path),o.buildURLFromParts(d)):c;var g=o.parseURL(l);if(!g)throw new Error("Error trying to parse base URL.");if(!g.netLoc&&g.path&&g.path[0]!=="/"){var f=i.exec(g.path);g.netLoc=f[1],g.path=f[2];}g.netLoc&&!g.path&&(g.path="/");var m={scheme:g.scheme,netLoc:d.netLoc,path:null,params:d.params,query:d.query,fragment:d.fragment};if(!d.netLoc&&(m.netLoc=g.netLoc,d.path[0]!=="/"))if(!d.path)m.path=g.path,d.params||(m.params=g.params,d.query||(m.query=g.query));else {var p=g.path,S=p.substring(0,p.lastIndexOf("/")+1)+d.path;m.path=o.normalizePath(S);}return m.path===null&&(m.path=h.alwaysNormalize?o.normalizePath(d.path):d.path),o.buildURLFromParts(m)},parseURL:function(l){var c=s.exec(l);return c?{scheme:c[1]||"",netLoc:c[2]||"",path:c[3]||"",params:c[4]||"",query:c[5]||"",fragment:c[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(n,"");l.length!==(l=l.replace(a,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};r.exports=o;})();})(is)),is.exports}Or();class Fr{constructor(){this.aborted=false,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0};}}var fe={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};function ye(r){return r.sn!=="initSegment"}const ci=Math.pow(2,32)-1,Mr=[].push,cn={video:1,audio:2,id3:3,text:4};function ae(r){return String.fromCharCode.apply(null,r)}function hn(r,e){const t=r[e]<<8|r[e+1];return t<0?65536+t:t}function $(r,e){const t=un(r,e);return t<0?4294967296+t:t}function hi(r,e){let t=$(r,e);return t*=Math.pow(2,32),t+=$(r,e+4),t}function un(r,e){return r[e]<<24|r[e+1]<<16|r[e+2]<<8|r[e+3]}function Nr(r){const e=r.byteLength;for(let t=0;t<e;){const s=$(r,t);if(s>8&&r[t+4]===109&&r[t+5]===111&&r[t+6]===111&&r[t+7]===102)return  true;t=s>1?t+s:e;}return  false}function z(r,e){const t=[];if(!e.length)return t;const s=r.byteLength;for(let i=0;i<s;){const n=$(r,i),a=ae(r.subarray(i+4,i+8)),o=n>1?i+n:s;if(a===e[0])if(e.length===1)t.push(r.subarray(i+8,o));else {const l=z(r.subarray(i+8,o),e.slice(1));l.length&&Mr.apply(t,l);}i=o;}return t}function Br(r){const e=[],t=r[0];let s=8;const i=$(r,s);s+=4;let n=0,a=0;t===0?(n=$(r,s),a=$(r,s+4),s+=8):(n=hi(r,s),a=hi(r,s+8),s+=16),s+=2;let o=r.length+a;const l=hn(r,s);s+=2;for(let c=0;c<l;c++){let h=s;const u=$(r,h);h+=4;const d=u&2147483647;if((u&2147483648)>>>31===1)return re.warn("SIDX has hierarchical references (not supported)"),null;const f=$(r,h);h+=4,e.push({referenceSize:d,subsegmentDuration:f,info:{duration:f/i,start:o,end:o+d-1}}),o+=d,h+=4,s=h;}return {earliestPresentationTime:n,timescale:i,version:t,referencesCount:l,references:e}}function dn(r){const e=[],t=z(r,["moov","trak"]);for(let i=0;i<t.length;i++){const n=t[i],a=z(n,["tkhd"])[0];if(a){let o=a[0];const l=$(a,o===0?12:20),c=z(n,["mdia","mdhd"])[0];if(c){o=c[0];const h=$(c,o===0?12:20),u=z(n,["mdia","hdlr"])[0];if(u){const d=ae(u.subarray(8,12)),g={soun:fe.AUDIO,vide:fe.VIDEO}[d],f=z(n,["mdia","minf","stbl","stsd"])[0],m=Ur(f);g?(e[l]={timescale:h,type:g,stsd:m},e[g]=ee({timescale:h,id:l},m)):e[l]={timescale:h,type:d,stsd:m};}}}}return z(r,["moov","mvex","trex"]).forEach(i=>{const n=$(i,4),a=e[n];a&&(a.default={duration:$(i,12),flags:$(i,20)});}),e}function Ur(r){const e=r.subarray(8),t=e.subarray(86),s=ae(e.subarray(4,8));let i=s,n;const a=s==="enca"||s==="encv";if(a){const c=z(e,[s])[0].subarray(s==="enca"?28:78);z(c,["sinf"]).forEach(u=>{const d=z(u,["schm"])[0];if(d){const g=ae(d.subarray(4,8));if(g==="cbcs"||g==="cenc"){const f=z(u,["frma"])[0];f&&(i=ae(f));}}});}const o=i;switch(i){case "avc1":case "avc2":case "avc3":case "avc4":{const l=z(t,["avcC"])[0];l&&l.length>3&&(i+="."+Lt(l[1])+Lt(l[2])+Lt(l[3]),n=Rt(o==="avc1"?"dva1":"dvav",t));break}case "mp4a":{const l=z(e,[s])[0],c=z(l.subarray(28),["esds"])[0];if(c&&c.length>7){let h=4;if(c[h++]!==3)break;h=ns(c,h),h+=2;const u=c[h++];if(u&128&&(h+=2),u&64&&(h+=c[h++]),c[h++]!==4)break;h=ns(c,h);const d=c[h++];if(d===64)i+="."+Lt(d);else break;if(h+=12,c[h++]!==5)break;h=ns(c,h);const g=c[h++];let f=(g&248)>>3;f===31&&(f+=1+((g&7)<<3)+((c[h]&224)>>5)),i+="."+f;}break}case "hvc1":case "hev1":{const l=z(t,["hvcC"])[0];if(l&&l.length>12){const c=l[1],h=["","A","B","C"][c>>6],u=c&31,d=$(l,2),g=(c&32)>>5?"H":"L",f=l[12],m=l.subarray(6,12);i+="."+h+u,i+="."+$r(d).toString(16).toUpperCase(),i+="."+g+f;let p="";for(let S=m.length;S--;){const E=m[S];(E||p)&&(p="."+E.toString(16).toUpperCase()+p);}i+=p;}n=Rt(o=="hev1"?"dvhe":"dvh1",t);break}case "dvh1":case "dvhe":case "dvav":case "dva1":case "dav1":{i=Rt(i,t)||i;break}case "vp09":{const l=z(t,["vpcC"])[0];if(l&&l.length>6){const c=l[4],h=l[5],u=l[6]>>4&15;i+="."+ke(c)+"."+ke(h)+"."+ke(u);}break}case "av01":{const l=z(t,["av1C"])[0];if(l&&l.length>2){const c=l[1]>>>5,h=l[1]&31,u=l[2]>>>7?"H":"M",d=(l[2]&64)>>6,g=(l[2]&32)>>5,f=c===2&&d?g?12:10:d?10:8,m=(l[2]&16)>>4,p=(l[2]&8)>>3,S=(l[2]&4)>>2,E=l[2]&3;i+="."+c+"."+ke(h)+u+"."+ke(f)+"."+m+"."+p+S+E+"."+ke(1)+"."+ke(1)+"."+ke(1)+"."+0,n=Rt("dav1",t);}break}}return {codec:i,encrypted:a,supplemental:n}}function Rt(r,e){const t=z(e,["dvvC"]),s=t.length?t[0]:z(e,["dvcC"])[0];if(s){const i=s[2]>>1&127,n=s[2]<<5&32|s[3]>>3&31;return r+"."+ke(i)+"."+ke(n)}}function $r(r){let e=0;for(let t=0;t<32;t++)e|=(r>>t&1)<<31-t;return e>>>0}function ns(r,e){const t=e+5;for(;r[e++]&128&&e<t;);return e}function Lt(r){return ("0"+r.toString(16).toUpperCase()).slice(-2)}function ke(r){return (r<10?"0":"")+r}function Gr(r,e){if(!r||!e)return;const t=e.keyId;t&&e.isCommonEncryption&&Kr(r,(s,i)=>{const n=s.subarray(8,24);n.some(a=>a!==0)||(re.log(`[eme] Patching keyId in 'enc${i?"a":"v"}>sinf>>tenc' box: ${xe(n)} -> ${xe(t)}`),s.set(t,8));});}function Kr(r,e){z(r,["moov","trak"]).forEach(s=>{const i=z(s,["mdia","minf","stbl","stsd"])[0];if(!i)return;const n=i.subarray(8);let a=z(n,["enca"]);const o=a.length>0;o||(a=z(n,["encv"])),a.forEach(l=>{const c=o?l.subarray(28):l.subarray(78);z(c,["sinf"]).forEach(u=>{const d=fn(u);d&&e(d,o);});});});}function fn(r){const e=z(r,["schm"])[0];if(e){const t=ae(e.subarray(4,8));if(t==="cbcs"||t==="cenc"){const s=z(r,["schi","tenc"])[0];if(s)return s}}}function Vr(r,e,t){const s={},i=z(r,["moof","traf"]);for(let n=0;n<i.length;n++){const a=i[n],o=z(a,["tfhd"])[0],l=$(o,4),c=e[l];if(!c)continue;s[l]||(s[l]={start:NaN,duration:0,sampleCount:0,timescale:c.timescale,type:c.type});const h=s[l],u=z(a,["tfdt"])[0];if(u){const T=u[0];let A=$(u,4);T===1&&(A===ci?t.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(A*=ci+1,A+=$(u,8))),B(A)&&(!B(h.start)||A<h.start)&&(h.start=A);}const d=c.default,g=$(o,0)|d?.flags;let f=d?.duration||0;g&8&&(g&2?f=$(o,12):f=$(o,8));const m=z(a,["trun"]);let p=h.start||0,S=0,E=f;for(let T=0;T<m.length;T++){const A=m[T],I=$(A,4),D=h.sampleCount;h.sampleCount+=I;const v=A[3]&1,L=A[3]&4,b=A[2]&1,R=A[2]&2,P=A[2]&4,O=A[2]&8;let N=8,U=I;for(v&&(N+=4),L&&I&&(!(A[N+1]&1)&&h.keyFrameIndex===void 0&&(h.keyFrameIndex=D),N+=4,b?(E=$(A,N),N+=4):E=f,R&&(N+=4),O&&(N+=4),p+=E,S+=E,U--);U--;)b?(E=$(A,N),N+=4):E=f,R&&(N+=4),P&&(A[N+1]&1||h.keyFrameIndex===void 0&&(h.keyFrameIndex=h.sampleCount-(U+1),h.keyFrameStart=p),N+=4),O&&(N+=4),p+=E,S+=E;!S&&f&&(S+=f*I);}h.duration+=S;}if(!Object.keys(s).some(n=>s[n].duration)){let n=1/0,a=0;const o=z(r,["sidx"]);for(let l=0;l<o.length;l++){const c=Br(o[l]);if(c!=null&&c.references){n=Math.min(n,c.earliestPresentationTime/c.timescale);const h=c.references.reduce((u,d)=>u+d.info.duration||0,0);a=Math.max(a,h+c.earliestPresentationTime/c.timescale);}}a&&B(a)&&Object.keys(s).forEach(l=>{s[l].duration||(s[l].duration=a*s[l].timescale-s[l].start);});}return s}function Hr(r){const e={valid:null,remainder:null},t=z(r,["moof"]);if(t.length<2)return e.remainder=r,e;const s=t[t.length-1];return e.valid=r.slice(0,s.byteOffset-8),e.remainder=r.slice(s.byteOffset-8),e}function Ae(r,e){const t=new Uint8Array(r.length+e.length);return t.set(r),t.set(e,r.length),t}function ui(r,e){const t=[],s=e.samples,i=e.timescale,n=e.id;let a=false;return z(s,["moof"]).map(l=>{const c=l.byteOffset-8;z(l,["traf"]).map(u=>{const d=z(u,["tfdt"]).map(g=>{const f=g[0];let m=$(g,4);return f===1&&(m*=Math.pow(2,32),m+=$(g,8)),m/i})[0];return d!==void 0&&(r=d),z(u,["tfhd"]).map(g=>{const f=$(g,4),m=$(g,0)&16777215,p=(m&1)!==0,S=(m&2)!==0,E=(m&8)!==0;let T=0;const A=(m&16)!==0;let I=0;const D=(m&32)!==0;let v=8;f===n&&(p&&(v+=8),S&&(v+=4),E&&(T=$(g,v),v+=4),A&&(I=$(g,v),v+=4),D&&(v+=4),e.type==="video"&&(a=Zt(e.codec)),z(u,["trun"]).map(L=>{const b=L[0],R=$(L,0)&16777215,P=(R&1)!==0;let O=0;const N=(R&4)!==0,U=(R&256)!==0;let q=0;const M=(R&512)!==0;let F=0;const V=(R&1024)!==0,H=(R&2048)!==0;let Y=0;const w=$(L,4);let k=8;P&&(O=$(L,k),k+=4),N&&(k+=4);let W=O+c;for(let Z=0;Z<w;Z++){if(U?(q=$(L,k),k+=4):q=T,M?(F=$(L,k),k+=4):F=I,V&&(k+=4),H&&(b===0?Y=$(L,k):Y=un(L,k),k+=4),e.type===fe.VIDEO){let j=0;for(;j<F;){const Q=$(s,W);if(W+=4,Yr(a,s[W])){const he=s.subarray(W,W+Q);Ms(he,a?2:1,r+Y/i,t);}W+=Q,j+=Q+4;}}r+=q/i;}}));})});}),t}function Zt(r){if(!r)return  false;const e=r.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function Yr(r,e){if(r){const t=e>>1&63;return t===39||t===40}else return (e&31)===6}function Ms(r,e,t,s){const i=gn(r);let n=0;n+=e;let a=0,o=0,l=0;for(;n<i.length;){a=0;do{if(n>=i.length)break;l=i[n++],a+=l;}while(l===255);o=0;do{if(n>=i.length)break;l=i[n++],o+=l;}while(l===255);const c=i.length-n;let h=n;if(o<c)n+=o;else if(o>c){re.error(`Malformed SEI payload. ${o} is too small, only ${c} bytes left to parse.`);break}if(a===4){if(i[h++]===181){const d=hn(i,h);if(h+=2,d===49){const g=$(i,h);if(h+=4,g===1195456820){const f=i[h++];if(f===3){const m=i[h++],p=31&m,S=64&m,E=S?2+p*3:0,T=new Uint8Array(E);if(S){T[0]=m;for(let A=1;A<E;A++)T[A]=i[h++];}s.push({type:f,payloadType:a,pts:t,bytes:T});}}}}}else if(a===5&&o>16){const u=[];for(let f=0;f<16;f++){const m=i[h++].toString(16);u.push(m.length==1?"0"+m:m),(f===3||f===5||f===7||f===9)&&u.push("-");}const d=o-16,g=new Uint8Array(d);for(let f=0;f<d;f++)g[f]=i[h++];s.push({payloadType:a,pts:t,uuid:u.join(""),userData:Se(g),userDataBytes:g});}}}function gn(r){const e=r.byteLength,t=[];let s=1;for(;s<e-2;)r[s]===0&&r[s+1]===0&&r[s+2]===3?(t.push(s+2),s+=2):s++;if(t.length===0)return r;const i=e-t.length,n=new Uint8Array(i);let a=0;for(s=0;s<i;a++,s++)a===t[0]&&(a++,t.shift()),n[s]=r[a];return n}function Wr(r){const e=r[0];let t="",s="",i=0,n=0,a=0,o=0,l=0,c=0;if(e===0){for(;ae(r.subarray(c,c+1))!=="\0";)t+=ae(r.subarray(c,c+1)),c+=1;for(t+=ae(r.subarray(c,c+1)),c+=1;ae(r.subarray(c,c+1))!=="\0";)s+=ae(r.subarray(c,c+1)),c+=1;s+=ae(r.subarray(c,c+1)),c+=1,i=$(r,12),n=$(r,16),o=$(r,20),l=$(r,24),c=28;}else if(e===1){c+=4,i=$(r,c),c+=4;const u=$(r,c);c+=4;const d=$(r,c);for(c+=4,a=2**32*u+d,Ar(a)||(a=Number.MAX_SAFE_INTEGER,re.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=$(r,c),c+=4,l=$(r,c),c+=4;ae(r.subarray(c,c+1))!=="\0";)t+=ae(r.subarray(c,c+1)),c+=1;for(t+=ae(r.subarray(c,c+1)),c+=1;ae(r.subarray(c,c+1))!=="\0";)s+=ae(r.subarray(c,c+1)),c+=1;s+=ae(r.subarray(c,c+1)),c+=1;}const h=r.subarray(c,r.byteLength);return {schemeIdUri:t,value:s,timeScale:i,presentationTime:a,presentationTimeDelta:n,eventDuration:o,id:l,payload:h}}const mn=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),Is={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function pn(r,e){const t=Is[e];return !!t&&!!t[r.slice(0,4)]}function qr(r,e,t=true){return !r.split(",").some(s=>!Ns(s,e,t))}function Ns(r,e,t=true){var s;const i=Tt(t);return (s=i?.isTypeSupported(Bs(r,e)))!=null?s:false}function Bs(r,e){return `${e}/mp4;codecs=${r}`}function di(r){const e=mn();return r.split(",").reduce((t,s)=>{const n=e&&Zt(s)?9:Is.video[s];return n?(n*2+t)/(t?3:2):(Is.audio[s]+t)/(t?2:1)},0)}const rs={};function jr(r,e=true){if(rs[r])return rs[r];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[r];for(let i=0;i<t.length;i++){var s;if(Ns(t[i],"audio",e))return rs[r]=t[i],t[i];if(t[i]==="mp3"&&(s=Tt(e))!=null&&s.isTypeSupported("audio/mpeg"))return ""}return r}const zr=/flac|opus|mp4a\.40\.34/i;function Rs(r,e=true){return r.replace(zr,t=>jr(t.toLowerCase(),e))}function Qr(r,e){const t=[];if(r){const s=r.split(",");for(let i=0;i<s.length;i++)pn(s[i],"video")||t.push(s[i]);}return e&&t.push(e),t.join(",")}function as(r,e){if(r&&(r.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(r)!==-1)&&(fi(r,"audio")||fi(r,"video")))return r;if(e){const t=e.split(",");if(t.length>1){if(r){for(let s=t.length;s--;)if(t[s].substring(0,4)===r.substring(0,4))return t[s]}return t[0]}}return e||r}function fi(r,e){return pn(r,e)&&Ns(r,e)}function Xr(r){if(r.startsWith("av01.")){const e=r.split("."),t=["0","111","01","01","01","0"];for(let s=e.length;s>4&&s<10;s++)e[s]=t[s-4];return e.join(".")}return r}function gi(r){const e=Tt(r)||{isTypeSupported:()=>false};return {mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function Ls(r){return r.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const Zr={supported:true,powerEfficient:true,smooth:true},Jr={supported:false,smooth:false,powerEfficient:false},yn={supported:true,configurations:[],decodingInfoResults:[Zr]};function ea(r,e){return {supported:false,configurations:e,decodingInfoResults:[Jr],error:r}}function ta(r,e,t,s,i,n){const a=r.videoCodec,o=r.audioCodec?r.audioGroups:null,l=n?.audioCodec,c=n?.channels,h=c?parseInt(c):l?1/0:2;let u=null;if(o!=null&&o.length)try{o.length===1&&o[0]?u=e.groups[o[0]].channels:u=o.reduce((d,g)=>{if(g){const f=e.groups[g];if(!f)throw new Error(`Audio track group ${g} not found`);Object.keys(f.channels).forEach(m=>{d[m]=(d[m]||0)+f.channels[m];});}return d},{2:0});}catch{return  true}return a!==void 0&&(a.split(",").some(d=>Zt(d))||r.width>1920&&r.height>1088||r.height>1920&&r.width>1088||r.frameRate>Math.max(s,30)||r.videoRange!=="SDR"&&r.videoRange!==t||r.bitrate>Math.max(i,8e6))||!!u&&B(h)&&Object.keys(u).some(d=>parseInt(d)>h)}function sa(r,e,t,s={}){const i=r.videoCodec;if(!i&&!r.audioCodec||!t)return Promise.resolve(yn);const n=[],a=ia(r),o=a.length,l=na(r,e,o>0),c=l.length;for(let h=o||1*c||1;h--;){const u={type:"media-source"};if(o&&(u.video=a[h%o]),c){u.audio=l[h%c];const d=u.audio.bitrate;u.video&&d&&(u.video.bitrate-=d);}n.push(u);}if(i){const h=navigator.userAgent;if(i.split(",").some(u=>Zt(u))&&mn())return Promise.resolve(ea(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent string: (${h})`),n))}return Promise.all(n.map(h=>{const u=aa(h);return s[u]||(s[u]=t.decodingInfo(h))})).then(h=>({supported:!h.some(u=>!u.supported),configurations:n,decodingInfoResults:h})).catch(h=>({supported:false,configurations:n,decodingInfoResults:[],error:h}))}function ia(r){var e;const t=(e=r.videoCodec)==null?void 0:e.split(","),s=Sn(r),i=r.width||640,n=r.height||480,a=r.frameRate||30,o=r.videoRange.toLowerCase();return t?t.map(l=>{const c={contentType:Bs(Xr(l),"video"),width:i,height:n,bitrate:s,framerate:a};return o!=="sdr"&&(c.transferFunction=o),c}):[]}function na(r,e,t){var s;const i=(s=r.audioCodec)==null?void 0:s.split(","),n=Sn(r);return i&&r.audioGroups?r.audioGroups.reduce((a,o)=>{var l;const c=o?(l=e.groups[o])==null?void 0:l.tracks:null;return c?c.reduce((h,u)=>{if(u.groupId===o){const d=parseFloat(u.channels||"");i.forEach(g=>{const f={contentType:Bs(g,"audio"),bitrate:t?ra(g,n):n};d&&(f.channels=""+d),h.push(f);});}return h},a):a},[]):[]}function ra(r,e){if(e<=1)return 1;let t=128e3;return r==="ec-3"?t=768e3:r==="ac-3"&&(t=64e4),Math.min(e/2,t)}function Sn(r){return Math.ceil(Math.max(r.bitrate*.9,r.averageBitrate)/1e3)*1e3||1}function aa(r){let e="";const{audio:t,video:s}=r;if(s){const i=Ls(s.contentType);e+=`${i}_r${s.height}x${s.width}f${Math.ceil(s.framerate)}${s.transferFunction||"sd"}_${Math.ceil(s.bitrate/1e5)}`;}if(t){const i=Ls(t.contentType);e+=`${s?"_":""}${i}_c${t.channels}`;}return e}const mi=["NONE","TYPE-0","TYPE-1",null],oa=["SDR","PQ","HLG"];var Bt={No:"",Yes:"YES",v2:"v2"};function pi(r){const{canSkipUntil:e,canSkipDateRanges:t,age:s}=r,i=s<e/2;return e&&i?t?Bt.v2:Bt.Yes:Bt.No}class yi{constructor(e,t,s){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=s;}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Vt{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(s=>!!s).map(s=>s.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const s=(t=e.supplemental)==null?void 0:t.videoCodec;s&&s!==e.videoCodec&&(this.codecSet+=`,${s.substring(0,4)}`);}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES);}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return Si(this._audioGroups,e)}hasSubtitleGroup(e){return Si(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let s=this._audioGroups;s||(s=this._audioGroups=[]),s.indexOf(t)===-1&&s.push(t);}else if(e==="text"){let s=this._subtitleGroups;s||(s=this._subtitleGroups=[]),s.indexOf(t)===-1&&s.push(t);}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return (e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return (e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function Si(r,e){return !e||!r?false:r.indexOf(e)!==-1}function la(){if(typeof matchMedia=="function"){const r=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(r.media!==e.media)return r.matches===true}return  false}function ca(r,e){let t=false,s=[];if(r&&(t=r!=="SDR",s=[r]),e){s=e.allowedVideoRanges||oa.slice(0);const i=s.join("")!=="SDR"&&!e.videoCodec;t=e.preferHDR!==void 0?e.preferHDR:i&&la(),t||(s=["SDR"]);}return {preferHDR:t,allowedVideoRanges:s}}const ha=r=>{const e=new WeakSet;return (t,s)=>{if(r&&(s=r(t,s)),typeof s=="object"&&s!==null){if(e.has(s))return;e.add(s);}return s}},se=(r,e)=>JSON.stringify(r,ha(e));function ua(r,e,t,s,i){const n=Object.keys(r),a=s?.channels,o=s?.audioCodec,l=i?.videoCodec,c=a&&parseInt(a)===2;let h=false,u=false,d=1/0,g=1/0,f=1/0,m=1/0,p=0,S=[];const{preferHDR:E,allowedVideoRanges:T}=ca(e,i);for(let L=n.length;L--;){const b=r[n[L]];h||(h=b.channels[2]>0),d=Math.min(d,b.minHeight),g=Math.min(g,b.minFramerate),f=Math.min(f,b.minBitrate),T.filter(P=>b.videoRanges[P]>0).length>0&&(u=true);}d=B(d)?d:0,g=B(g)?g:0;const A=Math.max(1080,d),I=Math.max(30,g);f=B(f)?f:t,t=Math.max(f,t),u||(e=void 0);const D=n.length>1;return {codecSet:n.reduce((L,b)=>{const R=r[b];if(b===L)return L;if(S=u?T.filter(P=>R.videoRanges[P]>0):[],D){if(R.minBitrate>t)return Pe(b,`min bitrate of ${R.minBitrate} > current estimate of ${t}`),L;if(!R.hasDefaultAudio)return Pe(b,"no renditions with default or auto-select sound found"),L;if(o&&b.indexOf(o.substring(0,4))%5!==0)return Pe(b,`audio codec preference "${o}" not found`),L;if(a&&!c){if(!R.channels[a])return Pe(b,`no renditions with ${a} channel sound found (channels options: ${Object.keys(R.channels)})`),L}else if((!o||c)&&h&&R.channels[2]===0)return Pe(b,"no renditions with stereo sound found"),L;if(R.minHeight>A)return Pe(b,`min resolution of ${R.minHeight} > maximum of ${A}`),L;if(R.minFramerate>I)return Pe(b,`min framerate of ${R.minFramerate} > maximum of ${I}`),L;if(!S.some(P=>R.videoRanges[P]>0))return Pe(b,`no variants with VIDEO-RANGE of ${se(S)} found`),L;if(l&&b.indexOf(l.substring(0,4))%5!==0)return Pe(b,`video codec preference "${l}" not found`),L;if(R.maxScore<p)return Pe(b,`max score of ${R.maxScore} < selected max of ${p}`),L}return L&&(di(b)>=di(L)||R.fragmentError>r[L].fragmentError)?L:(m=R.minIndex,p=R.maxScore,b)},void 0),videoRanges:S,preferHDR:E,minFramerate:g,minBitrate:f,minIndex:m}}function Pe(r,e){re.log(`[abr] start candidates with "${r}" ignored because ${e}`);}function da(r){return r.reduce((e,t)=>{let s=e.groups[t.groupId];s||(s=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:false,hasAutoSelect:false}),s.tracks.push(t);const i=t.channels||"2";return s.channels[i]=(s.channels[i]||0)+1,s.hasDefault=s.hasDefault||t.default,s.hasAutoSelect=s.hasAutoSelect||t.autoselect,s.hasDefault&&(e.hasDefaultAudio=true),s.hasAutoSelect&&(e.hasAutoSelectAudio=true),e},{hasDefaultAudio:false,hasAutoSelectAudio:false,groups:{}})}function fa(r,e,t,s){return r.slice(t,s+1).reduce((i,n,a)=>{if(!n.codecSet)return i;const o=n.audioGroups;let l=i[n.codecSet];l||(i[n.codecSet]=l={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:a,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!o,fragmentError:0}),l.minBitrate=Math.min(l.minBitrate,n.bitrate);const c=Math.min(n.height,n.width);return l.minHeight=Math.min(l.minHeight,c),l.minFramerate=Math.min(l.minFramerate,n.frameRate),l.minIndex=Math.min(l.minIndex,a),l.maxScore=Math.max(l.maxScore,n.score),l.fragmentError+=n.fragmentError,l.videoRanges[n.videoRange]=(l.videoRanges[n.videoRange]||0)+1,o&&o.forEach(h=>{if(!h)return;const u=e.groups[h];u&&(l.hasDefaultAudio=l.hasDefaultAudio||e.hasDefaultAudio?u.hasDefault:u.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(u.channels).forEach(d=>{l.channels[d]=(l.channels[d]||0)+u.channels[d];}));}),i},{})}function Ei(r){if(!r)return r;const{lang:e,assocLang:t,characteristics:s,channels:i,audioCodec:n}=r;return {lang:e,assocLang:t,characteristics:s,channels:i,audioCodec:n}}function Oe(r,e,t){if("attrs"in r){const s=e.indexOf(r);if(s!==-1)return s}for(let s=0;s<e.length;s++){const i=e[s];if(tt(r,i,t))return s}return  -1}function tt(r,e,t){const{groupId:s,name:i,lang:n,assocLang:a,default:o}=r,l=r.forced;return (s===void 0||e.groupId===s)&&(i===void 0||e.name===i)&&(n===void 0||ga(n,e.lang))&&(n===void 0||e.assocLang===a)&&(o===void 0||e.default===o)&&(l===void 0||e.forced===l)&&(!("characteristics"in r)||ma(r.characteristics||"",e.characteristics))&&(t===void 0||t(r,e))}function ga(r,e="--"){return r.length===e.length?r===e:r.startsWith(e)||e.startsWith(r)}function ma(r,e=""){const t=r.split(","),s=e.split(",");return t.length===s.length&&!t.some(i=>s.indexOf(i)===-1)}function et(r,e){const{audioCodec:t,channels:s}=r;return (t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(s===void 0||s===(e.channels||"2"))}function pa(r,e,t,s,i){const n=e[s],o=e.reduce((d,g,f)=>{const m=g.uri;return (d[m]||(d[m]=[])).push(f),d},{})[n.uri];o.length>1&&(s=Math.max.apply(Math,o));const l=n.videoRange,c=n.frameRate,h=n.codecSet.substring(0,4),u=Ti(e,s,d=>{if(d.videoRange!==l||d.frameRate!==c||d.codecSet.substring(0,4)!==h)return  false;const g=d.audioGroups,f=t.filter(m=>!g||g.indexOf(m.groupId)!==-1);return Oe(r,f,i)>-1});return u>-1?u:Ti(e,s,d=>{const g=d.audioGroups,f=t.filter(m=>!g||g.indexOf(m.groupId)!==-1);return Oe(r,f,i)>-1})}function Ti(r,e,t){for(let s=e;s>-1;s--)if(t(r[s]))return s;for(let s=e+1;s<r.length;s++)if(t(r[s]))return s;return  -1}function En(r,e){var t;return !!r&&r!==((t=e.loadLevelObj)==null?void 0:t.uri)}class ya extends be{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.supportedCache={},this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var s;const{fragCurrent:i,partCurrent:n,hls:a}=this,{autoLevelEnabled:o,media:l}=a;if(!i||!l)return;const c=performance.now(),h=n?n.stats:i.stats,u=n?n.duration:i.duration,d=c-h.loading.start,g=a.minAutoLevel,f=i.level,m=this._nextAutoLevel;if(h.aborted||h.loaded&&h.loaded===h.total||f<=g){this.clearTimer(),this._nextAutoLevel=-1;return}if(!o)return;const p=m>-1&&m!==f,S=!!t||p;if(!S&&(l.paused||!l.playbackRate||!l.readyState))return;const E=a.mainForwardBufferInfo;if(!S&&E===null)return;const T=this.bwEstimator.getEstimateTTFB(),A=Math.abs(l.playbackRate);if(d<=Math.max(T,1e3*(u/(A*2))))return;const I=E?E.len/A:0,D=h.loading.first?h.loading.first-h.loading.start:-1,v=h.loaded&&D>-1,L=this.getBwEstimate(),b=a.levels,R=b[f],P=Math.max(h.loaded,Math.round(u*(i.bitrate||R.averageBitrate)/8));let O=v?d-D:d;O<1&&v&&(O=Math.min(d,h.loaded*8/L));const N=v?h.loaded*1e3/O:0,U=T/1e3,q=N?(P-h.loaded)/N:P*8/L+U;if(q<=I)return;const M=N?N*8:L,F=((s=t?.details||this.hls.latestLevelDetails)==null?void 0:s.live)===true,V=this.hls.config.abrBandWidthUpFactor;let H=Number.POSITIVE_INFINITY,Y;for(Y=f-1;Y>g;Y--){const Z=b[Y].maxBitrate,j=!b[Y].details||F;if(H=this.getTimeToLoadFrag(U,M,u*Z,j),H<Math.min(I,u+U))break}if(H>=q||H>u*10)return;v?this.bwEstimator.sample(d-Math.min(T,D),h.loaded):this.bwEstimator.sampleTTFB(d);const w=b[Y].maxBitrate;this.getBwEstimate()*V>w&&this.resetEstimator(w);const k=this.findBestLevel(w,g,Y,0,I,1,1);k>-1&&(Y=k),this.warn(`Fragment ${i.sn}${n?" part "+n.index:""} of level ${f} is loading too slowly;
      Fragment duration: ${i.duration.toFixed(3)}
      Time to underbuffer: ${I.toFixed(3)} s
      Estimated load time for current fragment: ${q.toFixed(3)} s
      Estimated load time for down switch fragment: ${H.toFixed(3)} s
      TTFB estimate: ${D|0} ms
      Current BW estimate: ${B(L)?L|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${Y} @ ${w|0} bps`),a.nextLoadLevel=a.nextAutoLevel=Y,this.clearTimer();const W=()=>{if(this.clearTimer(),this.fragCurrent===i&&this.hls.loadLevel===Y&&Y>0){const Z=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${Y>0?"and switching down":""}
      Fragment duration: ${i.duration.toFixed(3)} s
      Time to underbuffer: ${Z.toFixed(3)} s`),i.abortRequests(),this.fragCurrent=this.partCurrent=null,Y>g){let j=this.findBestLevel(this.hls.levels[g].bitrate,g,Y,0,Z,1,1);j===-1&&(j=g),this.hls.nextLoadLevel=this.hls.nextAutoLevel=j,this.resetEstimator(this.hls.levels[j].bitrate);}}};p||q>H*2?W():this.timer=self.setInterval(W,H*1e3),a.trigger(y.FRAG_LOAD_EMERGENCY_ABORTED,{frag:i,part:n,stats:h});},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners();}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator();}initEstimator(){const e=this.hls.config;return new Rr(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.FRAG_LOADING,this.onFragLoading,this),e.on(y.FRAG_LOADED,this.onFragLoaded,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(y.ERROR,this.onError,this);}unregisterListeners(){const{hls:e}=this;e&&(e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.FRAG_LOADING,this.onFragLoading,this),e.off(y.FRAG_LOADED,this.onFragLoaded,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(y.ERROR,this.onError,this));}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=this.supportedCache=null,this.fragCurrent=this.partCurrent=null;}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.supportedCache={},this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer();}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null;}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey="";}onFragLoading(e,t){const s=t.frag;if(!this.ignoreFragment(s)){if(!s.bitrateTest){var i;this.fragCurrent=s,this.partCurrent=(i=t.part)!=null?i:null;}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100);}}onLevelSwitching(e,t){this.clearTimer();}onError(e,t){if(!t.fatal)switch(t.details){case _.BUFFER_ADD_CODEC_ERROR:case _.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case _.FRAG_LOAD_TIMEOUT:{const s=t.frag,{fragCurrent:i,partCurrent:n}=this;if(s&&i&&s.sn===i.sn&&s.level===i.level){const a=performance.now(),o=n?n.stats:s.stats,l=a-o.loading.start,c=o.loading.first?o.loading.first-o.loading.start:-1;if(o.loaded&&c>-1){const u=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(u,c),o.loaded);}else this.bwEstimator.sampleTTFB(l);}break}}}getTimeToLoadFrag(e,t,s,i){const n=e+s/t,a=i?e+this.lastLevelLoadSec:0;return n+a}onLevelLoaded(e,t){const s=this.hls.config,{loading:i}=t.stats,n=i.end-i.first;B(n)&&(this.lastLevelLoadSec=n/1e3),t.details.live?this.bwEstimator.update(s.abrEwmaSlowLive,s.abrEwmaFastLive):this.bwEstimator.update(s.abrEwmaSlowVoD,s.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo);}onFragLoaded(e,{frag:t,part:s}){const i=s?s.stats:t.stats;if(t.type===K.MAIN&&this.bwEstimator.sampleTTFB(i.loading.first-i.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const n=s?s.duration:t.duration,a=this.hls.levels[t.level],o=(a.loaded?a.loaded.bytes:0)+i.loaded,l=(a.loaded?a.loaded.duration:0)+n;a.loaded={bytes:o,duration:l},a.realBitrate=Math.round(8*o/l);}if(t.bitrateTest){const n={stats:i,frag:t,part:s,id:t.type};this.onFragBuffered(y.FRAG_BUFFERED,n),t.bitrateTest=false;}else this.lastLoadedFragLevel=t.level;}}onFragBuffered(e,t){const{frag:s,part:i}=t,n=i!=null&&i.stats.loaded?i.stats:s.stats;if(n.aborted||this.ignoreFragment(s))return;const a=n.parsing.end-n.loading.start-Math.min(n.loading.first-n.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(a,n.loaded),n.bwEstimate=this.getBwEstimate(),s.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0;}ignoreFragment(e){return e.type!==K.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1);}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,s=this.getBwEstimate(),i=this.hls.config.maxStarvationDelay,n=this.findBestLevel(s,t,e,0,i,1,1);if(n>-1)return n;const a=this.hls.firstLevel,o=Math.min(Math.max(a,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${a} clamped to ${o}`),o}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,s=this.bwEstimator.canEstimate(),i=this.lastLoadedFragLevel>-1;if(e!==-1&&(!s||!i||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const n=s&&i?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const a=this.hls.levels;if(a.length>Math.max(e,n)&&a[e].loadError<=a[n].loadError)return e}return this._nextAutoLevel=n,this.nextAutoLevelKey=this.getAutoLevelKey(),n}getAutoLevelKey(){return `${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:s}=this;if(s.levels.length<=1)return s.loadLevel;const{maxAutoLevel:i,config:n,minAutoLevel:a}=s,o=t?t.duration:e?e.duration:0,l=this.getBwEstimate(),c=this.getStarvationDelay();let h=n.abrBandWidthFactor,u=n.abrBandWidthUpFactor;if(c){const p=this.findBestLevel(l,a,i,c,0,h,u);if(p>=0)return this.rebufferNotice=-1,p}let d=o?Math.min(o,n.maxStarvationDelay):n.maxStarvationDelay;if(!c){const p=this.bitrateTestDelay;p&&(d=(o?Math.min(o,n.maxLoadingDelay):n.maxLoadingDelay)-p,this.info(`bitrate test took ${Math.round(1e3*p)}ms, set first fragment max fetchDuration to ${Math.round(1e3*d)} ms`),h=u=1);}const g=this.findBestLevel(l,a,i,c,d,h,u);if(this.rebufferNotice!==g&&(this.rebufferNotice=g,this.info(`${c?"rebuffering expected":"buffer is empty"}, optimal quality level ${g}`)),g>-1)return g;const f=s.levels[a],m=s.loadLevelObj;return m&&f?.bitrate<m.bitrate?a:s.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const s=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,i=e.mainForwardBufferInfo;return (i?i.len:0)/s}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,s,i,n,a,o){var l;const c=i+n,h=this.lastLoadedFragLevel,u=h===-1?this.hls.firstLevel:h,{fragCurrent:d,partCurrent:g}=this,{levels:f,allAudioTracks:m,loadLevel:p,config:S}=this.hls;if(f.length===1)return 0;const E=f[u],T=!!((l=this.hls.latestLevelDetails)!=null&&l.live),A=p===-1||h===-1;let I,D="SDR",v=E?.frameRate||0;const{audioPreference:L,videoPreference:b}=S,R=this.audioTracksByGroup||(this.audioTracksByGroup=da(m));let P=-1;if(A){if(this.firstSelection!==-1)return this.firstSelection;const M=this.codecTiers||(this.codecTiers=fa(f,R,t,s)),F=ua(M,D,e,L,b),{codecSet:V,videoRanges:H,minFramerate:Y,minBitrate:w,minIndex:k,preferHDR:W}=F;P=k,I=V,D=W?H[H.length-1]:H[0],v=Y,e=Math.max(e,w),this.log(`picked start tier ${se(F)}`);}else I=E?.codecSet,D=E?.videoRange;const O=g?g.duration:d?d.duration:0,N=this.bwEstimator.getEstimateTTFB()/1e3,U=[];for(let M=s;M>=t;M--){var q;const F=f[M],V=M>u;if(!F)continue;if(S.useMediaCapabilities&&!F.supportedResult&&!F.supportedPromise){const j=navigator.mediaCapabilities;typeof j?.decodingInfo=="function"&&ta(F,R,D,v,e,L)?(F.supportedPromise=sa(F,R,j,this.supportedCache),F.supportedPromise.then(Q=>{if(!this.hls)return;F.supportedResult=Q;const he=this.hls.levels,le=he.indexOf(F);Q.error?this.warn(`MediaCapabilities decodingInfo error: "${Q.error}" for level ${le} ${se(Q)}`):Q.supported?Q.decodingInfoResults.some(Ee=>Ee.smooth===false||Ee.powerEfficient===false)&&this.log(`MediaCapabilities decodingInfo for level ${le} not smooth or powerEfficient: ${se(Q)}`):(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${le} ${se(Q)}`),le>-1&&he.length>1&&(this.log(`Removing unsupported level ${le}`),this.hls.removeLevel(le),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)));}).catch(Q=>{this.warn(`Error handling MediaCapabilities decodingInfo: ${Q}`);})):F.supportedResult=yn;}if((I&&F.codecSet!==I||D&&F.videoRange!==D||V&&v>F.frameRate||!V&&v>0&&v<F.frameRate||(q=F.supportedResult)!=null&&(q=q.decodingInfoResults)!=null&&q.some(j=>j.smooth===false))&&(!A||M!==P)){U.push(M);continue}const H=F.details,Y=(g?H?.partTarget:H?.averagetargetduration)||O;let w;V?w=o*e:w=a*e;const k=O&&i>=O*2&&n===0?F.averageBitrate:F.maxBitrate,W=this.getTimeToLoadFrag(N,w,k*Y,H===void 0);if(w>=k&&(M===h||F.loadError===0&&F.fragmentError===0)&&(W<=N||!B(W)||T&&!this.bitrateTestDelay||W<c)){const j=this.forcedAutoLevel;return M!==p&&(j===-1||j!==p)&&(U.length&&this.trace(`Skipped level(s) ${U.join(",")} of ${s} max with CODECS and VIDEO-RANGE:"${f[U[0]].codecs}" ${f[U[0]].videoRange}; not compatible with "${I}" ${D}`),this.info(`switch candidate:${u}->${M} adjustedbw(${Math.round(w)})-bitrate=${Math.round(w-k)} ttfb:${N.toFixed(1)} avgDuration:${Y.toFixed(1)} maxFetchDuration:${c.toFixed(1)} fetchDuration:${W.toFixed(1)} firstSelection:${A} codecSet:${F.codecSet} videoRange:${F.videoRange} hls.loadLevel:${p}`)),A&&(this.firstSelection=M),M}}return  -1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t);}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:s}=this.hls;return Math.min(Math.max(e,s),t)}}const Tn={search:function(r,e){let t=0,s=r.length-1,i=null,n=null;for(;t<=s;){i=(t+s)/2|0,n=r[i];const a=e(n);if(a>0)t=i+1;else if(a<0)s=i-1;else return n}return null}};function Sa(r,e,t){if(e===null||!Array.isArray(r)||!r.length||!B(e))return null;const s=r[0].programDateTime;if(e<(s||0))return null;const i=r[r.length-1].endProgramDateTime;if(e>=(i||0))return null;for(let n=0;n<r.length;++n){const a=r[n];if(Ta(e,t,a))return a}return null}function ht(r,e,t=0,s=0,i=.005){let n=null;if(r){n=e[1+r.sn-e[0].sn]||null;const o=r.endDTS-t;o>0&&o<15e-7&&(t+=15e-7),n&&r.level!==n.level&&n.end<=r.end&&(n=e[2+r.sn-e[0].sn]||null);}else t===0&&e[0].start===0&&(n=e[0]);if(n&&((!r||r.level===n.level)&&xi(t,s,n)===0||Ea(n,r,Math.min(i,s))))return n;const a=Tn.search(e,xi.bind(null,t,s));return a&&(a!==r||!n)?a:n}function Ea(r,e,t){if(e&&e.start===0&&e.level<r.level&&(e.endPTS||0)>0){const s=e.tagList.reduce((i,n)=>(n[0]==="INF"&&(i+=parseFloat(n[1])),i),t);return r.start<=s}return  false}function xi(r=0,e=0,t){if(t.start<=r&&t.start+t.duration>r)return 0;const s=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-s<=r?1:t.start-s>r&&t.start?-1:0}function Ta(r,e,t){const s=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return (t.endProgramDateTime||0)-s>r}function xn(r,e,t){if(r&&r.startCC<=e&&r.endCC>=e){let s=r.fragments;const{fragmentHint:i}=r;i&&(s=s.concat(i));let n;return Tn.search(s,a=>a.cc<e?1:a.cc>e?-1:(n=a,a.end<=t?1:a.start>t?-1:0)),n||null}return null}function Ht(r){switch(r.details){case _.FRAG_LOAD_TIMEOUT:case _.KEY_LOAD_TIMEOUT:case _.LEVEL_LOAD_TIMEOUT:case _.MANIFEST_LOAD_TIMEOUT:return  true}return  false}function vn(r){return r.details.startsWith("key")}function An(r){return vn(r)&&!!r.frag&&!r.frag.decryptdata}function vi(r,e){const t=Ht(e);return r.default[`${t?"timeout":"error"}Retry`]}function Us(r,e){const t=r.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*r.retryDelayMs,r.maxRetryDelayMs)}function Ai(r){return ee(ee({},r),{errorRetry:null,timeoutRetry:null})}function Yt(r,e,t,s){if(!r)return  false;const i=s?.code,n=e<r.maxNumRetry&&(xa(i)||!!t);return r.shouldRetry?r.shouldRetry(r,e,t,s,n):n}function xa(r){return bs(r)||!!r&&(r<400||r>499)}function bs(r){return r===0&&navigator.onLine===false}var ce={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},me={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,MoveAllAlternatesMatchingKey:4};class va extends be{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.hls=e,this.registerListeners();}registerListeners(){const e=this.hls;e.on(y.ERROR,this.onError,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this);}unregisterListeners(){const e=this.hls;e&&(e.off(y.ERROR,this.onError,this),e.off(y.ERROR,this.onErrorOut,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this));}destroy(){this.unregisterListeners(),this.hls=null;}startLoad(e){}stopLoad(){this.playlistError=0;}getVariantLevelIndex(e){return e?.type===K.MAIN?e.level:this.getVariantIndex()}getVariantIndex(){var e;const t=this.hls,s=t.currentLevel;return (e=t.loadLevelObj)!=null&&e.details||s===-1?t.loadLevel:s}variantHasKey(e,t){if(e){var s;if((s=e.details)!=null&&s.hasKey(t))return  true;const i=e.audioGroups;if(i)return this.hls.allAudioTracks.filter(a=>i.indexOf(a.groupId)>=0).some(a=>{var o;return (o=a.details)==null?void 0:o.hasKey(t)})}return  false}onManifestLoading(){this.playlistError=0;}onLevelUpdated(){this.playlistError=0;}onError(e,t){var s;if(t.fatal)return;const i=this.hls,n=t.context;switch(t.details){case _.FRAG_LOAD_ERROR:case _.FRAG_LOAD_TIMEOUT:case _.KEY_LOAD_ERROR:case _.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case _.FRAG_PARSING_ERROR:if((s=t.frag)!=null&&s.gap){t.errorAction=ot();return}case _.FRAG_GAP:case _.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=ce.SendAlternateToPenaltyBox;return}case _.LEVEL_EMPTY_ERROR:case _.LEVEL_PARSING_ERROR:{var a;const l=t.parent===K.MAIN?t.level:i.loadLevel;t.details===_.LEVEL_EMPTY_ERROR&&((a=t.context)!=null&&(a=a.levelDetails)!=null&&a.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,l):(t.levelRetry=false,t.errorAction=this.getLevelSwitchAction(t,l));}return;case _.LEVEL_LOAD_ERROR:case _.LEVEL_LOAD_TIMEOUT:typeof n?.level=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,n.level));return;case _.AUDIO_TRACK_LOAD_ERROR:case _.AUDIO_TRACK_LOAD_TIMEOUT:case _.SUBTITLE_LOAD_ERROR:case _.SUBTITLE_TRACK_LOAD_TIMEOUT:if(n){const l=i.loadLevelObj;if(l&&(n.type===$e.AUDIO_TRACK&&l.hasAudioGroup(n.groupId)||n.type===$e.SUBTITLE_TRACK&&l.hasSubtitleGroup(n.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,i.loadLevel),t.errorAction.action=ce.SendAlternateToPenaltyBox,t.errorAction.flags=me.MoveAllAlternatesMatchingHost;return}}return;case _.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:t.errorAction={action:ce.SendAlternateToPenaltyBox,flags:me.MoveAllAlternatesMatchingHDCP};return;case _.KEY_SYSTEM_SESSION_UPDATE_FAILED:case _.KEY_SYSTEM_STATUS_INTERNAL_ERROR:case _.KEY_SYSTEM_NO_SESSION:t.errorAction={action:ce.SendAlternateToPenaltyBox,flags:me.MoveAllAlternatesMatchingKey};return;case _.BUFFER_ADD_CODEC_ERROR:case _.REMUX_ALLOC_ERROR:case _.BUFFER_APPEND_ERROR:if(!t.errorAction){var o;t.errorAction=this.getLevelSwitchAction(t,(o=t.level)!=null?o:i.loadLevel);}return;case _.INTERNAL_EXCEPTION:case _.BUFFER_APPENDING_ERROR:case _.BUFFER_FULL_ERROR:case _.LEVEL_SWITCH_ERROR:case _.BUFFER_STALLED_ERROR:case _.BUFFER_SEEK_OVER_HOLE:case _.BUFFER_NUDGE_ON_STALL:t.errorAction=ot();return}t.type===G.KEY_SYSTEM_ERROR&&(t.levelRetry=false,t.errorAction=ot());}getPlaylistRetryOrSwitchAction(e,t){const s=this.hls,i=vi(s.config.playlistLoadPolicy,e),n=this.playlistError++;if(Yt(i,n,Ht(e),e.response))return {action:ce.RetryRequest,flags:me.None,retryConfig:i,retryCount:n};const o=this.getLevelSwitchAction(e,t);return i&&(o.retryConfig=i,o.retryCount=n),o}getFragRetryOrSwitchAction(e){const t=this.hls,s=this.getVariantLevelIndex(e.frag),i=t.levels[s],{fragLoadPolicy:n,keyLoadPolicy:a}=t.config,o=vi(vn(e)?a:n,e),l=t.levels.reduce((h,u)=>h+u.fragmentError,0);if(i&&(e.details!==_.FRAG_GAP&&i.fragmentError++,!An(e)&&Yt(o,l,Ht(e),e.response)))return {action:ce.RetryRequest,flags:me.None,retryConfig:o,retryCount:l};const c=this.getLevelSwitchAction(e,s);return o&&(c.retryConfig=o,c.retryCount=l),c}getLevelSwitchAction(e,t){const s=this.hls;t==null&&(t=s.loadLevel);const i=this.hls.levels[t];if(i){var n,a;const c=e.details;i.loadError++,c===_.BUFFER_APPEND_ERROR&&i.fragmentError++;let h=-1;const{levels:u,loadLevel:d,minAutoLevel:g,maxAutoLevel:f}=s;!s.autoLevelEnabled&&!s.config.preserveManualLevelOnError&&(s.loadLevel=-1);const m=(n=e.frag)==null?void 0:n.type,S=(m===K.AUDIO&&c===_.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(c===_.BUFFER_ADD_CODEC_ERROR||c===_.BUFFER_APPEND_ERROR))&&u.some(({audioCodec:D})=>i.audioCodec!==D),T=e.sourceBufferName==="video"&&(c===_.BUFFER_ADD_CODEC_ERROR||c===_.BUFFER_APPEND_ERROR)&&u.some(({codecSet:D,audioCodec:v})=>i.codecSet!==D&&i.audioCodec===v),{type:A,groupId:I}=(a=e.context)!=null?a:{};for(let D=u.length;D--;){const v=(D+d)%u.length;if(v!==d&&v>=g&&v<=f&&u[v].loadError===0){var o,l;const L=u[v];if(c===_.FRAG_GAP&&m===K.MAIN&&e.frag){const b=u[v].details;if(b){const R=ht(e.frag,b.fragments,e.frag.start);if(R!=null&&R.gap)continue}}else {if(A===$e.AUDIO_TRACK&&L.hasAudioGroup(I)||A===$e.SUBTITLE_TRACK&&L.hasSubtitleGroup(I))continue;if(m===K.AUDIO&&(o=i.audioGroups)!=null&&o.some(b=>L.hasAudioGroup(b))||m===K.SUBTITLE&&(l=i.subtitleGroups)!=null&&l.some(b=>L.hasSubtitleGroup(b))||S&&i.audioCodec===L.audioCodec||T&&i.codecSet===L.codecSet||!S&&i.codecSet!==L.codecSet)continue}h=v;break}}if(h>-1&&s.loadLevel!==h)return e.levelRetry=true,this.playlistError=0,{action:ce.SendAlternateToPenaltyBox,flags:me.None,nextAutoLevel:h}}return {action:ce.SendAlternateToPenaltyBox,flags:me.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var s;switch((s=t.errorAction)==null?void 0:s.action){case ce.DoNothing:break;case ce.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==_.FRAG_GAP?t.fatal=true:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,s=e.errorAction;if(!s)return;const{flags:i}=s,n=s.nextAutoLevel;switch(i){case me.None:this.switchLevel(e,n);break;case me.MoveAllAlternatesMatchingHDCP:{const l=this.getVariantLevelIndex(e.frag),c=t.levels[l],h=c?.attrs["HDCP-LEVEL"];if(s.hdcpLevel=h,h==="NONE")this.warn("HDCP policy resticted output with HDCP-LEVEL=NONE");else if(h){t.maxHdcpLevel=mi[mi.indexOf(h)-1],s.resolved=true,this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}}case me.MoveAllAlternatesMatchingKey:{const l=e.decryptdata;if(l){const c=this.hls.levels,h=c.length;for(let d=h;d--;)if(this.variantHasKey(c[d],l)){var a,o;this.log(`Banned key found in level ${d} (${c[d].bitrate}bps) or audio group "${(a=c[d].audioGroups)==null?void 0:a.join(",")}" (${(o=e.frag)==null?void 0:o.type} fragment) ${xe(l.keyId||[])}`),c[d].fragmentError++,c[d].loadError++,this.log(`Removing level ${d} with key error (${e.error})`),this.hls.removeLevel(d);}const u=e.frag;if(this.hls.levels.length<h)s.resolved=true;else if(u&&u.type!==K.MAIN){const d=u.decryptdata;d&&!l.matches(d)&&(s.resolved=true);}}break}}s.resolved||this.switchLevel(e,n);}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=true,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===_.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){const s=Ls(e.mimeType),i=this.hls.levels;for(let n=i.length;n--;)i[n][`${e.sourceBufferName}Codec`]===s&&(this.log(`Removing level ${n} for ${e.details} ("${s}" not supported)`),this.hls.removeLevel(n));}}}function ot(r){const e={action:ce.DoNothing,flags:me.None};return r&&(e.resolved=true),e}var ve={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"},qe={cbc:0,ctr:1};class Aa{constructor(e,t,s){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=s;}decrypt(e,t){switch(this.aesMode){case qe.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case qe.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function Ia(r){const e=r.byteLength,t=e&&new DataView(r.buffer).getUint8(e-1);return t?r.slice(0,e-t):r}class Ra{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable();}uint8ArrayToUint32Array_(e){const t=new DataView(e),s=new Uint32Array(4);for(let i=0;i<4;i++)s[i]=t.getUint32(i*4);return s}initTable(){const e=this.sBox,t=this.invSBox,s=this.subMix,i=s[0],n=s[1],a=s[2],o=s[3],l=this.invSubMix,c=l[0],h=l[1],u=l[2],d=l[3],g=new Uint32Array(256);let f=0,m=0,p=0;for(p=0;p<256;p++)p<128?g[p]=p<<1:g[p]=p<<1^283;for(p=0;p<256;p++){let S=m^m<<1^m<<2^m<<3^m<<4;S=S>>>8^S&255^99,e[f]=S,t[S]=f;const E=g[f],T=g[E],A=g[T];let I=g[S]*257^S*16843008;i[f]=I<<24|I>>>8,n[f]=I<<16|I>>>16,a[f]=I<<8|I>>>24,o[f]=I,I=A*16843009^T*65537^E*257^f*16843008,c[S]=I<<24|I>>>8,h[S]=I<<16|I>>>16,u[S]=I<<8|I>>>24,d[S]=I,f?(f=E^g[g[g[A^E]]],m^=g[g[m]]):f=m=1;}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let s=true,i=0;for(;i<t.length&&s;)s=t[i]===this.key[i],i++;if(s)return;this.key=t;const n=this.keySize=t.length;if(n!==4&&n!==6&&n!==8)throw new Error("Invalid aes key size="+n);const a=this.ksRows=(n+6+1)*4;let o,l;const c=this.keySchedule=new Uint32Array(a),h=this.invKeySchedule=new Uint32Array(a),u=this.sBox,d=this.rcon,g=this.invSubMix,f=g[0],m=g[1],p=g[2],S=g[3];let E,T;for(o=0;o<a;o++){if(o<n){E=c[o]=t[o];continue}T=E,o%n===0?(T=T<<8|T>>>24,T=u[T>>>24]<<24|u[T>>>16&255]<<16|u[T>>>8&255]<<8|u[T&255],T^=d[o/n|0]<<24):n>6&&o%n===4&&(T=u[T>>>24]<<24|u[T>>>16&255]<<16|u[T>>>8&255]<<8|u[T&255]),c[o]=E=(c[o-n]^T)>>>0;}for(l=0;l<a;l++)o=a-l,l&3?T=c[o]:T=c[o-4],l<4||o<=4?h[l]=T:h[l]=f[u[T>>>24]]^m[u[T>>>16&255]]^p[u[T>>>8&255]]^S[u[T&255]],h[l]=h[l]>>>0;}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,s){const i=this.keySize+6,n=this.invKeySchedule,a=this.invSBox,o=this.invSubMix,l=o[0],c=o[1],h=o[2],u=o[3],d=this.uint8ArrayToUint32Array_(s);let g=d[0],f=d[1],m=d[2],p=d[3];const S=new Int32Array(e),E=new Int32Array(S.length);let T,A,I,D,v,L,b,R,P,O,N,U,q,M;const F=this.networkToHostOrderSwap;for(;t<S.length;){for(P=F(S[t]),O=F(S[t+1]),N=F(S[t+2]),U=F(S[t+3]),v=P^n[0],L=U^n[1],b=N^n[2],R=O^n[3],q=4,M=1;M<i;M++)T=l[v>>>24]^c[L>>16&255]^h[b>>8&255]^u[R&255]^n[q],A=l[L>>>24]^c[b>>16&255]^h[R>>8&255]^u[v&255]^n[q+1],I=l[b>>>24]^c[R>>16&255]^h[v>>8&255]^u[L&255]^n[q+2],D=l[R>>>24]^c[v>>16&255]^h[L>>8&255]^u[b&255]^n[q+3],v=T,L=A,b=I,R=D,q=q+4;T=a[v>>>24]<<24^a[L>>16&255]<<16^a[b>>8&255]<<8^a[R&255]^n[q],A=a[L>>>24]<<24^a[b>>16&255]<<16^a[R>>8&255]<<8^a[v&255]^n[q+1],I=a[b>>>24]<<24^a[R>>16&255]<<16^a[v>>8&255]<<8^a[L&255]^n[q+2],D=a[R>>>24]<<24^a[v>>16&255]<<16^a[L>>8&255]<<8^a[b&255]^n[q+3],E[t]=F(T^g),E[t+1]=F(D^f),E[t+2]=F(I^m),E[t+3]=F(A^p),g=P,f=O,m=N,p=U,t=t+4;}return E.buffer}}class La{constructor(e,t,s){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=s;}expandKey(){const e=ba(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},false,["encrypt","decrypt"])}}function ba(r){switch(r){case qe.cbc:return "AES-CBC";case qe.ctr:return "AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${r}`)}}const _a=16;class $s{constructor(e,{removePKCS7Padding:t=true}={}){if(this.logEnabled=true,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const s=self.crypto;s&&(this.subtle=s.subtle||s.webkitSubtle);}catch{}this.useSoftware=!this.subtle;}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null;}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const s=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?Ia(s):s}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null);}decrypt(e,t,s,i){return this.useSoftware?new Promise((n,a)=>{const o=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(o,t,s,i);const l=this.flush();l?n(l.buffer):a(new Error("[softwareDecrypt] Failed to decrypt data"));}):this.webCryptoDecrypt(new Uint8Array(e),t,s,i)}softwareDecrypt(e,t,s,i){const{currentIV:n,currentResult:a,remainderData:o}=this;if(i!==qe.cbc||t.byteLength!==16)return re.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),o&&(e=Ae(o,e),this.remainderData=null);const l=this.getValidChunk(e);if(!l.length)return null;n&&(s=n);let c=this.softwareDecrypter;c||(c=this.softwareDecrypter=new Ra),c.expandKey(t);const h=a;return this.currentResult=c.decrypt(l.buffer,0,s),this.currentIV=l.slice(-16).buffer,h||null}webCryptoDecrypt(e,t,s,i){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,s,i));this.key=t,this.fastAesKey=new La(this.subtle,t,i);}return this.fastAesKey.expandKey().then(n=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new Aa(this.subtle,new Uint8Array(s),i).decrypt(e.buffer,n)):Promise.reject(new Error("web crypto not initialized"))).catch(n=>(re.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${n.name}: ${n.message}`),this.onWebCryptoError(e,t,s,i)))}onWebCryptoError(e,t,s,i){const n=this.enableSoftwareAES;if(n){this.useSoftware=true,this.logEnabled=true,this.softwareDecrypt(e,t,s,i);const a=this.flush();if(a)return a.buffer}throw new Error("WebCrypto"+(n?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const s=e.length-e.length%_a;return s!==e.length&&(t=e.slice(0,s),this.remainderData=e.slice(s)),t}logOnce(e){this.logEnabled&&(re.log(`[decrypter]: ${e}`),this.logEnabled=false);}}const Ii=Math.pow(2,17);class Da{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e;}destroy(){this.loader&&(this.loader.destroy(),this.loader=null);}abort(){this.loader&&this.loader.abort();}load(e,t){const s=e.url;if(!s)return Promise.reject(new He({type:G.NETWORK_ERROR,details:_.FRAG_LOAD_ERROR,fatal:false,frag:e,error:new Error(`Fragment does not have a ${s?"part list":"url"}`),networkDetails:null}));this.abort();const i=this.config,n=i.fLoader,a=i.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(f=>f[0]==="GAP")){l(Li(e));return}else e.gap=false;const c=this.loader=n?new n(i):new a(i),h=Ri(e);e.loader=c;const u=Ai(i.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:Ii};e.stats=c.stats;const g={onSuccess:(f,m,p,S)=>{this.resetLoader(e,c);let E=f.data;p.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(E.slice(0,16)),E=E.slice(16)),o({frag:e,part:null,payload:E,networkDetails:S});},onError:(f,m,p,S)=>{this.resetLoader(e,c),l(new He({type:G.NETWORK_ERROR,details:_.FRAG_LOAD_ERROR,fatal:false,frag:e,response:ee({url:s,data:void 0},f),error:new Error(`HTTP Error ${f.code} ${f.text}`),networkDetails:p,stats:S}));},onAbort:(f,m,p)=>{this.resetLoader(e,c),l(new He({type:G.NETWORK_ERROR,details:_.INTERNAL_ABORTED,fatal:false,frag:e,error:new Error("Aborted"),networkDetails:p,stats:f}));},onTimeout:(f,m,p)=>{this.resetLoader(e,c),l(new He({type:G.NETWORK_ERROR,details:_.FRAG_LOAD_TIMEOUT,fatal:false,frag:e,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:p,stats:f}));}};t&&(g.onProgress=(f,m,p,S)=>t({frag:e,part:null,payload:p,networkDetails:S})),c.load(h,d,g);})}loadPart(e,t,s){this.abort();const i=this.config,n=i.fLoader,a=i.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){l(Li(e,t));return}const c=this.loader=n?new n(i):new a(i),h=Ri(e,t);e.loader=c;const u=Ai(i.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Ii};t.stats=c.stats,c.load(h,d,{onSuccess:(g,f,m,p)=>{this.resetLoader(e,c),this.updateStatsFromPart(e,t);const S={frag:e,part:t,payload:g.data,networkDetails:p};s(S),o(S);},onError:(g,f,m,p)=>{this.resetLoader(e,c),l(new He({type:G.NETWORK_ERROR,details:_.FRAG_LOAD_ERROR,fatal:false,frag:e,part:t,response:ee({url:h.url,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:m,stats:p}));},onAbort:(g,f,m)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,c),l(new He({type:G.NETWORK_ERROR,details:_.INTERNAL_ABORTED,fatal:false,frag:e,part:t,error:new Error("Aborted"),networkDetails:m,stats:g}));},onTimeout:(g,f,m)=>{this.resetLoader(e,c),l(new He({type:G.NETWORK_ERROR,details:_.FRAG_LOAD_TIMEOUT,fatal:false,frag:e,part:t,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:m,stats:g}));}});})}updateStatsFromPart(e,t){const s=e.stats,i=t.stats,n=i.total;if(s.loaded+=i.loaded,n){const l=Math.round(e.duration/t.duration),c=Math.min(Math.round(s.loaded/n),l),u=(l-c)*Math.round(s.loaded/c);s.total=s.loaded+u;}else s.total=Math.max(s.loaded,s.total);const a=s.loading,o=i.loading;a.start?a.first+=o.first-o.start:(a.start=o.start,a.first=o.first),a.end=o.end;}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy();}}function Ri(r,e=null){const t=e||r,s={frag:r,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},i=t.byteRangeStartOffset,n=t.byteRangeEndOffset;if(B(i)&&B(n)){var a;let o=i,l=n;if(r.sn==="initSegment"&&Pa((a=r.decryptdata)==null?void 0:a.method)){const c=n-i;c%16&&(l=n+(16-c%16)),i!==0&&(s.resetIV=true,o=i-16);}s.rangeStart=o,s.rangeEnd=l;}return s}function Li(r,e){const t=new Error(`GAP ${r.gap?"tag":"attribute"} found`),s={type:G.MEDIA_ERROR,details:_.FRAG_GAP,fatal:false,frag:r,error:t,networkDetails:null};return e&&(s.part=e),(e||r).stats.aborted=true,new He(s)}function Pa(r){return r==="AES-128"||r==="AES-256"}class He extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e;}}class Ca extends be{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this);}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed();}onHandlerDestroying(){this.clearNextTick(),this.clearInterval();}onHandlerDestroyed(){}hasInterval(){return !!this._tickInterval}hasNextTick(){return !!this._tickTimer}setInterval(e){return this._tickInterval?false:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),true)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,true):false}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,true):false}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0);}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0);}doTick(){}}class In{constructor(e,t,s,i=0,n=-1,a=false){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=bt(),this.buffering={audio:bt(),video:bt(),audiovideo:bt()},this.level=e,this.sn=t,this.id=s,this.size=i,this.part=n,this.partial=a;}}function bt(){return {start:0,executeStart:0,executeEnd:0,end:0}}const bi={length:0,start:()=>0,end:()=>0};class J{static isBuffered(e,t){if(e){const s=J.getBuffered(e);for(let i=s.length;i--;)if(t>=s.start(i)&&t<=s.end(i))return  true}return  false}static bufferedRanges(e){if(e){const t=J.getBuffered(e);return J.timeRangesToArray(t)}return []}static timeRangesToArray(e){const t=[];for(let s=0;s<e.length;s++)t.push({start:e.start(s),end:e.end(s)});return t}static bufferInfo(e,t,s){if(e){const i=J.bufferedRanges(e);if(i.length)return J.bufferedInfo(i,t,s)}return {len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,s){t=Math.max(0,t),e.length>1&&e.sort((h,u)=>h.start-u.start||u.end-h.end);let i=-1,n=[];if(s)for(let h=0;h<e.length;h++){t>=e[h].start&&t<=e[h].end&&(i=h);const u=n.length;if(u){const d=n[u-1].end;e[h].start-d<s?e[h].end>d&&(n[u-1].end=e[h].end):n.push(e[h]);}else n.push(e[h]);}else n=e;let a=0,o,l=t,c=t;for(let h=0;h<n.length;h++){const u=n[h].start,d=n[h].end;if(i===-1&&t>=u&&t<=d&&(i=h),t+s>=u&&t<d)l=u,c=d,a=c-t;else if(t+s<u){o=u;break}}return {len:a,start:l||0,end:c||0,nextStart:o,buffered:e,bufferedIndex:i}}static getBuffered(e){try{return e.buffered||bi}catch(t){return re.log("failed to get media.buffered",t),bi}}}const ka=/\{\$([a-zA-Z0-9-_]+)\}/g;function wa(r,e){if(r.variableList!==null||r.hasVariableRefs){const t=r.variableList;return e.replace(ka,s=>{const i=s.substring(2,s.length-1),n=t?.[i];return n===void 0?(r.playlistParsingError||(r.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${i}"`)),s):n})}return e}const Oa=/^(\d+)x(\d+)$/,_i=/(.+?)=(".*?"|.*?)(?:,|$)/g;class At{constructor(e,t){typeof e=="string"&&(e=At.parseAttrList(e,t)),ie(this,e);}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const s=new Uint8Array(t.length/2);for(let i=0;i<t.length/2;i++)s[i]=parseInt(t.slice(i*2,i*2+2),16);return s}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const s=this[e];return s?parseFloat(s):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const s=this[e];return (s?s.split(/[ ,]+/):[]).reduce((i,n)=>(i[n.toLowerCase()]=true,i),t)}bool(e){return this[e]==="YES"}decimalResolution(e){const t=Oa.exec(this[e]);if(t!==null)return {width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let s;const i={};for(_i.lastIndex=0;(s=_i.exec(e))!==null;){const a=s[1].trim();let o=s[2];const l=o.indexOf('"')===0&&o.lastIndexOf('"')===o.length-1;let c=false;if(l)o=o.slice(1,-1);else switch(a){case "IV":case "SCTE35-CMD":case "SCTE35-IN":case "SCTE35-OUT":c=true;}if(t&&(l||c))o=wa(t,o);else if(!c&&!l)switch(a){case "CLOSED-CAPTIONS":if(o==="NONE")break;case "ALLOWED-CPC":case "CLASS":case "ASSOC-LANGUAGE":case "AUDIO":case "BYTERANGE":case "CHANNELS":case "CHARACTERISTICS":case "CODECS":case "DATA-ID":case "END-DATE":case "GROUP-ID":case "ID":case "IMPORT":case "INSTREAM-ID":case "KEYFORMAT":case "KEYFORMATVERSIONS":case "LANGUAGE":case "NAME":case "PATHWAY-ID":case "QUERYPARAM":case "RECENTLY-REMOVED-DATERANGES":case "SERVER-URI":case "STABLE-RENDITION-ID":case "STABLE-VARIANT-ID":case "START-DATE":case "SUBTITLES":case "SUPPLEMENTAL-CODECS":case "URI":case "VALUE":case "VIDEO":case "X-ASSET-LIST":case "X-ASSET-URI":re.warn(`${e}: attribute ${a} is missing quotes`);}i[a]=o;}return i}}const Fa="com.apple.hls.interstitial";class Ma{constructor(e,t,s=0){var i;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=t?.tagAnchor||null,this.tagOrder=(i=t?.tagOrder)!=null?i:s,t){const n=t.attr;for(const a in n)if(Object.prototype.hasOwnProperty.call(e,a)&&e[a]!==n[a]){re.warn(`DATERANGE tag attribute: "${a}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=a;break}e=ie(new At({}),n,e);}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const n=t?.endDate||new Date(this.attr["END-DATE"]);B(n.getTime())&&(this._endDate=n);}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:false,post:false,once:false}):e}get startTime(){const{tagAnchor:e}=this;return e===null||e.programDateTime===null?(re.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return t!==null?this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(B(e))return e}else if(this._endDate)return (this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return "PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===Fa}get isValid(){return !!this.id&&!this._badValueForSameId&&B(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}function Na(r,e){return r.length===e.length?!r.some((t,s)=>t!==e[s]):false}function Gs(r){return r==="AES-128"||r==="AES-256"||r==="AES-256-CTR"}function Ks(r){switch(r){case "AES-128":case "AES-256":return qe.cbc;case "AES-256-CTR":return qe.ctr;default:throw new Error(`invalid full segment method ${r}`)}}function Ba(r){return Uint8Array.from(atob(r),e=>e.charCodeAt(0))}function Di(r){return Uint8Array.from(unescape(encodeURIComponent(r)),e=>e.charCodeAt(0))}function Ua(r){const e=function(s,i,n){const a=s[i];s[i]=s[n],s[n]=a;};e(r,0,3),e(r,1,2),e(r,4,5),e(r,6,7);}const Wt=typeof self<"u"?self:void 0;var te={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},We={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function os(r){switch(r){case We.FAIRPLAY:return te.FAIRPLAY;case We.PLAYREADY:return te.PLAYREADY;case We.WIDEVINE:return te.WIDEVINE;case We.CLEARKEY:return te.CLEARKEY}}function ls(r){switch(r){case te.FAIRPLAY:return We.FAIRPLAY;case te.PLAYREADY:return We.PLAYREADY;case te.WIDEVINE:return We.WIDEVINE;case te.CLEARKEY:return We.CLEARKEY}}function _t(r){const{drmSystems:e,widevineLicenseUrl:t}=r,s=e?[te.FAIRPLAY,te.WIDEVINE,te.PLAYREADY,te.CLEARKEY].filter(i=>!!e[i]):[];return !s[te.WIDEVINE]&&t&&s.push(te.WIDEVINE),s}const Rn=(function(r){return Wt!=null&&(r=Wt.navigator)!=null&&r.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null})();function $a(r,e,t,s){let i;switch(r){case te.FAIRPLAY:i=["cenc","sinf"];break;case te.WIDEVINE:case te.PLAYREADY:i=["cenc"];break;case te.CLEARKEY:i=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${r}`)}return Ga(i,e,t,s)}function Ga(r,e,t,s){return [{initDataTypes:r,persistentState:s.persistentState||"optional",distinctiveIdentifier:s.distinctiveIdentifier||"optional",sessionTypes:s.sessionTypes||[s.sessionType||"temporary"],audioCapabilities:e.map(n=>({contentType:`audio/mp4; codecs=${n}`,robustness:s.audioRobustness||"",encryptionScheme:s.audioEncryptionScheme||null})),videoCapabilities:t.map(n=>({contentType:`video/mp4; codecs=${n}`,robustness:s.videoRobustness||"",encryptionScheme:s.videoEncryptionScheme||null}))}]}function Ka(r){var e;return !!r&&(r.sessionType==="persistent-license"||!!((e=r.sessionTypes)!=null&&e.some(t=>t==="persistent-license")))}function Va(r,e){let t=r.length;if(!t)if(e.hasProgramDateTime){const o=e.fragments[e.fragments.length-1];r.push(o),t++;}else return;const s=r[t-1],i=e.live?1/0:e.totalduration,n=Object.keys(e.dateRanges);for(let o=n.length;o--;){const l=e.dateRanges[n[o]],c=l.startDate.getTime();l.tagAnchor=s.ref;for(let h=t;h--;){var a;if(((a=r[h])==null?void 0:a.sn)<e.startSN)break;const u=Ha(e,c,r,h,i);if(u!==-1){l.tagAnchor=e.fragments[u].ref;break}}}}function Ha(r,e,t,s,i){const n=t[s];if(n){const o=n.programDateTime;if(e>=o||s===0){var a;const l=(((a=t[s+1])==null?void 0:a.start)||i)-n.start;if(e<=o+l*1e3){const c=t[s].sn-r.startSN;if(c<0)return  -1;const h=r.fragments;if(h.length>t.length){const d=(t[s+1]||h[h.length-1]).sn-r.startSN;for(let g=d;g>c;g--){const f=h[g].programDateTime;if(e>=f&&e<f+h[g].duration*1e3)return g}}return c}}}return  -1}function Ya(r,e,t){r.rawProgramDateTime?t.push(r):e!=null&&e.programDateTime&&(r.programDateTime=e.endProgramDateTime);}function cs(r,e){const t=e.startPTS;if(B(t)){let s=0,i;e.sn>r.sn?(s=t-r.start,i=r):(s=r.start-t,i=e),i.duration!==s&&i.setDuration(s);}else e.sn>r.sn?r.cc===e.cc&&r.minEndPTS?e.setStart(r.start+(r.minEndPTS-r.start)):e.setStart(r.start+r.duration):e.setStart(Math.max(r.start-e.duration,0));}function Ln(r,e,t,s,i,n,a){s-t<=0&&(a.warn("Fragment should have a positive duration",e),s=t+e.duration,n=i+e.duration);let l=t,c=s;const h=e.startPTS,u=e.endPTS;if(B(h)){const S=Math.abs(h-t);r&&S>r.totalduration?a.warn(`media timestamps and playlist times differ by ${S}s for level ${e.level} ${r.url}`):B(e.deltaPTS)?e.deltaPTS=Math.max(S,e.deltaPTS):e.deltaPTS=S,l=Math.max(t,h),t=Math.min(t,h),i=e.startDTS!==void 0?Math.min(i,e.startDTS):i,c=Math.min(s,u),s=Math.max(s,u),n=e.endDTS!==void 0?Math.max(n,e.endDTS):n;}const d=t-e.start;e.start!==0&&e.setStart(t),e.setDuration(s-e.start),e.startPTS=t,e.maxStartPTS=l,e.startDTS=i,e.endPTS=s,e.minEndPTS=c,e.endDTS=n;const g=e.sn;if(!r||g<r.startSN||g>r.endSN)return 0;let f;const m=g-r.startSN,p=r.fragments;for(p[m]=e,f=m;f>0;f--)cs(p[f],p[f-1]);for(f=m;f<p.length-1;f++)cs(p[f],p[f+1]);return r.fragmentHint&&cs(p[p.length-1],r.fragmentHint),r.PTSKnown=r.alignedSliding=true,d}function Wa(r,e,t){if(r===e)return;let s=null;const i=r.fragments;for(let h=i.length-1;h>=0;h--){const u=i[h].initSegment;if(u){s=u;break}}r.fragmentHint&&delete r.fragmentHint.endPTS;let n;za(r,e,(h,u,d,g)=>{if((!e.startCC||e.skippedSegments)&&u.cc!==h.cc){const f=h.cc-u.cc;for(let m=d;m<g.length;m++)g[m].cc+=f;e.endCC=g[g.length-1].cc;}B(h.startPTS)&&B(h.endPTS)&&(u.setStart(u.startPTS=h.startPTS),u.startDTS=h.startDTS,u.maxStartPTS=h.maxStartPTS,u.endPTS=h.endPTS,u.endDTS=h.endDTS,u.minEndPTS=h.minEndPTS,u.setDuration(h.endPTS-h.startPTS),u.duration&&(n=u),e.PTSKnown=e.alignedSliding=true),h.hasStreams&&(u.elementaryStreams=h.elementaryStreams),u.loader=h.loader,h.hasStats&&(u.stats=h.stats),h.initSegment&&(u.initSegment=h.initSegment,s=h.initSegment);});const a=e.fragments,o=e.fragmentHint?a.concat(e.fragmentHint):a;if(s&&o.forEach(h=>{var u;h&&(!h.initSegment||h.initSegment.relurl===((u=s)==null?void 0:u.relurl))&&(h.initSegment=s);}),e.skippedSegments){if(e.deltaUpdateFailed=a.some(h=>!h),e.deltaUpdateFailed){t.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let h=e.skippedSegments;h--;)a.shift();e.startSN=a[0].sn;}else {e.canSkipDateRanges&&(e.dateRanges=qa(r.dateRanges,e,t));const h=r.fragments.filter(u=>u.rawProgramDateTime);if(r.hasProgramDateTime&&!e.hasProgramDateTime)for(let u=1;u<o.length;u++)o[u].programDateTime===null&&Ya(o[u],o[u-1],h);Va(h,e);}e.endCC=a[a.length-1].cc;}if(!e.startCC){var l;const h=_n(r,e.startSN-1);e.startCC=(l=h?.cc)!=null?l:a[0].cc;}ja(r.partList,e.partList,(h,u)=>{u.elementaryStreams=h.elementaryStreams,u.stats=h.stats;}),n?Ln(e,n,n.startPTS,n.endPTS,n.startDTS,n.endDTS,t):bn(r,e),a.length&&(e.totalduration=e.edge-a[0].start),e.driftStartTime=r.driftStartTime,e.driftStart=r.driftStart;const c=e.advancedDateTime;if(e.advanced&&c){const h=e.edge;e.driftStart||(e.driftStartTime=c,e.driftStart=h),e.driftEndTime=c,e.driftEnd=h;}else e.driftEndTime=r.driftEndTime,e.driftEnd=r.driftEnd,e.advancedDateTime=r.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=r.requestScheduled);}function qa(r,e,t){const{dateRanges:s,recentlyRemovedDateranges:i}=e,n=ie({},r);i&&i.forEach(l=>{delete n[l];});const o=Object.keys(n).length;return o?(Object.keys(s).forEach(l=>{const c=n[l],h=new Ma(s[l].attr,c);h.isValid?(n[l]=h,c||(h.tagOrder+=o)):t.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${se(s[l].attr)}"`);}),n):s}function ja(r,e,t){if(r&&e){let s=0;for(let i=0,n=r.length;i<=n;i++){const a=r[i],o=e[i+s];a&&o&&a.index===o.index&&a.fragment.sn===o.fragment.sn?t(a,o):s--;}}}function za(r,e,t){const s=e.skippedSegments,i=Math.max(r.startSN,e.startSN)-e.startSN,n=(r.fragmentHint?1:0)+(s?e.endSN:Math.min(r.endSN,e.endSN))-e.startSN,a=e.startSN-r.startSN,o=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=r.fragmentHint?r.fragments.concat(r.fragmentHint):r.fragments;for(let c=i;c<=n;c++){const h=l[a+c];let u=o[c];if(s&&!u&&h&&(u=e.fragments[c]=h),h&&u){t(h,u,c,o);const d=h.relurl,g=u.relurl;if(d&&Za(d,g)){e.playlistParsingError=Pi(`media sequence mismatch ${u.sn}:`,r,e,h,u);return}else if(h.cc!==u.cc){e.playlistParsingError=Pi(`discontinuity sequence mismatch (${h.cc}!=${u.cc})`,r,e,h,u);return}}}}function Pi(r,e,t,s,i){return new Error(`${r} ${i.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${t.startSN}
${t.m3u8}`)}function bn(r,e,t=true){const s=e.startSN+e.skippedSegments-r.startSN,i=r.fragments,n=s>=0;let a=0;if(n&&s<i.length)a=i[s].start;else if(n&&e.startSN===r.endSN+1)a=r.fragmentEnd;else if(n&&t)a=r.fragmentStart+s*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)a=r.fragmentStart;else return;_s(e,a);}function _s(r,e){if(e){const t=r.fragments;for(let s=r.skippedSegments;s<t.length;s++)t[s].addStart(e);r.fragmentHint&&r.fragmentHint.addStart(e);}}function Qa(r,e=1/0){let t=1e3*r.targetduration;if(r.updated){const s=r.fragments;if(s.length&&t*4>e){const n=s[s.length-1].duration*1e3;n<t&&(t=n);}}else t/=2;return Math.round(t)}function _n(r,e,t){if(!r)return null;let s=r.fragments[e-r.startSN];return s||(s=r.fragmentHint,s&&s.sn===e)?s:e<r.startSN&&t&&t.sn===e?t:null}function Ci(r,e,t){return r?Dn(r.partList,e,t):null}function Dn(r,e,t){if(r)for(let s=r.length;s--;){const i=r[s];if(i.index===t&&i.fragment.sn===e)return i}return null}function Xa(r){r.forEach((e,t)=>{var s;(s=e.details)==null||s.fragments.forEach(i=>{i.level=t,i.initSegment&&(i.initSegment.level=t);});});}function Za(r,e){return r!==e&&e?ki(r)!==ki(e):false}function ki(r){return r.replace(/\?[^?]*$/,"")}function yt(r,e){for(let s=0,i=r.length;s<i;s++){var t;if(((t=r[s])==null?void 0:t.cc)===e)return r[s]}return null}function Ja(r,e){return !!(r&&e.startCC<r.endCC&&e.endCC>r.startCC)}function wi(r,e){const t=r.start+e;r.startPTS=t,r.setStart(t),r.endPTS=t+r.duration;}function Pn(r,e){const t=e.fragments;for(let s=0,i=t.length;s<i;s++)wi(t[s],r);e.fragmentHint&&wi(e.fragmentHint,r),e.alignedSliding=true;}function eo(r,e){r&&(Cn(e,r),e.alignedSliding||qt(e,r),!e.alignedSliding&&!e.skippedSegments&&bn(r,e,false));}function Cn(r,e){if(!Ja(e,r))return;const t=Math.min(e.endCC,r.endCC),s=yt(e.fragments,t),i=yt(r.fragments,t);if(!s||!i)return;re.log(`Aligning playlist at start of dicontinuity sequence ${t}`);const n=s.start-i.start;Pn(n,r);}function qt(r,e){if(!r.hasProgramDateTime||!e.hasProgramDateTime)return;const t=r.fragments,s=e.fragments;if(!t.length||!s.length)return;let i,n;const a=Math.min(e.endCC,r.endCC);e.startCC<a&&r.startCC<a&&(i=yt(s,a),n=yt(t,a)),(!i||!n)&&(i=s[Math.floor(s.length/2)],n=yt(t,i.cc)||t[Math.floor(t.length/2)]);const o=i.programDateTime,l=n.programDateTime;if(!o||!l)return;const c=(l-o)/1e3-(n.start-i.start);Pn(c,r);}function Fe(r,e,t){Ge(r,e,t),r.addEventListener(e,t);}function Ge(r,e,t){r.removeEventListener(e,t);}const to={toString:function(r){let e="";const t=r.length;for(let s=0;s<t;s++)e+=`[${r.start(s).toFixed(3)}-${r.end(s).toFixed(3)}]`;return e}},C={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class kn extends Ca{constructor(e,t,s,i,n){super(i,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=C.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=false,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=false,this.decrypter=void 0,this.initPTS=[],this.buffering=true,this.loadingParts=false,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:a,fragCurrent:o,media:l,mediaBuffer:c,state:h}=this,u=l?l.currentTime:0,d=J.bufferInfo(c||l,u,a.maxBufferHole),g=!d.len;if(this.log(`Media seeking to ${B(u)?u.toFixed(3):u}, state: ${h}, ${g?"out of":"in"} buffer`),this.state===C.ENDED)this.resetLoadingState();else if(o){const f=a.maxFragLookUpTolerance,m=o.start-f,p=o.start+o.duration+f;if(g||p<d.start||m>d.end){const S=u>p;(u<m||S)&&(S&&o.loader&&(this.log(`Cancelling fragment load for seek (sn: ${o.sn})`),o.abortRequests(),this.resetLoadingState()),this.fragPrevious=null);}}if(l){this.fragmentTracker.removeFragmentsInRange(u,1/0,this.playlistType,true);const f=this.lastCurrentTime;if(u>f&&(this.lastCurrentTime=u),!this.loadingParts){const m=Math.max(d.end,u),p=this.shouldLoadParts(this.getLevelDetails(),m);p&&(this.log(`LL-Part loading ON after seeking to ${u.toFixed(2)} with buffer @${m.toFixed(2)}`),this.loadingParts=p);}}this.hls.hasEnoughToStart||(this.log(`Setting ${g?"startPosition":"nextLoadPosition"} to ${u} for seek without enough to start`),this.nextLoadPosition=u,g&&(this.startPosition=u)),g&&this.state===C.IDLE&&this.tickImmediate();},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0;},this.playlistType=n,this.hls=e,this.fragmentLoader=new Da(e.config),this.keyLoader=s,this.fragmentTracker=t,this.config=e.config,this.decrypter=new $s(e.config);}registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.ERROR,this.onError,this);}unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.ERROR,this.onError,this);}doTick(){this.onTickEnd();}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===C.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=C.STOPPED;}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=false;}resumeBuffering(){this.buffering=true;}get inFlightFrag(){return {frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return  false;const s=e.end||0,i=this.config.timelineOffset||0;if(s<=i)return  false;const n=e.buffered;this.config.maxBufferHole&&n&&n.length>1&&(e=J.bufferedInfo(n,e.start,0));const a=e.nextStart;if(a&&a>i&&a<t.edge||this.media.currentTime<e.start)return  false;const l=t.partList;if(l!=null&&l.length){const h=l[l.length-1];return J.isBuffered(this.media,h.start+h.duration/2)}const c=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(c)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null)return this.levelLastLoaded.details}get timelineOffset(){const e=this.config.timelineOffset;if(e){var t;return ((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}onMediaAttached(e,t){const s=this.media=this.mediaBuffer=t.media;Fe(s,"seeking",this.onMediaSeeking),Fe(s,"ended",this.onMediaEnded);const i=this.config;this.levels&&i.autoStartLoad&&this.state===C.STOPPED&&this.startLoad(i.startPosition);}onMediaDetaching(e,t){const s=!!t.transferMedia,i=this.media;if(i!==null){if(i.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),Ge(i,"seeking",this.onMediaSeeking),Ge(i,"ended",this.onMediaEnded),this.keyLoader&&!s&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,s){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=false,this.fragmentTracker.removeAllFragments(),this.stopLoad();}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=false;}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset;}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null;}onHandlerDestroyed(){this.state=C.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed();}loadFragment(e,t,s){this.startFragRequested=true,this._loadFragForPlayback(e,t,s);}_loadFragForPlayback(e,t,s){const i=n=>{const a=n.frag;if(this.fragContextChanged(a)){this.warn(`${a.type} sn: ${a.sn}${n.part?" part: "+n.part.index:""} of ${this.fragInfo(a,false,n.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(a);return}a.stats.chunkCount++,this._handleFragmentLoadProgress(n);};this._doFragLoad(e,t,s,i).then(n=>{if(!n)return;const a=this.state,o=n.frag;if(this.fragContextChanged(o)){(a===C.FRAG_LOADING||!this.fragCurrent&&a===C.PARSING)&&(this.fragmentTracker.removeFragment(o),this.state=C.IDLE);return}"payload"in n&&(this.log(`Loaded ${o.type} sn: ${o.sn} of ${this.playlistLabel()} ${o.level}`),this.hls.trigger(y.FRAG_LOADED,n)),this._handleFragmentLoadComplete(n);}).catch(n=>{this.state===C.STOPPED||this.state===C.ERROR||(this.warn(`Frag error: ${n?.message||n}`),this.resetFragmentLoading(e));});}clearTrackerIfNeeded(e){var t;const{fragmentTracker:s}=this;if(s.getState(e)===ve.APPENDING){const n=e.type,a=this.getFwdBufferInfo(this.mediaBuffer,n),o=Math.max(e.duration,a?a.len:this.config.maxBufferLength),l=this.backtrackFragment;((l?e.sn-l.sn:0)===1||this.reduceMaxBufferLength(o,e.duration))&&s.removeFragment(e);}else ((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?s.removeAllFragments():s.hasParts(e.type)&&(s.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),s.getState(e)===ve.PARTIAL&&s.removeFragment(e));}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type});}e.fragments[0]||(e.deltaUpdateFailed=true);}waitForLive(e){const t=e.details;return t?.live&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,s=null){if(!(e-t))return;const i={startOffset:e,endOffset:t,type:s};this.hls.trigger(y.BUFFER_FLUSHING,i);}_loadInitSegment(e,t){this._doFragLoad(e,t).then(s=>{const i=s?.frag;if(!i||this.fragContextChanged(i)||!this.levels)throw new Error("init load aborted");return s}).then(s=>{const{hls:i}=this,{frag:n,payload:a}=s,o=n.decryptdata;if(a&&a.byteLength>0&&o!=null&&o.key&&o.iv&&Gs(o.method)){const l=self.performance.now();return this.decrypter.decrypt(new Uint8Array(a),o.key.buffer,o.iv.buffer,Ks(o.method)).catch(c=>{throw i.trigger(y.ERROR,{type:G.MEDIA_ERROR,details:_.FRAG_DECRYPT_ERROR,fatal:false,error:c,reason:c.message,frag:n}),c}).then(c=>{const h=self.performance.now();return i.trigger(y.FRAG_DECRYPTED,{frag:n,payload:c,stats:{tstart:l,tdecrypt:h}}),s.payload=c,this.completeInitSegmentLoad(s)})}return this.completeInitSegmentLoad(s)}).catch(s=>{this.state===C.STOPPED||this.state===C.ERROR||(this.warn(s),this.resetFragmentLoading(e));});}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const s=e.frag.stats;this.state!==C.STOPPED&&(this.state=C.IDLE),e.frag.data=new Uint8Array(e.payload),s.parsing.start=s.buffering.start=self.performance.now(),s.parsing.end=s.buffering.end=self.performance.now(),this.tick();}unhandledEncryptionError(e,t){var s,i;const n=e.tracks;if(n&&!t.encrypted&&((s=n.audio)!=null&&s.encrypted||(i=n.video)!=null&&i.encrypted)&&(!this.config.emeEnabled||!this.keyLoader.emeController)){const a=this.media,o=new Error(`Encrypted track with no key in ${this.fragInfo(t)} (media ${a?"attached mediaKeys: "+a.mediaKeys:"detached"})`);return this.warn(o.message),!a||a.mediaKeys?false:(this.hls.trigger(y.ERROR,{type:G.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_NO_KEYS,fatal:false,error:o,frag:t}),this.resetTransmuxer(),true)}return  false}fragContextChanged(e){const{fragCurrent:t}=this;return !e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const s=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,false,t)} > buffer:${s?to.toString(J.getBuffered(s)):"(detached)"})`),ye(e)){var i;if(e.type!==K.SUBTITLE){const a=e.elementaryStreams;if(!Object.keys(a).some(o=>!!a[o])){this.state=C.IDLE;return}}const n=(i=this.levels)==null?void 0:i[e.level];n!=null&&n.fragmentError&&(this.log(`Resetting level fragment error count of ${n.fragmentError} on frag buffered`),n.fragmentError=0);}this.state=C.IDLE;}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:s,part:i,partsLoaded:n}=e,a=!n||n.length===0||n.some(l=>!l),o=new In(s.level,s.sn,s.stats.chunkCount+1,0,i?i.index:-1,!a);t.flush(o);}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,s=null,i){var n;this.fragCurrent=e;const a=t.details;if(!this.levels||!a)throw new Error(`frag load aborted, missing level${a?"":" detail"}s`);let o=null;if(e.encrypted&&!((n=e.decryptdata)!=null&&n.key)){if(this.log(`Loading key for ${e.sn} of [${a.startSN}-${a.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=C.KEY_LOADING,this.fragCurrent=e,o=this.keyLoader.load(e).then(d=>{if(!this.fragContextChanged(d.frag))return this.hls.trigger(y.KEY_LOADED,d),this.state===C.KEY_LOADING&&(this.state=C.IDLE),d}),this.hls.trigger(y.KEY_LOADING,{frag:e}),this.fragCurrent===null)return this.log("context changed in KEY_LOADING"),Promise.resolve(null)}else e.encrypted||(o=this.keyLoader.loadClear(e,a.encryptedFragments,this.startFragRequested),o&&this.log("[eme] blocking frag load until media-keys acquired"));const l=this.fragPrevious;if(ye(e)&&(!l||e.sn!==l.sn)){const d=this.shouldLoadParts(t.details,e.end);d!==this.loadingParts&&(this.log(`LL-Part loading ${d?"ON":"OFF"} loading sn ${l?.sn}->${e.sn}`),this.loadingParts=d);}if(s=Math.max(e.start,s||0),this.loadingParts&&ye(e)){const d=a.partList;if(d&&i){s>a.fragmentEnd&&a.fragmentHint&&(e=a.fragmentHint);const g=this.getNextPart(d,e,s);if(g>-1){const f=d[g];e=this.fragCurrent=f.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${f.index} (${g}/${d.length-1}) of ${this.fragInfo(e,false,f)}) cc: ${e.cc} [${a.startSN}-${a.endSN}], target: ${parseFloat(s.toFixed(3))}`),this.nextLoadPosition=f.start+f.duration,this.state=C.FRAG_LOADING;let m;return o?m=o.then(p=>!p||this.fragContextChanged(p.frag)?null:this.doFragPartsLoad(e,f,t,i)).catch(p=>this.handleFragLoadError(p)):m=this.doFragPartsLoad(e,f,t,i).catch(p=>this.handleFragLoadError(p)),this.hls.trigger(y.FRAG_LOADING,{frag:e,part:f,targetBufferTime:s}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):m}else if(!e.url||this.loadedEndOfParts(d,s))return Promise.resolve(null)}}if(ye(e)&&this.loadingParts){var c;this.log(`LL-Part loading OFF after next part miss @${s.toFixed(2)} Check buffer at sn: ${e.sn} loaded parts: ${(c=a.partList)==null?void 0:c.filter(d=>d.loaded).map(d=>`[${d.start}-${d.end}]`)}`),this.loadingParts=false;}else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,false)}) cc: ${e.cc} ${"["+a.startSN+"-"+a.endSN+"]"}, target: ${parseFloat(s.toFixed(3))}`),B(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=C.FRAG_LOADING;const h=this.config.progressive&&e.type!==K.SUBTITLE;let u;return h&&o?u=o.then(d=>!d||this.fragContextChanged(d.frag)?null:this.fragmentLoader.load(e,i)).catch(d=>this.handleFragLoadError(d)):u=Promise.all([this.fragmentLoader.load(e,h?i:void 0),o]).then(([d])=>(!h&&i&&i(d),d)).catch(d=>this.handleFragLoadError(d)),this.hls.trigger(y.FRAG_LOADING,{frag:e,targetBufferTime:s}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):u}doFragPartsLoad(e,t,s,i){return new Promise((n,a)=>{var o;const l=[],c=(o=s.details)==null?void 0:o.partList,h=u=>{this.fragmentLoader.loadPart(e,u,i).then(d=>{l[u.index]=d;const g=d.part;this.hls.trigger(y.FRAG_LOADED,d);const f=Ci(s.details,e.sn,u.index+1)||Dn(c,e.sn,u.index+1);if(f)h(f);else return n({frag:e,part:g,partsLoaded:l})}).catch(a);};h(t);})}handleFragLoadError(e){if("data"in e){const t=e.data;t.frag&&t.details===_.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):t.frag&&t.type===G.KEY_SYSTEM_ERROR?(t.frag.abortRequests(),this.resetStartWhenNotLoaded(),this.resetFragmentLoading(t.frag)):this.hls.trigger(y.ERROR,t);}else this.hls.trigger(y.ERROR,{type:G.OTHER_ERROR,details:_.INTERNAL_EXCEPTION,err:e,error:e,fatal:true});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==C.PARSING){!this.fragCurrent&&this.state!==C.STOPPED&&this.state!==C.ERROR&&(this.state=C.IDLE);return}const{frag:s,part:i,level:n}=t,a=self.performance.now();s.stats.parsing.end=a,i&&(i.stats.parsing.end=a);const o=this.getLevelDetails(),c=o&&s.sn>o.endSN||this.shouldLoadParts(o,s.end);c!==this.loadingParts&&(this.log(`LL-Part loading ${c?"ON":"OFF"} after parsing segment ending @${s.end.toFixed(2)}`),this.loadingParts=c),this.updateLevelTiming(s,i,n,e.partial);}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e.partList){var s;const n=e.partList[0];if(n.fragment.type===K.SUBTITLE)return  false;const a=n.end+(((s=e.fragmentHint)==null?void 0:s.duration)||0);if(t>=a){var i;if((this.hls.hasEnoughToStart?((i=this.media)==null?void 0:i.currentTime)||this.lastCurrentTime:this.getLoadPosition())>n.start-n.fragment.duration)return  true}}}return  false}getCurrentContext(e){const{levels:t,fragCurrent:s}=this,{level:i,sn:n,part:a}=e;if(!(t!=null&&t[i]))return this.warn(`Levels object was unset while buffering fragment ${n} of ${this.playlistLabel()} ${i}. The current chunk will not be buffered.`),null;const o=t[i],l=o.details,c=a>-1?Ci(l,n,a):null,h=c?c.fragment:_n(l,n,s);return h?(s&&s!==h&&(h.stats=s.stats),{frag:h,part:c,level:o}):null}bufferFragmentData(e,t,s,i,n){if(this.state!==C.PARSING)return;const{data1:a,data2:o}=e;let l=a;if(o&&(l=Ae(a,o)),!l.length)return;const c=this.initPTS[t.cc],h=c?-c.baseTime/c.timescale:void 0,u={type:e.type,frag:t,part:s,chunkMeta:i,offset:h,parent:t.type,data:l};if(this.hls.trigger(y.BUFFER_APPENDING,u),e.dropped&&e.independent&&!s){if(n)return;this.flushBufferGap(t);}}flushBufferGap(e){const t=this.media;if(!t)return;if(!J.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const s=t.currentTime,i=J.bufferInfo(t,s,0),n=e.duration,a=Math.min(this.config.maxFragLookUpTolerance*2,n*.25),o=Math.max(Math.min(e.start-a,i.end-a),s+a);e.start-o>a&&this.flushMainBuffer(o,e.start);}getFwdBufferInfo(e,t){var s;const i=this.getLoadPosition();if(!B(i))return null;const a=this.lastCurrentTime>i||(s=this.media)!=null&&s.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,i,t,a)}getFwdBufferInfoAtPos(e,t,s,i){const n=J.bufferInfo(e,t,i);if(n.len===0&&n.nextStart!==void 0){const a=this.fragmentTracker.getBufferedFrag(t,s);if(a&&(n.nextStart<=a.end||a.gap)){const o=Math.max(Math.min(n.nextStart,a.end)-t,i);return J.bufferInfo(e,t,o)}}return n}getMaxBufferLength(e){const{config:t}=this;let s;return e?s=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):s=t.maxBufferLength,Math.min(s,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const s=this.config,i=Math.max(Math.min(e-t,s.maxBufferLength),t),n=Math.max(e-t*3,s.maxMaxBufferLength/2,i);return n>=i?(s.maxMaxBufferLength=n,this.warn(`Reduce max buffer length to ${n}s`),true):false}getAppendedFrag(e,t=K.MAIN){const s=this.fragmentTracker?this.fragmentTracker.getAppendedFrag(e,t):null;return s&&"fragment"in s?s.fragment:s}getNextFragment(e,t){const s=t.fragments,i=s.length;if(!i)return null;const{config:n}=this,a=s[0].start,o=n.lowLatencyMode&&!!t.partList;let l=null;if(t.live){const u=n.initialLiveManifestSize;if(i<u)return this.warn(`Not enough fragments to start playback (have: ${i}, need: ${u})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<a){var c;o&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=true),l=this.getInitialLiveFragment(t);const d=this.hls.startPosition,g=this.hls.liveSyncPosition,f=l?(d!==-1&&d>=a?d:g)||l.start:e;this.log(`Setting startPosition to ${f} to match start frag at live edge. mainStart: ${d} liveSyncPosition: ${g} frag.start: ${(c=l)==null?void 0:c.start}`),this.startPosition=this.nextLoadPosition=f;}}else e<=a&&(l=s[0]);if(!l){const u=this.loadingParts?t.partEnd:t.fragmentEnd;l=this.getFragmentAtPosition(e,u,t);}let h=this.filterReplacedPrimary(l,t);if(!h&&l){const u=l.sn-t.startSN;h=this.filterReplacedPrimary(s[u+1]||null,t);}return this.mapToInitFragWhenRequired(h)}isLoopLoading(e,t){const s=this.fragmentTracker.getState(e);return (s===ve.OK||s===ve.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,s,i,n){let a=null;if(e.gap&&(a=this.getNextFragment(this.nextLoadPosition,t),a&&!a.gap&&s.nextStart)){const o=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,s.nextStart,i,0);if(o!==null&&s.len+o.len>=n){const l=a.sn;return this.loopSn!==l&&(this.log(`buffer full after gaps in "${i}" playlist starting at sn: ${l}`),this.loopSn=l),null}}return this.loopSn=void 0,a}get primaryPrefetch(){if(Oi(this.config)){var e;if((e=this.hls.interstitialsManager)==null||(e=e.playingItem)==null?void 0:e.event)return  true}return  false}filterReplacedPrimary(e,t){if(!e)return e;if(Oi(this.config)&&e.type!==K.SUBTITLE){const s=this.hls.interstitialsManager,i=s?.bufferingItem;if(i){const a=i.event;if(a){if(a.appendInPlace||Math.abs(e.start-i.start)>1||i.start===0)return null}else if(e.end<=i.start&&t?.live===false||e.start>i.end&&i.nextEvent&&(i.nextEvent.appendInPlace||e.start-i.end>1))return null}const n=s?.playerQueue;if(n)for(let a=n.length;a--;){const o=n[a].interstitial;if(o.appendInPlace&&e.start>=o.startTime&&e.end<=o.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!e.initSegment.data&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,s){let i=-1,n=false,a=true;for(let o=0,l=e.length;o<l;o++){const c=e[o];if(a=a&&!c.independent,i>-1&&s<c.start)break;const h=c.loaded;h?i=-1:(n||(c.independent||a)&&c.fragment===t)&&(c.fragment!==t&&this.warn(`Need buffer at ${s} but next unloaded part starts at ${c.start}`),i=o),n=h;}return i}loadedEndOfParts(e,t){let s;for(let i=e.length;i--;){if(s=e[i],!s.loaded)return  false;if(t>s.start)return  true}return  false}getInitialLiveFragment(e){const t=e.fragments,s=this.fragPrevious;let i=null;if(s){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${s.programDateTime}`),i=Sa(t,s.endProgramDateTime,this.config.maxFragLookUpTolerance)),!i){const n=s.sn+1;if(n>=e.startSN&&n<=e.endSN){const a=t[n-e.startSN];s.cc===a.cc&&(i=a,this.log(`Live playlist, switching playlist, load frag with next SN: ${i.sn}`));}i||(i=xn(e,s.cc,s.end),i&&this.log(`Live playlist, switching playlist, load frag with same CC: ${i.sn}`));}}else {const n=this.hls.liveSyncPosition;n!==null&&(i=this.getFragmentAtPosition(n,this.bitrateTest?e.fragmentEnd:e.edge,e));}return i}getFragmentAtPosition(e,t,s){const{config:i}=this;let{fragPrevious:n}=this,{fragments:a,endSN:o}=s;const{fragmentHint:l}=s,{maxFragLookUpTolerance:c}=i,h=s.partList,u=!!(this.loadingParts&&h!=null&&h.length&&l);u&&!this.bitrateTest&&h[h.length-1].fragment.sn===l.sn&&(a=a.concat(l),o=l.sn);let d;if(e<t){var g;const m=e<this.lastCurrentTime||e>t-c||(g=this.media)!=null&&g.paused||!this.startFragRequested?0:c;d=ht(n,a,e,m);}else d=a[a.length-1];if(d){const f=d.sn-s.startSN,m=this.fragmentTracker.getState(d);if((m===ve.OK||m===ve.PARTIAL&&d.gap)&&(n=d),n&&d.sn===n.sn&&(!u||h[0].fragment.sn>d.sn||!s.live)&&d.level===n.level){const S=a[f+1];d.sn<o&&this.fragmentTracker.getState(S)!==ve.OK?d=S:d=null;}}return d}alignPlaylists(e,t,s){const i=e.fragments.length;if(!i)return this.warn("No fragments in live playlist"),0;const n=e.fragmentStart,a=!t,o=e.alignedSliding&&B(n);if(a||!o&&!n){eo(s,e);const l=e.fragmentStart;return this.log(`Live playlist sliding: ${l.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${i}`),l}return n}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let s=this.startPosition;s<t&&(s=-1);const i=this.timelineOffset;if(s===-1){const n=this.startTimeOffset!==null,a=n?this.startTimeOffset:e.startTimeOffset;a!==null&&B(a)?(s=t+a,a<0&&(s+=e.edge),s=Math.min(Math.max(t,s),t+e.totalduration),this.log(`Setting startPosition to ${s} for start time offset ${a} found in ${n?"multivariant":"media"} playlist`),this.startPosition=s):e.live?(s=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${s}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=s=0),this.lastCurrentTime=s+i;}this.nextLoadPosition=s+i;}getLoadPosition(){var e;const{media:t}=this;let s=0;return (e=this.hls)!=null&&e.hasEnoughToStart&&t?s=t.currentTime:this.nextLoadPosition>=0&&(s=this.nextLoadPosition),s}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&ye(e)&&e.stats.aborted&&(this.log(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e));}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==C.FRAG_LOADING_WAITING_RETRY)&&(this.state=C.IDLE);}onFragmentOrKeyLoadError(e,t){var s;if(t.chunkMeta&&!t.frag){const S=this.getCurrentContext(t.chunkMeta);S&&(t.frag=S.frag);}const i=t.frag;if(!i||i.type!==e||!this.levels)return;if(this.fragContextChanged(i)){var n;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(n=this.fragCurrent)==null?void 0:n.url}`);return}const a=t.details===_.FRAG_GAP;a&&this.fragmentTracker.fragBuffered(i,true);const o=t.errorAction;if(!o){this.state=C.ERROR;return}const{action:l,flags:c,retryCount:h=0,retryConfig:u}=o,d=!!u,g=d&&l===ce.RetryRequest,f=d&&!o.resolved&&c===me.MoveAllAlternatesMatchingHost,m=(s=this.hls.latestLevelDetails)==null?void 0:s.live;if(!g&&f&&ye(i)&&!i.endList&&m&&!An(t))this.resetFragmentErrors(e),this.treatAsGap(i),o.resolved=true;else if((g||f)&&h<u.maxNumRetry){var p;const S=bs((p=t.response)==null?void 0:p.code),E=Us(u,h);if(this.resetStartWhenNotLoaded(),this.retryDate=self.performance.now()+E,this.state=C.FRAG_LOADING_WAITING_RETRY,o.resolved=true,S){this.log("Waiting for connection (offline)"),this.retryDate=1/0,t.reason="offline";return}this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${h+1}/${u.maxNumRetry} in ${E}ms`);}else if(u)if(this.resetFragmentErrors(e),h<u.maxNumRetry)!a&&l!==ce.RemoveAlternatePermanently&&(o.resolved=true);else {this.warn(`${t.details} reached or exceeded max retry (${h})`);return}else l===ce.SendAlternateToPenaltyBox?this.state=C.WAITING_LEVEL:this.state=C.ERROR;this.tickImmediate();}checkRetryDate(){const e=self.performance.now(),t=this.retryDate,s=t===1/0;(!t||e>=t||s&&!bs(0))&&(s&&this.log("Connection restored (online)"),this.resetStartWhenNotLoaded(),this.state=C.IDLE);}reduceLengthAndFlushBuffer(e){if(this.state===C.PARSING||this.state===C.PARSED){const t=e.frag,s=e.parent,i=this.getFwdBufferInfo(this.mediaBuffer,s),n=i&&i.len>.5;n&&this.reduceMaxBufferLength(i.len,t?.duration||10);const a=!n;return a&&this.warn(`Buffer full error while media.currentTime (${this.getLoadPosition()}) is not buffered, flush ${s} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),a}return  false}resetFragmentErrors(e){e===K.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=false),this.state!==C.STOPPED&&(this.state=C.IDLE);}afterBufferFlushed(e,t,s){if(!e)return;const i=J.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,i,s),this.state===C.ENDED&&this.resetLoadingState();}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==C.STOPPED&&(this.state=C.IDLE);}resetStartWhenNotLoaded(){if(!this.hls.hasEnoughToStart){this.startFragRequested=false;const e=this.levelLastLoaded,t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition;}}resetWhenMissingContext(e){this.log(`Loading context changed while buffering sn ${e.sn} of ${this.playlistLabel()} ${e.level===-1?"<removed>":e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(),this.resetLoadingState();}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,false,true);}updateLevelTiming(e,t,s,i){const n=s.details;if(!n){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((l,c)=>{const h=e.elementaryStreams[c];if(h){const u=h.endPTS-h.startPTS;if(u<=0)return this.warn(`Could not parse fragment ${e.sn} ${c} duration reliably (${u})`),l||false;const d=i?0:Ln(n,e,h.startPTS,h.endPTS,h.startDTS,h.endDTS,this);return this.hls.trigger(y.LEVEL_PTS_UPDATED,{details:n,level:s,drift:d,type:c,frag:e,start:h.startPTS,end:h.endPTS}),true}return l},false)){var o;const l=((o=this.transmuxer)==null?void 0:o.error)===null;if((s.fragmentError===0||l&&(s.fragmentError<2||e.endList))&&this.treatAsGap(e,s),l){const c=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(c.message),this.hls.trigger(y.ERROR,{type:G.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,fatal:false,error:c,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${s.url}"`}),!this.hls)return;this.resetTransmuxer();}}this.state=C.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,false,t)})`),this.hls.trigger(y.FRAG_PARSED,{frag:e,part:t});}playlistLabel(){return this.playlistType===K.MAIN?"level":"track"}fragInfo(e,t=true,s){var i,n;return `${this.playlistLabel()} ${e.level} (${s?"part":"frag"}:[${((i=t&&!s?e.startPTS:(s||e).start)!=null?i:NaN).toFixed(3)}-${((n=t&&!s?e.endPTS:(s||e).end)!=null?n:NaN).toFixed(3)}]${s&&e.type==="main"?"INDEPENDENT="+(s.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=true,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,true);}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset();}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(),this.resetLoadingState());}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`));}get state(){return this._state}}function Oi(r){return !!r.interstitialsController&&r.enableInterstitialPlayback!==false}class so{constructor(){this.chunks=[],this.dataLength=0;}push(e){this.chunks.push(e),this.dataLength+=e.length;}flush(){const{chunks:e,dataLength:t}=this;let s;if(e.length)e.length===1?s=e[0]:s=io(e,t);else return new Uint8Array(0);return this.reset(),s}reset(){this.chunks.length=0,this.dataLength=0;}}function io(r,e){const t=new Uint8Array(e);let s=0;for(let i=0;i<r.length;i++){const n=r[i];t.set(n,s),s+=n.length;}return t}var hs={exports:{}},Fi;function no(){return Fi||(Fi=1,(function(r){var e=Object.prototype.hasOwnProperty,t="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(t=false));function i(l,c,h){this.fn=l,this.context=c,this.once=h||false;}function n(l,c,h,u,d){if(typeof h!="function")throw new TypeError("The listener must be a function");var g=new i(h,u||l,d),f=t?t+c:c;return l._events[f]?l._events[f].fn?l._events[f]=[l._events[f],g]:l._events[f].push(g):(l._events[f]=g,l._eventsCount++),l}function a(l,c){--l._eventsCount===0?l._events=new s:delete l._events[c];}function o(){this._events=new s,this._eventsCount=0;}o.prototype.eventNames=function(){var c=[],h,u;if(this._eventsCount===0)return c;for(u in h=this._events)e.call(h,u)&&c.push(t?u.slice(1):u);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(h)):c},o.prototype.listeners=function(c){var h=t?t+c:c,u=this._events[h];if(!u)return [];if(u.fn)return [u.fn];for(var d=0,g=u.length,f=new Array(g);d<g;d++)f[d]=u[d].fn;return f},o.prototype.listenerCount=function(c){var h=t?t+c:c,u=this._events[h];return u?u.fn?1:u.length:0},o.prototype.emit=function(c,h,u,d,g,f){var m=t?t+c:c;if(!this._events[m])return  false;var p=this._events[m],S=arguments.length,E,T;if(p.fn){switch(p.once&&this.removeListener(c,p.fn,void 0,true),S){case 1:return p.fn.call(p.context),true;case 2:return p.fn.call(p.context,h),true;case 3:return p.fn.call(p.context,h,u),true;case 4:return p.fn.call(p.context,h,u,d),true;case 5:return p.fn.call(p.context,h,u,d,g),true;case 6:return p.fn.call(p.context,h,u,d,g,f),true}for(T=1,E=new Array(S-1);T<S;T++)E[T-1]=arguments[T];p.fn.apply(p.context,E);}else {var A=p.length,I;for(T=0;T<A;T++)switch(p[T].once&&this.removeListener(c,p[T].fn,void 0,true),S){case 1:p[T].fn.call(p[T].context);break;case 2:p[T].fn.call(p[T].context,h);break;case 3:p[T].fn.call(p[T].context,h,u);break;case 4:p[T].fn.call(p[T].context,h,u,d);break;default:if(!E)for(I=1,E=new Array(S-1);I<S;I++)E[I-1]=arguments[I];p[T].fn.apply(p[T].context,E);}}return  true},o.prototype.on=function(c,h,u){return n(this,c,h,u,false)},o.prototype.once=function(c,h,u){return n(this,c,h,u,true)},o.prototype.removeListener=function(c,h,u,d){var g=t?t+c:c;if(!this._events[g])return this;if(!h)return a(this,g),this;var f=this._events[g];if(f.fn)f.fn===h&&(!d||f.once)&&(!u||f.context===u)&&a(this,g);else {for(var m=0,p=[],S=f.length;m<S;m++)(f[m].fn!==h||d&&!f[m].once||u&&f[m].context!==u)&&p.push(f[m]);p.length?this._events[g]=p.length===1?p[0]:p:a(this,g);}return this},o.prototype.removeAllListeners=function(c){var h;return c?(h=t?t+c:c,this._events[h]&&a(this,h)):(this._events=new s,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,r.exports=o;})(hs)),hs.exports}var ro=no(),wn=wr(ro);const jt="1.6.15",ut={};function ao(){return typeof __HLS_WORKER_BUNDLE__=="function"}function oo(){const r=ut[jt];if(r)return r.clientCount++,r;const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e),i={worker:new self.Worker(t),objectURL:t,clientCount:1};return ut[jt]=i,i}function lo(r){const e=ut[r];if(e)return e.clientCount++,e;const t=new self.URL(r,self.location.href).href,i={worker:new self.Worker(t),scriptURL:t,clientCount:1};return ut[r]=i,i}function co(r){const e=ut[r||jt];if(e&&e.clientCount--===1){const{worker:s,objectURL:i}=e;delete ut[r||jt],i&&self.URL.revokeObjectURL(i),s.terminate();}}function On(r,e){return e+10<=r.length&&r[e]===51&&r[e+1]===68&&r[e+2]===73&&r[e+3]<255&&r[e+4]<255&&r[e+6]<128&&r[e+7]<128&&r[e+8]<128&&r[e+9]<128}function Vs(r,e){return e+10<=r.length&&r[e]===73&&r[e+1]===68&&r[e+2]===51&&r[e+3]<255&&r[e+4]<255&&r[e+6]<128&&r[e+7]<128&&r[e+8]<128&&r[e+9]<128}function Jt(r,e){let t=0;return t=(r[e]&127)<<21,t|=(r[e+1]&127)<<14,t|=(r[e+2]&127)<<7,t|=r[e+3]&127,t}function xt(r,e){const t=e;let s=0;for(;Vs(r,e);){s+=10;const i=Jt(r,e+6);s+=i,On(r,e+10)&&(s+=10),e+=s;}if(s>0)return r.subarray(t,t+s)}function ho(r,e,t,s){const i=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],n=e[t+2],a=n>>2&15;if(a>12){const g=new Error(`invalid ADTS sampling index:${a}`);r.emit(y.ERROR,y.ERROR,{type:G.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,fatal:true,error:g,reason:g.message});return}const o=(n>>6&3)+1,l=e[t+3]>>6&3|(n&1)<<2,c="mp4a.40."+o,h=i[a];let u=a;(o===5||o===29)&&(u-=3);const d=[o<<3|(u&14)>>1,(u&1)<<7|l<<3];return re.log(`manifest codec:${s}, parsed codec:${c}, channels:${l}, rate:${h} (ADTS object type:${o} sampling index:${a})`),{config:d,samplerate:h,channelCount:l,codec:c,parsedCodec:c,manifestCodec:s}}function Fn(r,e){return r[e]===255&&(r[e+1]&246)===240}function Mn(r,e){return r[e+1]&1?7:9}function Hs(r,e){return (r[e+3]&3)<<11|r[e+4]<<3|(r[e+5]&224)>>>5}function uo(r,e){return e+5<r.length}function zt(r,e){return e+1<r.length&&Fn(r,e)}function fo(r,e){return uo(r,e)&&Fn(r,e)&&Hs(r,e)<=r.length-e}function go(r,e){if(zt(r,e)){const t=Mn(r,e);if(e+t>=r.length)return  false;const s=Hs(r,e);if(s<=t)return  false;const i=e+s;return i===r.length||zt(r,i)}return  false}function Nn(r,e,t,s,i){if(!r.samplerate){const n=ho(e,t,s,i);if(!n)return;ie(r,n);}}function Bn(r){return 1024*9e4/r}function mo(r,e){const t=Mn(r,e);if(e+t<=r.length){const s=Hs(r,e)-t;if(s>0)return {headerLength:t,frameLength:s}}}function Un(r,e,t,s,i){const n=Bn(r.samplerate),a=s+i*n,o=mo(e,t);let l;if(o){const{frameLength:u,headerLength:d}=o,g=d+u,f=Math.max(0,t+g-e.length);f?(l=new Uint8Array(g-d),l.set(e.subarray(t+d,e.length),0)):l=e.subarray(t+d,t+g);const m={unit:l,pts:a};return f||r.samples.push(m),{sample:m,length:g,missing:f}}const c=e.length-t;return l=new Uint8Array(c),l.set(e.subarray(t,e.length),0),{sample:{unit:l,pts:a},length:c,missing:-1}}function po(r,e){return Vs(r,e)&&Jt(r,e+6)+10<=r.length-e}function yo(r){return r instanceof ArrayBuffer?r:r.byteOffset==0&&r.byteLength==r.buffer.byteLength?r.buffer:new Uint8Array(r).buffer}function us(r,e=0,t=1/0){return So(r,e,t,Uint8Array)}function So(r,e,t,s){const i=Eo(r);let n=1;"BYTES_PER_ELEMENT"in s&&(n=s.BYTES_PER_ELEMENT);const a=To(r)?r.byteOffset:0,o=(a+r.byteLength)/n,l=(a+e)/n,c=Math.floor(Math.max(0,Math.min(l,o))),h=Math.floor(Math.min(c+Math.max(t,0),o));return new s(i,c,h-c)}function Eo(r){return r instanceof ArrayBuffer?r:r.buffer}function To(r){return r&&r.buffer instanceof ArrayBuffer&&r.byteLength!==void 0&&r.byteOffset!==void 0}function xo(r){const e={key:r.type,description:"",data:"",mimeType:null,pictureType:null},t=3;if(r.size<2)return;if(r.data[0]!==t){console.log("Ignore frame with unrecognized character encoding");return}const s=r.data.subarray(1).indexOf(0);if(s===-1)return;const i=Se(us(r.data,1,s)),n=r.data[2+s],a=r.data.subarray(3+s).indexOf(0);if(a===-1)return;const o=Se(us(r.data,3+s,a));let l;return i==="-->"?l=Se(us(r.data,4+s+a)):l=yo(r.data.subarray(4+s+a)),e.mimeType=i,e.pictureType=n,e.description=o,e.data=l,e}function vo(r){if(r.size<2)return;const e=Se(r.data,true),t=new Uint8Array(r.data.subarray(e.length+1));return {key:r.type,info:e,data:t.buffer}}function Ao(r){if(r.size<2)return;if(r.type==="TXXX"){let t=1;const s=Se(r.data.subarray(t),true);t+=s.length+1;const i=Se(r.data.subarray(t));return {key:r.type,info:s,data:i}}const e=Se(r.data.subarray(1));return {key:r.type,info:"",data:e}}function Io(r){if(r.type==="WXXX"){if(r.size<2)return;let t=1;const s=Se(r.data.subarray(t),true);t+=s.length+1;const i=Se(r.data.subarray(t));return {key:r.type,info:s,data:i}}const e=Se(r.data);return {key:r.type,info:"",data:e}}function Ro(r){return r.type==="PRIV"?vo(r):r.type[0]==="W"?Io(r):r.type==="APIC"?xo(r):Ao(r)}function Lo(r){const e=String.fromCharCode(r[0],r[1],r[2],r[3]),t=Jt(r,4),s=10;return {type:e,size:t,data:r.subarray(s,s+t)}}const Dt=10,bo=10;function _o(r){let e=0;const t=[];for(;Vs(r,e);){const s=Jt(r,e+6);r[e+5]>>6&1&&(e+=Dt),e+=Dt;const i=e+s;for(;e+bo<i;){const n=Lo(r.subarray(e)),a=Ro(n);a&&t.push(a),e+=n.size+Dt;}On(r,e)&&(e+=Dt);}return t}function Do(r){return r&&r.key==="PRIV"&&r.info==="com.apple.streaming.transportStreamTimestamp"}function Po(r){if(r.data.byteLength===8){const e=new Uint8Array(r.data),t=e[3]&1;let s=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return s/=45,t&&(s+=4772185884e-2),Math.round(s)}}function Ys(r){const e=_o(r);for(let t=0;t<e.length;t++){const s=e[t];if(Do(s))return Po(s)}}let dt=(function(r){return r.audioId3="org.id3",r.dateRange="com.apple.quicktime.HLS",r.emsg="https://aomedia.org/emsg/ID3",r.misbklv="urn:misb:KLV:bin:1910.1",r})({});function we(r="",e=9e4){return {type:r,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class Ws{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null;}resetInitSegment(e,t,s,i){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0};}resetTimeStamp(e){this.initPTS=e,this.resetContiguity();}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0;}canParse(e,t){return  false}appendFrame(e,t,s){}demux(e,t){this.cachedData&&(e=Ae(this.cachedData,e),this.cachedData=null);let s=xt(e,0),i=s?s.length:0,n;const a=this._audioTrack,o=this._id3Track,l=s?Ys(s):void 0,c=e.length;for((this.basePTS===null||this.frameIndex===0&&B(l))&&(this.basePTS=Co(l,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),s&&s.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:s,type:dt.audioId3,duration:Number.POSITIVE_INFINITY});i<c;){if(this.canParse(e,i)){const h=this.appendFrame(a,e,i);h?(this.frameIndex++,this.lastPTS=h.sample.pts,i+=h.length,n=i):i=c;}else po(e,i)?(s=xt(e,i),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:s,type:dt.audioId3,duration:Number.POSITIVE_INFINITY}),i+=s.length,n=i):i++;if(i===c&&n!==c){const h=e.slice(n);this.cachedData?this.cachedData=Ae(this.cachedData,h):this.cachedData=h;}}return {audioTrack:a,videoTrack:we(),id3Track:o,textTrack:we()}}demuxSampleAes(e,t,s){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:we(),id3Track:this._id3Track,textTrack:we()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0;}}const Co=(r,e,t)=>{if(B(r))return r*90;const s=t?t.baseTime*9e4/t.timescale:0;return e*9e4+s};let Pt=null;const ko=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],wo=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Oo=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],Fo=[0,1,1,4];function $n(r,e,t,s,i){if(t+24>e.length)return;const n=Gn(e,t);if(n&&t+n.frameLength<=e.length){const a=n.samplesPerFrame*9e4/n.sampleRate,o=s+i*a,l={unit:e.subarray(t,t+n.frameLength),pts:o,dts:o};return r.config=[],r.channelCount=n.channelCount,r.samplerate=n.sampleRate,r.samples.push(l),{sample:l,length:n.frameLength,missing:0}}}function Gn(r,e){const t=r[e+1]>>3&3,s=r[e+1]>>1&3,i=r[e+2]>>4&15,n=r[e+2]>>2&3;if(t!==1&&i!==0&&i!==15&&n!==3){const a=r[e+2]>>1&1,o=r[e+3]>>6,l=t===3?3-s:s===3?3:4,c=ko[l*14+i-1]*1e3,u=wo[(t===3?0:t===2?1:2)*3+n],d=o===3?1:2,g=Oo[t][s],f=Fo[s],m=g*8*f,p=Math.floor(g*c/u+a)*f;if(Pt===null){const T=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Pt=T?parseInt(T[1]):0;}return Pt&&Pt<=87&&s===2&&c>=224e3&&o===0&&(r[e+3]=r[e+3]|128),{sampleRate:u,channelCount:d,frameLength:p,samplesPerFrame:m}}}function qs(r,e){return r[e]===255&&(r[e+1]&224)===224&&(r[e+1]&6)!==0}function Kn(r,e){return e+1<r.length&&qs(r,e)}function Mo(r,e){return qs(r,e)&&4<=r.length-e}function Vn(r,e){if(e+1<r.length&&qs(r,e)){const s=Gn(r,e);let i=4;s!=null&&s.frameLength&&(i=s.frameLength);const n=e+i;return n===r.length||Kn(r,n)}return  false}class No extends Ws{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t;}resetInitSegment(e,t,s,i){super.resetInitSegment(e,t,s,i),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0};}static probe(e,t){if(!e)return  false;const s=xt(e,0);let i=s?.length||0;if(Vn(e,i))return  false;for(let n=e.length;i<n;i++)if(go(e,i))return t.log("ADTS sync word found !"),true;return  false}canParse(e,t){return fo(e,t)}appendFrame(e,t,s){Nn(e,this.observer,t,s,e.manifestCodec);const i=Un(e,t,s,this.basePTS,this.frameIndex);if(i&&i.missing===0)return i}}const Hn=(r,e)=>{let t=0,s=5;e+=s;const i=new Uint32Array(1),n=new Uint32Array(1),a=new Uint8Array(1);for(;s>0;){a[0]=r[e];const o=Math.min(s,8),l=8-o;n[0]=4278190080>>>24+l<<l,i[0]=(a[0]&n[0])>>l,t=t?t<<o|i[0]:i[0],e+=1,s-=o;}return t};class Bo extends Ws{constructor(e){super(),this.observer=void 0,this.observer=e;}resetInitSegment(e,t,s,i){super.resetInitSegment(e,t,s,i),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0};}canParse(e,t){return t+64<e.length}appendFrame(e,t,s){const i=Yn(e,t,s,this.basePTS,this.frameIndex);if(i!==-1)return {sample:e.samples[e.samples.length-1],length:i,missing:0}}static probe(e){if(!e)return  false;const t=xt(e,0);if(!t)return  false;const s=t.length;return e[s]===11&&e[s+1]===119&&Ys(t)!==void 0&&Hn(e,s)<16}}function Yn(r,e,t,s,i){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return  -1;const n=e[t+4]>>6;if(n>=3)return  -1;const o=[48e3,44100,32e3][n],l=e[t+4]&63,h=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][l*3+n]*2;if(t+h>e.length)return  -1;const u=e[t+6]>>5;let d=0;u===2?d+=2:(u&1&&u!==1&&(d+=2),u&4&&(d+=2));const g=(e[t+6]<<8|e[t+7])>>12-d&1,m=[2,1,2,3,3,4,4,5][u]+g,p=e[t+5]>>3,S=e[t+5]&7,E=new Uint8Array([n<<6|p<<1|S>>2,(S&3)<<6|u<<3|g<<2|l>>4,l<<4&224]),T=1536/o*9e4,A=s+i*T,I=e.subarray(t,t+h);return r.config=E,r.channelCount=m,r.samplerate=o,r.samples.push({unit:I,pts:A}),h}class Uo extends Ws{resetInitSegment(e,t,s,i){super.resetInitSegment(e,t,s,i),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0};}static probe(e){if(!e)return  false;const t=xt(e,0);let s=t?.length||0;if(t&&e[s]===11&&e[s+1]===119&&Ys(t)!==void 0&&Hn(e,s)<=16)return  false;for(let i=e.length;s<i;s++)if(Vn(e,s))return re.log("MPEG Audio sync word found !"),true;return  false}canParse(e,t){return Mo(e,t)}appendFrame(e,t,s){if(this.basePTS!==null)return $n(e,t,s,this.basePTS,this.frameIndex)}}const $o=/\/emsg[-/]ID3/i;class Go{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t;}resetTimeStamp(){}resetInitSegment(e,t,s,i){const n=this.videoTrack=we("video",1),a=this.audioTrack=we("audio",1),o=this.txtTrack=we("text",1);if(this.id3Track=we("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const l=dn(e);if(l.video){const{id:c,timescale:h,codec:u,supplemental:d}=l.video;n.id=c,n.timescale=o.timescale=h,n.codec=u,n.supplemental=d;}if(l.audio){const{id:c,timescale:h,codec:u}=l.audio;a.id=c,a.timescale=h,a.codec=u;}o.id=cn.text,n.sampleDuration=0,n.duration=a.duration=i;}resetContiguity(){this.remainderData=null;}static probe(e){return Nr(e)}demux(e,t){this.timeOffset=t;let s=e;const i=this.videoTrack,n=this.txtTrack;if(this.config.progressive){this.remainderData&&(s=Ae(this.remainderData,e));const o=Hr(s);this.remainderData=o.remainder,i.samples=o.valid||new Uint8Array;}else i.samples=s;const a=this.extractID3Track(i,t);return n.samples=ui(t,i),{videoTrack:i,audioTrack:this.audioTrack,id3Track:a,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,s=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const i=this.extractID3Track(t,this.timeOffset);return s.samples=ui(e,t),{videoTrack:t,audioTrack:we(),id3Track:i,textTrack:we()}}extractID3Track(e,t){const s=this.id3Track;if(e.samples.length){const i=z(e.samples,["emsg"]);i&&i.forEach(n=>{const a=Wr(n);if($o.test(a.schemeIdUri)){const o=Mi(a,t);let l=a.eventDuration===4294967295?Number.POSITIVE_INFINITY:a.eventDuration/a.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const c=a.payload;s.samples.push({data:c,len:c.byteLength,dts:o,pts:o,type:dt.emsg,duration:l});}else if(this.config.enableEmsgKLVMetadata&&a.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const o=Mi(a,t);s.samples.push({data:a.payload,len:a.payload.byteLength,dts:o,pts:o,type:dt.misbklv,duration:Number.POSITIVE_INFINITY});}});}return s}demuxSampleAes(e,t,s){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0;}}function Mi(r,e){return B(r.presentationTime)?r.presentationTime/r.timeScale:e+r.presentationTimeDelta/r.timeScale}class Ko{constructor(e,t,s){this.keyData=void 0,this.decrypter=void 0,this.keyData=s,this.decrypter=new $s(t,{removePKCS7Padding:false});}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,qe.cbc)}decryptAacSample(e,t,s){const i=e[t].unit;if(i.length<=16)return;const n=i.subarray(16,i.length-i.length%16),a=n.buffer.slice(n.byteOffset,n.byteOffset+n.length);this.decryptBuffer(a).then(o=>{const l=new Uint8Array(o);i.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,s);}).catch(s);}decryptAacSamples(e,t,s){for(;;t++){if(t>=e.length){s();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,s),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,s=new Int8Array(t);let i=0;for(let n=32;n<e.length-16;n+=160,i+=16)s.set(e.subarray(n,n+16),i);return s}getAvcDecryptedUnit(e,t){const s=new Uint8Array(t);let i=0;for(let n=32;n<e.length-16;n+=160,i+=16)e.set(s.subarray(i,i+16),n);return e}decryptAvcSample(e,t,s,i,n){const a=gn(n.data),o=this.getAvcEncryptedData(a);this.decryptBuffer(o.buffer).then(l=>{n.data=this.getAvcDecryptedUnit(a,l),this.decrypter.isSync()||this.decryptAvcSamples(e,t,s+1,i);}).catch(i);}decryptAvcSamples(e,t,s,i){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,s=0){if(t>=e.length){i();return}const n=e[t].units;for(;!(s>=n.length);s++){const a=n[s];if(!(a.data.length<=48||a.type!==1&&a.type!==5)&&(this.decryptAvcSample(e,t,s,i,a),!this.decrypter.isSync()))return}}}}class Wn{constructor(){this.VideoSample=null;}createVideoSample(e,t,s){return {key:e,frame:false,pts:t,dts:s,units:[],length:0}}getLastNalUnit(e){var t;let s=this.VideoSample,i;if((!s||s.units.length===0)&&(s=e[e.length-1]),(t=s)!=null&&t.units){const n=s.units;i=n[n.length-1];}return i}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const s=t.samples,i=s.length;if(i){const n=s[i-1];e.pts=n.pts,e.dts=n.dts;}else {t.dropped++;return}}t.samples.push(e);}}parseNALu(e,t,s){const i=t.byteLength;let n=e.naluState||0;const a=n,o=[];let l=0,c,h,u,d=-1,g=0;for(n===-1&&(d=0,g=this.getNALuType(t,0),n=0,l=1);l<i;){if(c=t[l++],!n){n=c?0:1;continue}if(n===1){n=c?0:2;continue}if(!c)n=3;else if(c===1){if(h=l-n-1,d>=0){const f={data:t.subarray(d,h),type:g};o.push(f);}else {const f=this.getLastNalUnit(e.samples);f&&(a&&l<=4-a&&f.state&&(f.data=f.data.subarray(0,f.data.byteLength-a)),h>0&&(f.data=Ae(f.data,t.subarray(0,h)),f.state=0));}l<i?(u=this.getNALuType(t,l),d=l,g=u,n=0):n=-1;}else n=0;}if(d>=0&&n>=0){const f={data:t.subarray(d,i),type:g,state:n};o.push(f);}if(o.length===0){const f=this.getLastNalUnit(e.samples);f&&(f.data=Ae(f.data,t));}return e.naluState=n,o}}class St{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0;}loadWord(){const e=this.data,t=this.bytesAvailable,s=e.byteLength-t,i=new Uint8Array(4),n=Math.min(4,t);if(n===0)throw new Error("no bytes available");i.set(e.subarray(s,s+n)),this.word=new DataView(i.buffer).getUint32(0),this.bitsAvailable=n*8,this.bytesAvailable-=n;}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e);}readBits(e){let t=Math.min(this.bitsAvailable,e);const s=this.word>>>32-t;if(e>32&&re.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?s<<t|this.readBits(t):s}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if((this.word&2147483648>>>e)!==0)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ());}skipEG(){this.skipBits(1+this.skipLZ());}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class Vo extends Wn{parsePES(e,t,s,i){const n=this.parseNALu(e,s.data,i);let a=this.VideoSample,o,l=false;s.data=null,a&&n.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(false,s.pts,s.dts)),n.forEach(c=>{var h,u;switch(c.type){case 1:{let m=false;o=true;const p=c.data;if(l&&p.length>4){const S=this.readSliceType(p);(S===2||S===4||S===7||S===9)&&(m=true);}if(m){var d;(d=a)!=null&&d.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null);}a||(a=this.VideoSample=this.createVideoSample(true,s.pts,s.dts)),a.frame=true,a.key=m;break}case 5:o=true,(h=a)!=null&&h.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(true,s.pts,s.dts)),a.key=true,a.frame=true;break;case 6:{o=true,Ms(c.data,1,s.pts,t.samples);break}case 7:{var g,f;o=true,l=true;const m=c.data,p=this.readSPS(m);if(!e.sps||e.width!==p.width||e.height!==p.height||((g=e.pixelRatio)==null?void 0:g[0])!==p.pixelRatio[0]||((f=e.pixelRatio)==null?void 0:f[1])!==p.pixelRatio[1]){e.width=p.width,e.height=p.height,e.pixelRatio=p.pixelRatio,e.sps=[m];const S=m.subarray(1,4);let E="avc1.";for(let T=0;T<3;T++){let A=S[T].toString(16);A.length<2&&(A="0"+A),E+=A;}e.codec=E;}break}case 8:o=true,e.pps=[c.data];break;case 9:o=true,e.audFound=true,(u=a)!=null&&u.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(false,s.pts,s.dts));break;case 12:o=true;break;default:o=false;break}a&&o&&a.units.push(c);}),i&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null);}getNALuType(e,t){return e[t]&31}readSliceType(e){const t=new St(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let s=8,i=8,n;for(let a=0;a<e;a++)i!==0&&(n=t.readEG(),i=(s+n+256)%256),s=i===0?s:i;}readSPS(e){const t=new St(e);let s=0,i=0,n=0,a=0,o,l,c;const h=t.readUByte.bind(t),u=t.readBits.bind(t),d=t.readUEG.bind(t),g=t.readBoolean.bind(t),f=t.skipBits.bind(t),m=t.skipEG.bind(t),p=t.skipUEG.bind(t),S=this.skipScalingList.bind(this);h();const E=h();if(u(5),f(3),h(),p(),E===100||E===110||E===122||E===244||E===44||E===83||E===86||E===118||E===128){const L=d();if(L===3&&f(1),p(),p(),f(1),g())for(l=L!==3?8:12,c=0;c<l;c++)g()&&(c<6?S(16,t):S(64,t));}p();const T=d();if(T===0)d();else if(T===1)for(f(1),m(),m(),o=d(),c=0;c<o;c++)m();p(),f(1);const A=d(),I=d(),D=u(1);D===0&&f(1),f(1),g()&&(s=d(),i=d(),n=d(),a=d());let v=[1,1];if(g()&&g())switch(h()){case 1:v=[1,1];break;case 2:v=[12,11];break;case 3:v=[10,11];break;case 4:v=[16,11];break;case 5:v=[40,33];break;case 6:v=[24,11];break;case 7:v=[20,11];break;case 8:v=[32,11];break;case 9:v=[80,33];break;case 10:v=[18,11];break;case 11:v=[15,11];break;case 12:v=[64,33];break;case 13:v=[160,99];break;case 14:v=[4,3];break;case 15:v=[3,2];break;case 16:v=[2,1];break;case 255:{v=[h()<<8|h(),h()<<8|h()];break}}return {width:Math.ceil((A+1)*16-s*2-i*2),height:(2-D)*(I+1)*16-(D?2:4)*(n+a),pixelRatio:v}}}class Ho extends Wn{constructor(...e){super(...e),this.initVPS=null;}parsePES(e,t,s,i){const n=this.parseNALu(e,s.data,i);let a=this.VideoSample,o,l=false;s.data=null,a&&n.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(false,s.pts,s.dts)),n.forEach(c=>{var h,u;switch(c.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:a||(a=this.VideoSample=this.createVideoSample(false,s.pts,s.dts)),a.frame=true,o=true;break;case 16:case 17:case 18:case 21:if(o=true,l){var d;(d=a)!=null&&d.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null);}a||(a=this.VideoSample=this.createVideoSample(true,s.pts,s.dts)),a.key=true,a.frame=true;break;case 19:case 20:o=true,(h=a)!=null&&h.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(true,s.pts,s.dts)),a.key=true,a.frame=true;break;case 39:o=true,Ms(c.data,2,s.pts,t.samples);break;case 32:o=true,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=ie(e.params,this.readVPS(c.data)),this.initVPS=c.data),e.vps=[c.data];break;case 33:if(o=true,l=true,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],c.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const g=this.readSPS(c.data);e.width=g.width,e.height=g.height,e.pixelRatio=g.pixelRatio,e.codec=g.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(const f in g.params)e.params[f]=g.params[f];}this.pushParameterSet(e.sps,c.data,e.vps),a||(a=this.VideoSample=this.createVideoSample(true,s.pts,s.dts)),a.key=true;break;case 34:if(o=true,typeof e.params=="object"){if(!e.pps){e.pps=[];const g=this.readPPS(c.data);for(const f in g)e.params[f]=g[f];}this.pushParameterSet(e.pps,c.data,e.vps);}break;case 35:o=true,e.audFound=true,(u=a)!=null&&u.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(false,s.pts,s.dts));break;default:o=false;break}a&&o&&a.units.push(c);}),i&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null);}pushParameterSet(e,t,s){(s&&s[0]===this.initVPS||!s&&!e.length)&&e.push(t);}getNALuType(e,t){return (e[t]&126)>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let s=0;for(let i=0;i<e.byteLength;i++)i>=2&&e[i]===3&&e[i-1]===0&&e[i-2]===0||(t[s]=e[i],s++);return new Uint8Array(t.buffer,0,s)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null);}readVPS(e){const t=new St(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);const s=t.readBits(3),i=t.readBoolean();return {numTemporalLayers:s+1,temporalIdNested:i}}readSPS(e){const t=new St(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const s=t.readBits(3);t.readBoolean();const i=t.readBits(2),n=t.readBoolean(),a=t.readBits(5),o=t.readUByte(),l=t.readUByte(),c=t.readUByte(),h=t.readUByte(),u=t.readUByte(),d=t.readUByte(),g=t.readUByte(),f=t.readUByte(),m=t.readUByte(),p=t.readUByte(),S=t.readUByte(),E=[],T=[];for(let X=0;X<s;X++)E.push(t.readBoolean()),T.push(t.readBoolean());if(s>0)for(let X=s;X<8;X++)t.readBits(2);for(let X=0;X<s;X++)E[X]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),T[X]&&t.readUByte();t.readUEG();const A=t.readUEG();A==3&&t.skipBits(1);const I=t.readUEG(),D=t.readUEG(),v=t.readBoolean();let L=0,b=0,R=0,P=0;v&&(L+=t.readUEG(),b+=t.readUEG(),R+=t.readUEG(),P+=t.readUEG());const O=t.readUEG(),N=t.readUEG(),U=t.readUEG(),q=t.readBoolean();for(let X=q?0:s;X<=s;X++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let ue=0;ue<4;ue++)for(let Te=0;Te<(ue===3?2:6);Te++)if(!t.readBoolean())t.readUEG();else {const Ie=Math.min(64,1<<4+(ue<<1));ue>1&&t.readEG();for(let st=0;st<Ie;st++)t.readEG();}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const V=t.readUEG();let H=0;for(let X=0;X<V;X++){let ue=false;if(X!==0&&(ue=t.readBoolean()),ue){X===V&&t.readUEG(),t.readBoolean(),t.readUEG();let Te=0;for(let ze=0;ze<=H;ze++){const Ie=t.readBoolean();let st=false;Ie||(st=t.readBoolean()),(Ie||st)&&Te++;}H=Te;}else {const Te=t.readUEG(),ze=t.readUEG();H=Te+ze;for(let Ie=0;Ie<Te;Ie++)t.readUEG(),t.readBoolean();for(let Ie=0;Ie<ze;Ie++)t.readUEG(),t.readBoolean();}}if(t.readBoolean()){const X=t.readUEG();for(let ue=0;ue<X;ue++){for(let Te=0;Te<U+4;Te++)t.readBits(1);t.readBits(1);}}let w=0,k=1,W=1,Z=true,j=1,Q=0;t.readBoolean(),t.readBoolean();let he=false;if(t.readBoolean()){if(t.readBoolean()){const Qe=t.readUByte(),ei=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],It=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];Qe>0&&Qe<16?(k=ei[Qe-1],W=It[Qe-1]):Qe===255&&(k=t.readBits(16),W=t.readBits(16));}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),he=t.readBoolean(),he&&(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG()),t.readBoolean()&&(j=t.readBits(32),Q=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){const It=t.readBoolean(),ti=t.readBoolean();let ft=false;(It||ti)&&(ft=t.readBoolean(),ft&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),ft&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let si=0;si<=s;si++){Z=t.readBoolean();const vr=Z||t.readBoolean();let ii=false;vr?t.readEG():ii=t.readBoolean();const ni=ii?1:t.readUEG()+1;if(It)for(let gt=0;gt<ni;gt++)t.readUEG(),t.readUEG(),ft&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(ti)for(let gt=0;gt<ni;gt++)t.readUEG(),t.readUEG(),ft&&(t.readUEG(),t.readUEG()),t.skipBits(1);}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),w=t.readUEG());}let Ee=I,_e=D;if(v){let X=1,ue=1;A===1?X=ue=2:A==2&&(X=2),Ee=I-X*b-X*L,_e=D-ue*P-ue*R;}const je=i?["A","B","C"][i]:"",xr=o<<24|l<<16|c<<8|h;let ts=0;for(let X=0;X<32;X++)ts=(ts|(xr>>X&1)<<31-X)>>>0;let ss=ts.toString(16);return a===1&&ss==="2"&&(ss="6"),{codecString:`hvc1.${je}${a}.${ss}.${n?"H":"L"}${S}.B0`,params:{general_tier_flag:n,general_profile_idc:a,general_profile_space:i,general_profile_compatibility_flags:[o,l,c,h],general_constraint_indicator_flags:[u,d,g,f,m,p],general_level_idc:S,bit_depth:O+8,bit_depth_luma_minus8:O,bit_depth_chroma_minus8:N,min_spatial_segmentation_idc:w,chroma_format_idc:A,frame_rate:{fixed:Z,fps:Q/j}},width:Ee,height:_e,pixelRatio:[k,W]}}readPPS(e){const t=new St(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const i=t.readBoolean(),n=t.readBoolean();let a=1;return n&&i?a=0:n?a=3:i&&(a=2),{parallelismType:a}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const oe=188;class Ye{constructor(e,t,s,i){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=false,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=s,this.logger=i,this.videoParser=null;}static probe(e,t){const s=Ye.syncOffset(e);return s>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${s}`),s!==-1}static syncOffset(e){const t=e.length;let s=Math.min(oe*5,t-oe)+1,i=0;for(;i<s;){let n=false,a=-1,o=0;for(let l=i;l<t;l+=oe)if(e[l]===71&&(t-l===oe||e[l+oe]===71)){if(o++,a===-1&&(a=l,a!==0&&(s=Math.min(a+oe*99,e.length-oe)+1)),n||(n=Ds(e,l)===0),n&&o>1&&(a===0&&o>2||l+oe>s))return a}else {if(o)return  -1;break}i++;}return  -1}static createTrack(e,t){return {container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:cn[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,s,i){this.pmtParsed=false,this._pmtId=-1,this._videoTrack=Ye.createTrack("video"),this._videoTrack.duration=i,this._audioTrack=Ye.createTrack("audio",i),this._id3Track=Ye.createTrack("id3"),this._txtTrack=Ye.createTrack("text"),this._audioTrack.segmentCodec="aac",this.videoParser=null,this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=s;}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:s}=this;e&&(e.pesData=null),t&&(t.pesData=null),s&&(s.pesData=null),this.aacOverFlow=null,this.remainderData=null;}demux(e,t,s=false,i=false){s||(this.sampleAes=null);let n;const a=this._videoTrack,o=this._audioTrack,l=this._id3Track,c=this._txtTrack;let h=a.pid,u=a.pesData,d=o.pid,g=l.pid,f=o.pesData,m=l.pesData,p=null,S=this.pmtParsed,E=this._pmtId,T=e.length;if(this.remainderData&&(e=Ae(this.remainderData,e),T=e.length,this.remainderData=null),T<oe&&!i)return this.remainderData=e,{audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};const A=Math.max(0,Ye.syncOffset(e));T-=(T-A)%oe,T<e.byteLength&&!i&&(this.remainderData=new Uint8Array(e.buffer,T,e.buffer.byteLength-T));let I=0;for(let v=A;v<T;v+=oe)if(e[v]===71){const L=!!(e[v+1]&64),b=Ds(e,v),R=(e[v+3]&48)>>4;let P;if(R>1){if(P=v+5+e[v+4],P===v+oe)continue}else P=v+4;switch(b){case h:L&&(u&&(n=nt(u,this.logger))&&(this.readyVideoParser(a.segmentCodec),this.videoParser!==null&&this.videoParser.parsePES(a,c,n,false)),u={data:[],size:0}),u&&(u.data.push(e.subarray(P,v+oe)),u.size+=v+oe-P);break;case d:if(L){if(f&&(n=nt(f,this.logger)))switch(o.segmentCodec){case "aac":this.parseAACPES(o,n);break;case "mp3":this.parseMPEGPES(o,n);break;case "ac3":this.parseAC3PES(o,n);break}f={data:[],size:0};}f&&(f.data.push(e.subarray(P,v+oe)),f.size+=v+oe-P);break;case g:L&&(m&&(n=nt(m,this.logger))&&this.parseID3PES(l,n),m={data:[],size:0}),m&&(m.data.push(e.subarray(P,v+oe)),m.size+=v+oe-P);break;case 0:L&&(P+=e[P]+1),E=this._pmtId=Yo(e,P);break;case E:{L&&(P+=e[P]+1);const O=Wo(e,P,this.typeSupported,s,this.observer,this.logger);h=O.videoPid,h>0&&(a.pid=h,a.segmentCodec=O.segmentVideoCodec),d=O.audioPid,d>0&&(o.pid=d,o.segmentCodec=O.segmentAudioCodec),g=O.id3Pid,g>0&&(l.pid=g),p!==null&&!S&&(this.logger.warn(`MPEG-TS PMT found at ${v} after unknown PID '${p}'. Backtracking to sync byte @${A} to parse all TS packets.`),p=null,v=A-188),S=this.pmtParsed=true;break}case 17:case 8191:break;default:p=b;break}}else I++;I>0&&Ps(this.observer,new Error(`Found ${I} TS packet/s that do not start with 0x47`),void 0,this.logger),a.pesData=u,o.pesData=f,l.pesData=m;const D={audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};return i&&this.extractRemainingSamples(D),D}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,false,true):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:s,id3Track:i,textTrack:n}=e,a=s.pesData,o=t.pesData,l=i.pesData;let c;if(a&&(c=nt(a,this.logger))?(this.readyVideoParser(s.segmentCodec),this.videoParser!==null&&(this.videoParser.parsePES(s,n,c,true),s.pesData=null)):s.pesData=a,o&&(c=nt(o,this.logger))){switch(t.segmentCodec){case "aac":this.parseAACPES(t,c);break;case "mp3":this.parseMPEGPES(t,c);break;case "ac3":this.parseAC3PES(t,c);break}t.pesData=null;}else o!=null&&o.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=o;l&&(c=nt(l,this.logger))?(this.parseID3PES(i,c),i.pesData=null):i.pesData=l;}demuxSampleAes(e,t,s){const i=this.demux(e,s,true,!this.config.progressive),n=this.sampleAes=new Ko(this.observer,this.config,t);return this.decrypt(i,n)}readyVideoParser(e){this.videoParser===null&&(e==="avc"?this.videoParser=new Vo:e==="hevc"&&(this.videoParser=new Ho));}decrypt(e,t){return new Promise(s=>{const{audioTrack:i,videoTrack:n}=e;i.samples&&i.segmentCodec==="aac"?t.decryptAacSamples(i.samples,0,()=>{n.samples?t.decryptAvcSamples(n.samples,0,0,()=>{s(e);}):s(e);}):n.samples&&t.decryptAvcSamples(n.samples,0,0,()=>{s(e);});})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0;}parseAACPES(e,t){let s=0;const i=this.aacOverFlow;let n=t.data;if(i){this.aacOverFlow=null;const u=i.missing,d=i.sample.unit.byteLength;if(u===-1)n=Ae(i.sample.unit,n);else {const g=d-u;i.sample.unit.set(n.subarray(0,u),g),e.samples.push(i.sample),s=i.missing;}}let a,o;for(a=s,o=n.length;a<o-1&&!zt(n,a);a++);if(a!==s){let u;const d=a<o-1;if(d?u=`AAC PES did not start with ADTS header,offset:${a}`:u="No ADTS header found in AAC PES",Ps(this.observer,new Error(u),d,this.logger),!d)return}Nn(e,this.observer,n,a,this.audioCodec);let l;if(t.pts!==void 0)l=t.pts;else if(i){const u=Bn(e.samplerate);l=i.sample.pts+u;}else {this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let c=0,h;for(;a<o;)if(h=Un(e,n,a,l,c),a+=h.length,h.missing){this.aacOverFlow=h;break}else for(c++;a<o-1&&!zt(n,a);a++);}parseMPEGPES(e,t){const s=t.data,i=s.length;let n=0,a=0;const o=t.pts;if(o===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;a<i;)if(Kn(s,a)){const l=$n(e,s,a,o,n);if(l)a+=l.length,n++;else break}else a++;}parseAC3PES(e,t){{const s=t.data,i=t.pts;if(i===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const n=s.length;let a=0,o=0,l;for(;o<n&&(l=Yn(e,s,o,i,a++))>0;)o+=l;}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const s=ie({},t,{type:this._videoTrack?dt.emsg:dt.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(s);}}function Ds(r,e){return ((r[e+1]&31)<<8)+r[e+2]}function Yo(r,e){return (r[e+10]&31)<<8|r[e+11]}function Wo(r,e,t,s,i,n){const a={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},o=(r[e+1]&15)<<8|r[e+2],l=e+3+o-4,c=(r[e+10]&15)<<8|r[e+11];for(e+=12+c;e<l;){const h=Ds(r,e),u=(r[e+3]&15)<<8|r[e+4];switch(r[e]){case 207:if(!s){ds("ADTS AAC",n);break}case 15:a.audioPid===-1&&(a.audioPid=h);break;case 21:a.id3Pid===-1&&(a.id3Pid=h);break;case 219:if(!s){ds("H.264",n);break}case 27:a.videoPid===-1&&(a.videoPid=h);break;case 3:case 4:!t.mpeg&&!t.mp3?n.log("MPEG audio found, not supported in this browser"):a.audioPid===-1&&(a.audioPid=h,a.segmentAudioCodec="mp3");break;case 193:if(!s){ds("AC-3",n);break}case 129:t.ac3?a.audioPid===-1&&(a.audioPid=h,a.segmentAudioCodec="ac3"):n.log("AC-3 audio found, not supported in this browser");break;case 6:if(a.audioPid===-1&&u>0){let d=e+5,g=u;for(;g>2;){r[d]===106&&(t.ac3!==true?n.log("AC-3 audio found, not supported in this browser for now"):(a.audioPid=h,a.segmentAudioCodec="ac3"));const m=r[d+1]+2;d+=m,g-=m;}}break;case 194:case 135:return Ps(i,new Error("Unsupported EC-3 in M2TS found"),void 0,n),a;case 36:a.videoPid===-1&&(a.videoPid=h,a.segmentVideoCodec="hevc",n.log("HEVC in M2TS found"));break}e+=u+5;}return a}function Ps(r,e,t,s){s.warn(`parsing error: ${e.message}`),r.emit(y.ERROR,y.ERROR,{type:G.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,fatal:false,levelRetry:t,error:e,reason:e.message});}function ds(r,e){e.log(`${r} with AES-128-CBC encryption found in unencrypted stream`);}function nt(r,e){let t=0,s,i,n,a,o;const l=r.data;if(!r||r.size===0)return null;for(;l[0].length<19&&l.length>1;)l[0]=Ae(l[0],l[1]),l.splice(1,1);if(s=l[0],(s[0]<<16)+(s[1]<<8)+s[2]===1){if(i=(s[4]<<8)+s[5],i&&i>r.size-6)return null;const h=s[7];h&192&&(a=(s[9]&14)*536870912+(s[10]&255)*4194304+(s[11]&254)*16384+(s[12]&255)*128+(s[13]&254)/2,h&64?(o=(s[14]&14)*536870912+(s[15]&255)*4194304+(s[16]&254)*16384+(s[17]&255)*128+(s[18]&254)/2,a-o>60*9e4&&(e.warn(`${Math.round((a-o)/9e4)}s delta between PTS and DTS, align them`),a=o)):o=a),n=s[8];let u=n+9;if(r.size<=u)return null;r.size-=u;const d=new Uint8Array(r.size);for(let g=0,f=l.length;g<f;g++){s=l[g];let m=s.byteLength;if(u)if(u>m){u-=m;continue}else s=s.subarray(u),m-=u,u=0;d.set(s,t),t+=m;}return i&&(i-=n+3),{data:d,pts:a,dts:o,len:i}}return null}class qo{static getSilentFrame(e,t){switch(e){case "mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const Ke=Math.pow(2,32)-1;class x{static init(){x.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in x.types)x.types.hasOwnProperty(e)&&(x.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),s=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);x.HDLR_TYPES={video:t,audio:s};const i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),n=new Uint8Array([0,0,0,0,0,0,0,0]);x.STTS=x.STSC=x.STCO=n,x.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),x.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),x.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),x.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const a=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);x.FTYP=x.box(x.types.ftyp,a,l,a,o),x.DINF=x.box(x.types.dinf,x.box(x.types.dref,i));}static box(e,...t){let s=8,i=t.length;const n=i;for(;i--;)s+=t[i].byteLength;const a=new Uint8Array(s);for(a[0]=s>>24&255,a[1]=s>>16&255,a[2]=s>>8&255,a[3]=s&255,a.set(e,4),i=0,s=8;i<n;i++)a.set(t[i],s),s+=t[i].byteLength;return a}static hdlr(e){return x.box(x.types.hdlr,x.HDLR_TYPES[e])}static mdat(e){return x.box(x.types.mdat,e)}static mdhd(e,t){t*=e;const s=Math.floor(t/(Ke+1)),i=Math.floor(t%(Ke+1));return x.box(x.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,s>>24,s>>16&255,s>>8&255,s&255,i>>24,i>>16&255,i>>8&255,i&255,85,196,0,0]))}static mdia(e){return x.box(x.types.mdia,x.mdhd(e.timescale||0,e.duration||0),x.hdlr(e.type),x.minf(e))}static mfhd(e){return x.box(x.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?x.box(x.types.minf,x.box(x.types.smhd,x.SMHD),x.DINF,x.stbl(e)):x.box(x.types.minf,x.box(x.types.vmhd,x.VMHD),x.DINF,x.stbl(e))}static moof(e,t,s){return x.box(x.types.moof,x.mfhd(e),x.traf(s,t))}static moov(e){let t=e.length;const s=[];for(;t--;)s[t]=x.trak(e[t]);return x.box.apply(null,[x.types.moov,x.mvhd(e[0].timescale||0,e[0].duration||0)].concat(s).concat(x.mvex(e)))}static mvex(e){let t=e.length;const s=[];for(;t--;)s[t]=x.trex(e[t]);return x.box.apply(null,[x.types.mvex,...s])}static mvhd(e,t){t*=e;const s=Math.floor(t/(Ke+1)),i=Math.floor(t%(Ke+1)),n=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,s>>24,s>>16&255,s>>8&255,s&255,i>>24,i>>16&255,i>>8&255,i&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return x.box(x.types.mvhd,n)}static sdtp(e){const t=e.samples||[],s=new Uint8Array(4+t.length);let i,n;for(i=0;i<t.length;i++)n=t[i].flags,s[i+4]=n.dependsOn<<4|n.isDependedOn<<2|n.hasRedundancy;return x.box(x.types.sdtp,s)}static stbl(e){return x.box(x.types.stbl,x.stsd(e),x.box(x.types.stts,x.STTS),x.box(x.types.stsc,x.STSC),x.box(x.types.stsz,x.STSZ),x.box(x.types.stco,x.STCO))}static avc1(e){let t=[],s=[],i,n,a;for(i=0;i<e.sps.length;i++)n=e.sps[i],a=n.byteLength,t.push(a>>>8&255),t.push(a&255),t=t.concat(Array.prototype.slice.call(n));for(i=0;i<e.pps.length;i++)n=e.pps[i],a=n.byteLength,s.push(a>>>8&255),s.push(a&255),s=s.concat(Array.prototype.slice.call(n));const o=x.box(x.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(s))),l=e.width,c=e.height,h=e.pixelRatio[0],u=e.pixelRatio[1];return x.box(x.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,c>>8&255,c&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,x.box(x.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),x.box(x.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,h&255,u>>24,u>>16&255,u>>8&255,u&255])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return x.box(x.types.mp4a,x.audioStsd(e),x.box(x.types.esds,x.esds(e)))}static mp3(e){return x.box(x.types[".mp3"],x.audioStsd(e))}static ac3(e){return x.box(x.types["ac-3"],x.audioStsd(e),x.box(x.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if(e.type==="audio"){if(t==="aac")return x.box(x.types.stsd,x.STSD,x.mp4a(e));if(t==="ac3"&&e.config)return x.box(x.types.stsd,x.STSD,x.ac3(e));if(t==="mp3"&&e.codec==="mp3")return x.box(x.types.stsd,x.STSD,x.mp3(e))}else if(e.pps&&e.sps){if(t==="avc")return x.box(x.types.stsd,x.STSD,x.avc1(e));if(t==="hevc"&&e.vps)return x.box(x.types.stsd,x.STSD,x.hvc1(e))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,s=(e.duration||0)*(e.timescale||0),i=e.width||0,n=e.height||0,a=Math.floor(s/(Ke+1)),o=Math.floor(s%(Ke+1));return x.box(x.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,a>>24,a>>16&255,a>>8&255,a&255,o>>24,o>>16&255,o>>8&255,o&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,i&255,0,0,n>>8&255,n&255,0,0]))}static traf(e,t){const s=x.sdtp(e),i=e.id,n=Math.floor(t/(Ke+1)),a=Math.floor(t%(Ke+1));return x.box(x.types.traf,x.box(x.types.tfhd,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,i&255])),x.box(x.types.tfdt,new Uint8Array([1,0,0,0,n>>24,n>>16&255,n>>8&255,n&255,a>>24,a>>16&255,a>>8&255,a&255])),x.trun(e,s.length+16+20+8+16+8+8),s)}static trak(e){return e.duration=e.duration||4294967295,x.box(x.types.trak,x.tkhd(e),x.mdia(e))}static trex(e){const t=e.id;return x.box(x.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const s=e.samples||[],i=s.length,n=12+16*i,a=new Uint8Array(n);let o,l,c,h,u,d;for(t+=8+n,a.set([e.type==="video"?1:0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,i&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),o=0;o<i;o++)l=s[o],c=l.duration,h=l.size,u=l.flags,d=l.cts,a.set([c>>>24&255,c>>>16&255,c>>>8&255,c&255,h>>>24&255,h>>>16&255,h>>>8&255,h&255,u.isLeading<<2|u.dependsOn,u.isDependedOn<<6|u.hasRedundancy<<4|u.paddingValue<<1|u.isNonSync,u.degradPrio&61440,u.degradPrio&15,d>>>24&255,d>>>16&255,d>>>8&255,d&255],12+16*o);return x.box(x.types.trun,a)}static initSegment(e){x.types||x.init();const t=x.moov(e);return Ae(x.FTYP,t)}static hvc1(e){const t=e.params,s=[e.vps,e.sps,e.pps],i=4,n=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),i-1|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),s.length]);let a=n.length;for(let f=0;f<s.length;f+=1){a+=3;for(let m=0;m<s[f].length;m+=1)a+=2+s[f][m].length;}const o=new Uint8Array(a);o.set(n,0),a=n.length;const l=s.length-1;for(let f=0;f<s.length;f+=1){o.set(new Uint8Array([32+f|(f===l?128:0),0,s[f].length]),a),a+=3;for(let m=0;m<s[f].length;m+=1)o.set(new Uint8Array([s[f][m].length>>8,s[f][m].length&255]),a),a+=2,o.set(s[f][m],a),a+=s[f][m].length;}const c=x.box(x.types.hvcC,o),h=e.width,u=e.height,d=e.pixelRatio[0],g=e.pixelRatio[1];return x.box(x.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,h>>8&255,h&255,u>>8&255,u&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),c,x.box(x.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),x.box(x.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,d&255,g>>24,g>>16&255,g>>8&255,g&255])))}}x.types=void 0;x.HDLR_TYPES=void 0;x.STTS=void 0;x.STSC=void 0;x.STCO=void 0;x.STSZ=void 0;x.VMHD=void 0;x.SMHD=void 0;x.STSD=void 0;x.FTYP=void 0;x.DINF=void 0;const qn=9e4;function js(r,e,t=1,s=false){const i=r*e*t;return s?Math.round(i):i}function jo(r,e,t=1,s=false){return js(r,e,1/t,s)}function mt(r,e=false){return js(r,1e3,1/qn,e)}function zo(r,e=1){return js(r,qn,1/e)}function Ni(r){const{baseTime:e,timescale:t,trackId:s}=r;return `${e/t} (${e}/${t}) trackId: ${s}`}const Qo=10*1e3,Xo=1024,Zo=1152,Jo=1536;let rt=null,fs=null;function Bi(r,e,t,s){return {duration:e,size:t,cts:s,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:r?2:1,isNonSync:r?0:1}}}class Ut extends be{constructor(e,t,s,i){if(super("mp4-remuxer",i),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=false,this._initPTS=null,this._initDTS=null,this.nextVideoTs=null,this.nextAudioTs=null,this.videoSampleDuration=null,this.isAudioContiguous=false,this.isVideoContiguous=false,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=s,this.ISGenerated=false,rt===null){const a=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);rt=a?parseInt(a[1]):0;}if(fs===null){const n=navigator.userAgent.match(/Safari\/(\d+)/i);fs=n?parseInt(n[1]):0;}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null;}resetTimeStamp(e){const t=this._initPTS;(!t||!e||e.trackId!==t.trackId||e.baseTime!==t.baseTime||e.timescale!==t.timescale)&&this.log(`Reset initPTS: ${t&&Ni(t)} > ${e&&Ni(e)}`),this._initPTS=this._initDTS=e;}resetNextTimestamp(){this.log("reset next timestamp"),this.isVideoContiguous=false,this.isAudioContiguous=false;}resetInitSegment(){this.log("ISGenerated flag reset"),this.ISGenerated=false,this.videoTrackConfig=void 0;}getVideoStartPts(e){let t=false;const s=e[0].pts,i=e.reduce((n,a)=>{let o=a.pts,l=o-n;return l<-4294967296&&(t=true,o=pe(o,s),l=o-n),l>0?n:o},s);return t&&this.debug("PTS rollover detected"),i}remux(e,t,s,i,n,a,o,l){let c,h,u,d,g,f,m=n,p=n;const S=e.pid>-1,E=t.pid>-1,T=t.samples.length,A=e.samples.length>0,I=o&&T>0||T>1;if((!S||A)&&(!E||I)||this.ISGenerated||o){if(this.ISGenerated){var v,L,b,R;const U=this.videoTrackConfig;(U&&(t.width!==U.width||t.height!==U.height||((v=t.pixelRatio)==null?void 0:v[0])!==((L=U.pixelRatio)==null?void 0:L[0])||((b=t.pixelRatio)==null?void 0:b[1])!==((R=U.pixelRatio)==null?void 0:R[1]))||!U&&I||this.nextAudioTs===null&&A)&&this.resetInitSegment();}this.ISGenerated||(u=this.generateIS(e,t,n,a));const P=this.isVideoContiguous;let O=-1,N;if(I&&(O=el(t.samples),!P&&this.config.forceKeyFrameOnDiscontinuity))if(f=true,O>0){this.warn(`Dropped ${O} out of ${T} video samples due to a missing keyframe`);const U=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(O),t.dropped+=O,p+=(t.samples[0].pts-U)/t.inputTimeScale,N=p;}else O===-1&&(this.warn(`No keyframe found out of ${T} video samples`),f=false);if(this.ISGenerated){if(A&&I){const U=this.getVideoStartPts(t.samples),M=(pe(e.samples[0].pts,U)-U)/t.inputTimeScale;m+=Math.max(0,M),p+=Math.max(0,-M);}if(A){if(e.samplerate||(this.warn("regenerate InitSegment as audio detected"),u=this.generateIS(e,t,n,a)),h=this.remuxAudio(e,m,this.isAudioContiguous,a,E||I||l===K.AUDIO?p:void 0),I){const U=h?h.endPTS-h.startPTS:0;t.inputTimeScale||(this.warn("regenerate InitSegment as video detected"),u=this.generateIS(e,t,n,a)),c=this.remuxVideo(t,p,P,U);}}else I&&(c=this.remuxVideo(t,p,P,0));c&&(c.firstKeyFrame=O,c.independent=O!==-1,c.firstKeyFramePTS=N);}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(s.samples.length&&(g=jn(s,n,this._initPTS,this._initDTS)),i.samples.length&&(d=zn(i,n,this._initPTS))),{audio:h,video:c,initSegment:u,independent:f,text:d,id3:g}}computeInitPts(e,t,s,i){const n=Math.round(s*t);let a=pe(e,n);if(a<n+t)for(this.log(`Adjusting PTS for rollover in timeline near ${(n-a)/t} ${i}`);a<n+t;)a+=8589934592;return a-n}generateIS(e,t,s,i){const n=e.samples,a=t.samples,o=this.typeSupported,l={},c=this._initPTS;let h=!c||i,u="audio/mp4",d,g,f,m=-1;if(h&&(d=g=1/0),e.config&&n.length){switch(e.timescale=e.samplerate,e.segmentCodec){case "mp3":o.mpeg?(u="audio/mpeg",e.codec=""):o.mp3&&(e.codec="mp3");break;case "ac3":e.codec="ac-3";break}l.audio={id:"audio",container:u,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&o.mpeg?new Uint8Array(0):x.initSegment([e]),metadata:{channelCount:e.channelCount}},h&&(m=e.id,f=e.inputTimeScale,!c||f!==c.timescale?d=g=this.computeInitPts(n[0].pts,f,s,"audio"):h=false);}if(t.sps&&t.pps&&a.length){if(t.timescale=t.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:x.initSegment([t]),metadata:{width:t.width,height:t.height}},h)if(m=t.id,f=t.inputTimeScale,!c||f!==c.timescale){const p=this.getVideoStartPts(a),S=pe(a[0].dts,p),E=this.computeInitPts(S,f,s,"video"),T=this.computeInitPts(p,f,s,"video");g=Math.min(g,E),d=Math.min(d,T);}else h=false;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio};}if(Object.keys(l).length)return this.ISGenerated=true,h?(c&&this.warn(`Timestamps at playlist time: ${i?"":"~"}${s} ${d/f} != initPTS: ${c.baseTime/c.timescale} (${c.baseTime}/${c.timescale}) trackId: ${c.trackId}`),this.log(`Found initPTS at playlist time: ${s} offset: ${d/f} (${d}/${f}) trackId: ${m}`),this._initPTS={baseTime:d,timescale:f,trackId:m},this._initDTS={baseTime:g,timescale:f,trackId:m}):d=f=void 0,{tracks:l,initPTS:d,timescale:f,trackId:m}}remuxVideo(e,t,s,i){const n=e.inputTimeScale,a=e.samples,o=[],l=a.length,c=this._initPTS,h=c.baseTime*n/c.timescale;let u=this.nextVideoTs,d=8,g=this.videoSampleDuration,f,m,p=Number.POSITIVE_INFINITY,S=Number.NEGATIVE_INFINITY,E=false;if(!s||u===null){const w=h+t*n,k=a[0].pts-pe(a[0].dts,a[0].pts);rt&&u!==null&&Math.abs(w-k-(u+h))<15e3?s=true:u=w-k-h;}const T=u+h;for(let w=0;w<l;w++){const k=a[w];k.pts=pe(k.pts,T),k.dts=pe(k.dts,T),k.dts<a[w>0?w-1:w].dts&&(E=true);}E&&a.sort(function(w,k){const W=w.dts-k.dts,Z=w.pts-k.pts;return W||Z}),f=a[0].dts,m=a[a.length-1].dts;const A=m-f,I=A?Math.round(A/(l-1)):g||e.inputTimeScale/30;if(s){const w=f-T,k=w>I,W=w<-1;if((k||W)&&(k?this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${mt(w,true)} ms (${w}dts) hole between fragments detected at ${t.toFixed(3)}`):this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${mt(-w,true)} ms (${w}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!W||T>=a[0].pts||rt)){f=T;const Z=a[0].pts-w;if(k)a[0].dts=f,a[0].pts=Z;else {let j=true;for(let Q=0;Q<a.length&&!(a[Q].dts>Z&&j);Q++){const he=a[Q].pts;if(a[Q].dts-=w,a[Q].pts-=w,Q<a.length-1){const le=a[Q+1].pts,Ee=a[Q].pts,_e=le<=Ee,je=le<=he;j=_e==je;}}}this.log(`Video: Initial PTS/DTS adjusted: ${mt(Z,true)}/${mt(f,true)}, delta: ${mt(w,true)} ms`);}}f=Math.max(0,f);let D=0,v=0,L=f;for(let w=0;w<l;w++){const k=a[w],W=k.units,Z=W.length;let j=0;for(let Q=0;Q<Z;Q++)j+=W[Q].data.length;v+=j,D+=Z,k.length=j,k.dts<L?(k.dts=L,L+=I/4|0||1):L=k.dts,p=Math.min(k.pts,p),S=Math.max(k.pts,S);}m=a[l-1].dts;const b=v+4*D+8;let R;try{R=new Uint8Array(b);}catch(w){this.observer.emit(y.ERROR,y.ERROR,{type:G.MUX_ERROR,details:_.REMUX_ALLOC_ERROR,fatal:false,error:w,bytes:b,reason:`fail allocating video mdat ${b}`});return}const P=new DataView(R.buffer);P.setUint32(0,b),R.set(x.types.mdat,4);let O=false,N=Number.POSITIVE_INFINITY,U=Number.POSITIVE_INFINITY,q=Number.NEGATIVE_INFINITY,M=Number.NEGATIVE_INFINITY;for(let w=0;w<l;w++){const k=a[w],W=k.units;let Z=0;for(let he=0,le=W.length;he<le;he++){const Ee=W[he],_e=Ee.data,je=Ee.data.byteLength;P.setUint32(d,je),d+=4,R.set(_e,d),d+=je,Z+=4+je;}let j;if(w<l-1)g=a[w+1].dts-k.dts,j=a[w+1].pts-k.pts;else {const he=this.config,le=w>0?k.dts-a[w-1].dts:I;if(j=w>0?k.pts-a[w-1].pts:I,he.stretchShortVideoTrack&&this.nextAudioTs!==null){const Ee=Math.floor(he.maxBufferHole*n),_e=(i?p+i*n:this.nextAudioTs+h)-k.pts;_e>Ee?(g=_e-le,g<0?g=le:O=true,this.log(`It is approximately ${_e/90} ms to the next segment; using duration ${g/90} ms for the last video frame.`)):g=le;}else g=le;}const Q=Math.round(k.pts-k.dts);N=Math.min(N,g),q=Math.max(q,g),U=Math.min(U,j),M=Math.max(M,j),o.push(Bi(k.key,g,Z,Q));}if(o.length){if(rt){if(rt<70){const w=o[0].flags;w.dependsOn=2,w.isNonSync=0;}}else if(fs&&M-U<q-N&&I/q<.025&&o[0].cts===0){this.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let w=f;for(let k=0,W=o.length;k<W;k++){const Z=w+o[k].duration,j=w+o[k].cts;if(k<W-1){const Q=Z+o[k+1].cts;o[k].duration=Q-j;}else o[k].duration=k?o[k-1].duration:I;o[k].cts=0,w=Z;}}}g=O||!g?I:g;const F=m+g;this.nextVideoTs=u=F-h,this.videoSampleDuration=g,this.isVideoContiguous=true;const Y={data1:x.moof(e.sequenceNumber++,f,ie(e,{samples:o})),data2:R,startPTS:(p-h)/n,endPTS:(S+g-h)/n,startDTS:(f-h)/n,endDTS:u/n,type:"video",hasAudio:false,hasVideo:true,nb:o.length,dropped:e.dropped};return e.samples=[],e.dropped=0,Y}getSamplesPerFrame(e){switch(e.segmentCodec){case "mp3":return Zo;case "ac3":return Jo;default:return Xo}}remuxAudio(e,t,s,i,n){const a=e.inputTimeScale,o=e.samplerate?e.samplerate:a,l=a/o,c=this.getSamplesPerFrame(e),h=c*l,u=this._initPTS,d=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,g=[],f=n!==void 0;let m=e.samples,p=d?0:8,S=this.nextAudioTs||-1;const E=u.baseTime*a/u.timescale,T=E+t*a;if(this.isAudioContiguous=s=s||m.length&&S>0&&(i&&Math.abs(T-(S+E))<9e3||Math.abs(pe(m[0].pts,T)-(S+E))<20*h),m.forEach(function(M){M.pts=pe(M.pts,T);}),!s||S<0){const M=m.length;if(m=m.filter(F=>F.pts>=0),M!==m.length&&this.warn(`Removed ${m.length-M} of ${M} samples (initPTS ${E} / ${a})`),!m.length)return;n===0?S=0:i&&!f?S=Math.max(0,T-E):S=m[0].pts-E;}if(e.segmentCodec==="aac"){const M=this.config.maxAudioFramesDrift;for(let F=0,V=S+E;F<m.length;F++){const H=m[F],Y=H.pts,w=Y-V,k=Math.abs(1e3*w/a);if(w<=-M*h&&f)F===0&&(this.warn(`Audio frame @ ${(Y/a).toFixed(3)}s overlaps marker by ${Math.round(1e3*w/a)} ms.`),this.nextAudioTs=S=Y-E,V=Y);else if(w>=M*h&&k<Qo&&f){let W=Math.round(w/h);for(V=Y-W*h;V<0&&W&&h;)W--,V+=h;F===0&&(this.nextAudioTs=S=V-E),this.warn(`Injecting ${W} audio frames @ ${((V-E)/a).toFixed(3)}s due to ${Math.round(1e3*w/a)} ms gap.`);for(let Z=0;Z<W;Z++){let j=qo.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);j||(this.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),j=H.unit.subarray()),m.splice(F,0,{unit:j,pts:V}),V+=h,F++;}}H.pts=V,V+=h;}}let A=null,I=null,D,v=0,L=m.length;for(;L--;)v+=m[L].unit.byteLength;for(let M=0,F=m.length;M<F;M++){const V=m[M],H=V.unit;let Y=V.pts;if(I!==null){const k=g[M-1];k.duration=Math.round((Y-I)/l);}else if(s&&e.segmentCodec==="aac"&&(Y=S+E),A=Y,v>0){v+=p;try{D=new Uint8Array(v);}catch(k){this.observer.emit(y.ERROR,y.ERROR,{type:G.MUX_ERROR,details:_.REMUX_ALLOC_ERROR,fatal:false,error:k,bytes:v,reason:`fail allocating audio mdat ${v}`});return}d||(new DataView(D.buffer).setUint32(0,v),D.set(x.types.mdat,4));}else return;D.set(H,p);const w=H.byteLength;p+=w,g.push(Bi(true,c,w,0)),I=Y;}const b=g.length;if(!b)return;const R=g[g.length-1];S=I-E,this.nextAudioTs=S+l*R.duration;const P=d?new Uint8Array(0):x.moof(e.sequenceNumber++,A/l,ie({},e,{samples:g}));e.samples=[];const O=(A-E)/a,N=this.nextAudioTs/a,q={data1:P,data2:D,startPTS:O,endPTS:N,startDTS:O,endDTS:N,type:"audio",hasAudio:true,hasVideo:false,nb:b};return this.isAudioContiguous=true,q}}function pe(r,e){let t;if(e===null)return r;for(e<r?t=-8589934592:t=8589934592;Math.abs(r-e)>4294967296;)r+=t;return r}function el(r){for(let e=0;e<r.length;e++)if(r[e].key)return e;return  -1}function jn(r,e,t,s){const i=r.samples.length;if(!i)return;const n=r.inputTimeScale;for(let o=0;o<i;o++){const l=r.samples[o];l.pts=pe(l.pts-t.baseTime*n/t.timescale,e*n)/n,l.dts=pe(l.dts-s.baseTime*n/s.timescale,e*n)/n;}const a=r.samples;return r.samples=[],{samples:a}}function zn(r,e,t){const s=r.samples.length;if(!s)return;const i=r.inputTimeScale;for(let a=0;a<s;a++){const o=r.samples[a];o.pts=pe(o.pts-t.baseTime*i/t.timescale,e*i)/i;}r.samples.sort((a,o)=>a.pts-o.pts);const n=r.samples;return r.samples=[],{samples:n}}class tl extends be{constructor(e,t,s,i){super("passthrough-remuxer",i),this.emitInitSegment=false,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=false;}destroy(){}resetTimeStamp(e){this.lastEndTime=null;const t=this.initPTS;t&&e&&t.baseTime===e.baseTime&&t.timescale===e.timescale||(this.initPTS=e);}resetNextTimestamp(){this.isVideoContiguous=false,this.lastEndTime=null;}resetInitSegment(e,t,s,i){this.audioCodec=t,this.videoCodec=s,this.generateInitSegment(e,i),this.emitInitSegment=true;}generateInitSegment(e,t){let{audioCodec:s,videoCodec:i}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const{audio:n,video:a}=this.initData=dn(e);if(t)Gr(e,t);else {const l=n||a;l!=null&&l.encrypted&&this.warn(`Init segment with encrypted track with has no key ("${l.codec}")!`);}n&&(s=Ui(n,fe.AUDIO,this)),a&&(i=Ui(a,fe.VIDEO,this));const o={};n&&a?o.audiovideo={container:"video/mp4",codec:s+","+i,supplemental:a.supplemental,encrypted:a.encrypted,initSegment:e,id:"main"}:n?o.audio={container:"audio/mp4",codec:s,encrypted:n.encrypted,initSegment:e,id:"audio"}:a?o.video={container:"video/mp4",codec:i,supplemental:a.supplemental,encrypted:a.encrypted,initSegment:e,id:"main"}:this.warn("initSegment does not contain moov or trak boxes."),this.initTracks=o;}remux(e,t,s,i,n,a){var o,l;let{initPTS:c,lastEndTime:h}=this;const u={audio:void 0,video:void 0,text:i,id3:s,initSegment:void 0};B(h)||(h=this.lastEndTime=n||0);const d=t.samples;if(!d.length)return u;const g={initPTS:void 0,timescale:void 0,trackId:void 0};let f=this.initData;if((o=f)!=null&&o.length||(this.generateInitSegment(d),f=this.initData),!((l=f)!=null&&l.length))return this.warn("Failed to generate initSegment."),u;this.emitInitSegment&&(g.tracks=this.initTracks,this.emitInitSegment=false);const m=Vr(d,f,this),p=f.audio?m[f.audio.id]:null,S=f.video?m[f.video.id]:null,E=Ct(S,1/0),T=Ct(p,1/0),A=Ct(S,0,true),I=Ct(p,0,true);let D=n,v=0;const L=p&&(!S||!c&&T<E||c&&c.trackId===f.audio.id),b=L?p:S;if(b){const V=b.timescale,H=b.start-n*V,Y=L?f.audio.id:f.video.id;D=b.start/V,v=L?I-T:A-E,(a||!c)&&(sl(c,D,n,v)||V!==c.timescale)&&(c&&this.warn(`Timestamps at playlist time: ${a?"":"~"}${n} ${H/V} != initPTS: ${c.baseTime/c.timescale} (${c.baseTime}/${c.timescale}) trackId: ${c.trackId}`),this.log(`Found initPTS at playlist time: ${n} offset: ${D-n} (${H}/${V}) trackId: ${Y}`),c=null,g.initPTS=H,g.timescale=V,g.trackId=Y);}else this.warn(`No audio or video samples found for initPTS at playlist time: ${n}`);c?(g.initPTS=c.baseTime,g.timescale=c.timescale,g.trackId=c.trackId):((!g.timescale||g.trackId===void 0||g.initPTS===void 0)&&(this.warn("Could not set initPTS"),g.initPTS=D,g.timescale=1,g.trackId=-1),this.initPTS=c={baseTime:g.initPTS,timescale:g.timescale,trackId:g.trackId});const R=D-c.baseTime/c.timescale,P=R+v;v>0?this.lastEndTime=P:(this.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const O=!!f.audio,N=!!f.video;let U="";O&&(U+="audio"),N&&(U+="video");const q=(f.audio?f.audio.encrypted:false)||(f.video?f.video.encrypted:false),M={data1:d,startPTS:R,startDTS:R,endPTS:P,endDTS:P,type:U,hasAudio:O,hasVideo:N,nb:1,dropped:0,encrypted:q};u.audio=O&&!N?M:void 0,u.video=N?M:void 0;const F=S?.sampleCount;if(F){const V=S.keyFrameIndex,H=V!==-1;M.nb=F,M.dropped=V===0||this.isVideoContiguous?0:H?V:F,M.independent=H,M.firstKeyFrame=V,H&&S.keyFrameStart&&(M.firstKeyFramePTS=(S.keyFrameStart-c.baseTime)/c.timescale),this.isVideoContiguous||(u.independent=H),this.isVideoContiguous||(this.isVideoContiguous=H),M.dropped&&this.warn(`fmp4 does not start with IDR: firstIDR ${V}/${F} dropped: ${M.dropped} start: ${M.firstKeyFramePTS||"NA"}`);}return u.initSegment=g,u.id3=jn(s,n,c,c),i.samples.length&&(u.text=zn(i,n,c)),u}}function Ct(r,e,t=false){return r?.start!==void 0?(r.start+(t?r.duration:0))/r.timescale:e}function sl(r,e,t,s){if(r===null)return  true;const i=Math.max(s,1),n=e-r.baseTime/r.timescale;return Math.abs(n-t)>i}function Ui(r,e,t){const s=r.codec;return s&&s.length>4?s:e===fe.AUDIO?s==="ec-3"||s==="ac-3"||s==="alac"?s:s==="fLaC"||s==="Opus"?Rs(s,false):(t.warn(`Unhandled audio codec "${s}" in mp4 MAP`),s||"mp4a"):(t.warn(`Unhandled video codec "${s}" in mp4 MAP`),s||"avc1")}let Ue;try{Ue=self.performance.now.bind(self.performance);}catch{Ue=Date.now;}const $t=[{demux:Go,remux:tl},{demux:Ye,remux:Ut},{demux:No,remux:Ut},{demux:Uo,remux:Ut}];$t.splice(2,0,{demux:Bo,remux:Ut});class $i{constructor(e,t,s,i,n,a){this.asyncResult=false,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=s,this.id=n,this.logger=a;}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset();}push(e,t,s,i){const n=s.transmuxing;n.executeStart=Ue();let a=new Uint8Array(e);const{currentTransmuxState:o,transmuxConfig:l}=this;i&&(this.currentTransmuxState=i);const{contiguous:c,discontinuity:h,trackSwitch:u,accurateTimeOffset:d,timeOffset:g,initSegmentChange:f}=i||o,{audioCodec:m,videoCodec:p,defaultInitPts:S,duration:E,initSegmentData:T}=l,A=il(a,t);if(A&&Gs(A.method)){const L=this.getDecrypter(),b=Ks(A.method);if(L.isSync()){let R=L.softwareDecrypt(a,A.key.buffer,A.iv.buffer,b);if(s.part>-1){const O=L.flush();R=O&&O.buffer;}if(!R)return n.executeEnd=Ue(),gs(s);a=new Uint8Array(R);}else return this.asyncResult=true,this.decryptionPromise=L.webCryptoDecrypt(a,A.key.buffer,A.iv.buffer,b).then(R=>{const P=this.push(R,null,s);return this.decryptionPromise=null,P}),this.decryptionPromise}const I=this.needsProbing(h,u);if(I){const L=this.configureTransmuxer(a);if(L)return this.logger.warn(`[transmuxer] ${L.message}`),this.observer.emit(y.ERROR,y.ERROR,{type:G.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,fatal:false,error:L,reason:L.message}),n.executeEnd=Ue(),gs(s)}(h||u||f||I)&&this.resetInitSegment(T,m,p,E,t),(h||f||I)&&this.resetInitialTimestamp(S),c||this.resetContiguity();const D=this.transmux(a,A,g,d,s);this.asyncResult=Qt(D);const v=this.currentTransmuxState;return v.contiguous=true,v.discontinuity=false,v.trackSwitch=false,n.executeEnd=Ue(),D}flush(e){const t=e.transmuxing;t.executeStart=Ue();const{decrypter:s,currentTransmuxState:i,decryptionPromise:n}=this;if(n)return this.asyncResult=true,n.then(()=>this.flush(e));const a=[],{timeOffset:o}=i;if(s){const u=s.flush();u&&a.push(this.push(u.buffer,null,e));}const{demuxer:l,remuxer:c}=this;if(!l||!c){t.executeEnd=Ue();const u=[gs(e)];return this.asyncResult?Promise.resolve(u):u}const h=l.flush(o);return Qt(h)?(this.asyncResult=true,h.then(u=>(this.flushRemux(a,u,e),a))):(this.flushRemux(a,h,e),this.asyncResult?Promise.resolve(a):a)}flushRemux(e,t,s){const{audioTrack:i,videoTrack:n,id3Track:a,textTrack:o}=t,{accurateTimeOffset:l,timeOffset:c}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${s.sn}${s.part>-1?" part: "+s.part:""} of ${this.id===K.MAIN?"level":"track"} ${s.level}`);const h=this.remuxer.remux(i,n,a,o,c,l,true,this.id);e.push({remuxResult:h,chunkMeta:s}),s.transmuxing.executeEnd=Ue();}resetInitialTimestamp(e){const{demuxer:t,remuxer:s}=this;!t||!s||(t.resetTimeStamp(e),s.resetTimeStamp(e));}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp());}resetInitSegment(e,t,s,i,n){const{demuxer:a,remuxer:o}=this;!a||!o||(a.resetInitSegment(e,t,s,i),o.resetInitSegment(e,t,s,n));}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0);}transmux(e,t,s,i,n){let a;return t&&t.method==="SAMPLE-AES"?a=this.transmuxSampleAes(e,t,s,i,n):a=this.transmuxUnencrypted(e,s,i,n),a}transmuxUnencrypted(e,t,s,i){const{audioTrack:n,videoTrack:a,id3Track:o,textTrack:l}=this.demuxer.demux(e,t,false,!this.config.progressive);return {remuxResult:this.remuxer.remux(n,a,o,l,t,s,false,this.id),chunkMeta:i}}transmuxSampleAes(e,t,s,i,n){return this.demuxer.demuxSampleAes(e,t,s).then(a=>({remuxResult:this.remuxer.remux(a.audioTrack,a.videoTrack,a.id3Track,a.textTrack,s,i,false,this.id),chunkMeta:n}))}configureTransmuxer(e){const{config:t,observer:s,typeSupported:i}=this;let n;for(let u=0,d=$t.length;u<d;u++){var a;if((a=$t[u].demux)!=null&&a.probe(e,this.logger)){n=$t[u];break}}if(!n)return new Error("Failed to find demuxer by probing fragment data");const o=this.demuxer,l=this.remuxer,c=n.remux,h=n.demux;(!l||!(l instanceof c))&&(this.remuxer=new c(s,t,i,this.logger)),(!o||!(o instanceof h))&&(this.demuxer=new h(s,t,i,this.logger),this.probe=h.probe);}needsProbing(e,t){return !this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new $s(this.config)),e}}function il(r,e){let t=null;return r.byteLength>0&&e?.key!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const gs=r=>({remuxResult:{},chunkMeta:r});function Qt(r){return "then"in r&&r.then instanceof Function}class nl{constructor(e,t,s,i,n){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=s,this.duration=i,this.defaultInitPts=n||null;}}class rl{constructor(e,t,s,i,n,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=s,this.trackSwitch=i,this.timeOffset=n,this.initSegmentChange=a;}}let Gi=0;class al{constructor(e,t,s,i){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=Gi++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=l=>{const c=l.data,h=this.hls;if(!(!h||!(c!=null&&c.event)||c.instanceNo!==this.instanceNo))switch(c.event){case "init":{var u;const d=(u=this.workerContext)==null?void 0:u.objectURL;d&&self.URL.revokeObjectURL(d);break}case "transmuxComplete":{this.handleTransmuxComplete(c.data);break}case "flush":{this.onFlush(c.data);break}case "workerLog":{h.logger[c.data.logType]&&h.logger[c.data.logType](c.data.message);break}default:{c.data=c.data||{},c.data.frag=this.frag,c.data.part=this.part,c.data.id=this.id,h.trigger(c.event,c.data);break}}},this.onWorkerError=l=>{if(!this.hls)return;const c=new Error(`${l.message}  (${l.filename}:${l.lineno})`);this.hls.config.enableWorker=false,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(y.ERROR,{type:G.OTHER_ERROR,details:_.INTERNAL_EXCEPTION,fatal:false,event:"demuxerWorker",error:c});};const n=e.config;this.hls=e,this.id=t,this.useWorker=!!n.enableWorker,this.onTransmuxComplete=s,this.onFlush=i;const a=(l,c)=>{c=c||{},c.frag=this.frag||void 0,l===y.ERROR&&(c=c,c.parent=this.id,c.part=this.part,this.error=c.error),this.hls.trigger(l,c);};this.observer=new wn,this.observer.on(y.FRAG_DECRYPTED,a),this.observer.on(y.ERROR,a);const o=gi(n.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const l=this.hls.logger;if(n.workerPath||ao()){try{n.workerPath?(l.log(`loading Web Worker ${n.workerPath} for "${t}"`),this.workerContext=lo(n.workerPath)):(l.log(`injecting Web Worker for "${t}"`),this.workerContext=oo());const{worker:h}=this.workerContext;h.addEventListener("message",this.onWorkerMessage),h.addEventListener("error",this.onWorkerError),h.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:o,id:t,config:se(n)});}catch(h){l.warn(`Error setting up "${t}" Web Worker, fallback to inline`,h),this.terminateWorker(),this.error=null,this.transmuxer=new $i(this.observer,o,n,"",t,e.logger);}return}}this.transmuxer=new $i(this.observer,o,n,"",t,e.logger);}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=Gi++;const t=this.hls.config,s=gi(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:s,id:this.id,config:se(t)});}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),co(this.hls.config.workerPath);}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else {const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null);}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null;}push(e,t,s,i,n,a,o,l,c,h){var u,d;c.transmuxing.start=self.performance.now();const{instanceNo:g,transmuxer:f}=this,m=a?a.start:n.start,p=n.decryptdata,S=this.frag,E=!(S&&n.cc===S.cc),T=!(S&&c.level===S.level),A=S?c.sn-S.sn:-1,I=this.part?c.part-this.part.index:-1,D=A===0&&c.id>1&&c.id===S?.stats.chunkCount,v=!T&&(A===1||A===0&&(I===1||D&&I<=0)),L=self.performance.now();(T||A||n.stats.parsing.start===0)&&(n.stats.parsing.start=L),a&&(I||!v)&&(a.stats.parsing.start=L);const b=!(S&&((u=n.initSegment)==null?void 0:u.url)===((d=S.initSegment)==null?void 0:d.url)),R=new rl(E,v,l,T,m,b);if(!v||E||b){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${n.type} sn: ${c.sn}${c.part>-1?" part: "+c.part:""} ${this.id===K.MAIN?"level":"track"}: ${c.level} id: ${c.id}
        discontinuity: ${E}
        trackSwitch: ${T}
        contiguous: ${v}
        accurateTimeOffset: ${l}
        timeOffset: ${m}
        initSegmentChange: ${b}`);const P=new nl(s,i,t,o,h);this.configureTransmuxer(P);}if(this.frag=n,this.part=a,this.workerContext)this.workerContext.worker.postMessage({instanceNo:g,cmd:"demux",data:e,decryptdata:p,chunkMeta:c,state:R},e instanceof ArrayBuffer?[e]:[]);else if(f){const P=f.push(e,p,c,R);Qt(P)?P.then(O=>{this.handleTransmuxComplete(O);}).catch(O=>{this.transmuxerError(O,c,"transmuxer-interface push error");}):this.handleTransmuxComplete(P);}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:s}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(s){const i=s.flush(e);Qt(i)?i.then(n=>{this.handleFlushResult(n,e);}).catch(n=>{this.transmuxerError(n,e,"transmuxer-interface flush error");}):this.handleFlushResult(i,e);}}transmuxerError(e,t,s){this.hls&&(this.error=e,this.hls.trigger(y.ERROR,{type:G.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:false,error:e,err:e,reason:s}));}handleFlushResult(e,t){e.forEach(s=>{this.handleTransmuxComplete(s);}),this.onFlush(t);}configureTransmuxer(e){const{instanceNo:t,transmuxer:s}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):s&&s.configure(e);}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e);}}const Ki=100;class ol extends kn{constructor(e,t,s){super(e,t,s,"audio-stream-controller",K.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=false,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=false,this.bufferFlushed=false,this.cachedTrackLoadedData=null,this.registerListeners();}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem();}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null;}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(y.BUFFER_RESET,this.onBufferReset,this),e.on(y.BUFFER_CREATED,this.onBufferCreated,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(y.FRAG_LOADING,this.onFragLoading,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this);}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(y.BUFFER_RESET,this.onBufferReset,this),e.off(y.BUFFER_CREATED,this.onBufferCreated,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(y.FRAG_LOADING,this.onFragLoading,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this));}onInitPtsFound(e,{frag:t,id:s,initPTS:i,timescale:n,trackId:a}){if(s===K.MAIN){const o=t.cc,l=this.fragCurrent;if(this.initPTS[o]={baseTime:i,timescale:n,trackId:a},this.log(`InitPTS for cc: ${o} found from main: ${i/n} (${i}/${n}) trackId: ${a}`),this.mainAnchor=t,this.state===C.WAITING_INIT_PTS){const c=this.waitingData;(!c&&!this.loadingParts||c&&c.frag.cc!==o)&&this.syncWithAnchor(t,c?.frag);}else !this.hls.hasEnoughToStart&&l&&l.cc!==o?(l.abortRequests(),this.syncWithAnchor(t,l)):this.state===C.IDLE&&this.tick();}}getLoadPosition(){return !this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var s;const i=((s=this.mainFragLoading)==null?void 0:s.frag)||null;if(t&&i?.cc===t.cc)return;const n=(i||e).cc,a=this.getLevelDetails(),o=this.getLoadPosition(),l=xn(a,n,o);l&&(this.log(`Syncing with main frag at ${l.start} cc ${l.cc}`),this.startFragRequested=false,this.nextLoadPosition=l.start,this.resetLoadingState(),this.state===C.IDLE&&this.doTickIdle());}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=C.STOPPED;return}const s=this.lastCurrentTime;this.stopLoad(),this.setInterval(Ki),s>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${s.toFixed(3)}`),e=s,this.state=C.IDLE):this.state=C.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick();}doTick(){switch(this.state){case C.IDLE:this.doTickIdle();break;case C.WAITING_TRACK:{const{levels:e,trackId:t}=this,s=e?.[t],i=s?.details;if(i&&!this.waitForLive(s)){if(this.waitForCdnTuneIn(i))break;this.state=C.WAITING_INIT_PTS;}break}case C.FRAG_LOADING_WAITING_RETRY:{this.checkRetryDate();break}case C.WAITING_INIT_PTS:{const e=this.waitingData;if(e){const{frag:t,part:s,cache:i,complete:n}=e,a=this.mainAnchor;if(this.initPTS[t.cc]!==void 0){this.waitingData=null,this.state=C.FRAG_LOADING;const o=i.flush().buffer,l={frag:t,part:s,payload:o,networkDetails:null};this._handleFragmentLoadProgress(l),n&&super._handleFragmentLoadComplete(l);}else a&&a.cc!==e.frag.cc&&this.syncWithAnchor(a,e.frag);}else this.state=C.IDLE;}}this.onTickEnd();}resetLoadingState(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState();}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime);}doTickIdle(){var e;const{hls:t,levels:s,media:i,trackId:n}=this,a=t.config;if(!this.buffering||!i&&!this.primaryPrefetch&&(this.startFragRequested||!a.startFragPrefetch)||!(s!=null&&s[n]))return;const o=s[n],l=o.details;if(!l||this.waitForLive(o)||this.waitForCdnTuneIn(l)){this.state=C.WAITING_TRACK,this.startFragRequested=false;return}const c=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&c&&(this.bufferFlushed=false,this.afterBufferFlushed(c,fe.AUDIO,K.AUDIO));const h=this.getFwdBufferInfo(c,K.AUDIO);if(h===null)return;if(!this.switchingTrack&&this._streamEnded(h,l)){t.trigger(y.BUFFER_EOS,{type:"audio"}),this.state=C.ENDED;return}const u=h.len,d=t.maxBufferLength,g=l.fragments,f=g[0].start,m=this.getLoadPosition(),p=this.flushing?m:h.end;if(this.switchingTrack&&i){const T=m;l.PTSKnown&&T<f&&(h.end>f||h.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=f+.05);}if(u>=d&&!this.switchingTrack&&p<g[g.length-1].start)return;let S=this.getNextFragment(p,l);if(S&&this.isLoopLoading(S,p)&&(S=this.getNextFragmentLoopLoading(S,l,h,K.MAIN,d)),!S){this.bufferFlushed=true;return}let E=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&E&&ye(S)&&!S.endList&&(!l.live||!this.loadingParts&&p<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(E)===ve.OK&&(this.mainFragLoading=E=null),E&&ye(E))){if(S.start>E.end){const A=this.fragmentTracker.getFragAtPos(p,K.MAIN);A&&A.end>E.end&&(E=A,this.mainFragLoading={frag:A,targetBufferTime:null});}if(S.start>E.end)return}this.loadFragment(S,o,p);}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=false,super.onMediaDetaching(e,t);}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(s=>new Vt(s));}onAudioTrackSwitching(e,t){const s=!!t.url;this.trackId=t.id;const{fragCurrent:i}=this;i&&(i.abortRequests(),this.removeUnbufferedFrags(i.start)),this.resetLoadingState(),s?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==C.STOPPED&&(this.setInterval(Ki),this.state=C.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval());}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=false,this.resetItem(),this.trackId=-1;}onLevelLoaded(e,t){this.mainDetails=t.details;const s=this.cachedTrackLoadedData;s&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(y.AUDIO_TRACK_LOADED,s));}onAudioTrackLoaded(e,t){var s;const{levels:i}=this,{details:n,id:a,groupId:o,track:l}=t;if(!i){this.warn(`Audio tracks reset while loading track ${a} "${l.name}" of "${o}"`);return}const c=this.mainDetails;if(!c||n.endCC>c.endCC||c.expired){this.cachedTrackLoadedData=t,this.state!==C.STOPPED&&(this.state=C.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${a} "${l.name}" of "${o}" loaded [${n.startSN},${n.endSN}]${n.lastPartSn?`[part-${n.lastPartSn}-${n.lastPartIndex}]`:""},duration:${n.totalduration}`);const h=i[a];let u=0;if(n.live||(s=h.details)!=null&&s.live){if(this.checkLiveUpdate(n),n.deltaUpdateFailed)return;if(h.details){var d;u=this.alignPlaylists(n,h.details,(d=this.levelLastLoaded)==null?void 0:d.details);}n.alignedSliding||(Cn(n,c),n.alignedSliding||qt(n,c),u=n.fragmentStart);}h.details=n,this.levelLastLoaded=h,this.startFragRequested||this.setStartPosition(c,u),this.hls.trigger(y.AUDIO_TRACK_UPDATED,{details:n,id:a,groupId:t.groupId}),this.state===C.WAITING_TRACK&&!this.waitForCdnTuneIn(n)&&(this.state=C.IDLE),this.tick();}_handleFragmentLoadProgress(e){var t;const s=e.frag,{part:i,payload:n}=e,{config:a,trackId:o,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${s.sn} of level ${s.level} will not be buffered`);return}const c=l[o];if(!c){this.warn("Audio track is undefined on fragment load progress");return}const h=c.details;if(!h){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(s.start);return}const u=a.defaultAudioCodec||c.audioCodec||"mp4a.40.2";let d=this.transmuxer;d||(d=this.transmuxer=new al(this.hls,K.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const g=this.initPTS[s.cc],f=(t=s.initSegment)==null?void 0:t.data;if(g!==void 0){const p=i?i.index:-1,S=p!==-1,E=new In(s.level,s.sn,s.stats.chunkCount,n.byteLength,p,S);d.push(n,f,u,"",s,i,h.totalduration,false,E,g);}else {this.log(`Unknown video PTS for cc ${s.cc}, waiting for video PTS before demuxing audio frag ${s.sn} of [${h.startSN} ,${h.endSN}],track ${o}`);const{cache:m}=this.waitingData=this.waitingData||{frag:s,part:i,cache:new so,complete:false};m.push(new Uint8Array(n)),this.state!==C.STOPPED&&(this.state=C.WAITING_INIT_PTS);}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=true;return}super._handleFragmentLoadComplete(e);}onBufferReset(){this.mediaBuffer=null;}onBufferCreated(e,t){this.bufferFlushed=this.flushing=false;const s=t.tracks.audio;s&&(this.mediaBuffer=s.buffer||null);}onFragLoading(e,t){!this.audioOnly&&t.frag.type===K.MAIN&&ye(t.frag)&&(this.mainFragLoading=t,this.state===C.IDLE&&this.tick());}onFragBuffered(e,t){const{frag:s,part:i}=t;if(s.type!==K.AUDIO){!this.audioOnly&&s.type===K.MAIN&&!s.elementaryStreams.video&&!s.elementaryStreams.audiovideo&&(this.audioOnly=true,this.mainFragLoading=null);return}if(this.fragContextChanged(s)){this.warn(`Fragment ${s.sn}${i?" p: "+i.index:""} of level ${s.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(ye(s)){this.fragPrevious=s;const n=this.switchingTrack;n&&(this.bufferedTrack=n,this.switchingTrack=null,this.hls.trigger(y.AUDIO_TRACK_SWITCHED,ee({},n)));}this.fragBufferedComplete(s,i),this.media&&this.tick();}onError(e,t){var s;if(t.fatal){this.state=C.ERROR;return}switch(t.details){case _.FRAG_GAP:case _.FRAG_PARSING_ERROR:case _.FRAG_DECRYPT_ERROR:case _.FRAG_LOAD_ERROR:case _.FRAG_LOAD_TIMEOUT:case _.KEY_LOAD_ERROR:case _.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(K.AUDIO,t);break;case _.AUDIO_TRACK_LOAD_ERROR:case _.AUDIO_TRACK_LOAD_TIMEOUT:case _.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===C.WAITING_TRACK&&((s=t.context)==null?void 0:s.type)===$e.AUDIO_TRACK&&(this.state=C.IDLE);break;case _.BUFFER_ADD_CODEC_ERROR:case _.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)||this.resetLoadingState();break;case _.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case _.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==fe.VIDEO&&(this.flushing=true);}onBufferFlushed(e,{type:t}){if(t!==fe.VIDEO){this.flushing=false,this.bufferFlushed=true,this.state===C.ENDED&&(this.state=C.IDLE);const s=this.mediaBuffer||this.media;s&&(this.afterBufferFlushed(s,t,K.AUDIO),this.tick());}}_handleTransmuxComplete(e){var t;const s="audio",{hls:i}=this,{remuxResult:n,chunkMeta:a}=e,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}const{frag:l,part:c,level:h}=o,{details:u}=h,{audio:d,text:g,id3:f,initSegment:m}=n;if(this.fragContextChanged(l)||!u){this.fragmentTracker.removeFragment(l);return}if(this.state=C.PARSING,this.switchingTrack&&d&&this.completeAudioSwitch(this.switchingTrack),m!=null&&m.tracks){const p=l.initSegment||l;if(this.unhandledEncryptionError(m,l))return;this._bufferInitSegment(h,m.tracks,p,a),i.trigger(y.FRAG_PARSING_INIT_SEGMENT,{frag:p,id:s,tracks:m.tracks});}if(d){const{startPTS:p,endPTS:S,startDTS:E,endDTS:T}=d;c&&(c.elementaryStreams[fe.AUDIO]={startPTS:p,endPTS:S,startDTS:E,endDTS:T}),l.setElementaryStreamInfo(fe.AUDIO,p,S,E,T),this.bufferFragmentData(d,l,c,a);}if(f!=null&&(t=f.samples)!=null&&t.length){const p=ie({id:s,frag:l,details:u},f);i.trigger(y.FRAG_PARSING_METADATA,p);}if(g){const p=ie({id:s,frag:l,details:u},g);i.trigger(y.FRAG_PARSING_USERDATA,p);}}_bufferInitSegment(e,t,s,i){if(this.state!==C.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;const n=t.audio;n.id=K.AUDIO;const a=e.audioCodec;this.log(`Init audio buffer, container:${n.container}, codecs[level/parsed]=[${a}/${n.codec}]`),a&&a.split(",").length===1&&(n.levelCodec=a),this.hls.trigger(y.BUFFER_CODECS,t);const o=n.initSegment;if(o!=null&&o.byteLength){const l={type:"audio",frag:s,part:null,chunkMeta:i,parent:s.type,data:o};this.hls.trigger(y.BUFFER_APPENDING,l);}this.tickImmediate();}loadFragment(e,t,s){const i=this.fragmentTracker.getState(e);if(this.switchingTrack||i===ve.NOT_LOADED||i===ve.PARTIAL){var n;if(!ye(e))this._loadInitSegment(e,t);else if((n=t.details)!=null&&n.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=C.WAITING_INIT_PTS;const a=this.mainDetails;a&&a.fragmentStart!==t.details.fragmentStart&&qt(t.details,a);}else super.loadFragment(e,t,s);}else this.clearTrackerIfNeeded(e);}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:s,assocLang:i,characteristics:n,audioCodec:a,channels:o}=this.bufferedTrack;tt({name:t,lang:s,assocLang:i,characteristics:n,audioCodec:a,channels:o},e,et)||(En(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e);}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(y.AUDIO_TRACK_SWITCHED,ee({},e));}}class Qn extends be{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=false,this.timer=-1,this.hls=e;}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null;}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1);}startLoad(){this.canLoad=true,this.loadPlaylist();}stopLoad(){this.canLoad=false,this.clearTimer();}switchParams(e,t,s){const i=t?.renditionReports;if(i){let n=-1;for(let a=0;a<i.length;a++){const o=i[a];let l;try{l=new self.URL(o.URI,t.url).href;}catch(c){this.warn(`Could not construct new URL for Rendition Report: ${c}`),l=o.URI||"";}if(l===e){n=a;break}else l===e.substring(0,l.length)&&(n=a);}if(n!==-1){const a=i[n],o=parseInt(a["LAST-MSN"])||t.lastPartSn;let l=parseInt(a["LAST-PART"])||t.lastPartIndex;if(this.hls.config.lowLatencyMode){const h=Math.min(t.age-t.partTarget,t.targetduration);l>=0&&h>t.partTarget&&(l+=1);}const c=s&&pi(s);return new yi(o,l>=0?l:void 0,c)}}}loadPlaylist(e){this.clearTimer();}loadingPlaylist(e,t){this.clearTimer();}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(s){this.warn(`Could not construct new URL with HLS Delivery Directives: ${s}`);}return e}playlistLoaded(e,t,s){const{details:i,stats:n}=t,a=self.performance.now(),o=n.loading.first?Math.max(0,a-n.loading.first):0;i.advancedDateTime=Date.now()-o;const l=this.hls.config.timelineOffset;if(l!==i.appliedTimelineOffset){const h=Math.max(l||0,0);i.appliedTimelineOffset=h,i.fragments.forEach(u=>{u.setStart(u.playlistOffset+h);});}if(i.live||s!=null&&s.live){const h="levelInfo"in t?t.levelInfo:t.track;if(i.reloaded(s),s&&i.fragments.length>0){Wa(s,i,this);const E=i.playlistParsingError;if(E){this.warn(E);const T=this.hls;if(!T.config.ignorePlaylistParsingErrors){var c;const{networkDetails:A}=t;T.trigger(y.ERROR,{type:G.NETWORK_ERROR,details:_.LEVEL_PARSING_ERROR,fatal:false,url:i.url,error:E,reason:E.message,level:t.level||void 0,parent:(c=i.fragments[0])==null?void 0:c.type,networkDetails:A,stats:n});return}i.playlistParsingError=null;}}i.requestScheduled===-1&&(i.requestScheduled=n.loading.start);const u=this.hls.mainForwardBufferInfo,d=u?u.end-u.len:0,g=(i.edge-d)*1e3,f=Qa(i,g);if(i.requestScheduled+f<a?i.requestScheduled=a:i.requestScheduled+=f,this.log(`live playlist ${e} ${i.advanced?"REFRESHED "+i.lastPartSn+"-"+i.lastPartIndex:i.updated?"UPDATED":"MISSED"}`),!this.canLoad||!i.live)return;let m,p,S;if(i.canBlockReload&&i.endSN&&i.advanced){const E=this.hls.config.lowLatencyMode,T=i.lastPartSn,A=i.endSN,I=i.lastPartIndex,D=I!==-1,v=T===A;D?v?(p=A+1,S=E?0:I):(p=T,S=E?I+1:i.maxPartIndex):p=A+1;const L=i.age,b=L+i.ageHeader;let R=Math.min(b-i.partTarget,i.targetduration*1.5);if(R>0){if(b>i.targetduration*3)this.log(`Playlist last advanced ${L.toFixed(2)}s ago. Omitting segment and part directives.`),p=void 0,S=void 0;else if(s!=null&&s.tuneInGoal&&b-i.partTarget>s.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${s.tuneInGoal} to: ${R} with playlist age: ${i.age}`),R=0;else {const P=Math.floor(R/i.targetduration);if(p+=P,S!==void 0){const O=Math.round(R%i.targetduration/i.partTarget);S+=O;}this.log(`CDN Tune-in age: ${i.ageHeader}s last advanced ${L.toFixed(2)}s goal: ${R} skip sn ${P} to part ${S}`);}i.tuneInGoal=R;}if(m=this.getDeliveryDirectives(i,t.deliveryDirectives,p,S),E||!v){i.requestScheduled=a,this.loadingPlaylist(h,m);return}}else (i.canBlockReload||i.canSkipUntil)&&(m=this.getDeliveryDirectives(i,t.deliveryDirectives,p,S));m&&p!==void 0&&i.canBlockReload&&(i.requestScheduled=n.loading.first+Math.max(f-o*2,f/2)),this.scheduleLoading(h,m,i);}else this.clearTimer();}scheduleLoading(e,t,s){const i=s||e.details;if(!i){this.loadingPlaylist(e,t);return}const n=self.performance.now(),a=i.requestScheduled;if(n>=a){this.loadingPlaylist(e,t);return}const o=a-n;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(o)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),o);}getDeliveryDirectives(e,t,s,i){let n=pi(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(s=t.msn,i=t.part,n=Bt.No),new yi(s,i,n)}checkRetry(e){const t=e.details,s=Ht(e),i=e.errorAction,{action:n,retryCount:a=0,retryConfig:o}=i||{},l=!!i&&!!o&&(n===ce.RetryRequest||!i.resolved&&n===ce.SendAlternateToPenaltyBox);if(l){var c;if(a>=o.maxNumRetry)return  false;if(s&&(c=e.context)!=null&&c.deliveryDirectives)this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else {const h=Us(o,a);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),h),this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" in ${h}ms`);}e.levelRetry=true,i.resolved=true;}return l}}function Xn(r,e){if(r.length!==e.length)return  false;for(let t=0;t<r.length;t++)if(!vt(r[t].attrs,e[t].attrs))return  false;return  true}function vt(r,e,t){const s=r["STABLE-RENDITION-ID"];return s&&!t?s===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(i=>r[i]!==e[i])}function Cs(r,e){return e.label.toLowerCase()===r.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(r.lang||"").toLowerCase())}class ll extends Qn{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=true,this.registerListeners();}registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(y.ERROR,this.onError,this);}unregisterListeners(){const{hls:e}=this;e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVEL_LOADING,this.onLevelLoading,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(y.ERROR,this.onError,this);}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy();}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=true;}onManifestParsed(e,t){this.tracks=t.audioTracks||[];}onAudioTrackLoaded(e,t){const{id:s,groupId:i,details:n}=t,a=this.tracksInGroup[s];if(!a||a.groupId!==i){this.warn(`Audio track with id:${s} and group:${i} not found in active group ${a?.groupId}`);return}const o=a.details;a.details=t.details,this.log(`Audio track ${s} "${a.name}" lang:${a.lang} group:${i} loaded [${n.startSN}-${n.endSN}]`),s===this.trackId&&this.playlistLoaded(s,t,o);}onLevelLoading(e,t){this.switchLevel(t.level);}onLevelSwitching(e,t){this.switchLevel(t.level);}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const s=t.audioGroups||null,i=this.groupIds;let n=this.currentTrack;if(!s||i?.length!==s?.length||s!=null&&s.some(o=>i?.indexOf(o)===-1)){this.groupIds=s,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(d=>!s||s.indexOf(d.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(d=>d.default)&&(this.selectDefaultTrack=false),o.forEach((d,g)=>{d.id=g;});else if(!n&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const l=this.hls.config.audioPreference;if(!n&&l){const d=Oe(l,o,et);if(d>-1)n=o[d];else {const g=Oe(l,this.tracks);n=this.tracks[g];}}let c=this.findTrackId(n);c===-1&&n&&(c=this.findTrackId(null));const h={audioTracks:o};this.log(`Updating audio tracks, ${o.length} track(s) found in group(s): ${s?.join(",")}`),this.hls.trigger(y.AUDIO_TRACKS_UPDATED,h);const u=this.trackId;if(c!==-1&&u===-1)this.setAudioTrack(c);else if(o.length&&u===-1){var a;const d=new Error(`No audio track selected for current audio group-ID(s): ${(a=this.groupIds)==null?void 0:a.join(",")} track count: ${o.length}`);this.warn(d.message),this.hls.trigger(y.ERROR,{type:G.MEDIA_ERROR,details:_.AUDIO_TRACK_LOAD_ERROR,fatal:true,error:d});}}}onError(e,t){t.fatal||!t.context||t.context.type===$e.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t);}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=false,this.setAudioTrack(e);}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const s=this.allAudioTracks;if(this.selectDefaultTrack=false,s.length){const i=this.currentTrack;if(i&&tt(e,i,et))return i;const n=Oe(e,this.tracksInGroup,et);if(n>-1){const a=this.tracksInGroup[n];return this.setAudioTrack(n),a}else if(i){let a=t.loadLevel;a===-1&&(a=t.firstAutoLevel);const o=pa(e,t.levels,s,a,et);if(o===-1)return null;t.nextLoadLevel=o;}if(e.channels||e.audioCodec){const a=Oe(e,s);if(a>-1)return s[a]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=false;const s=this.currentTrack,i=t[e],n=i.details&&!i.details.live;if(e===this.trackId&&i===s&&n||(this.log(`Switching to audio-track ${e} "${i.name}" lang:${i.lang} group:${i.groupId} channels:${i.channels}`),this.trackId=e,this.currentTrack=i,this.hls.trigger(y.AUDIO_TRACK_SWITCHING,ee({},i)),n))return;const a=this.switchParams(i.url,s?.details,i.details);this.loadPlaylist(a);}findTrackId(e){const t=this.tracksInGroup;for(let s=0;s<t.length;s++){const i=t[s];if(!(this.selectDefaultTrack&&!i.default)&&(!e||tt(e,i,et)))return s}if(e){const{name:s,lang:i,assocLang:n,characteristics:a,audioCodec:o,channels:l}=e;for(let c=0;c<t.length;c++){const h=t[c];if(tt({name:s,lang:i,assocLang:n,characteristics:a,audioCodec:o,channels:l},h,et))return c}for(let c=0;c<t.length;c++){const h=t[c];if(vt(e.attrs,h.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return c}for(let c=0;c<t.length;c++){const h=t[c];if(vt(e.attrs,h.attrs,["LANGUAGE"]))return c}}return  -1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&En(t.url,this.hls)&&this.scheduleLoading(t,e);}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const s=e.id,i=e.groupId,n=this.getUrlWithDirectives(e.url,t),a=e.details,o=a?.age;this.log(`Loading audio-track ${s} "${e.name}" lang:${e.lang} group:${i}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${o&&a.live?" age "+o.toFixed(1)+(a.type&&" "+a.type||""):""} ${n}`),this.hls.trigger(y.AUDIO_TRACK_LOADING,{url:n,id:s,groupId:i,deliveryDirectives:t||null,track:e});}}class cl{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e;}destroy(){this.tracks=this.queues=null;}append(e,t,s){if(this.queues===null||this.tracks===null)return;const i=this.queues[t];i.push(e),i.length===1&&!s&&this.executeNext(t);}appendBlocker(e){return new Promise(t=>{const s={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(s,e);})}prependBlocker(e){return new Promise(t=>{if(this.queues){const s={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(s);}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const s=(t=e[0])==null?void 0:t.label;(s==="async-blocker"||s==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1));});}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio");}executeNext(e){if(this.queues===null||this.tracks===null)return;const t=this.queues[e];if(t.length){const i=t[0];try{i.execute();}catch(n){var s;if(i.onError(n),this.queues===null||this.tracks===null)return;const a=(s=this.tracks[e])==null?void 0:s.buffer;a!=null&&a.updating||this.shiftAndExecuteNext(e);}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e));}current(e){var t;return ((t=this.queues)==null?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return e===null||t===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var t,s;return (t=this.queues)!=null&&t[e]||(s=this.tracks)!=null&&s[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const s=(t=this.tracks)==null?void 0:t[e],i=s?.buffer;return i?`SourceBuffer${i.updating?" updating":""}${s.ended?" ended":""}${s.ending?" ending":""}`:"none"}listOps(e){var t;return ((t=this.queues)==null?void 0:t[e].map(s=>s.label).join(", "))||""}}const Vi=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,Zn="HlsJsTrackRemovedError";class hl extends Error{constructor(e){super(e),this.name=Zn;}}class ul extends be{constructor(e,t){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=s=>{var i;this.hls&&((i=this.mediaSource)==null?void 0:i.readyState)==="open"&&this.hls.pauseBuffering();},this._onStartStreaming=s=>{this.hls&&this.hls.resumeBuffering();},this._onMediaSourceOpen=s=>{const{media:i,mediaSource:n}=this;s&&this.log("Media source opened"),!(!i||!n)&&(n.removeEventListener("sourceopen",this._onMediaSourceOpen),i.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(y.MEDIA_ATTACHED,{media:i,mediaSource:n}),this.mediaSource!==null&&this.checkPendingTracks());},this._onMediaSourceClose=()=>{this.log("Media source closed");},this._onMediaSourceEnded=()=>{this.log("Media source ended");},this._onMediaEmptied=()=>{const{mediaSrc:s,_objectUrl:i}=this;s!==i&&this.error(`Media element src was set while attaching MediaSource (${i} > ${s})`);},this.hls=e,this.fragmentTracker=t,this.appendSource=kr(Tt(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners();}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null;}registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.BUFFER_RESET,this.onBufferReset,this),e.on(y.BUFFER_APPENDING,this.onBufferAppending,this),e.on(y.BUFFER_CODECS,this.onBufferCodecs,this),e.on(y.BUFFER_EOS,this.onBufferEos,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(y.FRAG_PARSED,this.onFragParsed,this),e.on(y.FRAG_CHANGED,this.onFragChanged,this),e.on(y.ERROR,this.onError,this);}unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.BUFFER_RESET,this.onBufferReset,this),e.off(y.BUFFER_APPENDING,this.onBufferAppending,this),e.off(y.BUFFER_CODECS,this.onBufferCodecs,this),e.off(y.BUFFER_EOS,this.onBufferEos,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(y.FRAG_PARSED,this.onFragParsed,this),e.off(y.FRAG_CHANGED,this.onFragChanged,this),e.off(y.ERROR,this.onError,this);}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const s={};if(this.operationQueue){const n=this.isUpdating();n||this.operationQueue.removeBlockers();const a=this.isQueued();(n||a)&&this.warn(`Transfering MediaSource with${a?" operations in queue":""}${n?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy();}const i=this.transferData;return !this.sourceBufferCount&&i&&i.mediaSource===t?ie(s,i.tracks):this.sourceBuffers.forEach(n=>{const[a]=n;a&&(s[a]=ie({},this.tracks[a]),this.removeBuffer(a)),n[0]=n[1]=null;}),{media:e,mediaSource:t,tracks:s}}initTracks(){const e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0;}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null;}onManifestParsed(e,t){var s;let i=2;(t.audio&&!t.video||!t.altAudio)&&(i=1),this.bufferCodecEventsTotal=i,this.log(`${i} bufferCodec event(s) expected.`),(s=this.transferData)!=null&&s.mediaSource&&this.sourceBufferCount&&i&&this.bufferCreated();}onMediaAttaching(e,t){const s=this.media=t.media;this.transferData=this.overrides=void 0;const i=Tt(this.appendSource);if(i){const n=!!t.mediaSource;(n||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const a=this.mediaSource=t.mediaSource||new i;if(this.assignMediaSource(a),n)this._objectUrl=s.src,this.attachTransferred();else {const o=this._objectUrl=self.URL.createObjectURL(a);if(this.appendSource)try{s.removeAttribute("src");const l=self.ManagedMediaSource;s.disableRemotePlayback=s.disableRemotePlayback||l&&a instanceof l,Hi(s),dl(s,o),s.load();}catch{s.src=o;}else s.src=o;}s.addEventListener("emptied",this._onMediaEmptied);}}assignMediaSource(e){var t,s;this.log(`${((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${(s=e.constructor)==null?void 0:s.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming));}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const s=this.tracks,i=t.tracks,n=i?Object.keys(i):null,a=n?n.length:0,o=()=>{Promise.resolve().then(()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen();});};if(i&&n&&a){if(!this.tracksReady){this.hls.config.startFragPrefetch=true,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${se(s,(l,c)=>l==="initSegment"?void 0:c)};
transfer tracks: ${se(i,(l,c)=>l==="initSegment"?void 0:c)}}`),!ln(i,s)){t.mediaSource=null,t.tracks=void 0;const l=e.currentTime,c=this.details,h=Math.max(l,c?.fragments[0].start||0);if(h-l>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${l} -> ${h}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(i)}"->"${Object.keys(s)}") start time: ${h} currentTime: ${l}`),this.onMediaDetaching(y.MEDIA_DETACHING,{}),this.onMediaAttaching(y.MEDIA_ATTACHING,t),e.currentTime=h;return}this.transferData=void 0,n.forEach(l=>{const c=l,h=i[c];if(h){const u=h.buffer;if(u){const d=this.fragmentTracker,g=h.id;if(d.hasFragments(g)||d.hasParts(g)){const p=J.getBuffered(u);d.detectEvictedFragments(c,p,g,null,true);}const f=ms(c),m=[c,u];this.sourceBuffers[f]=m,u.updating&&this.operationQueue&&this.operationQueue.prependBlocker(c),this.trackSourceBuffer(c,h);}}}),o(),this.bufferCreated();}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),o();}get mediaSourceOpenOrEnded(){var e;const t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}onMediaDetaching(e,t){const s=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:i,mediaSource:n,_objectUrl:a}=this;if(n){if(this.log(`media source ${s?"transferring":"detaching"}`),s)this.sourceBuffers.forEach(([o])=>{o&&this.removeBuffer(o);}),this.resetQueue();else {if(this.mediaSourceOpenOrEnded){const o=n.readyState==="open";try{const l=n.sourceBuffers;for(let c=l.length;c--;)o&&l[c].abort(),n.removeSourceBuffer(l[c]);o&&n.endOfStream();}catch(l){this.warn(`onMediaDetaching: ${l.message} while calling endOfStream`);}}this.sourceBufferCount&&this.onBufferReset();}n.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("sourceended",this._onMediaSourceEnded),n.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(n.removeEventListener("startstreaming",this._onStartStreaming),n.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null;}i&&(i.removeEventListener("emptied",this._onMediaEmptied),s||(a&&self.URL.revokeObjectURL(a),this.mediaSrc===a?(i.removeAttribute("src"),this.appendSource&&Hi(i),i.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(y.MEDIA_DETACHED,t);}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e);}),this.initTracks();}resetBuffer(e){var t;const s=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),s)try{var i;(i=this.mediaSource)!=null&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(s);}catch(n){this.warn(`onBufferReset ${e}`,n);}delete this.tracks[e];}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[ms(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0);}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new cl(this.tracks);}onBufferCodecs(e,t){var s;const i=this.tracks,n=Object.keys(t);this.log(`BUFFER_CODECS: "${n}" (current SB count ${this.sourceBufferCount})`);const a="audiovideo"in t&&(i.audio||i.video)||i.audiovideo&&("audio"in t||"video"in t),o=!a&&this.sourceBufferCount&&this.media&&n.some(l=>!i[l]);if(a||o){this.warn(`Unsupported transition between "${Object.keys(i)}" and "${n}" SourceBuffers`);return}n.forEach(l=>{var c,h;const u=t[l],{id:d,codec:g,levelCodec:f,container:m,metadata:p,supplemental:S}=u;let E=i[l];const T=(c=this.transferData)==null||(c=c.tracks)==null?void 0:c[l],A=T!=null&&T.buffer?T:E,I=A?.pendingCodec||A?.codec,D=A?.levelCodec;E||(E=i[l]={buffer:void 0,listeners:[],codec:g,supplemental:S,container:m,levelCodec:f,metadata:p,id:d});const v=as(I,D),L=v?.replace(Vi,"$1");let b=as(g,f);const R=(h=b)==null?void 0:h.replace(Vi,"$1");b&&v&&L!==R&&(l.slice(0,5)==="audio"&&(b=Rs(b,this.appendSource)),this.log(`switching codec ${I} to ${b}`),b!==(E.pendingCodec||E.codec)&&(E.pendingCodec=b),E.container=m,this.appendChangeType(l,m,b));}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&(this.bufferCodecEventsTotal>1&&!this.tracks.video&&!t.video&&((s=t.audio)==null?void 0:s.id)==="main"&&(this.log("Main audio-only"),this.bufferCodecEventsTotal=1),this.mediaSourceOpenOrEnded&&this.checkPendingTracks());}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const s=this.tracks[t];return e[t]={id:s.id,container:s.container,codec:s.codec,levelCodec:s.levelCodec},e},{})}appendChangeType(e,t,s){const i=`${t};codecs=${s}`,n={label:`change-type=${i}`,execute:()=>{const a=this.tracks[e];if(a){const o=a.buffer;o!=null&&o.changeType&&(this.log(`changing ${e} sourceBuffer type to ${i}`),o.changeType(i),a.codec=s,a.container=t);}this.shiftAndExecuteNext(e);},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn(`Failed to change ${e} SourceBuffer type`,a);}};this.append(n,e,this.isPending(this.tracks[e]));}blockAudio(e){var t;const s=e.start,i=s+e.duration*.05;if(((t=this.fragmentTracker.getAppendedFrag(s,K.MAIN))==null?void 0:t.gap)===true)return;const a={label:"block-audio",execute:()=>{var o;const l=this.tracks.video;(this.lastVideoAppendEnd>i||l!=null&&l.buffer&&J.isBuffered(l.buffer,i)||((o=this.fragmentTracker.getAppendedFrag(i,K.MAIN))==null?void 0:o.gap)===true)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"));},onStart:()=>{},onComplete:()=>{},onError:o=>{this.warn("Error executing block-audio operation",o);}};this.blockedAudioAppend={op:a,frag:e},this.append(a,"audio",true);}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op));}onBufferAppending(e,t){const{tracks:s}=this,{data:i,type:n,parent:a,frag:o,part:l,chunkMeta:c,offset:h}=t,u=c.buffering[n],{sn:d,cc:g}=o,f=self.performance.now();u.start=f;const m=o.stats.buffering,p=l?l.stats.buffering:null;m.start===0&&(m.start=f),p&&p.start===0&&(p.start=f);const S=s.audio;let E=false;n==="audio"&&S?.container==="audio/mpeg"&&(E=!this.lastMpegAudioChunk||c.id===1||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const T=s.video,A=T?.buffer;if(A&&d!=="initSegment"){const v=l||o,L=this.blockedAudioAppend;if(n==="audio"&&a!=="main"&&!this.blockedAudioAppend&&!(T.ending||T.ended)){const R=v.start+v.duration*.05,P=A.buffered,O=this.currentOp("video");!P.length&&!O?this.blockAudio(v):!O&&!J.isBuffered(A,R)&&this.lastVideoAppendEnd<R&&this.blockAudio(v);}else if(n==="video"){const b=v.end;if(L){const R=L.frag.start;(b>R||b<this.lastVideoAppendEnd||J.isBuffered(A,R))&&this.unblockAudio();}this.lastVideoAppendEnd=b;}}const I=(l||o).start,D={label:`append-${n}`,execute:()=>{var v;u.executeStart=self.performance.now();const L=(v=this.tracks[n])==null?void 0:v.buffer;L&&(E?this.updateTimestampOffset(L,I,.1,n,d,g):h!==void 0&&B(h)&&this.updateTimestampOffset(L,h,1e-6,n,d,g)),this.appendExecutor(i,n);},onStart:()=>{},onComplete:()=>{const v=self.performance.now();u.executeEnd=u.end=v,m.first===0&&(m.first=v),p&&p.first===0&&(p.first=v);const L={};this.sourceBuffers.forEach(([b,R])=>{b&&(L[b]=J.getBuffered(R));}),this.appendErrors[n]=0,n==="audio"||n==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(y.BUFFER_APPENDED,{type:n,frag:o,part:l,chunkMeta:c,parent:o.type,timeRanges:L});},onError:v=>{var L;const b={type:G.MEDIA_ERROR,parent:o.type,details:_.BUFFER_APPEND_ERROR,sourceBufferName:n,frag:o,part:l,chunkMeta:c,error:v,err:v,fatal:false},R=(L=this.media)==null?void 0:L.error;if(v.code===DOMException.QUOTA_EXCEEDED_ERR||v.name=="QuotaExceededError"||"quota"in v)b.details=_.BUFFER_FULL_ERROR;else if(v.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!R)b.errorAction=ot(true);else if(v.name===Zn&&this.sourceBufferCount===0)b.errorAction=ot(true);else {const P=++this.appendErrors[n];this.warn(`Failed ${P}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${n}" sourceBuffer (${R||"no media error"})`),(P>=this.hls.config.appendErrorMaxRetry||R)&&(b.fatal=true);}this.hls.trigger(y.ERROR,b);}};this.log(`queuing "${n}" append sn: ${d}${l?" p: "+l.index:""} of ${o.type===K.MAIN?"level":"track"} ${o.level} cc: ${g}`),this.append(D,n,this.isPending(this.tracks[n]));}getFlushOp(e,t,s){return this.log(`queuing "${e}" remove ${t}-${s}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,s);},onStart:()=>{},onComplete:()=>{this.hls.trigger(y.BUFFER_FLUSHED,{type:e});},onError:i=>{this.warn(`Failed to remove ${t}-${s} from "${e}" SourceBuffer`,i);}}}onBufferFlushing(e,t){const{type:s,startOffset:i,endOffset:n}=t;s?this.append(this.getFlushOp(s,i,n),s):this.sourceBuffers.forEach(([a])=>{a&&this.append(this.getFlushOp(a,i,n),a);});}onFragParsed(e,t){const{frag:s,part:i}=t,n=[],a=i?i.elementaryStreams:s.elementaryStreams;a[fe.AUDIOVIDEO]?n.push("audiovideo"):(a[fe.AUDIO]&&n.push("audio"),a[fe.VIDEO]&&n.push("video"));const o=()=>{const l=self.performance.now();s.stats.buffering.end=l,i&&(i.stats.buffering.end=l);const c=i?i.stats:s.stats;this.hls.trigger(y.FRAG_BUFFERED,{frag:s,part:i,stats:c,id:s.type});};n.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${s.type} level: ${s.level} sn: ${s.sn}`),this.blockBuffers(o,n).catch(l=>{this.warn(`Fragment buffered callback ${l}`),this.stepOperationQueue(this.sourceBufferTypes);});}onFragChanged(e,t){this.trimBuffers();}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{if(e){const t=this.tracks[e];if(t)return !t.ended||t.ending}return  false})}onBufferEos(e,t){var s;this.sourceBuffers.forEach(([a])=>{if(a){const o=this.tracks[a];(!t.type||t.type===a)&&(o.ending=true,o.ended||(o.ended=true,this.log(`${a} buffer reached EOS`)));}});const i=((s=this.overrides)==null?void 0:s.endOfStream)!==false;this.sourceBufferCount>0&&!this.sourceBuffers.some(([a])=>{var o;return a&&!((o=this.tracks[a])!=null&&o.ended)})?i?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:a}=this;if(!a||a.readyState!=="open"){a&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${a.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),a.endOfStream(),this.hls.trigger(y.BUFFERED_TO_END,void 0);})):(this.tracksEnded(),this.hls.trigger(y.BUFFERED_TO_END,void 0)):t.type==="video"&&this.unblockAudio();}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){const t=this.tracks[e];t&&(t.ending=false);}});}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration());}updateDuration(){this.blockUntilOpen(()=>{const e=this.getDurationAndRange();e&&this.updateMediaSource(e);});}onError(e,t){if(t.details===_.BUFFER_APPEND_ERROR&&t.frag){var s;const i=(s=t.errorAction)==null?void 0:s.nextAutoLevel;B(i)&&i!==t.frag.level&&this.resetAppendErrors();}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0};}trimBuffers(){const{hls:e,details:t,media:s}=this;if(!s||t===null||!this.sourceBufferCount)return;const i=e.config,n=s.currentTime,a=t.levelTargetDuration,o=t.live&&i.liveBackBufferLength!==null?i.liveBackBufferLength:i.backBufferLength;if(B(o)&&o>=0){const c=Math.max(o,a),h=Math.floor(n/a)*a-c;this.flushBackBuffer(n,a,h);}const l=i.frontBufferFlushThreshold;if(B(l)&&l>0){const c=Math.max(i.maxBufferLength,l),h=Math.max(c,a),u=Math.floor(n/a)*a+h;this.flushFrontBuffer(n,a,u);}}flushBackBuffer(e,t,s){this.sourceBuffers.forEach(([i,n])=>{if(n){const o=J.getBuffered(n);if(o.length>0&&s>o.start(0)){var a;this.hls.trigger(y.BACK_BUFFER_REACHED,{bufferEnd:s});const l=this.tracks[i];if((a=this.details)!=null&&a.live)this.hls.trigger(y.LIVE_BACK_BUFFER_REACHED,{bufferEnd:s});else if(l!=null&&l.ended){this.log(`Cannot flush ${i} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:0,endOffset:s,type:i});}}});}flushFrontBuffer(e,t,s){this.sourceBuffers.forEach(([i,n])=>{if(n){const a=J.getBuffered(n),o=a.length;if(o<2)return;const l=a.start(o-1),c=a.end(o-1);if(s>l||e>=l&&e<=c)return;this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:l,endOffset:1/0,type:i});}});}getDurationAndRange(){var e;const{details:t,mediaSource:s}=this;if(!t||!this.media||s?.readyState!=="open")return null;const i=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&s.setLiveSeekableRange){const c=Math.max(0,t.fragmentStart),h=Math.max(c,i);return {duration:1/0,start:c,end:h}}return {duration:1/0}}const n=(e=this.overrides)==null?void 0:e.duration;if(n)return B(n)?{duration:n}:null;const a=this.media.duration,o=B(s.duration)?s.duration:0;return i>o&&i>a||!B(a)?{duration:i}:null}updateMediaSource({duration:e,start:t,end:s}){const i=this.mediaSource;!this.media||!i||i.readyState!=="open"||(i.duration!==e&&(B(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),i.duration=e),t!==void 0&&s!==void 0&&(this.log(`MediaSource duration is set to ${i.duration}. Setting seekable range to ${t}-${s}.`),i.setLiveSeekableRange(t,s)));}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:s}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${se(s)}`),this.tracksReady){var i;const n=(i=this.transferData)==null?void 0:i.tracks;n&&Object.keys(n).length?this.attachTransferred():this.createSourceBuffers();}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,s])=>{if(t){const i=this.tracks[t];e[t]={buffer:s,container:i.container,codec:i.codec,supplemental:i.supplemental,levelCodec:i.levelCodec,id:i.id,metadata:i.metadata};}}),this.hls.trigger(y.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t);});}else {const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(y.ERROR,{type:G.MEDIA_ERROR,details:_.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:true,error:e,reason:e.message});}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:s}=this;if(!s)throw new Error("createSourceBuffers called when mediaSource was null");for(const n in e){const a=n,o=e[a];if(this.isPending(o)){const l=this.getTrackCodec(o,a),c=`${o.container};codecs=${l}`;o.codec=l,this.log(`creating sourceBuffer(${c})${this.currentOp(a)?" Queued":""} ${se(o)}`);try{const h=s.addSourceBuffer(c),u=ms(a),d=[a,h];t[u]=d,o.buffer=h;}catch(h){var i;this.error(`error while trying to add sourceBuffer: ${h.message}`),this.shiftAndExecuteNext(a),(i=this.operationQueue)==null||i.removeBlockers(),delete this.tracks[a],this.hls.trigger(y.ERROR,{type:G.MEDIA_ERROR,details:_.BUFFER_ADD_CODEC_ERROR,fatal:false,error:h,sourceBufferName:a,mimeType:c,parent:o.id});return}this.trackSourceBuffer(a,o);}}this.bufferCreated();}getTrackCodec(e,t){const s=e.supplemental;let i=e.codec;s&&(t==="video"||t==="audiovideo")&&qr(s,"video")&&(i=Qr(i,s));const n=as(i,e.levelCodec);return n?t.slice(0,5)==="audio"?Rs(n,this.appendSource):n:""}trackSourceBuffer(e,t){const s=t.buffer;if(!s)return;const i=this.getTrackCodec(t,e);this.tracks[e]={buffer:s,codec:i,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(n,a)=>{const o=a.removedRanges;o!=null&&o.length&&this.hls.trigger(y.BUFFER_FLUSHED,{type:n});});}get mediaSrc(){var e,t;const s=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return s?.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart();}onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const s=this.currentOp(e);s&&(s.onComplete(),this.shiftAndExecuteNext(e));}onSBUpdateError(e,t){var s;const i=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(s=this.mediaSource)==null?void 0:s.readyState}`);this.error(`${i}`,t),this.hls.trigger(y.ERROR,{type:G.MEDIA_ERROR,details:_.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:i,fatal:false});const n=this.currentOp(e);n&&n.onError(i);}updateTimestampOffset(e,t,s,i,n,a){const o=t-e.timestampOffset;Math.abs(o)>=s&&(this.log(`Updating ${i} SourceBuffer timestampOffset to ${t} (sn: ${n} cc: ${a})`),e.timestampOffset=t);}removeExecutor(e,t,s){const{media:i,mediaSource:n}=this,a=this.tracks[e],o=a?.buffer;if(!i||!n||!o){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}const l=B(i.duration)?i.duration:1/0,c=B(n.duration)?n.duration:1/0,h=Math.max(0,t),u=Math.min(s,l,c);u>h&&(!a.ending||a.ended)?(a.ended=false,this.log(`Removing [${h},${u}] from the ${e} SourceBuffer`),o.remove(h,u)):this.shiftAndExecuteNext(e);}appendExecutor(e,t){const s=this.tracks[t],i=s?.buffer;if(!i)throw new hl(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);s.ending=false,s.ended=false,i.appendBuffer(e);}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes);});else try{e();}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`);}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return !!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:s}=this,i=t.map(a=>this.appendBlocker(a));return t.length>1&&this.blockedAudioAppend&&this.unblockAudio(),Promise.all(i).then(a=>{s===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes));})}stepOperationQueue(e){e.forEach(t=>{var s;const i=(s=this.tracks[t])==null?void 0:s.buffer;!i||i.updating||this.shiftAndExecuteNext(t);});}append(e,t,s){this.operationQueue&&this.operationQueue.append(e,t,s);}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e);}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e);}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,s){const i=this.tracks[e];if(!i)return;const n=i.buffer;if(!n)return;const a=s.bind(this,e);i.listeners.push({event:t,listener:a}),n.addEventListener(t,a);}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const s=t.buffer;s&&(t.listeners.forEach(i=>{s.removeEventListener(i.event,i.listener);}),t.listeners.length=0);}}function Hi(r){const e=r.querySelectorAll("source");[].slice.call(e).forEach(t=>{r.removeChild(t);});}function dl(r,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,r.appendChild(t);}function ms(r){return r==="audio"?1:0}class zs{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners();}setStreamController(e){this.streamController=e;}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null;}registerListeners(){const{hls:e}=this;e.on(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.BUFFER_CODECS,this.onBufferCodecs,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this);}unregisterListener(){const{hls:e}=this;e.off(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.BUFFER_CODECS,this.onBufferCodecs,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this);}onFpsDropLevelCapping(e,t){const s=this.hls.levels[t.droppedLevel];this.isLevelAllowed(s)&&this.restrictedLevels.push({bitrate:s.bitrate,height:s.height,width:s.width});}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize();}onManifestParsed(e,t){const s=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,s.config.capLevelToPlayerSize&&t.video&&this.startCapping();}onLevelsUpdated(e,t){this.timer&&B(this.autoLevelCapping)&&this.detectPlayerSize();}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping();}onMediaDetaching(){this.stopCapping(),this.media=null;}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,s=this.getMaxLevel(e.length-1);s!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${s}: ${e[s].height}p@${e[s].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=s,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping;}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return  -1;const s=t.filter((i,n)=>this.isLevelAllowed(i)&&n<=e);return this.clientRect=null,zs.getMaxLevelByMediaSize(s,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize());}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0);}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const s=e.getBoundingClientRect();t.width=s.width,t.height=s.height,!t.width&&!t.height&&(t.width=s.right-s.left||e.width||0,t.height=s.bottom-s.top||e.height||0);}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio;}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return !this.restrictedLevels.some(s=>e.bitrate===s.bitrate&&e.width===s.width&&e.height===s.height)}static getMaxLevelByMediaSize(e,t,s){if(!(e!=null&&e.length))return  -1;const i=(o,l)=>l?o.width!==l.width||o.height!==l.height:true;let n=e.length-1;const a=Math.max(t,s);for(let o=0;o<e.length;o+=1){const l=e[o];if((l.width>=a||l.height>=a)&&i(l,e[o+1])){n=o;break}}return n}}const fl={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},de=fl,gl={HLS:"h"},ml=gl;class Me{constructor(e,t){Array.isArray(e)&&(e=e.map(s=>s instanceof Me?s:new Me(s))),this.value=e,this.params=t;}}const pl="Dict";function yl(r){return Array.isArray(r)?JSON.stringify(r):r instanceof Map?"Map{}":r instanceof Set?"Set{}":typeof r=="object"?JSON.stringify(r):String(r)}function Sl(r,e,t,s){return new Error(`failed to ${r} "${yl(e)}" as ${t}`,{cause:s})}function Ne(r,e,t){return Sl("serialize",r,e,t)}class Jn{constructor(e){this.description=e;}}const Yi="Bare Item",El="Boolean";function Tl(r){if(typeof r!="boolean")throw Ne(r,El);return r?"?1":"?0"}function xl(r){return btoa(String.fromCharCode(...r))}const vl="Byte Sequence";function Al(r){if(ArrayBuffer.isView(r)===false)throw Ne(r,vl);return `:${xl(r)}:`}const Il="Integer";function Rl(r){return r<-999999999999999||999999999999999<r}function er(r){if(Rl(r))throw Ne(r,Il);return r.toString()}function Ll(r){return `@${er(r.getTime()/1e3)}`}function tr(r,e){if(r<0)return -tr(-r,e);const t=Math.pow(10,e);if(Math.abs(r*t%1-.5)<Number.EPSILON){const i=Math.floor(r*t);return (i%2===0?i:i+1)/t}else return Math.round(r*t)/t}const bl="Decimal";function _l(r){const e=tr(r,3);if(Math.floor(Math.abs(e)).toString().length>12)throw Ne(r,bl);const t=e.toString();return t.includes(".")?t:`${t}.0`}const Dl="String",Pl=/[\x00-\x1f\x7f]+/;function Cl(r){if(Pl.test(r))throw Ne(r,Dl);return `"${r.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function kl(r){return r.description||r.toString().slice(7,-1)}const wl="Token";function Wi(r){const e=kl(r);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===false)throw Ne(e,wl);return e}function ks(r){switch(typeof r){case "number":if(!B(r))throw Ne(r,Yi);return Number.isInteger(r)?er(r):_l(r);case "string":return Cl(r);case "symbol":return Wi(r);case "boolean":return Tl(r);case "object":if(r instanceof Date)return Ll(r);if(r instanceof Uint8Array)return Al(r);if(r instanceof Jn)return Wi(r);default:throw Ne(r,Yi)}}const Ol="Key";function ws(r){if(/^[a-z*][a-z0-9\-_.*]*$/.test(r)===false)throw Ne(r,Ol);return r}function Qs(r){return r==null?"":Object.entries(r).map(([e,t])=>t===true?`;${ws(e)}`:`;${ws(e)}=${ks(t)}`).join("")}function sr(r){return r instanceof Me?`${ks(r.value)}${Qs(r.params)}`:ks(r)}function Fl(r){return `(${r.value.map(sr).join(" ")})${Qs(r.params)}`}function Ml(r,e={whitespace:true}){if(typeof r!="object"||r==null)throw Ne(r,pl);const t=r instanceof Map?r.entries():Object.entries(r),s=e?.whitespace?" ":"";return Array.from(t).map(([i,n])=>{n instanceof Me||(n=new Me(n));let a=ws(i);return n.value===true?a+=Qs(n.params):(a+="=",Array.isArray(n.value)?a+=Fl(n):a+=sr(n)),a}).join(`,${s}`)}function ir(r,e){return Ml(r,e)}const Ce="CMCD-Object",ne="CMCD-Request",Xe="CMCD-Session",Ve="CMCD-Status",Nl={br:Ce,ab:Ce,d:Ce,ot:Ce,tb:Ce,tpb:Ce,lb:Ce,tab:Ce,lab:Ce,url:Ce,pb:ne,bl:ne,tbl:ne,dl:ne,ltc:ne,mtp:ne,nor:ne,nrr:ne,rc:ne,sn:ne,sta:ne,su:ne,ttfb:ne,ttfbb:ne,ttlb:ne,cmsdd:ne,cmsds:ne,smrt:ne,df:ne,cs:ne,ts:ne,cid:Xe,pr:Xe,sf:Xe,sid:Xe,st:Xe,v:Xe,msd:Xe,bs:Ve,bsd:Ve,cdn:Ve,rtp:Ve,bg:Ve,pt:Ve,ec:Ve,e:Ve},Bl={REQUEST:ne};function Ul(r){return Object.keys(r).reduce((e,t)=>{var s;return (s=r[t])===null||s===void 0||s.forEach(i=>e[i]=t),e},{})}function $l(r,e){const t={};if(!r)return t;const s=Object.keys(r),i=e?Ul(e):{};return s.reduce((n,a)=>{var o;const l=Nl[a]||i[a]||Bl.REQUEST,c=(o=n[l])!==null&&o!==void 0?o:n[l]={};return c[a]=r[a],n},t)}function Gl(r){return ["ot","sf","st","e","sta"].includes(r)}function Kl(r){return typeof r=="number"?B(r):r!=null&&r!==""&&r!==false}const nr="event";function Vl(r,e){const t=new URL(r),s=new URL(e);if(t.origin!==s.origin)return r;const i=t.pathname.split("/").slice(1),n=s.pathname.split("/").slice(1,-1);for(;i[0]===n[0];)i.shift(),n.shift();for(;n.length;)n.shift(),i.unshift("..");return i.join("/")+t.search+t.hash}const Gt=r=>Math.round(r),Os=(r,e)=>Array.isArray(r)?r.map(t=>Os(t,e)):r instanceof Me&&typeof r.value=="string"?new Me(Os(r.value,e),r.params):(e.baseUrl&&(r=Vl(r,e.baseUrl)),e.version===1?encodeURIComponent(r):r),kt=r=>Gt(r/100)*100,Hl=(r,e)=>{let t=r;return e.version>=2&&(r instanceof Me&&typeof r.value=="string"?t=new Me([r]):typeof r=="string"&&(t=[r])),Os(t,e)},Yl={br:Gt,d:Gt,bl:kt,dl:kt,mtp:kt,nor:Hl,rtp:kt,tb:Gt},rr="request",ar="response",Xs=["ab","bg","bl","br","bs","bsd","cdn","cid","cs","df","ec","lab","lb","ltc","msd","mtp","pb","pr","pt","sf","sid","sn","st","sta","tab","tb","tbl","tpb","ts","v"],Wl=["e"],ql=/^[a-zA-Z0-9-.]+-[a-zA-Z0-9-.]+$/;function es(r){return ql.test(r)}function jl(r){return Xs.includes(r)||Wl.includes(r)||es(r)}const or=["d","dl","nor","ot","rtp","su"];function zl(r){return Xs.includes(r)||or.includes(r)||es(r)}const Ql=["cmsdd","cmsds","rc","smrt","ttfb","ttfbb","ttlb","url"];function Xl(r){return Xs.includes(r)||or.includes(r)||Ql.includes(r)||es(r)}const Zl=["bl","br","bs","cid","d","dl","mtp","nor","nrr","ot","pr","rtp","sf","sid","st","su","tb","v"];function Jl(r){return Zl.includes(r)||es(r)}const ec={[ar]:Xl,[nr]:jl,[rr]:zl};function lr(r,e={}){const t={};if(r==null||typeof r!="object")return t;const s=e.version||r.v||1,i=e.reportingMode||rr,n=s===1?Jl:ec[i];let a=Object.keys(r).filter(n);const o=e.filter;typeof o=="function"&&(a=a.filter(o));const l=i===ar||i===nr;l&&!a.includes("ts")&&a.push("ts"),s>1&&!a.includes("v")&&a.push("v");const c=ie({},Yl,e.formatters),h={version:s,reportingMode:i,baseUrl:e.baseUrl};return a.sort().forEach(u=>{let d=r[u];const g=c[u];if(typeof g=="function"&&(d=g(d,h)),u==="v"){if(s===1)return;d=s;}u=="pr"&&d===1||(l&&u==="ts"&&!B(d)&&(d=Date.now()),Kl(d)&&(Gl(u)&&typeof d=="string"&&(d=new Jn(d)),t[u]=d));}),t}function tc(r,e={}){const t={};if(!r)return t;const s=lr(r,e),i=$l(s,e?.customHeaderMap);return Object.entries(i).reduce((n,[a,o])=>{const l=ir(o,{whitespace:false});return l&&(n[a]=l),n},t)}function sc(r,e,t){return ie(r,tc(e,t))}const ic="CMCD";function nc(r,e={}){return r?ir(lr(r,e),{whitespace:false}):""}function rc(r,e={}){if(!r)return "";const t=nc(r,e);return encodeURIComponent(t)}function ac(r,e={}){if(!r)return "";const t=rc(r,e);return `${ic}=${t}`}const qi=/CMCD=[^&#]+/;function oc(r,e,t){const s=ac(e,t);if(!s)return r;if(qi.test(r))return r.replace(qi,s);const i=r.includes("?")?"&":"?";return `${r}${i}${s}`}class lc{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=false,this.includeKeys=void 0,this.initialized=false,this.starved=false,this.buffering=true,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=true),this.buffering=true;},this.onPlaying=()=>{this.initialized||(this.initialized=true),this.buffering=false;},this.applyPlaylistData=i=>{try{this.apply(i,{ot:de.MANIFEST,su:!this.initialized});}catch(n){this.hls.logger.warn("Could not generate manifest CMCD data.",n);}},this.applyFragmentData=i=>{try{const{frag:n,part:a}=i,o=this.hls.levels[n.level],l=this.getObjectType(n),c={d:(a||n).duration*1e3,ot:l};(l===de.VIDEO||l===de.AUDIO||l==de.MUXED)&&(c.br=o.bitrate/1e3,c.tb=this.getTopBandwidth(l)/1e3,c.bl=this.getBufferLength(l));const h=a?this.getNextPart(a):this.getNextFrag(n);h!=null&&h.url&&h.url!==n.url&&(c.nor=h.url),this.apply(i,c);}catch(n){this.hls.logger.warn("Could not generate segment CMCD data.",n);}},this.hls=e;const t=this.config=e.config,{cmcd:s}=t;s!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=s.sessionId||e.sessionId,this.cid=s.contentId,this.useHeaders=s.useHeaders===true,this.includeKeys=s.includeKeys,this.registerListeners());}registerListeners(){const e=this.hls;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHED,this.onMediaDetached,this),e.on(y.BUFFER_CREATED,this.onBufferCreated,this);}unregisterListeners(){const e=this.hls;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHED,this.onMediaDetached,this),e.off(y.BUFFER_CREATED,this.onBufferCreated,this);}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null;}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying);}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null);}onBufferCreated(e,t){var s,i;this.audioBuffer=(s=t.tracks.audio)==null?void 0:s.buffer,this.videoBuffer=(i=t.tracks.video)==null?void 0:i.buffer;}createData(){var e;return {v:1,sf:ml.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){ie(t,this.createData());const s=t.ot===de.INIT||t.ot===de.VIDEO||t.ot===de.MUXED;this.starved&&s&&(t.bs=true,t.su=true,this.starved=false),t.su==null&&(t.su=this.buffering);const{includeKeys:i}=this;i&&(t=Object.keys(t).reduce((a,o)=>(i.includes(o)&&(a[o]=t[o]),a),{}));const n={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),sc(e.headers,t,n)):e.url=oc(e.url,t,n);}getNextFrag(e){var t;const s=(t=this.hls.levels[e.level])==null?void 0:t.details;if(s){const i=e.sn-s.startSN;return s.fragments[i+1]}}getNextPart(e){var t;const{index:s,fragment:i}=e,n=(t=this.hls.levels[i.level])==null||(t=t.details)==null?void 0:t.partList;if(n){const{sn:a}=i;for(let o=n.length-1;o>=0;o--){const l=n[o];if(l.index===s&&l.fragment.sn===a)return n[o+1]}}}getObjectType(e){const{type:t}=e;if(t==="subtitle")return de.TIMED_TEXT;if(e.sn==="initSegment")return de.INIT;if(t==="audio")return de.AUDIO;if(t==="main")return this.hls.audioTracks.length?de.VIDEO:de.MUXED}getTopBandwidth(e){let t=0,s;const i=this.hls;if(e===de.AUDIO)s=i.audioTracks;else {const n=i.maxAutoLevel,a=n>-1?n+1:i.levels.length;s=i.levels.slice(0,a);}return s.forEach(n=>{n.bitrate>t&&(t=n.bitrate);}),t>0?t:NaN}getBufferLength(e){const t=this.media,s=e===de.AUDIO?this.audioBuffer:this.videoBuffer;return !s||!t?NaN:J.bufferInfo(s,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,s=e||this.config.loader;return class{constructor(n){this.loader=void 0,this.loader=new s(n);}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy();}abort(){this.loader.abort();}load(n,a,o){t(n),this.loader.load(n,a,o);}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,s=e||this.config.loader;return class{constructor(n){this.loader=void 0,this.loader=new s(n);}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy();}abort(){this.loader.abort();}load(n,a,o){t(n),this.loader.load(n,a,o);}}}}const cc=3e5;class hc extends be{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=false,this.enabled=true,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners();}registerListeners(){const e=this.hls;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.ERROR,this.onError,this);}unregisterListeners(){const e=this.hls;e&&(e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.ERROR,this.onError,this));}pathways(){return (this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e);}startLoad(){if(this.started=true,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri);}}stopLoad(){this.started=false,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout();}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1);}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null;}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(s=>s!==e));}onManifestLoading(){this.stopLoad(),this.enabled=true,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null;}onManifestLoaded(e,t){const{contentSteering:s}=t;s!==null&&(this.pathwayId=s.pathwayId,this.uri=s.uri,this.started&&this.startLoad());}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks;}onError(e,t){const{errorAction:s}=t;if(s?.action===ce.SendAlternateToPenaltyBox&&s.flags===me.MoveAllAlternatesMatchingHost){const i=this.levels;let n=this._pathwayPriority,a=this.pathwayId;if(t.context){const{groupId:o,pathwayId:l,type:c}=t.context;o&&i?a=this.getPathwayForGroupId(o,c,a):l&&(a=l);}a in this.penalizedPathways||(this.penalizedPathways[a]=performance.now()),!n&&i&&(n=this.pathways()),n&&n.length>1&&(this.updatePathwayPriority(n),s.resolved=this.pathwayId!==a),t.details===_.BUFFER_APPEND_ERROR&&!t.fatal?s.resolved=true:s.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${a} levels: ${i&&i.length} priorities: ${se(n)} penalized: ${se(this.penalizedPathways)}`);}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const s=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${s}"`),t=this.getLevelsForPathway(s),this.pathwayId=s;}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t;const s=this.penalizedPathways,i=performance.now();Object.keys(s).forEach(n=>{i-s[n]>cc&&delete s[n];});for(let n=0;n<e.length;n++){const a=e[n];if(a in s)continue;if(a===this.pathwayId)return;const o=this.hls.nextLoadLevel,l=this.hls.levels[o];if(t=this.getLevelsForPathway(a),t.length>0){this.log(`Setting Pathway to "${a}"`),this.pathwayId=a,Xa(t),this.hls.trigger(y.LEVELS_UPDATED,{levels:t});const c=this.hls.levels[o];l&&c&&this.levels&&(c.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&c.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${c.bitrate}`),this.hls.nextLoadLevel=o);break}}}getPathwayForGroupId(e,t,s){const i=this.getLevelsForPathway(s).concat(this.levels||[]);for(let n=0;n<i.length;n++)if(t===$e.AUDIO_TRACK&&i[n].hasAudioGroup(e)||t===$e.SUBTITLE_TRACK&&i[n].hasSubtitleGroup(e))return i[n].pathwayId;return s}clonePathways(e){const t=this.levels;if(!t)return;const s={},i={};e.forEach(n=>{const{ID:a,"BASE-ID":o,"URI-REPLACEMENT":l}=n;if(t.some(h=>h.pathwayId===a))return;const c=this.getLevelsForPathway(o).map(h=>{const u=new At(h.attrs);u["PATHWAY-ID"]=a;const d=u.AUDIO&&`${u.AUDIO}_clone_${a}`,g=u.SUBTITLES&&`${u.SUBTITLES}_clone_${a}`;d&&(s[u.AUDIO]=d,u.AUDIO=d),g&&(i[u.SUBTITLES]=g,u.SUBTITLES=g);const f=cr(h.uri,u["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),m=new Vt({attrs:u,audioCodec:h.audioCodec,bitrate:h.bitrate,height:h.height,name:h.name,url:f,videoCodec:h.videoCodec,width:h.width});if(h.audioGroups)for(let p=1;p<h.audioGroups.length;p++)m.addGroupId("audio",`${h.audioGroups[p]}_clone_${a}`);if(h.subtitleGroups)for(let p=1;p<h.subtitleGroups.length;p++)m.addGroupId("text",`${h.subtitleGroups[p]}_clone_${a}`);return m});t.push(...c),ji(this.audioTracks,s,l,a),ji(this.subtitleTracks,i,l,a);});}loadSteeringManifest(e){const t=this.hls.config,s=t.loader;this.loader&&this.loader.destroy(),this.loader=new s(t);let i;try{i=new self.URL(e);}catch{this.enabled=false,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(i.protocol!=="data:"){const h=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;i.searchParams.set("_HLS_pathway",this.pathwayId),i.searchParams.set("_HLS_throughput",""+h);}const n={responseType:"json",url:i.href},a=t.steeringManifestLoadPolicy.default,o=a.errorRetry||a.timeoutRetry||{},l={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},c={onSuccess:(h,u,d,g)=>{this.log(`Loaded steering manifest: "${i}"`);const f=h.data;if(f?.VERSION!==1){this.log(`Steering VERSION ${f.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=f.TTL;const{"RELOAD-URI":m,"PATHWAY-CLONES":p,"PATHWAY-PRIORITY":S}=f;if(m)try{this.uri=new self.URL(m,i).href;}catch{this.enabled=false,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${m}`);return}this.scheduleRefresh(this.uri||d.url),p&&this.clonePathways(p);const E={steeringManifest:f,url:i.toString()};this.hls.trigger(y.STEERING_MANIFEST_LOADED,E),S&&this.updatePathwayPriority(S);},onError:(h,u,d,g)=>{if(this.log(`Error loading steering manifest: ${h.code} ${h.text} (${u.url})`),this.stopLoad(),h.code===410){this.enabled=false,this.log(`Steering manifest ${u.url} no longer available`);return}let f=this.timeToLoad*1e3;if(h.code===429){const m=this.loader;if(typeof m?.getResponseHeader=="function"){const p=m.getResponseHeader("Retry-After");p&&(f=parseFloat(p)*1e3);}this.log(`Steering manifest ${u.url} rate limited`);return}this.scheduleRefresh(this.uri||u.url,f);},onTimeout:(h,u,d)=>{this.log(`Timeout loading steering manifest (${u.url})`),this.scheduleRefresh(this.uri||u.url);}};this.log(`Requesting steering manifest: ${i}`),this.loader.load(n,l,c);}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var s;const i=(s=this.hls)==null?void 0:s.media;if(i&&!i.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3);},t);}}function ji(r,e,t,s){r&&Object.keys(e).forEach(i=>{const n=r.filter(a=>a.groupId===i).map(a=>{const o=ie({},a);return o.details=void 0,o.attrs=new At(o.attrs),o.url=o.attrs.URI=cr(a.url,a.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),o.groupId=o.attrs["GROUP-ID"]=e[i],o.attrs["PATHWAY-ID"]=s,o});r.push(...n);});}function cr(r,e,t,s){const{HOST:i,PARAMS:n,[t]:a}=s;let o;e&&(o=a?.[e],o&&(r=o));const l=new self.URL(r);return i&&!o&&(l.host=i),n&&Object.keys(n).sort().forEach(c=>{c&&l.searchParams.set(c,n[c]);}),l.href}class lt extends be{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.mediaResolved=void 0,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=lt.CDMCleanupPromise?[lt.CDMCleanupPromise]:[],this.bannedKeyIds={},this.onMediaEncrypted=t=>{const{initDataType:s,initData:i}=t,n=`"${t.type}" event: init data type: "${s}"`;if(this.debug(n),i!==null){if(!this.keyFormatPromise){let a=Object.keys(this.keySystemAccessPromises);a.length||(a=_t(this.config));const o=a.map(ls).filter(l=>!!l);this.keyFormatPromise=this.getKeyFormatPromise(o);}this.keyFormatPromise.then(a=>{const o=os(a);if(s!=="sinf"||o!==te.FAIRPLAY){this.log(`Ignoring "${t.type}" event with init data type: "${s}" for selected key-system ${o}`);return}let l;try{const g=ae(new Uint8Array(i)),f=Ba(JSON.parse(g).sinf),m=fn(f);if(!m)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");l=new Uint8Array(m.subarray(8,24));}catch(g){this.warn(`${n} Failed to parse sinf: ${g}`);return}const c=xe(l),{keyIdToKeySessionPromise:h,mediaKeySessions:u}=this;let d=h[c];for(let g=0;g<u.length;g++){const f=u[g],m=f.decryptdata;if(!m.keyId)continue;const p=xe(m.keyId);if(Na(l,m.keyId)||m.uri.replace(/-/g,"").indexOf(c)!==-1){if(d=h[p],!d)continue;if(m.pssh)break;delete h[p],m.pssh=new Uint8Array(i),m.keyId=l,d=h[c]=d.then(()=>this.generateRequestWithPreferredKeySession(f,s,i,"encrypted-event-key-match")),d.catch(S=>this.handleError(S));break}}d||this.handleError(new Error(`Key ID ${c} not encountered in playlist. Key-system sessions ${u.length}.`));}).catch(a=>this.handleError(a));}},this.onWaitingForKey=t=>{this.log(`"${t.type}" event`);},this.hls=e,this.config=e.config,this.registerListeners();}destroy(){this.onDestroying(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null;}registerListeners(){this.hls.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(y.DESTROYING,this.onDestroying,this);}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(y.DESTROYING,this.onDestroying,this);}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:s}=this.config,i=t?.[e];if(i)return i.licenseUrl;if(e===te.WIDEVINE&&s)return s}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(t===void 0)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,s=t?.[e];if(s)return s.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`);}attemptKeySystemAccess(e){const t=this.hls.levels,s=(a,o,l)=>!!a&&l.indexOf(a)===o,i=t.map(a=>a.audioCodec).filter(s),n=t.map(a=>a.videoCodec).filter(s);return i.length+n.length===0&&n.push("avc1.42e01e"),new Promise((a,o)=>{const l=c=>{const h=c.shift();this.getMediaKeysPromise(h,i,n).then(u=>a({keySystem:h,mediaKeys:u})).catch(u=>{c.length?l(c):u instanceof ge?o(u):o(new ge({type:G.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_NO_ACCESS,error:u,fatal:true},u.message));});};l(e);})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:s}=this.config;if(typeof s!="function"){let i=`Configured requestMediaKeySystemAccess is not a function ${s}`;return Rn===null&&self.location.protocol==="http:"&&(i=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(i))}return s(e,t)}getMediaKeysPromise(e,t,s){var i;const n=$a(e,t,s,this.config.drmSystemOptions||{});let a=this.keySystemAccessPromises[e],o=(i=a)==null?void 0:i.keySystemAccess;if(!o){this.log(`Requesting encrypted media "${e}" key-system access with config: ${se(n)}`),o=this.requestMediaKeySystemAccess(e,n);const l=a=this.keySystemAccessPromises[e]={keySystemAccess:o};return o.catch(c=>{this.log(`Failed to obtain access to key-system "${e}": ${c}`);}),o.then(c=>{this.log(`Access for key-system "${c.keySystem}" obtained`);const h=this.fetchServerCertificate(e);this.log(`Create media-keys for "${e}"`);const u=l.mediaKeys=c.createMediaKeys().then(d=>(this.log(`Media-keys created for "${e}"`),l.hasMediaKeys=true,h.then(g=>g?this.setMediaKeysServerCertificate(d,e,g):d)));return u.catch(d=>{this.error(`Failed to create media-keys for "${e}"}: ${d}`);}),u})}return o.then(()=>a.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:s}){this.log(`Creating key-system session "${t}" keyId: ${xe(e.keyId||[])} keyUri: ${e.uri}`);const i=s.createSession(),n={decryptdata:e,keySystem:t,mediaKeys:s,mediaKeysSession:i,keyStatus:"status-pending"};return this.mediaKeySessions.push(n),n}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const s=this.createMediaKeySessionContext(e),i=wt(t),n="cenc";this.keyIdToKeySessionPromise[i]=this.generateRequestWithPreferredKeySession(s,n,t.pssh.buffer,"expired");}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e);}updateKeySession(e,t){const s=e.mediaKeysSession;return this.log(`Updating key-session "${s.sessionId}" for keyId ${xe(e.decryptdata.keyId||[])}
      } (data length: ${t.byteLength})`),s.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>ls(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:t,mediaKeys:s})=>this.attemptSetMediaKeys(t,s))}selectKeySystem(e){return new Promise((t,s)=>{this.getKeySystemSelectionPromise(e).then(({keySystem:i})=>{const n=ls(i);n?t(n):s(new Error(`Unable to find format for key-system "${i}"`));}).catch(s);})}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){const t=_t(this.config),s=e.map(os).filter(i=>!!i&&t.indexOf(i)!==-1);return this.selectKeySystem(s)}getKeyStatus(e){const{mediaKeySessions:t}=this;for(let s=0;s<t.length;s++){const i=uc(e,t[s]);if(i)return i}}loadKey(e){const t=e.keyInfo.decryptdata,s=wt(t),i=this.bannedKeyIds[s];if(i||this.getKeyStatus(t)==="internal-error"){const o=zi(i||"internal-error",t);return this.handleError(o,e.frag),Promise.reject(o)}const n=`(keyId: ${s} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${n}`);const a=this.keyIdToKeySessionPromise[s];if(!a){const o=this.getKeySystemForKeyPromise(t).then(({keySystem:l,mediaKeys:c})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${n}`),this.attemptSetMediaKeys(l,c).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:l,mediaKeys:c,decryptdata:t}))))).then(l=>{const c="cenc",h=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(l,c,h,"playlist-key")});return o.catch(l=>this.handleError(l,e.frag)),this.keyIdToKeySessionPromise[s]=o,o}return a.catch(o=>{if(o instanceof ge){const l=ee({},o.data);this.getKeyStatus(t)==="internal-error"&&(l.decryptdata=t);const c=new ge(l,o.message);this.handleError(c,e.frag);}}),a}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e,t){if(this.hls)if(e instanceof ge){t&&(e.data.frag=t);const s=e.data.decryptdata;this.error(`${e.message}${s?` (${xe(s.keyId||[])})`:""}`),this.hls.trigger(y.ERROR,e.data);}else this.error(e.message),this.hls.trigger(y.ERROR,{type:G.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_NO_KEYS,error:e,fatal:true});}getKeySystemForKeyPromise(e){const t=wt(e),s=this.keyIdToKeySessionPromise[t];if(!s){const i=os(e.keyFormat),n=i?[i]:_t(this.config);return this.attemptKeySystemAccess(n)}return s}getKeySystemSelectionPromise(e){if(e.length||(e=_t(this.config)),e.length===0)throw new ge({type:G.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:true},`Missing key-system license configuration options ${se({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaResolved=void 0,this.mediaKeys===t)return Promise.resolve();const s=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const i=Promise.all(s).then(()=>this.media?this.media.setMediaKeys(t):new Promise((n,a)=>{this.mediaResolved=()=>{if(this.mediaResolved=void 0,!this.media)return a(new Error("Attempted to set mediaKeys without media element attached"));this.mediaKeys=t,this.media.setMediaKeys(t).then(n).catch(a);};}));return this.mediaKeys=t,this.setMediaKeysQueue.push(i),i.then(()=>{this.log(`Media-keys set for "${e}"`),s.push(i),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(n=>s.indexOf(n)===-1);})}generateRequestWithPreferredKeySession(e,t,s,i){var n;const a=(n=this.config.drmSystems)==null||(n=n[e.keySystem])==null?void 0:n.generateRequest;if(a)try{const f=a.call(this.hls,t,s,e);if(!f)throw new Error("Invalid response from configured generateRequest filter");t=f.initDataType,s=f.initData?f.initData:null,e.decryptdata.pssh=s?new Uint8Array(s):null;}catch(f){if(this.warn(f.message),this.hls&&this.hls.config.debug)throw f}if(s===null)return this.log(`Skipping key-session request for "${i}" (no initData)`),Promise.resolve(e);const o=wt(e.decryptdata),l=e.decryptdata.uri;this.log(`Generating key-session request for "${i}" keyId: ${o} URI: ${l} (init data type: ${t} length: ${s.byteLength})`);const c=new wn,h=e._onmessage=f=>{const m=e.mediaKeysSession;if(!m){c.emit("error",new Error("invalid state"));return}const{messageType:p,message:S}=f;this.log(`"${p}" message event for session "${m.sessionId}" message size: ${S.byteLength}`),p==="license-request"||p==="license-renewal"?this.renewLicense(e,S).catch(E=>{c.eventNames().length?c.emit("error",E):this.handleError(E);}):p==="license-release"?e.keySystem===te.FAIRPLAY&&this.updateKeySession(e,Di("acknowledged")).then(()=>this.removeSession(e)).catch(E=>this.handleError(E)):this.warn(`unhandled media key message type "${p}"`);},u=(f,m)=>{m.keyStatus=f;let p;f.startsWith("usable")?c.emit("resolved"):f==="internal-error"||f==="output-restricted"||f==="output-downscaled"?p=zi(f,m.decryptdata):f==="expired"?p=new Error(`key expired (keyId: ${o})`):f==="released"?p=new Error("key released"):f==="status-pending"||this.warn(`unhandled key status change "${f}" (keyId: ${o})`),p&&(c.eventNames().length?c.emit("error",p):this.handleError(p));},d=e._onkeystatuseschange=f=>{if(!e.mediaKeysSession){c.emit("error",new Error("invalid state"));return}const p=this.getKeyStatuses(e);if(!Object.keys(p).some(A=>p[A]!=="status-pending"))return;if(p[o]==="expired"){this.log(`Expired key ${se(p)} in key-session "${e.mediaKeysSession.sessionId}"`),this.renewKeySession(e);return}let E=p[o];if(E)u(E,e);else {var T;e.keyStatusTimeouts||(e.keyStatusTimeouts={}),(T=e.keyStatusTimeouts)[o]||(T[o]=self.setTimeout(()=>{if(!e.mediaKeysSession||!this.mediaKeys)return;const I=this.getKeyStatus(e.decryptdata);if(I&&I!=="status-pending")return this.log(`No status for keyId ${o} in key-session "${e.mediaKeysSession.sessionId}". Using session key-status ${I} from other session.`),u(I,e);this.log(`key status for ${o} in key-session "${e.mediaKeysSession.sessionId}" timed out after 1000ms`),E="internal-error",u(E,e);},1e3)),this.log(`No status for keyId ${o} (${se(p)}).`);}};Fe(e.mediaKeysSession,"message",h),Fe(e.mediaKeysSession,"keystatuseschange",d);const g=new Promise((f,m)=>{c.on("error",m),c.on("resolved",f);});return e.mediaKeysSession.generateRequest(t,s).then(()=>{this.log(`Request generated for key-session "${e.mediaKeysSession.sessionId}" keyId: ${o} URI: ${l}`);}).catch(f=>{throw new ge({type:G.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_NO_SESSION,error:f,decryptdata:e.decryptdata,fatal:false},`Error generating key-session request: ${f}`)}).then(()=>g).catch(f=>(c.removeAllListeners(),this.removeSession(e).then(()=>{throw f}))).then(()=>(c.removeAllListeners(),e))}getKeyStatuses(e){const t={};return e.mediaKeysSession.keyStatuses.forEach((s,i)=>{if(typeof i=="string"&&typeof s=="object"){const o=i;i=s,s=o;}const n="buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i);if(e.keySystem===te.PLAYREADY&&n.length===16){const o=xe(n);t[o]=s,Ua(n);}const a=xe(n);s==="internal-error"&&(this.bannedKeyIds[a]=s),this.log(`key status change "${s}" for keyStatuses keyId: ${a} key-session "${e.mediaKeysSession.sessionId}"`),t[a]=s;}),t}fetchServerCertificate(e){const t=this.config,s=t.loader,i=new s(t),n=this.getServerCertificateUrl(e);return n?(this.log(`Fetching server certificate for "${e}"`),new Promise((a,o)=>{const l={responseType:"arraybuffer",url:n},c=t.certLoadPolicy.default,h={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,g,f,m)=>{a(d.data);},onError:(d,g,f,m)=>{o(new ge({type:G.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:true,networkDetails:f,response:ee({url:l.url,data:void 0},d)},`"${e}" certificate request failed (${n}). Status: ${d.code} (${d.text})`));},onTimeout:(d,g,f)=>{o(new ge({type:G.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:true,networkDetails:f,response:{url:l.url,data:void 0}},`"${e}" certificate request timed out (${n})`));},onAbort:(d,g,f)=>{o(new Error("aborted"));}};i.load(l,h,u);})):Promise.resolve()}setMediaKeysServerCertificate(e,t,s){return new Promise((i,n)=>{e.setServerCertificate(s).then(a=>{this.log(`setServerCertificate ${a?"success":"not supported by CDM"} (${s.byteLength}) on "${t}"`),i(e);}).catch(a=>{n(new ge({type:G.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:a,fatal:true},a.message));});})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(s=>this.updateKeySession(e,new Uint8Array(s)).catch(i=>{throw new ge({type:G.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_SESSION_UPDATE_FAILED,decryptdata:e.decryptdata,error:i,fatal:false},i.message)}))}unpackPlayReadyKeyMessage(e,t){const s=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!s.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const i=new DOMParser().parseFromString(s,"application/xml"),n=i.querySelectorAll("HttpHeader");if(n.length>0){let h;for(let u=0,d=n.length;u<d;u++){var a,o;h=n[u];const g=(a=h.querySelector("name"))==null?void 0:a.textContent,f=(o=h.querySelector("value"))==null?void 0:o.textContent;g&&f&&e.setRequestHeader(g,f);}}const l=i.querySelector("Challenge"),c=l?.textContent;if(!c)throw new Error("Cannot find <Challenge> in key message");return Di(atob(c))}setupLicenseXHR(e,t,s,i){const n=this.config.licenseXhrSetup;return n?Promise.resolve().then(()=>{if(!s.decryptdata)throw new Error("Key removed");return n.call(this.hls,e,t,s,i)}).catch(a=>{if(!s.decryptdata)throw a;return e.open("POST",t,true),n.call(this.hls,e,t,s,i)}).then(a=>(e.readyState||e.open("POST",t,true),{xhr:e,licenseChallenge:a||i})):(e.open("POST",t,true),Promise.resolve({xhr:e,licenseChallenge:i}))}requestLicense(e,t){const s=this.config.keyLoadPolicy.default;return new Promise((i,n)=>{const a=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${a}`);const o=new XMLHttpRequest;o.responseType="arraybuffer",o.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return n(new Error("invalid state"));if(o.readyState===4)if(o.status===200){this._requestLicenseFailureCount=0;let l=o.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const c=this.config.licenseResponseCallback;if(c)try{l=c.call(this.hls,o,a,e);}catch(h){this.error(h);}i(l);}else {const l=s.errorRetry,c=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>c||o.status>=400&&o.status<500)n(new ge({type:G.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_LICENSE_REQUEST_FAILED,decryptdata:e.decryptdata,fatal:true,networkDetails:o,response:{url:a,data:void 0,code:o.status,text:o.statusText}},`License Request XHR failed (${a}). Status: ${o.status} (${o.statusText})`));else {const h=c-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${h} attempts left`),this.requestLicense(e,t).then(i,n);}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=o,this.setupLicenseXHR(o,a,e,t).then(({xhr:l,licenseChallenge:c})=>{e.keySystem==te.PLAYREADY&&(c=this.unpackPlayReadyKeyMessage(l,c)),l.send(c);}).catch(n);})}onDestroying(){this.unregisterListeners(),this._clear();}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const s=t.media;this.media=s,Fe(s,"encrypted",this.onMediaEncrypted),Fe(s,"waitingforkey",this.onWaitingForKey);const i=this.mediaResolved;i?i():this.mediaKeys=s.mediaKeys;}onMediaDetached(){const e=this.media;e&&(Ge(e,"encrypted",this.onMediaEncrypted),Ge(e,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null);}_clear(){var e;this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},this.bannedKeyIds={};const t=this.mediaResolved;if(t&&t(),!this.mediaKeys&&!this.mediaKeySessions.length)return;const s=this.media,i=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null;const n=i.length;lt.CDMCleanupPromise=Promise.all(i.map(a=>this.removeSession(a)).concat((s==null||(e=s.setMediaKeys(null))==null?void 0:e.catch(a=>{this.log(`Could not clear media keys: ${a}`),this.hls&&this.hls.trigger(y.ERROR,{type:G.OTHER_ERROR,details:_.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:false,error:new Error(`Could not clear media keys: ${a}`)});}))||Promise.resolve())).catch(a=>{this.log(`Could not close sessions and clear media keys: ${a}`),this.hls&&this.hls.trigger(y.ERROR,{type:G.OTHER_ERROR,details:_.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:false,error:new Error(`Could not close sessions and clear media keys: ${a}`)});}).then(()=>{n&&this.log("finished closing key sessions and clearing media keys");});}onManifestLoading(){this._clear();}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const s=t.reduce((i,n)=>(i.indexOf(n.keyFormat)===-1&&i.push(n.keyFormat),i),[]);this.log(`Selecting key-system from session-keys ${s.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(s);}}removeSession(e){const{mediaKeysSession:t,licenseXhr:s,decryptdata:i}=e;if(t){this.log(`Remove licenses and keys and close session "${t.sessionId}" keyId: ${xe(i?.keyId||[])}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),s&&s.readyState!==XMLHttpRequest.DONE&&s.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const n=this.mediaKeySessions.indexOf(e);n>-1&&this.mediaKeySessions.splice(n,1);const{keyStatusTimeouts:a}=e;a&&Object.keys(a).forEach(c=>self.clearTimeout(a[c]));const{drmSystemOptions:o}=this.config;return (Ka(o)?new Promise((c,h)=>{self.setTimeout(()=>h(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(c).catch(h);}):Promise.resolve()).catch(c=>{this.log(`Could not remove session: ${c}`),this.hls&&this.hls.trigger(y.ERROR,{type:G.OTHER_ERROR,details:_.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:false,error:new Error(`Could not remove session: ${c}`)});}).then(()=>t.close()).catch(c=>{this.log(`Could not close session: ${c}`),this.hls&&this.hls.trigger(y.ERROR,{type:G.OTHER_ERROR,details:_.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:false,error:new Error(`Could not close session: ${c}`)});})}return Promise.resolve()}}lt.CDMCleanupPromise=void 0;function wt(r){if(!r)throw new Error("Could not read keyId of undefined decryptdata");if(r.keyId===null)throw new Error("keyId is null");return xe(r.keyId)}function uc(r,e){if(r.keyId&&e.mediaKeysSession.keyStatuses.has(r.keyId))return e.mediaKeysSession.keyStatuses.get(r.keyId);if(r.matches(e.decryptdata))return e.keyStatus}class ge extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error;}}function zi(r,e){const t=r==="output-restricted",s=t?_.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:_.KEY_SYSTEM_STATUS_INTERNAL_ERROR;return new ge({type:G.KEY_SYSTEM_ERROR,details:s,fatal:false,decryptdata:e},t?"HDCP level output restricted":`key status changed to "${r}"`)}class dc{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=false,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners();}setStreamController(e){this.streamController=e;}registerListeners(){this.hls.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(y.MEDIA_DETACHING,this.onMediaDetaching,this);}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(y.MEDIA_DETACHING,this.onMediaDetaching,this);}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=false,this.media=null;}onMediaAttaching(e,t){const s=this.hls.config;if(s.capLevelOnFPSDrop){const i=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=i,i&&typeof i.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=true),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),s.fpsDroppedMonitoringPeriod);}}onMediaDetaching(){this.media=null;}checkFPS(e,t,s){const i=performance.now();if(t){if(this.lastTime){const n=i-this.lastTime,a=s-this.lastDroppedFrames,o=t-this.lastDecodedFrames,l=1e3*a/n,c=this.hls;if(c.trigger(y.FPS_DROP,{currentDropped:a,currentDecoded:o,totalDroppedFrames:s}),l>0&&a>c.config.fpsDroppedMonitoringThreshold*o){let h=c.currentLevel;c.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+h),h>0&&(c.autoLevelCapping===-1||c.autoLevelCapping>=h)&&(h=h-1,c.trigger(y.FPS_DROP_LEVEL_CAPPING,{level:h,droppedLevel:c.currentLevel}),c.autoLevelCapping=h,this.streamController.nextLevelSwitch());}}this.lastTime=i,this.lastDroppedFrames=s,this.lastDecodedFrames=t;}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames);}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount);}}function fc(r,e){let t;try{t=new Event("addtrack");}catch{t=document.createEvent("Event"),t.initEvent("addtrack",false,false);}t.track=r,e.dispatchEvent(t);}function hr(r,e){const t=r.mode;if(t==="disabled"&&(r.mode="hidden"),r.cues&&!r.cues.getCueById(e.id))try{if(r.addCue(e),!r.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(s){re.debug(`[texttrack-utils]: ${s}`);try{const i=new self.TextTrackCue(e.startTime,e.endTime,e.text);i.id=e.id,r.addCue(i);}catch(i){re.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${i}`);}}t==="disabled"&&(r.mode=t);}function pt(r,e){const t=r.mode;if(t==="disabled"&&(r.mode="hidden"),r.cues)for(let s=r.cues.length;s--;)r.removeCue(r.cues[s]);t==="disabled"&&(r.mode=t);}function Qi(r,e,t,s){const i=r.mode;if(i==="disabled"&&(r.mode="hidden"),r.cues&&r.cues.length>0){const n=mc(r.cues,e,t);for(let a=0;a<n.length;a++)r.removeCue(n[a]);}i==="disabled"&&(r.mode=i);}function gc(r,e){if(e<=r[0].startTime)return 0;const t=r.length-1;if(e>r[t].endTime)return  -1;let s=0,i=t,n;for(;s<=i;)if(n=Math.floor((i+s)/2),e<r[n].startTime)i=n-1;else if(e>r[n].startTime&&s<t)s=n+1;else return n;return r[s].startTime-e<e-r[i].startTime?s:i}function mc(r,e,t){const s=[],i=gc(r,e);if(i>-1)for(let n=i,a=r.length;n<a;n++){const o=r[n];if(o.startTime>=e&&o.endTime<=t)s.push(o);else if(o.startTime>t)return s}return s}function Kt(r){const e=[];for(let t=0;t<r.length;t++){const s=r[t];(s.kind==="subtitles"||s.kind==="captions")&&s.label&&e.push(r[t]);}return e}class pc extends Qn{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=true,this.queuedDefaultTrack=-1,this.useTextTrackPolling=false,this.subtitlePollingInterval=-1,this._subtitleDisplay=true,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const s=Kt(this.media.textTracks);for(let n=0;n<s.length;n++)if(s[n].mode==="hidden")t=s[n];else if(s[n].mode==="showing"){t=s[n];break}const i=this.findTrackForTextTrack(t);this.subtitleTrack!==i&&this.setSubtitleTrack(i);},this.registerListeners();}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy();}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes();}registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(y.ERROR,this.onError,this);}unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVEL_LOADING,this.onLevelLoading,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(y.ERROR,this.onError,this);}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange));}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e);}onMediaDetaching(e,t){const s=this.media;if(!s)return;const i=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||s.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,i)return;Kt(s.textTracks).forEach(a=>{pt(a);});}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=true;}onManifestParsed(e,t){this.tracks=t.subtitleTracks;}onSubtitleTrackLoaded(e,t){const{id:s,groupId:i,details:n}=t,a=this.tracksInGroup[s];if(!a||a.groupId!==i){this.warn(`Subtitle track with id:${s} and group:${i} not found in active group ${a?.groupId}`);return}const o=a.details;a.details=t.details,this.log(`Subtitle track ${s} "${a.name}" lang:${a.lang} group:${i} loaded [${n.startSN}-${n.endSN}]`),s===this.trackId&&this.playlistLoaded(s,t,o);}onLevelLoading(e,t){this.switchLevel(t.level);}onLevelSwitching(e,t){this.switchLevel(t.level);}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const s=t.subtitleGroups||null,i=this.groupIds;let n=this.currentTrack;if(!s||i?.length!==s?.length||s!=null&&s.some(a=>i?.indexOf(a)===-1)){this.groupIds=s,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(h=>!s||s.indexOf(h.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(h=>h.default)&&(this.selectDefaultTrack=false),a.forEach((h,u)=>{h.id=u;});else if(!n&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const o=this.hls.config.subtitlePreference;if(!n&&o){this.selectDefaultTrack=false;const h=Oe(o,a);if(h>-1)n=a[h];else {const u=Oe(o,this.tracks);n=this.tracks[u];}}let l=this.findTrackId(n);l===-1&&n&&(l=this.findTrackId(null));const c={subtitleTracks:a};this.log(`Updating subtitle tracks, ${a.length} track(s) found in "${s?.join(",")}" group-id`),this.hls.trigger(y.SUBTITLE_TRACKS_UPDATED,c),l!==-1&&this.trackId===-1&&this.setSubtitleTrack(l);}}findTrackId(e){const t=this.tracksInGroup,s=this.selectDefaultTrack;for(let i=0;i<t.length;i++){const n=t[i];if(!(s&&!n.default||!s&&!e)&&(!e||tt(n,e)))return i}if(e){for(let i=0;i<t.length;i++){const n=t[i];if(vt(e.attrs,n.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<t.length;i++){const n=t[i];if(vt(e.attrs,n.attrs,["LANGUAGE"]))return i}}return  -1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let s=0;s<t.length;s++){const i=t[s];if(Cs(i,e))return s}}return  -1}onError(e,t){t.fatal||!t.context||t.context.type===$e.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t);}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=false,this.setSubtitleTrack(e);}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=false,t.length){const s=this.currentTrack;if(s&&tt(e,s))return s;const i=Oe(e,this.tracksInGroup);if(i>-1){const n=this.tracksInGroup[i];return this.setSubtitleTrack(i),n}else {if(s)return null;{const n=Oe(e,t);if(n>-1)return t[n]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e);}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const s=e.id,i=e.groupId,n=this.getUrlWithDirectives(e.url,t),a=e.details,o=a?.age;this.log(`Loading subtitle ${s} "${e.name}" lang:${e.lang} group:${i}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${o&&a.live?" age "+o.toFixed(1)+(a.type&&" "+a.type||""):""} ${n}`),this.hls.trigger(y.SUBTITLE_TRACK_LOADING,{url:n,id:s,groupId:i,deliveryDirectives:t||null,track:e});}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=Kt(e.textTracks),s=this.currentTrack;let i;if(s&&(i=t.filter(n=>Cs(s,n))[0],i||this.warn(`Unable to find subtitle TextTrack with name "${s.name}" and language "${s.lang}"`)),[].slice.call(t).forEach(n=>{n.mode!=="disabled"&&n!==i&&(n.mode="disabled");}),i){const n=this.subtitleDisplay?"showing":"hidden";i.mode!==n&&(i.mode=n);}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!B(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=false;const s=this.currentTrack,i=t[e]||null;if(this.trackId=e,this.currentTrack=i,this.toggleTrackModes(),!i){this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:e});return}const n=!!i.details&&!i.details.live;if(e===this.trackId&&i===s&&n)return;this.log(`Switching to subtitle-track ${e}`+(i?` "${i.name}" lang:${i.lang} group:${i.groupId}`:""));const{id:a,groupId:o="",name:l,type:c,url:h}=i;this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:a,groupId:o,name:l,type:c,url:h});const u=this.switchParams(i.url,s?.details,i.details);this.loadPlaylist(u);}}function Et(r){let e=5381,t=r.length;for(;t;)e=e*33^r.charCodeAt(--t);return (e>>>0).toString()}const ct=.025;let Xt=(function(r){return r[r.Point=0]="Point",r[r.Range=1]="Range",r})({});function yc(r,e,t){return `${r.identifier}-${t+1}-${Et(e)}`}class Sc{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=false,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:false,jump:false},this.snapOptions={out:false,in:false},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e);}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions);}reset(){var e;this.appendInPlaceStarted=false,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null);}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return  true;const s=this.playoutLimit;return e<=0||isNaN(s)?false:s===0?true:(((t=this.assetList[e])==null?void 0:t.startOffset)||0)>s}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return ps(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return  true;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime,s=ps(t,e);return t-s<.1}return  false}get resumptionOffset(){const e=this.resumeOffset,t=B(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return ps(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?true:this.appendInPlaceDisabled?false:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<ct))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e;}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e;}get duration(){const e=this.playoutLimit;let t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e;}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?Xt.Range:Xt.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return Ec(this)}}function ps(r,e){return r-e.start<e.duration/2&&!(Math.abs(r-(e.start+e.duration))<ct)?e.start:e.start+e.duration}function ur(r,e,t){const s=new self.URL(r,t);return s.protocol!=="data:"&&s.searchParams.set("_HLS_primary_id",e),s}function ys(r,e){for(;(t=r.assetList[++e])!=null&&t.error;)var t;return e}function Ec(r){return `["${r.identifier}" ${r.cue.pre?"<pre>":r.cue.post?"<post>":""}${r.timelineStart.toFixed(2)}-${r.resumeTime.toFixed(2)}]`}function at(r){const e=r.timelineStart,t=r.duration||0;return `["${r.identifier}" ${e.toFixed(2)}-${(e+t).toFixed(2)}]`}class Tc{constructor(e,t,s,i){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=false,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls&&this.hls.trigger(y.PLAYOUT_LIMIT_REACHED,{});};const n=this.hls=new e(t);this.interstitial=s,this.assetItem=i;const a=()=>{this.hasDetails=true;};n.once(y.LEVEL_LOADED,a),n.once(y.AUDIO_TRACK_LOADED,a),n.once(y.SUBTITLE_TRACK_LOADED,a),n.on(y.MEDIA_ATTACHING,(o,{media:l})=>{this.removeMediaListeners(),this.mediaAttached=l,this.interstitial.playoutLimit&&(l.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&n.on(y.BUFFER_APPENDED,()=>{const h=this.bufferedEnd;this.reachedPlayout(h)&&(this._bufferedEosTime=h,n.trigger(y.BUFFERED_TO_END,void 0));}));});}get appendInPlace(){return this.interstitial.appendInPlace}loadSource(){const e=this.hls;if(e)if(e.url)e.levels.length&&!e.started&&e.startLoad(-1,true);else {let t=this.assetItem.uri;try{t=ur(t,e.config.primarySessionId||"").href;}catch{}e.loadSource(t);}}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return  false;if((t=this.hls)!=null&&t.bufferedToEnd)return  true;if(!e)return  false;const s=Math.min(this._bufferedEosTime||1/0,this.duration),i=this.timelineOffset,n=J.bufferInfo(e,i,0);return this.getAssetTime(n.end)>=s-.02}reachedPlayout(e){const s=this.interstitial.playoutLimit;return this.startOffset+e>=s}get destroyed(){var e;return !((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return ((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=J.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;if(!e)return 0;const t=this.interstitial.playoutLimit;if(t){const s=t-this.startOffset;if(s>0&&s<e)return s}return e}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return ((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const s=e-t;if(Math.abs(s)>1/9e4&&this.hls){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e;}}}getAssetTime(e){const t=this.timelineOffset,s=this.duration;return Math.min(Math.max(0,e-t),s)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout));}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd);}}destroy(){this.removeMediaListeners(),this.hls&&this.hls.destroy(),this.hls=null,this.tracks=this.mediaAttached=this.checkPlayout=null;}attachMedia(e){var t;this.loadSource(),(t=this.hls)==null||t.attachMedia(e);}detachMedia(){var e;this.removeMediaListeners(),this.mediaAttached=null,(e=this.hls)==null||e.detachMedia();}resumeBuffering(){var e;(e=this.hls)==null||e.resumeBuffering();}pauseBuffering(){var e;(e=this.hls)==null||e.pauseBuffering();}transferMedia(){var e;return this.bufferSnapShot(),((e=this.hls)==null?void 0:e.transferMedia())||null}resetDetails(){const e=this.hls;if(e&&this.hasDetails){e.stopLoad();const t=s=>delete s.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=false;}}on(e,t,s){var i;(i=this.hls)==null||i.on(e,t);}once(e,t,s){var i;(i=this.hls)==null||i.once(e,t);}off(e,t,s){var i;(i=this.hls)==null||i.off(e,t);}toString(){var e;return `HlsAssetPlayer: ${at(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}}const Xi=.033;class xc extends be{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e;}destroy(){this.reset(),this.onScheduleUpdate=null;}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null;}resetErrorsInRange(e,t){return this.events?this.events.reduce((s,i)=>e<=i.startOffset&&t>i.startOffset?(delete i.error,s+1):s,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let s=-1;e.nextEvent?s=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(s=this.findEventIndex(e.previousEvent.identifier)+1);const i=this.items;if(i)for(i[s]||(t===void 0&&(t=e.start),s=this.findItemIndexAtTime(t));s>=0&&(n=i[s])!=null&&n.event;){var n;s--;}return s}findItemIndexAtTime(e,t){const s=this.items;if(s)for(let i=0;i<s.length;i++){let n=s[i];if(t&&t!=="primary"&&(n=n[t]),e===n.start||e>n.start&&e<n.end)return i}return  -1}findJumpRestrictedIndex(e,t){const s=this.items;if(s)for(let i=e;i<=t&&s[i];i++){const n=s[i].event;if(n!=null&&n.restrictions.jump&&!n.appendInPlace)return i}return  -1}findEventIndex(e){const t=this.items;if(t)for(let i=t.length;i--;){var s;if(((s=t[i].event)==null?void 0:s.identifier)===e)return i}return  -1}findAssetIndex(e,t){const s=e.assetList,i=s.length;if(i>1)for(let n=0;n<i;n++){const a=s[n];if(!a.error){const o=a.timelineStart;if(t===o||t>o&&(t<o+(a.duration||0)||n===i-1))return n}}return 0}get assetIdAtEnd(){var e;const t=(e=this.items)==null||(e=e[this.length-1])==null?void 0:e.event;if(t){const s=t.assetList,i=s[s.length-1];if(i)return i.identifier}return null}parseInterstitialDateRanges(e,t){const s=e.main.details,{dateRanges:i}=s,n=this.events,a=this.parseDateRanges(i,{url:s.url},t),o=Object.keys(i),l=n?n.filter(c=>!o.includes(c.identifier)):[];a.length&&a.sort((c,h)=>{const u=c.cue.pre,d=c.cue.post,g=h.cue.pre,f=h.cue.post;if(u&&!g)return  -1;if(g&&!u||d&&!f)return 1;if(f&&!d)return  -1;if(!u&&!g&&!d&&!f){const m=c.startTime,p=h.startTime;if(m!==p)return m-p}return c.dateRange.tagOrder-h.dateRange.tagOrder}),this.events=a,l.forEach(c=>{this.removeEvent(c);}),this.updateSchedule(e,l);}updateSchedule(e,t=[],s=false){const i=this.events||[];if(i.length||t.length||this.length<2){const n=this.items,a=this.parseSchedule(i,e);(s||t.length||n?.length!==a.length||a.some((l,c)=>Math.abs(l.playout.start-n[c].playout.start)>.005||Math.abs(l.playout.end-n[c].playout.end)>.005))&&(this.items=a,this.onScheduleUpdate(t,n));}}parseDateRanges(e,t,s){const i=[],n=Object.keys(e);for(let a=0;a<n.length;a++){const o=n[a],l=e[o];if(l.isInterstitial){let c=this.eventMap[o];c?c.setDateRange(l):(c=new Sc(l,t),this.eventMap[o]=c,s===false&&(c.appendInPlace=s)),i.push(c);}}return i}parseSchedule(e,t){const s=[],i=t.main.details,n=i.live?1/0:i.edge;let a=0;if(e=e.filter(l=>!l.error&&!(l.cue.once&&l.hasPlayed)),e.length){this.resolveOffsets(e,t);let l=0,c=0;if(e.forEach((h,u)=>{const d=h.cue.pre,g=h.cue.post,f=e[u-1]||null,m=h.appendInPlace,p=g?n:h.startOffset,S=h.duration,E=h.timelineOccupancy===Xt.Range?S:0,T=h.resumptionOffset,A=f?.startTime===p,I=p+h.cumulativeDuration;let D=m?I+S:p+T;if(d||!g&&p<=0){const L=c;c+=E,h.timelineStart=I;const b=a;a+=S,s.push({event:h,start:I,end:D,playout:{start:b,end:a},integrated:{start:L,end:c}});}else if(p<=n){if(!A){const R=p-l;if(R>Xi){const P=l,O=c;c+=R;const N=a;a+=R;const U={previousEvent:e[u-1]||null,nextEvent:h,start:P,end:P+R,playout:{start:N,end:a},integrated:{start:O,end:c}};s.push(U);}else R>0&&f&&(f.cumulativeDuration+=R,s[s.length-1].end=p);}g&&(D=I),h.timelineStart=I;const L=c;c+=E;const b=a;a+=S,s.push({event:h,start:I,end:D,playout:{start:b,end:a},integrated:{start:L,end:c}});}else return;const v=h.resumeTime;g||v>n?l=n:l=v;}),l<n){var o;const h=l,u=c,d=n-l;c+=d;const g=a;a+=d,s.push({previousEvent:((o=s[s.length-1])==null?void 0:o.event)||null,nextEvent:null,start:l,end:h+d,playout:{start:g,end:a},integrated:{start:u,end:c}});}this.setDurations(n,a,c);}else s.push({previousEvent:null,nextEvent:null,start:0,end:n,playout:{start:0,end:n},integrated:{start:0,end:n}}),this.setDurations(n,n,n);return s}setDurations(e,t,s){this.durations={primary:e,playout:t,integrated:s};}resolveOffsets(e,t){const s=t.main.details,i=s.live?1/0:s.edge;let n=0,a=-1;e.forEach((o,l)=>{const c=o.cue.pre,h=o.cue.post,u=c?0:h?i:o.startTime;this.updateAssetDurations(o),a===u?o.cumulativeDuration=n:(n=0,a=u),!h&&o.snapOptions.in&&(o.resumeAnchor=ht(null,s.fragments,o.startOffset+o.resumptionOffset,0,0)||void 0),o.appendInPlace&&!o.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(o,t)||(o.appendInPlace=false)),!o.appendInPlace&&l+1<e.length&&e[l+1].startTime-e[l].resumeTime<Xi&&(e[l+1].appendInPlace=false,e[l+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${o}`));const g=B(o.resumeOffset)?o.resumeOffset:o.duration;n+=g;});}primaryCanResumeInPlaceAt(e,t){const s=e.resumeTime,i=e.startTime+e.resumptionOffset;return Math.abs(s-i)>ct?(this.log(`"${e.identifier}" resumption ${s} not aligned with estimated timeline end ${i}`),false):!Object.keys(t).some(a=>{const o=t[a].details,l=o.edge;if(s>=l)return this.log(`"${e.identifier}" resumption ${s} past ${a} playlist end ${l}`),false;const c=ht(null,o.fragments,s);if(!c)return this.log(`"${e.identifier}" resumption ${s} does not align with any fragments in ${a} playlist (${o.fragStart}-${o.fragmentEnd})`),true;const h=a==="audio"?.175:0;return Math.abs(c.start-s)<ct+h||Math.abs(c.end-s)<ct+h?false:(this.log(`"${e.identifier}" resumption ${s} not aligned with ${a} fragment bounds (${c.start}-${c.end} sn: ${c.sn} cc: ${c.cc})`),true)})}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let s=0,i=false,n=false;for(let a=0;a<e.assetList.length;a++){const o=e.assetList[a],l=t+s;o.startOffset=s,o.timelineStart=l,i||(i=o.duration===null),n||(n=!!o.error);const c=o.error?0:o.duration||0;s+=c;}i&&!n?e.duration=Math.max(s,e.duration):e.duration=s;}removeEvent(e){e.reset(),delete this.eventMap[e.identifier];}}function Re(r){return `[${r.event?'"'+r.event.identifier+'"':"primary"}: ${r.start.toFixed(2)}-${r.end.toFixed(2)}]`}class vc{constructor(e){this.hls=void 0,this.hls=e;}destroy(){this.hls=null;}loadAssetList(e,t){const s=e.assetListUrl;let i;try{i=ur(s,this.hls.sessionId,e.baseUrl);}catch(d){const g=this.assignAssetListError(e,_.ASSET_LIST_LOAD_ERROR,d,s);this.hls.trigger(y.ERROR,g);return}t&&i.protocol!=="data:"&&i.searchParams.set("_HLS_start_offset",""+t);const n=this.hls.config,a=n.loader,o=new a(n),l={responseType:"json",url:i.href},c=n.interstitialAssetListLoadPolicy.default,h={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,g,f,m)=>{const p=d.data,S=p?.ASSETS;if(!Array.isArray(S)){const E=this.assignAssetListError(e,_.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),f.url,g,m);this.hls.trigger(y.ERROR,E);return}e.assetListResponse=p,this.hls.trigger(y.ASSET_LIST_LOADED,{event:e,assetListResponse:p,networkDetails:m});},onError:(d,g,f,m)=>{const p=this.assignAssetListError(e,_.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${d.code} ${d.text} (${g.url})`),g.url,m,f);this.hls.trigger(y.ERROR,p);},onTimeout:(d,g,f)=>{const m=this.assignAssetListError(e,_.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${g.url})`),g.url,d,f);this.hls.trigger(y.ERROR,m);}};return o.load(l,h,u),this.hls.trigger(y.ASSET_LIST_LOADING,{event:e}),o}assignAssetListError(e,t,s,i,n,a){return e.error=s,{type:G.NETWORK_ERROR,details:t,fatal:false,interstitial:e,url:i,error:s,networkDetails:a,stats:n}}}function Zi(r){var e;r==null||(e=r.play())==null||e.catch(()=>{});}function Ot(r,e){return `[${r}] Advancing timeline position to ${e}`}class Ac extends be{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=false,this.onPlay=()=>{this.shouldPlay=true;},this.onPause=()=>{this.shouldPlay=false;},this.onSeeking=()=>{const s=this.currentTime;if(s===void 0||this.playbackDisabled||!this.schedule)return;const i=s-this.timelinePos;if(Math.abs(i)<1/7056e5)return;const a=i<=-0.01;this.timelinePos=s,this.bufferedPos=s;const o=this.playingItem;if(!o){this.checkBuffer();return}if(a&&this.schedule.resetErrorsInRange(s,s-i)&&this.updateSchedule(true),this.checkBuffer(),a&&s<o.start||s>=o.end){var l;const g=this.findItemIndex(o);let f=this.schedule.findItemIndexAtTime(s);if(f===-1&&(f=g+(a?-1:1),this.log(`seeked ${a?"back ":""}to position not covered by schedule ${s} (resolving from ${g} to ${f})`)),!this.isInterstitial(o)&&(l=this.media)!=null&&l.paused&&(this.shouldPlay=false),!a&&f>g){const m=this.schedule.findJumpRestrictedIndex(g+1,f);if(m>g){this.setSchedulePosition(m);return}}this.setSchedulePosition(f);return}const c=this.playingAsset;if(!c){if(this.playingLastItem&&this.isInterstitial(o)){const g=o.event.assetList[0];g&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(s,g));}return}const h=c.timelineStart,u=c.duration||0;if(a&&s<h||s>=h+u){var d;(d=o.event)!=null&&d.appendInPlace&&(this.clearAssetPlayers(o.event,o),this.flushFrontBuffer(s)),this.setScheduleToAssetAtTime(s,c);}},this.onTimeupdate=()=>{const s=this.currentTime;if(s===void 0||this.playbackDisabled)return;if(s>this.timelinePos)this.timelinePos=s,s>this.bufferedPos&&this.checkBuffer();else return;const i=this.playingItem;if(!i||this.playingLastItem)return;if(s>=i.end){this.timelinePos=i.end;const o=this.findItemIndex(i);this.setSchedulePosition(o+1);}const n=this.playingAsset;if(!n)return;const a=n.timelineStart+(n.duration||0);s>=a&&this.setScheduleToAssetAtTime(s,n);},this.onScheduleUpdate=(s,i)=>{const n=this.schedule;if(!n)return;const a=this.playingItem,o=n.events||[],l=n.items||[],c=n.durations,h=s.map(m=>m.identifier),u=!!(o.length||h.length);(u||i)&&this.log(`INTERSTITIALS_UPDATED (${o.length}): ${o}
Schedule: ${l.map(m=>Re(m))} pos: ${this.timelinePos}`),h.length&&this.log(`Removed events ${h}`);let d=null,g=null;a&&(d=this.updateItem(a,this.timelinePos),this.itemsMatch(a,d)?this.playingItem=d:this.waitingItem=this.endedItem=null),this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const f=this.bufferingItem;if(f&&(g=this.updateItem(f,this.bufferedPos),this.itemsMatch(f,g)?this.bufferingItem=g:f.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(f.event,null))),s.forEach(m=>{m.assetList.forEach(p=>{this.clearAssetPlayer(p.identifier,null);});}),this.playerQueue.forEach(m=>{if(m.interstitial.appendInPlace){const p=m.assetItem.timelineStart,S=m.timelineOffset-p;if(S)try{m.timelineOffset=p;}catch(E){Math.abs(S)>ct&&this.warn(`${E} ("${m.assetId}" ${m.timelineOffset}->${p})`);}}}),u||i){if(this.hls.trigger(y.INTERSTITIALS_UPDATED,{events:o.slice(0),schedule:l.slice(0),durations:c,removedIds:h}),this.isInterstitial(a)&&h.includes(a.event.identifier)){this.warn(`Interstitial "${a.event.identifier}" removed while playing`),this.primaryFallback(a.event);return}a&&this.trimInPlace(d,a),f&&g!==d&&this.trimInPlace(g,f),this.checkBuffer();}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new vc(e),this.schedule=new xc(this.onScheduleUpdate,e.logger),this.registerListeners();}registerListeners(){const e=this.hls;e&&(e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(y.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(y.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(y.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(y.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(y.BUFFER_APPENDED,this.onBufferAppended,this),e.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(y.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(y.MEDIA_ENDED,this.onMediaEnded,this),e.on(y.ERROR,this.onError,this),e.on(y.DESTROYING,this.onDestroying,this));}unregisterListeners(){const e=this.hls;e&&(e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(y.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(y.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(y.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(y.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(y.BUFFER_CODECS,this.onBufferCodecs,this),e.off(y.BUFFER_APPENDED,this.onBufferAppended,this),e.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(y.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(y.MEDIA_ENDED,this.onMediaEnded,this),e.off(y.ERROR,this.onError,this),e.off(y.DESTROYING,this.onDestroying,this));}startLoad(){this.resumeBuffering();}stopLoad(){this.pauseBuffering();}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering();}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering();}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.schedule=this.manager=null,this.hls=this.HlsPlayerClass=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null;}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e);}removeMediaListeners(e){Ge(e,"play",this.onPlay),Ge(e,"pause",this.onPause),Ge(e,"seeking",this.onSeeking),Ge(e,"timeupdate",this.onTimeupdate);}onMediaAttaching(e,t){const s=this.media=t.media;Fe(s,"seeking",this.onSeeking),Fe(s,"timeupdate",this.onTimeupdate),Fe(s,"play",this.onPlay),Fe(s,"pause",this.onPause);}onMediaAttached(e,t){const s=this.effectivePlayingItem,i=this.detachedData;if(this.detachedData=null,s===null)this.checkStart();else if(!i){this.clearScheduleState();const n=this.findItemIndex(s);this.setSchedulePosition(n);}}clearScheduleState(){this.log("clear schedule state"),this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null;}onMediaDetaching(e,t){const s=!!t.transferMedia,i=this.media;if(this.media=null,!s&&(i&&this.removeMediaListeners(i),this.detachedData)){const n=this.getBufferingPlayer();n&&(this.log(`Removing schedule state for detachedData and ${n}`),this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,n.detachMedia()),this.shouldPlay=false;}}get interstitialsManager(){if(!this.hls)return null;if(this.manager)return this.manager;const e=this,t=()=>e.bufferingItem||e.waitingItem,s=u=>u&&e.getAssetPlayer(u.identifier),i=(u,d,g,f,m)=>{if(u){let p=u[d].start;const S=u.event;if(S){if(d==="playout"||S.timelineOccupancy!==Xt.Point){const E=s(g);E?.interstitial===S&&(p+=E.assetItem.startOffset+E[m]);}}else {const E=f==="bufferedPos"?a():e[f];p+=E-u.start;}return p}return 0},n=(u,d)=>{var g;if(u!==0&&d!=="primary"&&(g=e.schedule)!=null&&g.length){var f;const m=e.schedule.findItemIndexAtTime(u),p=(f=e.schedule.items)==null?void 0:f[m];if(p){const S=p[d].start-p.start;return u+S}}return u},a=()=>{const u=e.bufferedPos;return u===Number.MAX_VALUE?o("primary"):Math.max(u,0)},o=u=>{var d,g;return (d=e.primaryDetails)!=null&&d.live?e.primaryDetails.edge:((g=e.schedule)==null?void 0:g.durations[u])||0},l=(u,d)=>{var g,f;const m=e.effectivePlayingItem;if(m!=null&&(g=m.event)!=null&&g.restrictions.skip||!e.schedule)return;e.log(`seek to ${u} "${d}"`);const p=e.effectivePlayingItem,S=e.schedule.findItemIndexAtTime(u,d),E=(f=e.schedule.items)==null?void 0:f[S],T=e.getBufferingPlayer(),A=T?.interstitial,I=A?.appendInPlace,D=p&&e.itemsMatch(p,E);if(p&&(I||D)){const v=s(e.playingAsset),L=v?.media||e.primaryMedia;if(L){const b=d==="primary"?L.currentTime:i(p,d,e.playingAsset,"timelinePos","currentTime"),R=u-b,P=(I?b:L.currentTime)+R;if(P>=0&&(!v||I||P<=v.duration)){L.currentTime=P;return}}}if(E){let v=u;if(d!=="primary"){const b=E[d].start,R=u-b;v=E.start+R;}const L=!e.isInterstitial(E);if((!e.isInterstitial(p)||p.event.appendInPlace)&&(L||E.event.appendInPlace)){const b=e.media||(I?T?.media:null);b&&(b.currentTime=v);}else if(p){const b=e.findItemIndex(p);if(S>b){const P=e.schedule.findJumpRestrictedIndex(b+1,S);if(P>b){e.setSchedulePosition(P);return}}let R=0;if(L)e.timelinePos=v,e.checkBuffer();else {const P=E.event.assetList,O=u-(E[d]||E).start;for(let N=P.length;N--;){const U=P[N];if(U.duration&&O>=U.startOffset&&O<U.startOffset+U.duration){R=N;break}}}e.setSchedulePosition(S,R);}}},c=()=>{const u=e.effectivePlayingItem;if(e.isInterstitial(u))return u;const d=t();return e.isInterstitial(d)?d:null},h={get bufferedEnd(){const u=t(),d=e.bufferingItem;if(d&&d===u){var g;return i(d,"playout",e.bufferingAsset,"bufferedPos","bufferedEnd")-d.playout.start||((g=e.bufferingAsset)==null?void 0:g.startOffset)||0}return 0},get currentTime(){const u=c(),d=e.effectivePlayingItem;return d&&d===u?i(d,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-d.playout.start:0},set currentTime(u){const d=c(),g=e.effectivePlayingItem;g&&g===d&&l(u+g.playout.start,"playout");},get duration(){const u=c();return u?u.playout.end-u.playout.start:0},get assetPlayers(){var u;const d=(u=c())==null?void 0:u.event.assetList;return d?d.map(g=>e.getAssetPlayer(g.identifier)):[]},get playingIndex(){var u;const d=(u=c())==null?void 0:u.event;return d&&e.effectivePlayingAsset?d.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return c()}};return this.manager={get events(){var u;return ((u=e.schedule)==null||(u=u.events)==null?void 0:u.slice(0))||[]},get schedule(){var u;return ((u=e.schedule)==null||(u=u.items)==null?void 0:u.slice(0))||[]},get interstitialPlayer(){return c()?h:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const u=t();return e.findItemIndex(u)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const u=e.effectivePlayingItem;return e.findItemIndex(u)},primary:{get bufferedEnd(){return a()},get currentTime(){const u=e.timelinePos;return u>0?u:0},set currentTime(u){l(u,"primary");},get duration(){return o("primary")},get seekableStart(){var u;return ((u=e.primaryDetails)==null?void 0:u.fragmentStart)||0}},integrated:{get bufferedEnd(){return i(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return i(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(u){l(u,"integrated");},get duration(){return o("integrated")},get seekableStart(){var u;return n(((u=e.primaryDetails)==null?void 0:u.fragmentStart)||0,"integrated")}},skip:()=>{const u=e.effectivePlayingItem,d=u?.event;if(d&&!d.restrictions.skip){const g=e.findItemIndex(u);if(d.appendInPlace){const f=u.playout.start+u.event.duration;l(f+.001,"playout");}else e.advanceAfterAssetEnded(d,g,1/0);}}}}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,s=(e=this.schedule)==null?void 0:e.items;return !this.playbackStarted||!t||!s?false:this.findItemIndex(t)===s.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,t;if(this.mediaSelection===null)return;const s=this.waitingItem||this.playingItem;if(this.isInterstitial(s)&&!s.event.appendInPlace)return;let i=this.media;!i&&(e=this.bufferingItem)!=null&&(e=e.event)!=null&&e.appendInPlace&&(i=this.primaryMedia);const n=(t=i)==null?void 0:t.currentTime;if(!(n===void 0||!B(n)))return n}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return !!(e!=null&&e.event)}retreiveMediaSource(e,t){const s=this.getAssetPlayer(e);s&&this.transferMediaFromPlayer(s,t);}transferMediaFromPlayer(e,t){const s=e.interstitial.appendInPlace,i=e.media;if(s&&i===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&i){this.detachedData={media:i};return}const n=e.transferMedia();this.log(`transfer MediaSource from ${e} ${se(n)}`),this.detachedData=n;}else t&&i&&(this.shouldPlay||(this.shouldPlay=!i.paused));}transferMediaTo(e,t){var s,i;if(e.media===t)return;let n=null;const a=this.hls,o=e!==a,l=o&&e.interstitial.appendInPlace,c=(s=this.detachedData)==null?void 0:s.mediaSource;let h;if(a.media)l&&(n=a.transferMedia(),this.detachedData=n),h="Primary";else if(c){const f=this.getBufferingPlayer();f?(n=f.transferMedia(),h=`${f}`):h="detached MediaSource";}else h="detached media";if(!n){if(c)n=this.detachedData,this.log(`using detachedData: MediaSource ${se(n)}`);else if(!this.detachedData||a.media===t){const f=this.playerQueue;f.length>1&&f.forEach(m=>{if(o&&m.interstitial.appendInPlace!==l){const p=m.interstitial;this.clearInterstitial(m.interstitial,null),p.appendInPlace=false,p.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${p}`);}}),this.hls.detachMedia(),this.detachedData={media:t};}}const u=n&&"mediaSource"in n&&((i=n.mediaSource)==null?void 0:i.readyState)!=="closed",d=u&&n?n:t;this.log(`${u?"transfering MediaSource":"attaching media"} to ${o?e:"Primary"} from ${h} (media.currentTime: ${t.currentTime})`);const g=this.schedule;if(d===n&&g){const f=o&&e.assetId===g.assetIdAtEnd;d.overrides={duration:g.duration,endOfStream:!o||f,cueRemoval:!o};}e.attachMedia(d);}onInterstitialCueEnter(){this.onTimeupdate();}checkStart(){const e=this.schedule,t=e?.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const s=this.timelinePos,i=this.effectivePlayingItem;if(s===-1){const n=this.hls.startPosition;if(this.log(Ot("checkStart",n)),this.timelinePos=n,t.length&&t[0].cue.pre){const a=e.findEventIndex(t[0].identifier);this.setSchedulePosition(a);}else if(n>=0||!this.primaryLive){const a=this.timelinePos=n>0?n:0,o=e.findItemIndexAtTime(a);this.setSchedulePosition(o);}}else if(i&&!this.playingItem){const n=e.findItemIndex(i);this.setSchedulePosition(n);}}advanceAssetBuffering(e,t){const s=e.event,i=s.findAssetIndex(t),n=ys(s,i);if(!s.isAssetPastPlayoutLimit(n))this.bufferedToEvent(e,n);else if(this.schedule){var a;const o=(a=this.schedule.items)==null?void 0:a[this.findItemIndex(e)+1];o&&this.bufferedToItem(o);}}advanceAfterAssetEnded(e,t,s){const i=ys(e,s);if(e.isAssetPastPlayoutLimit(i)){if(this.schedule){const n=this.schedule.items;if(n){const a=t+1,o=n.length;if(a>=o){this.setSchedulePosition(-1);return}const l=e.resumeTime;this.timelinePos<l&&(this.log(Ot("advanceAfterAssetEnded",l)),this.timelinePos=l,e.appendInPlace&&this.advanceInPlace(l),this.checkBuffer(this.bufferedPos<l)),this.setSchedulePosition(a);}}}else {if(e.appendInPlace){const n=e.assetList[i];n&&this.advanceInPlace(n.timelineStart);}this.setSchedulePosition(t,i);}}setScheduleToAssetAtTime(e,t){const s=this.schedule;if(!s)return;const i=t.parentIdentifier,n=s.getEvent(i);if(n){const a=s.findEventIndex(i),o=s.findAssetIndex(n,e);this.advanceAfterAssetEnded(n,a,o-1);}}setSchedulePosition(e,t){var s;const i=(s=this.schedule)==null?void 0:s.items;if(!i||this.playbackDisabled)return;const n=e>=0?i[e]:null;this.log(`setSchedulePosition ${e}, ${t} (${n&&Re(n)}) pos: ${this.timelinePos}`);const a=this.waitingItem||this.playingItem,o=this.playingLastItem;if(this.isInterstitial(a)){const h=a.event,u=this.playingAsset,d=u?.identifier,g=d?this.getAssetPlayer(d):null;if(g&&d&&(!this.eventItemsMatch(a,n)||t!==void 0&&d!==h.assetList[t].identifier)){var l;const f=h.findAssetIndex(u);if(this.log(`INTERSTITIAL_ASSET_ENDED ${f+1}/${h.assetList.length} ${at(u)}`),this.endedAsset=u,this.playingAsset=null,this.hls.trigger(y.INTERSTITIAL_ASSET_ENDED,{asset:u,assetListIndex:f,event:h,schedule:i.slice(0),scheduleIndex:e,player:g}),a!==this.playingItem){this.itemsMatch(a,this.playingItem)&&!this.playingAsset&&this.advanceAfterAssetEnded(h,this.findItemIndex(this.playingItem),f);return}this.retreiveMediaSource(d,n),g.media&&!((l=this.detachedData)!=null&&l.mediaSource)&&g.detachMedia();}if(!this.eventItemsMatch(a,n)&&(this.endedItem=a,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${h} ${Re(a)}`),h.hasPlayed=true,this.hls.trigger(y.INTERSTITIAL_ENDED,{event:h,schedule:i.slice(0),scheduleIndex:e}),h.cue.once)){var c;this.updateSchedule();const f=(c=this.schedule)==null?void 0:c.items;if(n&&f){const m=this.findItemIndex(n);this.advanceSchedule(m,f,t,a,o);}return}}this.advanceSchedule(e,i,t,a,o);}advanceSchedule(e,t,s,i,n){const a=this.schedule;if(!a)return;const o=t[e]||null,l=this.primaryMedia,c=this.playerQueue;if(c.length&&c.forEach(h=>{const u=h.interstitial,d=a.findEventIndex(u.identifier);(d<e||d>e+1)&&this.clearInterstitial(u,o);}),this.isInterstitial(o)){this.timelinePos=Math.min(Math.max(this.timelinePos,o.start),o.end);const h=o.event;if(s===void 0){s=a.findAssetIndex(h,this.timelinePos);const f=ys(h,s-1);if(h.isAssetPastPlayoutLimit(f)||h.appendInPlace&&this.timelinePos===o.end){this.advanceAfterAssetEnded(h,e,s);return}s=f;}const u=this.waitingItem;this.assetsBuffered(o,l)||this.setBufferingItem(o);let d=this.preloadAssets(h,s);if(this.eventItemsMatch(o,u||i)||(this.waitingItem=o,this.log(`INTERSTITIAL_STARTED ${Re(o)} ${h.appendInPlace?"append in place":""}`),this.hls.trigger(y.INTERSTITIAL_STARTED,{event:h,schedule:t.slice(0),scheduleIndex:e})),!h.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${h}`);return}if(h.assetListLoader&&(h.assetListLoader.destroy(),h.assetListLoader=void 0),!l){this.log(`Waiting for attachMedia to start Interstitial ${h}`);return}this.waitingItem=this.endedItem=null,this.playingItem=o;const g=h.assetList[s];if(!g){this.advanceAfterAssetEnded(h,e,s||0);return}if(d||(d=this.getAssetPlayer(g.identifier)),d===null||d.destroyed){const f=h.assetList.length;this.warn(`asset ${s+1}/${f} player destroyed ${h}`),d=this.createAssetPlayer(h,g,s),d.loadSource();}if(!this.eventItemsMatch(o,this.bufferingItem)&&h.appendInPlace&&this.isAssetBuffered(g))return;this.startAssetPlayer(d,s,t,e,l),this.shouldPlay&&Zi(d.media);}else o?(this.resumePrimary(o,e,i),this.shouldPlay&&Zi(this.hls.media)):n&&this.isInterstitial(i)&&(this.endedItem=null,this.playingItem=i,i.event.appendInPlace||this.attachPrimary(a.durations.primary,null));}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===false}get primaryDetails(){var e;return (e=this.mediaSelection)==null?void 0:e.main.details}get primaryLive(){var e;return !!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,s){var i,n;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${Re(e)}`),!((i=this.detachedData)!=null&&i.mediaSource)){let o=this.timelinePos;(o<e.start||o>=e.end)&&(o=this.getPrimaryResumption(e,t),this.log(Ot("resumePrimary",o)),this.timelinePos=o),this.attachPrimary(o,e);}if(!s)return;const a=(n=this.schedule)==null?void 0:n.items;a&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${Re(e)}`),this.hls.trigger(y.INTERSTITIALS_PRIMARY_RESUMED,{schedule:a.slice(0),scheduleIndex:t}),this.checkBuffer());}getPrimaryResumption(e,t){const s=e.start;if(this.primaryLive){const i=this.primaryDetails;if(t===0)return this.hls.startPosition;if(i&&(s<i.fragmentStart||s>i.edge))return this.hls.liveSyncPosition||-1}return s}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:J.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,s){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const i=this.primaryMedia;if(!i)return;const n=this.hls;n.media?this.checkBuffer():(this.transferMediaTo(n,i),s&&this.startLoadingPrimaryAt(e,s)),s||(this.log(Ot("attachPrimary",e)),this.timelinePos=e,this.startLoadingPrimaryAt(e,s));}startLoadingPrimaryAt(e,t){var s;const i=this.hls;!i.loadingEnabled||!i.media||Math.abs((((s=i.mainForwardBufferInfo)==null?void 0:s.start)||i.media.currentTime)-e)>.5?i.startLoad(e,t):i.bufferingEnabled||i.resumeBuffering();}onManifestLoading(){var e;this.stopLoad(),(e=this.schedule)==null||e.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=false,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(y.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(y.BUFFER_CODECS,this.onBufferCodecs,this);}onLevelUpdated(e,t){if(t.level===-1||!this.schedule)return;const s=this.hls.levels[t.level];if(!s.details)return;const i=ee(ee({},this.mediaSelection||this.altSelection),{},{main:s});this.mediaSelection=i,this.schedule.parseInterstitialDateRanges(i,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart();}onAudioTrackUpdated(e,t){const s=this.hls.audioTracks[t.id],i=this.mediaSelection;if(!i){this.altSelection=ee(ee({},this.altSelection),{},{audio:s});return}const n=ee(ee({},i),{},{audio:s});this.mediaSelection=n;}onSubtitleTrackUpdated(e,t){const s=this.hls.subtitleTracks[t.id],i=this.mediaSelection;if(!i){this.altSelection=ee(ee({},this.altSelection),{},{subtitles:s});return}const n=ee(ee({},i),{},{subtitles:s});this.mediaSelection=n;}onAudioTrackSwitching(e,t){const s=Ei(t);this.playerQueue.forEach(({hls:i})=>i&&(i.setAudioOption(t)||i.setAudioOption(s)));}onSubtitleTrackSwitch(e,t){const s=Ei(t);this.playerQueue.forEach(({hls:i})=>i&&(i.setSubtitleOption(t)||t.id!==-1&&i.setSubtitleOption(s)));}onBufferCodecs(e,t){const s=t.tracks;s&&(this.requiredTracks=s);}onBufferAppended(e,t){this.checkBuffer();}onBufferFlushed(e,t){const s=this.playingItem;if(s&&!this.itemsMatch(s,this.bufferingItem)&&!this.isInterstitial(s)){const i=this.timelinePos;this.bufferedPos=i,this.checkBuffer();}}onBufferedToEnd(e){if(!this.schedule)return;const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let i=0;i<t.length;i++){const n=t[i];if(n.cue.post){var s;const a=this.schedule.findEventIndex(n.identifier),o=(s=this.schedule.items)==null?void 0:s[a];this.isInterstitial(o)&&this.eventItemsMatch(o,this.bufferingItem)&&this.bufferedToItem(o,0);break}}this.bufferedPos=Number.MAX_VALUE;}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const s=this.findItemIndex(t);this.setSchedulePosition(s+1);}else this.shouldPlay=false;}updateItem(e,t){var s;const i=(s=this.schedule)==null?void 0:s.items;if(e&&i){const n=this.findItemIndex(e,t);return i[n]||null}return null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((n,a)=>{e.event.isAssetPastPlayoutLimit(a)&&this.clearAssetPlayer(n.identifier,null);});const s=e.end+.25,i=J.bufferInfo(this.primaryMedia,s,0);(i.end>s||(i.nextStart||0)>s)&&(this.log(`trim buffered interstitial ${Re(e)} (was ${Re(t)})`),this.attachPrimary(s,null,true),this.flushFrontBuffer(s));}}itemsMatch(e,t){return !!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var s;return !!t&&(e===t||e.event.identifier===((s=t.event)==null?void 0:s.identifier))}findItemIndex(e,t){return e&&this.schedule?this.schedule.findItemIndex(e,t):-1}updateSchedule(e=false){var t;const s=this.mediaSelection;s&&((t=this.schedule)==null||t.updateSchedule(s,[],e));}checkBuffer(e){var t;const s=(t=this.schedule)==null?void 0:t.items;if(!s)return;const i=J.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=i.len<1),this.updateBufferedPos(i.end,s,e);}updateBufferedPos(e,t,s){const i=this.schedule,n=this.bufferingItem;if(this.bufferedPos>e||!i)return;if(t.length===1&&this.itemsMatch(t[0],n)){this.bufferedPos=e;return}const a=this.playingItem,o=this.findItemIndex(a);let l=i.findItemIndexAtTime(e);if(this.bufferedPos<e){var c;const h=this.findItemIndex(n),u=Math.min(h+1,t.length-1),d=t[u];if((l===-1&&n&&e>=n.end||(c=d.event)!=null&&c.appendInPlace&&e+.01>=d.start)&&(l=u),this.isInterstitial(n)){const g=n.event;if(u-o>1&&g.appendInPlace===false||g.assetList.length===0&&g.assetListLoader)return}if(this.bufferedPos=e,l>h&&l>o)this.bufferedToItem(d);else {const g=this.primaryDetails;this.primaryLive&&g&&e>g.edge-g.targetduration&&d.start<g.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(d)&&this.preloadAssets(d.event,0);}}else s&&a&&!this.itemsMatch(a,n)&&(l===o?this.bufferedToItem(a):l===o+1&&this.bufferedToItem(t[l]));}assetsBuffered(e,t){return e.event.assetList.length===0?false:!e.event.assetList.some(i=>{const n=this.getAssetPlayer(i.identifier);return !(n!=null&&n.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,s=this.schedule;if(!this.itemsMatch(e,t)&&s){const{items:i,events:n}=s;if(!i||!n)return t;const a=this.isInterstitial(e),o=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));const l=o?o.remaining:t?t.end-this.timelinePos:0;if(this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${Re(e)}`+(t?` (${l.toFixed(2)} remaining)`:"")),!this.playbackDisabled)if(a){const c=s.findAssetIndex(e.event,this.bufferedPos);e.event.assetList.forEach((h,u)=>{const d=this.getAssetPlayer(h.identifier);d&&(u===c&&d.loadSource(),d.resumeBuffering());});}else this.hls.resumeBuffering(),this.playerQueue.forEach(c=>c.pauseBuffering());this.hls.trigger(y.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:n.slice(0),schedule:i.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)});}else this.bufferingItem!==e&&(this.bufferingItem=e);return t}bufferedToItem(e,t=0){const s=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(s!==null){this.bufferingAsset=null;const i=this.detachedData;i?i.mediaSource?this.attachPrimary(e.start,e,true):this.preloadPrimary(e):this.preloadPrimary(e);}}}preloadPrimary(e){const t=this.findItemIndex(e),s=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(s);}bufferedToEvent(e,t){const s=e.event,i=s.assetList.length===0&&!s.assetListLoader,n=s.cue.once;if(i||!n){const a=this.preloadAssets(s,t);if(a!=null&&a.interstitial.appendInPlace){const o=this.primaryMedia;o&&this.bufferAssetPlayer(a,o);}}}preloadAssets(e,t){const s=e.assetUrl,i=e.assetList.length,n=i===0&&!e.assetListLoader,a=e.cue.once;if(n){const l=e.timelineStart;if(e.appendInPlace){var o;const d=this.playingItem;!this.isInterstitial(d)&&(d==null||(o=d.nextEvent)==null?void 0:o.identifier)===e.identifier&&this.flushFrontBuffer(l+.25);}let c,h=0;if(!this.playingItem&&this.primaryLive&&(h=this.hls.startPosition,h===-1&&(h=this.hls.liveSyncPosition||0)),h&&!(e.cue.pre||e.cue.post)){const d=h-l;d>0&&(c=Math.round(d*1e3)/1e3);}if(this.log(`Load interstitial asset ${t+1}/${s?1:i} ${e}${c?` live-start: ${h} start-offset: ${c}`:""}`),s)return this.createAsset(e,0,0,l,e.duration,s);const u=this.assetListLoader.loadAssetList(e,c);u&&(e.assetListLoader=u);}else if(!a&&i){for(let c=t;c<i;c++){const h=e.assetList[c],u=this.getAssetPlayerQueueIndex(h.identifier);(u===-1||this.playerQueue[u].destroyed)&&!h.error&&this.createAssetPlayer(e,h,c);}const l=e.assetList[t];if(l){const c=this.getAssetPlayer(l.identifier);return c&&c.loadSource(),c}}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(i=>{this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:i});});}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let s=0;s<t.length;s++)if(e===t[s].assetId)return s;return  -1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t){for(let s=0;s<e.length;s++)if(e[s].media===t)return e[s]}return null}createAsset(e,t,s,i,n,a){const o={parentIdentifier:e.identifier,identifier:yc(e,a,t),duration:n,startOffset:s,timelineStart:i,uri:a};return this.createAssetPlayer(e,o,t)}createAssetPlayer(e,t,s){const i=this.hls,n=i.userConfig;let a=n.videoPreference;const o=i.loadLevelObj||i.levels[i.currentLevel];(a||o)&&(a=ie({},a),o.videoCodec&&(a.videoCodec=o.videoCodec),o.videoRange&&(a.allowedVideoRanges=[o.videoRange]));const l=i.audioTracks[i.audioTrack],c=i.subtitleTracks[i.subtitleTrack];let h=0;if(this.primaryLive||e.appendInPlace){const A=this.timelinePos-t.timelineStart;if(A>1){const I=t.duration;I&&A<I&&(h=A);}}const u=t.identifier,d=ee(ee({},n),{},{maxMaxBufferLength:Math.min(180,i.config.maxMaxBufferLength),autoStartLoad:true,startFragPrefetch:true,primarySessionId:i.sessionId,assetPlayerId:u,abrEwmaDefaultEstimate:i.bandwidthEstimate,interstitialsController:void 0,startPosition:h,liveDurationInfinity:false,testBandwidth:false,videoPreference:a,audioPreference:l||n.audioPreference,subtitlePreference:c||n.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=true,t.timelineStart&&(d.timelineOffset=t.timelineStart));const g=d.cmcd;g!=null&&g.sessionId&&g.contentId&&(d.cmcd=ie({},g,{contentId:Et(t.uri)})),this.getAssetPlayer(u)&&this.warn(`Duplicate date range identifier ${e} and asset ${u}`);const f=new Tc(this.HlsPlayerClass,d,e,t);this.playerQueue.push(f),e.assetList[s]=t;let m=true;const p=A=>{if(A.live){var I;const L=new Error(`Interstitials MUST be VOD assets ${e}`),b={fatal:true,type:G.OTHER_ERROR,details:_.INTERSTITIAL_ASSET_ITEM_ERROR,error:L},R=((I=this.schedule)==null?void 0:I.findEventIndex(e.identifier))||-1;this.handleAssetItemError(b,e,R,s,L.message);return}const D=A.edge-A.fragmentStart,v=t.duration;(m||v===null||D>v)&&(m=false,this.log(`Interstitial asset "${u}" duration change ${v} > ${D}`),t.duration=D,this.updateSchedule());};f.on(y.LEVEL_UPDATED,(A,{details:I})=>p(I)),f.on(y.LEVEL_PTS_UPDATED,(A,{details:I})=>p(I)),f.on(y.EVENT_CUE_ENTER,()=>this.onInterstitialCueEnter());const S=(A,I)=>{const D=this.getAssetPlayer(u);if(D&&I.tracks){D.off(y.BUFFER_CODECS,S),D.tracks=I.tracks;const v=this.primaryMedia;this.bufferingAsset===D.assetItem&&v&&!D.media&&this.bufferAssetPlayer(D,v);}};f.on(y.BUFFER_CODECS,S);const E=()=>{var A;const I=this.getAssetPlayer(u);if(this.log(`buffered to end of asset ${I}`),!I||!this.schedule)return;const D=this.schedule.findEventIndex(e.identifier),v=(A=this.schedule.items)==null?void 0:A[D];this.isInterstitial(v)&&this.advanceAssetBuffering(v,t);};f.on(y.BUFFERED_TO_END,E);const T=A=>()=>{if(!this.getAssetPlayer(u)||!this.schedule)return;this.shouldPlay=true;const D=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,D,A);};return f.once(y.MEDIA_ENDED,T(s)),f.once(y.PLAYOUT_LIMIT_REACHED,T(1/0)),f.on(y.ERROR,(A,I)=>{if(!this.schedule)return;const D=this.getAssetPlayer(u);if(I.details===_.BUFFER_STALLED_ERROR){if(D!=null&&D.appendInPlace){this.handleInPlaceStall(e);return}this.onTimeupdate(),this.checkBuffer(true);return}this.handleAssetItemError(I,e,this.schedule.findEventIndex(e.identifier),s,`Asset player error ${I.error} ${e}`);}),f.on(y.DESTROYING,()=>{if(!this.getAssetPlayer(u)||!this.schedule)return;const I=new Error(`Asset player destroyed unexpectedly ${u}`),D={fatal:true,type:G.OTHER_ERROR,details:_.INTERSTITIAL_ASSET_ITEM_ERROR,error:I};this.handleAssetItemError(D,e,this.schedule.findEventIndex(e.identifier),s,I.message);}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${at(t)}`),this.hls.trigger(y.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:s,event:e,player:f}),f}clearInterstitial(e,t){this.clearAssetPlayers(e,t),e.reset();}clearAssetPlayers(e,t){e.assetList.forEach(s=>{this.clearAssetPlayer(s.identifier,t);});}resetAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);if(t!==-1){this.log(`reset asset player "${e}" after error`);const s=this.playerQueue[t];this.transferMediaFromPlayer(s,null),s.resetDetails();}}clearAssetPlayer(e,t){const s=this.getAssetPlayerQueueIndex(e);if(s!==-1){const i=this.playerQueue[s];this.log(`clear ${i} toSegment: ${t&&Re(t)}`),this.transferMediaFromPlayer(i,t),this.playerQueue.splice(s,1),i.destroy();}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[];}startAssetPlayer(e,t,s,i,n){const{interstitial:a,assetItem:o,assetId:l}=e,c=a.assetList.length,h=this.playingAsset;this.endedAsset=null,this.playingAsset=o,(!h||h.identifier!==l)&&(h&&(this.clearAssetPlayer(h.identifier,s[i]),delete h.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${c} ${at(o)}`),this.hls.trigger(y.INTERSTITIAL_ASSET_STARTED,{asset:o,assetListIndex:t,event:a,schedule:s.slice(0),scheduleIndex:i,player:e})),this.bufferAssetPlayer(e,n);}bufferAssetPlayer(e,t){var s,i;if(!this.schedule)return;const{interstitial:n,assetItem:a}=e,o=this.schedule.findEventIndex(n.identifier),l=(s=this.schedule.items)==null?void 0:s[o];if(!l)return;e.loadSource(),this.setBufferingItem(l),this.bufferingAsset=a;const c=this.getBufferingPlayer();if(c===e)return;const h=n.appendInPlace;if(h&&c?.interstitial.appendInPlace===false)return;const u=c?.tracks||((i=this.detachedData)==null?void 0:i.tracks)||this.requiredTracks;if(h&&a!==this.playingAsset){if(!e.tracks){this.log(`Waiting for track info before buffering ${e}`);return}if(u&&!ln(u,e.tracks)){const d=new Error(`Asset ${at(a)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(u)}')`),g={fatal:true,type:G.OTHER_ERROR,details:_.INTERSTITIAL_ASSET_ITEM_ERROR,error:d},f=n.findAssetIndex(a);this.handleAssetItemError(g,n,o,f,d.message);return}}this.transferMediaTo(e,t);}handleInPlaceStall(e){const t=this.schedule,s=this.primaryMedia;if(!t||!s)return;const i=s.currentTime,n=t.findAssetIndex(e,i),a=e.assetList[n];if(a){const o=this.getAssetPlayer(a.identifier);if(o){const l=o.currentTime||i-a.timelineStart,c=o.duration-l;if(this.warn(`Stalled at ${l} of ${l+c} in ${o} ${e} (media.currentTime: ${i})`),l&&(c/s.playbackRate<.5||o.bufferedInPlaceToEnd(s))&&o.hls){const h=t.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,h,n);}}}}advanceInPlace(e){const t=this.primaryMedia;t&&t.currentTime<e&&(t.currentTime=e);}handleAssetItemError(e,t,s,i,n){if(e.details===_.BUFFER_STALLED_ERROR)return;const a=t.assetList[i]||null;if(this.warn(`INTERSTITIAL_ASSET_ERROR ${a&&at(a)} ${e.error}`),!this.schedule)return;const o=a?.identifier||"",l=this.getAssetPlayerQueueIndex(o),c=this.playerQueue[l]||null,h=this.schedule.items,u=ie({},e,{fatal:false,errorAction:ot(true),asset:a,assetListIndex:i,event:t,schedule:h,scheduleIndex:s,player:c});if(this.hls.trigger(y.INTERSTITIAL_ASSET_ERROR,u),!e.fatal)return;const d=this.playingAsset,g=this.bufferingAsset,f=new Error(n);if(a&&(this.clearAssetPlayer(o,null),a.error=f),!t.assetList.some(m=>!m.error))t.error=f;else for(let m=i;m<t.assetList.length;m++)this.resetAssetPlayer(t.assetList[m].identifier);this.updateSchedule(true),t.error?this.primaryFallback(t):d&&d.identifier===o?this.advanceAfterAssetEnded(t,s,i):g&&g.identifier===o&&this.isInterstitial(this.bufferingItem)&&this.advanceAssetBuffering(this.bufferingItem,g);}primaryFallback(e){const t=e.timelineStart,s=this.effectivePlayingItem;let i=this.timelinePos;if(s){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${i} playing: ${Re(s)} error: ${e.error}`),i===-1&&(i=this.hls.startPosition);const a=this.updateItem(s,i);this.itemsMatch(s,a)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t));}else if(i===-1){this.checkStart();return}if(!this.schedule)return;const n=this.schedule.findItemIndexAtTime(i);this.setSchedulePosition(n);}onAssetListLoaded(e,t){var s,i;const n=t.event,a=n.identifier,o=t.assetListResponse.ASSETS;if(!((s=this.schedule)!=null&&s.hasEvent(a)))return;const l=n.timelineStart,c=n.duration;let h=0;o.forEach((m,p)=>{const S=parseFloat(m.DURATION);this.createAsset(n,p,h,l+h,S,m.URI),h+=S;}),n.duration=h,this.log(`Loaded asset-list with duration: ${h} (was: ${c}) ${n}`);const u=this.waitingItem,d=u?.event.identifier===a;this.updateSchedule();const g=(i=this.bufferingItem)==null?void 0:i.event;if(d){var f;const m=this.schedule.findEventIndex(a),p=(f=this.schedule.items)==null?void 0:f[m];if(p){if(!this.playingItem&&this.timelinePos>p.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==m){n.error=new Error(`Interstitial ${o.length?"no longer within playback range":"asset-list is empty"} ${this.timelinePos} ${n}`),this.log(n.error.message),this.updateSchedule(true),this.primaryFallback(n);return}this.setBufferingItem(p);}this.setSchedulePosition(m);}else if(g?.identifier===a){const m=n.assetList[0];if(m){const p=this.getAssetPlayer(m.identifier);if(g.appendInPlace){const S=this.primaryMedia;p&&S&&this.bufferAssetPlayer(p,S);}else p&&p.loadSource();}}}onError(e,t){if(this.schedule)switch(t.details){case _.ASSET_LIST_PARSING_ERROR:case _.ASSET_LIST_LOAD_ERROR:case _.ASSET_LIST_LOAD_TIMEOUT:{const s=t.interstitial;s&&(this.updateSchedule(true),this.primaryFallback(s));break}case _.BUFFER_STALLED_ERROR:{const s=this.endedItem||this.waitingItem||this.playingItem;if(this.isInterstitial(s)&&s.event.appendInPlace){this.handleInPlaceStall(s.event);return}this.log(`Primary player stall @${this.timelinePos} bufferedPos: ${this.bufferedPos}`),this.onTimeupdate(),this.checkBuffer(true);break}}}}const Ji=500;class Ic extends kn{constructor(e,t,s){super(e,t,s,"subtitle-stream-controller",K.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners();}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null;}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this);}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this);}startLoad(e,t){this.stopLoad(),this.state=C.IDLE,this.setInterval(Ji),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick();}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null;}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t);}onLevelLoaded(e,t){this.mainDetails=t.details;}onSubtitleFragProcessed(e,t){const{frag:s,success:i}=t;if(this.fragContextChanged(s)||(ye(s)&&(this.fragPrevious=s),this.state=C.IDLE),!i)return;const n=this.tracksBuffered[this.currentTrackId];if(!n)return;let a;const o=s.start;for(let c=0;c<n.length;c++)if(o>=n[c].start&&o<=n[c].end){a=n[c];break}const l=s.start+s.duration;a?a.end=l:(a={start:o,end:l},n.push(a)),this.fragmentTracker.fragBuffered(s),this.fragBufferedComplete(s,null),this.media&&this.tick();}onBufferFlushing(e,t){const{startOffset:s,endOffset:i}=t;if(s===0&&i!==Number.POSITIVE_INFINITY){const n=i-1;if(n<=0)return;t.endOffsetSubtitles=Math.max(0,n),this.tracksBuffered.forEach(a=>{for(let o=0;o<a.length;){if(a[o].end<=n){a.shift();continue}else if(a[o].start<n)a[o].start=n;else break;o++;}}),this.fragmentTracker.removeFragmentsInRange(s,n,K.SUBTITLE);}}onError(e,t){const s=t.frag;s?.type===K.SUBTITLE&&(t.details===_.FRAG_GAP&&this.fragmentTracker.fragBuffered(s,true),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==C.STOPPED&&(this.state=C.IDLE));}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&Xn(this.levels,t)){this.levels=t.map(s=>new Vt(s));return}this.tracksBuffered=[],this.levels=t.map(s=>{const i=new Vt(s);return this.tracksBuffered[i.id]=[],i}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,K.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null;}onSubtitleTrackSwitch(e,t){var s;if(this.currentTrackId=t.id,!((s=this.levels)!=null&&s.length)||this.currentTrackId===-1){this.clearInterval();return}const i=this.levels[this.currentTrackId];i!=null&&i.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,i&&this.state!==C.STOPPED&&this.setInterval(Ji);}onSubtitleTrackLoaded(e,t){var s;const{currentTrackId:i,levels:n}=this,{details:a,id:o}=t;if(!n){this.warn(`Subtitle tracks were reset while loading level ${o}`);return}const l=n[o];if(o>=n.length||!l)return;this.log(`Subtitle track ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""},duration:${a.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let c=0;if(a.live||(s=l.details)!=null&&s.live){if(a.deltaUpdateFailed)return;const u=this.mainDetails;if(!u){this.startFragRequested=false;return}const d=u.fragments[0];if(!l.details)a.hasProgramDateTime&&u.hasProgramDateTime?(qt(a,u),c=a.fragmentStart):d&&(c=d.start,_s(a,c));else {var h;c=this.alignPlaylists(a,l.details,(h=this.levelLastLoaded)==null?void 0:h.details),c===0&&d&&(c=d.start,_s(a,c));}u&&!this.startFragRequested&&this.setStartPosition(u,c);}l.details=a,this.levelLastLoaded=l,o===i&&(this.hls.trigger(y.SUBTITLE_TRACK_UPDATED,{details:a,id:o,groupId:t.groupId}),this.tick(),a.live&&!this.fragCurrent&&this.media&&this.state===C.IDLE&&(ht(null,a.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0)));}_handleFragmentLoadComplete(e){const{frag:t,payload:s}=e,i=t.decryptdata,n=this.hls;if(!this.fragContextChanged(t)&&s&&s.byteLength>0&&i!=null&&i.key&&i.iv&&Gs(i.method)){const a=performance.now();this.decrypter.decrypt(new Uint8Array(s),i.key.buffer,i.iv.buffer,Ks(i.method)).catch(o=>{throw n.trigger(y.ERROR,{type:G.MEDIA_ERROR,details:_.FRAG_DECRYPT_ERROR,fatal:false,error:o,reason:o.message,frag:t}),o}).then(o=>{const l=performance.now();n.trigger(y.FRAG_DECRYPTED,{frag:t,payload:o,stats:{tstart:a,tdecrypt:l}});}).catch(o=>{this.warn(`${o.name}: ${o.message}`),this.state=C.IDLE;});}}doTick(){if(!this.media){this.state=C.IDLE;return}if(this.state===C.IDLE){const{currentTrackId:e,levels:t}=this,s=t?.[e];if(!s||!t.length||!s.details||this.waitForLive(s))return;const{config:i}=this,n=this.getLoadPosition(),a=J.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],n,i.maxBufferHole),{end:o,len:l}=a,c=s.details,h=this.hls.maxBufferLength+c.levelTargetDuration;if(l>h)return;const u=c.fragments,d=u.length,g=c.edge;let f=null;const m=this.fragPrevious;if(o<g){const E=i.maxFragLookUpTolerance,T=o>g-E?0:E;f=ht(m,u,Math.max(u[0].start,o),T),!f&&m&&m.start<u[0].start&&(f=u[0]);}else f=u[d-1];if(f=this.filterReplacedPrimary(f,s.details),!f)return;const p=f.sn-c.startSN,S=u[p-1];if(S&&S.cc===f.cc&&this.fragmentTracker.getState(S)===ve.NOT_LOADED&&(f=S),this.fragmentTracker.getState(f)===ve.NOT_LOADED){const E=this.mapToInitFragWhenRequired(f);E&&this.loadFragment(E,s,o);}}}loadFragment(e,t,s){ye(e)?super.loadFragment(e,t,s):this._loadInitSegment(e,t);}get mediaBufferTimeRanges(){return new Rc(this.tracksBuffered[this.currentTrackId]||[])}}class Rc{constructor(e){this.buffered=void 0;const t=(s,i,n)=>{if(i=i>>>0,i>n-1)throw new DOMException(`Failed to execute '${s}' on 'TimeRanges': The index provided (${i}) is greater than the maximum bound (${n})`);return e[i][s]};this.buffered={get length(){return e.length},end(s){return t("end",s,e.length)},start(s){return t("start",s,e.length)}};}}const Lc={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},dr=r=>String.fromCharCode(Lc[r]||r),Le=15,Be=100,bc={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},_c={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Dc={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Pc={25:2,26:4,29:6,30:8,31:10,27:13,28:15},Cc=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class kc{constructor(){this.time=null,this.verboseLevel=0;}log(e,t){if(this.verboseLevel>=e){const s=typeof t=="function"?t():t;re.log(`${this.time} [${e}] ${s}`);}}}const Ze=function(e){const t=[];for(let s=0;s<e.length;s++)t.push(e[s].toString(16));return t};class fr{constructor(){this.foreground="white",this.underline=false,this.italics=false,this.background="black",this.flash=false;}reset(){this.foreground="white",this.underline=false,this.italics=false,this.background="black",this.flash=false;}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let s=0;s<t.length;s++){const i=t[s];e.hasOwnProperty(i)&&(this[i]=e[i]);}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash;}toString(){return "color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class wc{constructor(){this.uchar=" ",this.penState=new fr;}reset(){this.uchar=" ",this.penState.reset();}setChar(e,t){this.uchar=e,this.penState.copy(t);}setPenState(e){this.penState.copy(e);}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState);}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class Oc{constructor(e){this.chars=[],this.pos=0,this.currPenState=new fr,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<Be;t++)this.chars.push(new wc);this.logger=e;}equals(e){for(let t=0;t<Be;t++)if(!this.chars[t].equals(e.chars[t]))return  false;return  true}copy(e){for(let t=0;t<Be;t++)this.chars[t].copy(e.chars[t]);}isEmpty(){let e=true;for(let t=0;t<Be;t++)if(!this.chars[t].isEmpty()){e=false;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>Be&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=Be);}moveCursor(e){const t=this.pos+e;if(e>1)for(let s=this.pos+1;s<t+1;s++)this.chars[s].setPenState(this.currPenState);this.setCursor(t);}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState);}insertChar(e){e>=144&&this.backSpace();const t=dr(e);if(this.pos>=Be){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1);}clearFromPos(e){let t;for(t=e;t<Be;t++)this.chars[t].reset();}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset();}clearToEndOfRow(){this.clearFromPos(this.pos);}getTextString(){const e=[];let t=true;for(let s=0;s<Be;s++){const i=this.chars[s].uchar;i!==" "&&(t=false),e.push(i);}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState);}}class Ss{constructor(e){this.rows=[],this.currRow=Le-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<Le;t++)this.rows.push(new Oc(e));this.logger=e;}reset(){for(let e=0;e<Le;e++)this.rows[e].clear();this.currRow=Le-1;}equals(e){let t=true;for(let s=0;s<Le;s++)if(!this.rows[s].equals(e.rows[s])){t=false;break}return t}copy(e){for(let t=0;t<Le;t++)this.rows[t].copy(e.rows[t]);}isEmpty(){let e=true;for(let t=0;t<Le;t++)if(!this.rows[t].isEmpty()){e=false;break}return e}backSpace(){this.rows[this.currRow].backSpace();}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow();}insertChar(e){this.rows[this.currRow].insertChar(e);}setPen(e){this.rows[this.currRow].setPenStyles(e);}moveCursor(e){this.rows[this.currRow].moveCursor(e);}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e);}setPAC(e){this.logger.log(2,()=>"pacData = "+se(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let o=0;o<Le;o++)this.rows[o].clear();const n=this.currRow+1-this.nrRollUpRows,a=this.lastOutputScreen;if(a){const o=a.rows[n].cueStartTime,l=this.logger.time;if(o!==null&&l!==null&&o<l)for(let c=0;c<this.nrRollUpRows;c++)this.rows[t-this.nrRollUpRows+c+1].copy(a.rows[n+c]);}}this.currRow=t;const s=this.rows[this.currRow];if(e.indent!==null){const n=e.indent,a=Math.max(n-1,0);s.setCursor(e.indent),e.color=s.chars[a].penState.foreground;}const i={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:false};this.setPen(i);}setBkgData(e){this.logger.log(2,()=>"bkgData = "+se(e)),this.backSpace(),this.setPen(e),this.insertChar(32);}setRollUpRows(e){this.nrRollUpRows=e;}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up");}getDisplayText(e){e=e||false;const t=[];let s="",i=-1;for(let n=0;n<Le;n++){const a=this.rows[n].getTextString();a&&(i=n+1,e?t.push("Row "+i+": '"+a+"'"):t.push(a.trim()));}return t.length>0&&(e?s="["+t.join(" | ")+"]":s=t.join(`
`)),s}getTextAndFormat(){return this.rows}}class en{constructor(e,t,s){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Ss(s),this.nonDisplayedMemory=new Ss(s),this.lastOutputScreen=new Ss(s),this.currRollUpRow=this.displayedMemory.rows[Le-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=s;}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Le-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null;}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e;}setPAC(e){this.writeScreen.setPAC(e);}setBkgData(e){this.writeScreen.setBkgData(e);}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e);}insertChars(e){for(let s=0;s<e.length;s++)this.writeScreen.insertChar(e[s]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(true)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(true)),this.outputDataUpdate());}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON");}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate());}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate();}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e);}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:true});}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON");}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT");}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT");}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(true);}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(true);}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset();}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText());}this.outputDataUpdate(true);}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e);}ccMIDROW(e){const t={flash:false};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else {const s=Math.floor(e/2)-16,i=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=i[s];}this.logger.log(2,"MIDROW: "+se(t)),this.writeScreen.setPen(t);}outputDataUpdate(e=false){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory));}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e));}}class tn{constructor(e,t,s){this.channels=void 0,this.currentChannel=0,this.cmdHistory=Mc(),this.logger=void 0;const i=this.logger=new kc;this.channels=[null,new en(e,t,i),new en(e+1,s,i)];}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t);}addData(e,t){this.logger.time=e;for(let s=0;s<t.length;s+=2){const i=t[s]&127,n=t[s+1]&127;let a=false,o=null;if(i===0&&n===0)continue;this.logger.log(3,()=>"["+Ze([t[s],t[s+1]])+"] -> ("+Ze([i,n])+")");const l=this.cmdHistory;if(i>=16&&i<=31){if(Fc(i,n,l)){Ft(null,null,l),this.logger.log(3,()=>"Repeated command ("+Ze([i,n])+") is dropped");continue}Ft(i,n,this.cmdHistory),a=this.parseCmd(i,n),a||(a=this.parseMidrow(i,n)),a||(a=this.parsePAC(i,n)),a||(a=this.parseBackgroundAttributes(i,n));}else Ft(null,null,l);if(!a&&(o=this.parseChars(i,n),o)){const h=this.currentChannel;h&&h>0?this.channels[h].insertChars(o):this.logger.log(2,"No channel found yet. TEXT-MODE?");}!a&&!o&&this.logger.log(2,()=>"Couldn't parse cleaned data "+Ze([i,n])+" orig: "+Ze([t[s],t[s+1]]));}}parseCmd(e,t){const s=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,i=(e===23||e===31)&&t>=33&&t<=35;if(!(s||i))return  false;const n=e===20||e===21||e===23?1:2,a=this.channels[n];return e===20||e===21||e===28||e===29?t===32?a.ccRCL():t===33?a.ccBS():t===34?a.ccAOF():t===35?a.ccAON():t===36?a.ccDER():t===37?a.ccRU(2):t===38?a.ccRU(3):t===39?a.ccRU(4):t===40?a.ccFON():t===41?a.ccRDC():t===42?a.ccTR():t===43?a.ccRTD():t===44?a.ccEDM():t===45?a.ccCR():t===46?a.ccENM():t===47&&a.ccEOC():a.ccTO(t-32),this.currentChannel=n,true}parseMidrow(e,t){let s=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?s=1:s=2,s!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),false;const i=this.channels[s];return i?(i.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+Ze([e,t])+")"),true):false}return  false}parsePAC(e,t){let s;const i=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,n=(e===16||e===24)&&t>=64&&t<=95;if(!(i||n))return  false;const a=e<=23?1:2;t>=64&&t<=95?s=a===1?bc[e]:Dc[e]:s=a===1?_c[e]:Pc[e];const o=this.channels[a];return o?(o.setPAC(this.interpretPAC(s,t)),this.currentChannel=a,true):false}interpretPAC(e,t){let s;const i={color:null,italics:false,indent:null,underline:false,row:e};return t>95?s=t-96:s=t-64,i.underline=(s&1)===1,s<=13?i.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(s/2)]:s<=15?(i.italics=true,i.color="white"):i.indent=Math.floor((s-16)/2)*4,i}parseChars(e,t){let s,i=null,n=null;if(e>=25?(s=2,n=e-8):(s=1,n=e),n>=17&&n<=19){let a;n===17?a=t+80:n===18?a=t+112:a=t+144,this.logger.log(2,()=>"Special char '"+dr(a)+"' in channel "+s),i=[a];}else e>=32&&e<=127&&(i=t===0?[e]:[e,t]);return i&&this.logger.log(3,()=>"Char codes =  "+Ze(i).join(",")),i}parseBackgroundAttributes(e,t){const s=(e===16||e===24)&&t>=32&&t<=47,i=(e===23||e===31)&&t>=45&&t<=47;if(!(s||i))return  false;let n;const a={};e===16||e===24?(n=Math.floor((t-32)/2),a.background=Cc[n],t%2===1&&(a.background=a.background+"_semi")):t===45?a.background="transparent":(a.foreground="black",t===47&&(a.underline=true));const o=e<=23?1:2;return this.channels[o].setBkgData(a),true}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset();}Ft(null,null,this.cmdHistory);}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const s=this.channels[t];s&&s.cueSplitAtTime(e);}}}function Ft(r,e,t){t.a=r,t.b=e;}function Fc(r,e,t){return t.a===r&&t.b===e}function Mc(){return {a:null,b:null}}var Zs=(function(){if(Wt!=null&&Wt.VTTCue)return self.VTTCue;const r=["","lr","rl"],e=["start","middle","end","left","right"];function t(o,l){if(typeof l!="string"||!Array.isArray(o))return  false;const c=l.toLowerCase();return ~o.indexOf(c)?c:false}function s(o){return t(r,o)}function i(o){return t(e,o)}function n(o,...l){let c=1;for(;c<arguments.length;c++){const h=arguments[c];for(const u in h)o[u]=h[u];}return o}function a(o,l,c){const h=this,u={enumerable:true};h.hasBeenReset=false;let d="",g=false,f=o,m=l,p=c,S=null,E="",T=true,A="auto",I="start",D=50,v="middle",L=50,b="middle";Object.defineProperty(h,"id",n({},u,{get:function(){return d},set:function(R){d=""+R;}})),Object.defineProperty(h,"pauseOnExit",n({},u,{get:function(){return g},set:function(R){g=!!R;}})),Object.defineProperty(h,"startTime",n({},u,{get:function(){return f},set:function(R){if(typeof R!="number")throw new TypeError("Start time must be set to a number.");f=R,this.hasBeenReset=true;}})),Object.defineProperty(h,"endTime",n({},u,{get:function(){return m},set:function(R){if(typeof R!="number")throw new TypeError("End time must be set to a number.");m=R,this.hasBeenReset=true;}})),Object.defineProperty(h,"text",n({},u,{get:function(){return p},set:function(R){p=""+R,this.hasBeenReset=true;}})),Object.defineProperty(h,"region",n({},u,{get:function(){return S},set:function(R){S=R,this.hasBeenReset=true;}})),Object.defineProperty(h,"vertical",n({},u,{get:function(){return E},set:function(R){const P=s(R);if(P===false)throw new SyntaxError("An invalid or illegal string was specified.");E=P,this.hasBeenReset=true;}})),Object.defineProperty(h,"snapToLines",n({},u,{get:function(){return T},set:function(R){T=!!R,this.hasBeenReset=true;}})),Object.defineProperty(h,"line",n({},u,{get:function(){return A},set:function(R){if(typeof R!="number"&&R!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");A=R,this.hasBeenReset=true;}})),Object.defineProperty(h,"lineAlign",n({},u,{get:function(){return I},set:function(R){const P=i(R);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");I=P,this.hasBeenReset=true;}})),Object.defineProperty(h,"position",n({},u,{get:function(){return D},set:function(R){if(R<0||R>100)throw new Error("Position must be between 0 and 100.");D=R,this.hasBeenReset=true;}})),Object.defineProperty(h,"positionAlign",n({},u,{get:function(){return v},set:function(R){const P=i(R);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");v=P,this.hasBeenReset=true;}})),Object.defineProperty(h,"size",n({},u,{get:function(){return L},set:function(R){if(R<0||R>100)throw new Error("Size must be between 0 and 100.");L=R,this.hasBeenReset=true;}})),Object.defineProperty(h,"align",n({},u,{get:function(){return b},set:function(R){const P=i(R);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");b=P,this.hasBeenReset=true;}})),h.displayState=void 0;}return a.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},a})();class Nc{decode(e,t){if(!e)return "";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function gr(r){function e(s,i,n,a){return (s|0)*3600+(i|0)*60+(n|0)+parseFloat(a||0)}const t=r.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class Bc{constructor(){this.values=Object.create(null);}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t);}get(e,t,s){return s?this.has(e)?this.values[e]:t[s]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,s){for(let i=0;i<s.length;++i)if(t===s[i]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10));}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const s=parseFloat(t);if(s>=0&&s<=100)return this.set(e,s),true}return  false}}function mr(r,e,t,s){const i=s?r.split(s):[r];for(const n in i){if(typeof i[n]!="string")continue;const a=i[n].split(t);if(a.length!==2)continue;const o=a[0],l=a[1];e(o,l);}}const Fs=new Zs(0,0,""),Mt=Fs.align==="middle"?"middle":"center";function Uc(r,e,t){const s=r;function i(){const o=gr(r);if(o===null)throw new Error("Malformed timestamp: "+s);return r=r.replace(/^[^\sa-zA-Z-]+/,""),o}function n(o,l){const c=new Bc;mr(o,function(d,g){let f;switch(d){case "region":for(let m=t.length-1;m>=0;m--)if(t[m].id===g){c.set(d,t[m].region);break}break;case "vertical":c.alt(d,g,["rl","lr"]);break;case "line":f=g.split(","),c.integer(d,f[0]),c.percent(d,f[0])&&c.set("snapToLines",false),c.alt(d,f[0],["auto"]),f.length===2&&c.alt("lineAlign",f[1],["start",Mt,"end"]);break;case "position":f=g.split(","),c.percent(d,f[0]),f.length===2&&c.alt("positionAlign",f[1],["start",Mt,"end","line-left","line-right","auto"]);break;case "size":c.percent(d,g);break;case "align":c.alt(d,g,["start",Mt,"end","left","right"]);break}},/:/,/\s/),l.region=c.get("region",null),l.vertical=c.get("vertical","");let h=c.get("line","auto");h==="auto"&&Fs.line===-1&&(h=-1),l.line=h,l.lineAlign=c.get("lineAlign","start"),l.snapToLines=c.get("snapToLines",true),l.size=c.get("size",100),l.align=c.get("align",Mt);let u=c.get("position","auto");u==="auto"&&Fs.position===50&&(u=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=u;}function a(){r=r.replace(/^\s+/,"");}if(a(),e.startTime=i(),a(),r.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+s);r=r.slice(3),a(),e.endTime=i(),a(),n(r,e);}function pr(r){return r.replace(/<br(?: \/)?>/gi,`
`)}class $c{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new Nc,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0;}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:true}));function s(){let n=t.buffer,a=0;for(n=pr(n);a<n.length&&n[a]!=="\r"&&n[a]!==`
`;)++a;const o=n.slice(0,a);return n[a]==="\r"&&++a,n[a]===`
`&&++a,t.buffer=n.slice(a),o}function i(n){mr(n,function(a,o){},/:/);}try{let n="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;n=s();const o=n.match(/^()?WEBVTT([ \t].*)?$/);if(!(o!=null&&o[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER";}let a=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(a?a=!1:n=s(),t.state){case "HEADER":/:/.test(n)?i(n):n||(t.state="ID");continue;case "NOTE":n||(t.state="ID");continue;case "ID":if(/^NOTE($|[ \t])/.test(n)){t.state="NOTE";break}if(!n)continue;if(t.cue=new Zs(0,0,""),t.state="CUE",n.indexOf("-->")===-1){t.cue.id=n;continue}case "CUE":if(!t.cue){t.state="BADCUE";continue}try{Uc(n,t.cue,t.regionList);}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case "CUETEXT":{const o=n.indexOf("-->")!==-1;if(!n||o&&(a=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=n;}continue;case "BADCUE":n||(t.state="ID");}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE";}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t);}return e.onflush&&e.onflush(),this}}const Gc=/\r\n|\n\r|\n|\r/g,Es=function(e,t,s=0){return e.slice(s,s+t.length)===t},Kc=function(e){let t=parseInt(e.slice(-3));const s=parseInt(e.slice(-6,-4)),i=parseInt(e.slice(-9,-7)),n=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!B(t)||!B(s)||!B(i)||!B(n))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*s,t+=60*1e3*i,t+=3600*1e3*n,t};function Js(r,e,t){return Et(r.toString())+Et(e.toString())+Et(t)}const Vc=function(e,t,s){let i=e[t],n=e[i.prevCC];if(!n||!n.new&&i.new){e.ccOffset=e.presentationOffset=i.start,i.new=false;return}for(;(a=n)!=null&&a.new;){var a;e.ccOffset+=i.start-n.start,i.new=false,i=n,n=e[i.prevCC];}e.presentationOffset=s;};function Hc(r,e,t,s,i,n,a){const o=new $c,l=Se(new Uint8Array(r)).trim().replace(Gc,`
`).split(`
`),c=[],h=e?zo(e.baseTime,e.timescale):0;let u="00:00.000",d=0,g=0,f,m=true;o.oncue=function(p){const S=t[s];let E=t.ccOffset;const T=(d-h)/9e4;if(S!=null&&S.new&&(g!==void 0?E=t.ccOffset=S.start:Vc(t,s,T)),T){if(!e){f=new Error("Missing initPTS for VTT MPEGTS");return}E=T-t.presentationOffset;}const A=p.endTime-p.startTime,I=pe((p.startTime+E-g)*9e4,i*9e4)/9e4;p.startTime=Math.max(I,0),p.endTime=Math.max(I+A,0);const D=p.text.trim();p.text=decodeURIComponent(encodeURIComponent(D)),p.id||(p.id=Js(p.startTime,p.endTime,D)),p.endTime>0&&c.push(p);},o.onparsingerror=function(p){f=p;},o.onflush=function(){if(f){a(f);return}n(c);},l.forEach(p=>{if(m)if(Es(p,"X-TIMESTAMP-MAP=")){m=false,p.slice(16).split(",").forEach(S=>{Es(S,"LOCAL:")?u=S.slice(6):Es(S,"MPEGTS:")&&(d=parseInt(S.slice(7)));});try{g=Kc(u)/1e3;}catch(S){f=S;}return}else p===""&&(m=false);o.parse(p+`
`);}),o.flush();}const Ts="stpp.ttml.im1t",yr=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Sr=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Yc={left:"start",center:"center",right:"end",start:"start",end:"end"};function sn(r,e,t,s){const i=z(new Uint8Array(r),["mdat"]);if(i.length===0){s(new Error("Could not parse IMSC1 mdat"));return}const n=i.map(o=>Se(o)),a=jo(e.baseTime,1,e.timescale);try{n.forEach(o=>t(Wc(o,a)));}catch(o){s(o);}}function Wc(r,e){const i=new DOMParser().parseFromString(r,"text/xml").getElementsByTagName("tt")[0];if(!i)throw new Error("Invalid ttml");const n={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},a=Object.keys(n).reduce((u,d)=>(u[d]=i.getAttribute(`ttp:${d}`)||n[d],u),{}),o=i.getAttribute("xml:space")!=="preserve",l=nn(xs(i,"styling","style")),c=nn(xs(i,"layout","region")),h=xs(i,"body","[begin]");return [].map.call(h,u=>{const d=Er(u,o);if(!d||!u.hasAttribute("begin"))return null;const g=As(u.getAttribute("begin"),a),f=As(u.getAttribute("dur"),a);let m=As(u.getAttribute("end"),a);if(g===null)throw rn(u);if(m===null){if(f===null)throw rn(u);m=g+f;}const p=new Zs(g-e,m-e,d);p.id=Js(p.startTime,p.endTime,p.text);const S=c[u.getAttribute("region")],E=l[u.getAttribute("style")],T=qc(S,E,l),{textAlign:A}=T;if(A){const I=Yc[A];I&&(p.lineAlign=I),p.align=A;}return ie(p,T),p}).filter(u=>u!==null)}function xs(r,e,t){const s=r.getElementsByTagName(e)[0];return s?[].slice.call(s.querySelectorAll(t)):[]}function nn(r){return r.reduce((e,t)=>{const s=t.getAttribute("xml:id");return s&&(e[s]=t),e},{})}function Er(r,e){return [].slice.call(r.childNodes).reduce((t,s,i)=>{var n;return s.nodeName==="br"&&i?t+`
`:(n=s.childNodes)!=null&&n.length?Er(s,e):e?t+s.textContent.trim().replace(/\s+/g," "):t+s.textContent},"")}function qc(r,e,t){const s="http://www.w3.org/ns/ttml#styling";let i=null;const n=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=r!=null&&r.hasAttribute("style")?r.getAttribute("style"):null;return a&&t.hasOwnProperty(a)&&(i=t[a]),n.reduce((o,l)=>{const c=vs(e,s,l)||vs(r,s,l)||vs(i,s,l);return c&&(o[l]=c),o},{})}function vs(r,e,t){return r&&r.hasAttributeNS(e,t)?r.getAttributeNS(e,t):null}function rn(r){return new Error(`Could not parse ttml timestamp ${r}`)}function As(r,e){if(!r)return null;let t=gr(r);return t===null&&(yr.test(r)?t=jc(r,e):Sr.test(r)&&(t=zc(r,e))),t}function jc(r,e){const t=yr.exec(r),s=(t[4]|0)+(t[5]|0)/e.subFrameRate;return (t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+s/e.frameRate}function zc(r,e){const t=Sr.exec(r),s=Number(t[1]);switch(t[2]){case "h":return s*3600;case "m":return s*60;case "ms":return s*1e3;case "f":return s/e.frameRate;case "t":return s/e.tickRate}return s}class Nt{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t;}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null);}newCue(e,t,s){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=s,this.timelineController.createCaptionsTrack(this.trackName);}reset(){this.cueRanges=[],this.startTime=null;}}class Qc{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=true,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=on(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(y.FRAG_LOADING,this.onFragLoading,this),e.on(y.FRAG_LOADED,this.onFragLoaded,this),e.on(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(y.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this);}destroy(){const{hls:e}=this;e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(y.FRAG_LOADING,this.onFragLoading,this),e.off(y.FRAG_LOADED,this.onFragLoaded,this),e.off(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(y.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0;}initCea608Parsers(){const e=new Nt(this,"textTrack1"),t=new Nt(this,"textTrack2"),s=new Nt(this,"textTrack3"),i=new Nt(this,"textTrack4");this.cea608Parser1=new tn(1,e,t),this.cea608Parser2=new tn(3,s,i);}addCues(e,t,s,i,n){let a=false;for(let o=n.length;o--;){const l=n[o],c=Xc(l[0],l[1],t,s);if(c>=0&&(l[0]=Math.min(l[0],t),l[1]=Math.max(l[1],s),a=true,c/(s-t)>.5))return}if(a||n.push([t,s]),this.config.renderTextTracksNatively){const o=this.captionsTracks[e];this.Cues.newCue(o,t,s,i);}else {const o=this.Cues.newCue(null,t,s,i);this.hls.trigger(y.CUES_PARSED,{type:"captions",cues:o,track:e});}}onInitPtsFound(e,{frag:t,id:s,initPTS:i,timescale:n,trackId:a}){const{unparsedVttFrags:o}=this;s===K.MAIN&&(this.initPTS[t.cc]={baseTime:i,timescale:n,trackId:a}),o.length&&(this.unparsedVttFrags=[],o.forEach(l=>{this.initPTS[l.frag.cc]?this.onFragLoaded(y.FRAG_LOADED,l):this.hls.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:false,frag:l.frag,error:new Error("Subtitle discontinuity domain does not match main")});}));}getExistingTrack(e,t){const{media:s}=this;if(s)for(let i=0;i<s.textTracks.length;i++){const n=s.textTracks[i];if(an(n,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return n}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e);}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:s,media:i}=this,{label:n,languageCode:a}=t[e],o=this.getExistingTrack(n,a);if(o)s[e]=o,pt(s[e]),fc(s[e],i);else {const l=this.createTextTrack("captions",n,a);l&&(l[e]=true,s[e]=l);}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const s=t.label,i={_id:e,label:s,kind:"captions",default:t.media?!!t.media.default:false,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=i,this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]});}createTextTrack(e,t,s){const i=this.media;if(i)return i.addTextTrack(e,t,s)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks();}onMediaDetaching(e,t){const s=!!t.transferMedia;if(this.media=null,s)return;const{captionsTracks:i}=this;Object.keys(i).forEach(n=>{pt(i[n]),delete i[n];}),this.nonNativeCaptionsTracks={};}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=on(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset());}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let s=0;s<t.length;s++)pt(t[s]);}onSubtitleTracksUpdated(e,t){const s=t.subtitleTracks||[],i=s.some(n=>n.textCodec===Ts);if(this.config.enableWebVTT||i&&this.config.enableIMSC1){if(Xn(this.tracks,s)){this.tracks=s;return}if(this.textTracks=[],this.tracks=s,this.config.renderTextTracksNatively){const a=this.media,o=a?Kt(a.textTracks):null;if(this.tracks.forEach((l,c)=>{let h;if(o){let u=null;for(let d=0;d<o.length;d++)if(o[d]&&an(o[d],l)){u=o[d],o[d]=null;break}u&&(h=u);}if(h)pt(h);else {const u=Tr(l);h=this.createTextTrack(u,l.name,l.lang),h&&(h.mode="disabled");}h&&this.textTracks.push(h);}),o!=null&&o.length){const l=o.filter(c=>c!==null).map(c=>c.label);l.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${l.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`);}}else if(this.tracks.length){const a=this.tracks.map(o=>({label:o.name,kind:o.type.toLowerCase(),default:o.default,subtitleTrack:o}));this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:a});}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(s=>{const i=/(?:CC|SERVICE)([1-4])/.exec(s.instreamId);if(!i)return;const n=`textTrack${i[1]}`,a=this.captionsProperties[n];a&&(a.label=s.name,s.lang&&(a.languageCode=s.lang),a.media=s);});}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t?.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===K.MAIN){var s,i;const{cea608Parser1:n,cea608Parser2:a,lastSn:o}=this,{cc:l,sn:c}=t.frag,h=(s=(i=t.part)==null?void 0:i.index)!=null?s:-1;n&&a&&(c!==o+1||c===o&&h!==this.lastPartIndex+1||l!==this.lastCc)&&(n.reset(),a.reset()),this.lastCc=l,this.lastSn=c,this.lastPartIndex=h;}}onFragLoaded(e,t){const{frag:s,payload:i}=t;if(s.type===K.SUBTITLE)if(i.byteLength){const n=s.decryptdata,a="stats"in t;if(n==null||!n.encrypted||a){const o=this.tracks[s.level],l=this.vttCCs;l[s.cc]||(l[s.cc]={start:s.start,prevCC:this.prevCC,new:true},this.prevCC=s.cc),o&&o.textCodec===Ts?this._parseIMSC1(s,i):this._parseVTTs(t);}}else this.hls.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:false,frag:s,error:new Error("Empty subtitle payload")});}_parseIMSC1(e,t){const s=this.hls;sn(t,this.initPTS[e.cc],i=>{this._appendCues(i,e.level),s.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:true,frag:e});},i=>{s.logger.log(`Failed to parse IMSC1: ${i}`),s.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:false,frag:e,error:i});});}_parseVTTs(e){var t;const{frag:s,payload:i}=e,{initPTS:n,unparsedVttFrags:a}=this,o=n.length-1;if(!n[s.cc]&&o===-1){a.push(e);return}const l=this.hls,c=(t=s.initSegment)!=null&&t.data?Ae(s.initSegment.data,new Uint8Array(i)).buffer:i;Hc(c,this.initPTS[s.cc],this.vttCCs,s.cc,s.start,h=>{this._appendCues(h,s.level),l.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:true,frag:s});},h=>{const u=h.message==="Missing initPTS for VTT MPEGTS";u?a.push(e):this._fallbackToIMSC1(s,i),l.logger.log(`Failed to parse VTT cue: ${h}`),!(u&&o>s.cc)&&l.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:false,frag:s,error:h});});}_fallbackToIMSC1(e,t){const s=this.tracks[e.level];s.textCodec||sn(t,this.initPTS[e.cc],()=>{s.textCodec=Ts,this._parseIMSC1(e,t);},()=>{s.textCodec="wvtt";});}_appendCues(e,t){const s=this.hls;if(this.config.renderTextTracksNatively){const i=this.textTracks[t];if(!i||i.mode==="disabled")return;e.forEach(n=>hr(i,n));}else {const i=this.tracks[t];if(!i)return;const n=i.default?"default":"subtitles"+t;s.trigger(y.CUES_PARSED,{type:"subtitles",cues:e,track:n});}}onFragDecrypted(e,t){const{frag:s}=t;s.type===K.SUBTITLE&&this.onFragLoaded(y.FRAG_LOADED,t);}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={};}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:s,samples:i}=t;if(!(s.type===K.MAIN&&this.closedCaptionsForLevel(s)==="NONE"))for(let n=0;n<i.length;n++){const a=i[n].bytes;if(a){this.cea608Parser1||this.initCea608Parsers();const o=this.extractCea608Data(a);this.cea608Parser1.addData(i[n].pts,o[0]),this.cea608Parser2.addData(i[n].pts,o[1]);}}}onBufferFlushing(e,{startOffset:t,endOffset:s,endOffsetSubtitles:i,type:n}){const{media:a}=this;if(!(!a||a.currentTime<s)){if(!n||n==="video"){const{captionsTracks:o}=this;Object.keys(o).forEach(l=>Qi(o[l],t,s));}if(this.config.renderTextTracksNatively&&t===0&&i!==void 0){const{textTracks:o}=this;Object.keys(o).forEach(l=>Qi(o[l],t,i));}}}extractCea608Data(e){const t=[[],[]],s=e[0]&31;let i=2;for(let n=0;n<s;n++){const a=e[i++],o=127&e[i++],l=127&e[i++];if(o===0&&l===0)continue;if((4&a)!==0){const h=3&a;(h===0||h===1)&&(t[h].push(o),t[h].push(l));}}return t}}function Tr(r){return r.characteristics&&/transcribes-spoken-dialog/gi.test(r.characteristics)&&/describes-music-and-sound/gi.test(r.characteristics)?"captions":"subtitles"}function an(r,e){return !!r&&r.kind===Tr(e)&&Cs(e,r)}function Xc(r,e,t,s){return Math.min(e,s)-Math.max(r,t)}function on(){return {ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:true}}}const Zc=/\s/,Jc={newCue(r,e,t,s){const i=[];let n,a,o,l,c;const h=self.VTTCue||self.TextTrackCue;for(let d=0;d<s.rows.length;d++)if(n=s.rows[d],o=true,l=0,c="",!n.isEmpty()){var u;for(let m=0;m<n.chars.length;m++)Zc.test(n.chars[m].uchar)&&o?l++:(c+=n.chars[m].uchar,o=false);n.cueStartTime=e,e===t&&(t+=1e-4),l>=16?l--:l++;const g=pr(c.trim()),f=Js(e,t,g);r!=null&&(u=r.cues)!=null&&u.getCueById(f)||(a=new h(e,t,g),a.id=f,a.line=d+1,a.align="left",a.position=10+Math.min(80,Math.floor(l*8/32)*10),i.push(a));}return r&&i.length&&(i.sort((d,g)=>d.line==="auto"||g.line==="auto"?0:d.line>8&&g.line>8?g.line-d.line:d.line-g.line),i.forEach(d=>hr(r,d))),i}},eh=/^age:\s*[\d.]+\s*$/im;class th{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new Fr,this.retryDelay=0;}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null;}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=true,e.abort()));}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader);}load(e,t,s){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=s,this.loadInternal();}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const s=this.loader=new self.XMLHttpRequest,i=this.stats;i.loading.first=0,i.loaded=0,i.aborted=false;const n=this.xhrSetup;n?Promise.resolve().then(()=>{if(!(this.loader!==s||this.stats.aborted))return n(s,t.url)}).catch(a=>{if(!(this.loader!==s||this.stats.aborted))return s.open("GET",t.url,true),n(s,t.url)}).then(()=>{this.loader!==s||this.stats.aborted||this.openAndSendXhr(s,t,e);}).catch(a=>{var o;(o=this.callbacks)==null||o.onError({code:s.status,text:a.message},t,s,i);}):this.openAndSendXhr(s,t,e);}openAndSendXhr(e,t,s){e.readyState||e.open("GET",t.url,true);const i=t.headers,{maxTimeToFirstByteMs:n,maxLoadTimeMs:a}=s.loadPolicy;if(i)for(const o in i)e.setRequestHeader(o,i[o]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),s.timeout=n&&B(n)?n:a,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.timeout),e.send();}readystatechange(){const{context:e,loader:t,stats:s}=this;if(!e||!t)return;const i=t.readyState,n=this.config;if(!s.aborted&&i>=2&&(s.loading.first===0&&(s.loading.first=Math.max(self.performance.now(),s.loading.start),n.timeout!==n.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),n.timeout=n.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),n.loadPolicy.maxLoadTimeMs-(s.loading.first-s.loading.start)))),i===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const c=t.status,h=t.responseType==="text"?t.responseText:null;if(c>=200&&c<300){const f=h??t.response;if(f!=null){var a,o;s.loading.end=Math.max(self.performance.now(),s.loading.first);const m=t.responseType==="arraybuffer"?f.byteLength:f.length;s.loaded=s.total=m,s.bwEstimate=s.total*8e3/(s.loading.end-s.loading.first);const p=(a=this.callbacks)==null?void 0:a.onProgress;p&&p(s,e,f,t);const S={url:t.responseURL,data:f,code:c};(o=this.callbacks)==null||o.onSuccess(S,s,e,t);return}}const u=n.loadPolicy.errorRetry,d=s.retry,g={url:e.url,data:void 0,code:c};if(Yt(u,d,false,g))this.retry(u);else {var l;re.error(`${c} while loading ${e.url}`),(l=this.callbacks)==null||l.onError({code:c,text:t.statusText},e,t,s);}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(Yt(e,t,true))this.retry(e);else {var s;re.warn(`timeout while loading ${(s=this.context)==null?void 0:s.url}`);const i=this.callbacks;i&&(this.abortInternal(),i.onTimeout(this.stats,this.context,this.loader));}}retry(e){const{context:t,stats:s}=this;this.retryDelay=Us(e,s.retry),s.retry++,re.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t?.url}, retrying ${s.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay);}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total);}getCacheAge(){let e=null;if(this.loader&&eh.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null;}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const sh={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null};ee(ee({autoStartLoad:true,startPosition:-1,defaultAudioCodec:void 0,debug:false,capLevelOnFPSDrop:false,capLevelToPlayerSize:false,ignoreDevicePixelRatio:false,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:true,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:false,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:true,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:false,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:true,workerPath:null,enableSoftwareAES:true,startLevel:void 0,startFragPrefetch:false,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:false,loader:th,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:ya,bufferController:ul,capLevelController:zs,errorController:va,fpsController:dc,stretchShortVideoTrack:false,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:true,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:false,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:false,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Rn,requireKeySystemAccessOnStart:false,testBandwidth:true,progressive:false,lowLatencyMode:true,cmcd:void 0,enableDateRangeMetadataCues:true,enableEmsgMetadataCues:true,enableEmsgKLVMetadata:false,enableID3MetadataCues:true,enableInterstitialPlayback:true,interstitialAppendInPlace:true,interstitialLiveLookAhead:10,useMediaCapabilities:true,preserveManualLevelOnError:false,certLoadPolicy:{default:sh},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},ih()),{},{subtitleStreamController:Ic,subtitleTrackController:pc,timelineController:Qc,audioStreamController:ol,audioTrackController:ll,emeController:lt,cmcdController:lc,contentSteeringController:hc,interstitialsController:Ac});function ih(){return {cueHandler:Jc,enableWebVTT:true,enableIMSC1:true,enableCEA708Captions:true,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:true}}function nh(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}(()=>{const r=nh();try{r&&new r(0,Number.POSITIVE_INFINITY,"");}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function ch(r,e){r.component(t=>{let{src:s$1=void 0,muted:i=void 0,playsinline:n=void 0,preload:a=void 0,autoplay:o=void 0,controls:l=void 0,currentTime:c=void 0,duration:h=void 0,paused:u=void 0,node:d=void 0,loop:g,is_stream:f,processingVideo:m=false,onloadeddata:p,onclick:S,onplay:E,onpause:T,onended:A,onmouseover:I,onmouseout:D,onfocus:v,onblur:L,onerror:b,onloadstart:R,onloadedmetadata:P,"data-testid":O,children:N}=e;t.push(`<div${attr_class("overlay svelte-17x1mvh",void 0,{hidden:!m})}><span class="load-wrap svelte-17x1mvh"><span class="loader svelte-17x1mvh"></span></span></div> <video${attr("src",s$1)}${attr("muted",i,true)}${attr("playsinline",n,true)}${attr("preload",a)}${attr("autoplay",o,true)}${attr("controls",l,true)}${attr("loop",g,true)}${attr("data-testid",O)} crossorigin="anonymous" class="svelte-17x1mvh">`),N?(t.push("<!--[-->"),N(t),t.push("<!---->")):t.push("<!--[!-->"),t.push("<!--]--></video>"),bind_props(e,{currentTime:c,duration:h,paused:u,node:d});});}

export { ch as c };
//# sourceMappingURL=Video2-BN0RGMYm.js.map
