const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./shadowMap.fragment-BL6AKVW4.js","./index-WPyB0dpY.js","./index-VELz1aW8.js","./index-D0tiHk1o.css","./packingFunctions-D94LO-z7.js","./clipPlaneFragment-Dsfroj8b.js","./shadowMap.vertex-D17xI9N5.js","./bonesDeclaration-BoGd3WD7.js","./instancesVertex-iU725k8C.js","./morphTargetsVertexDeclaration-B8R08NSd.js","./helperFunctions-ja4a2Aut.js","./sceneUboDeclaration-xs5YJum5.js","./meshUboDeclaration-B4569SdN.js","./clipPlaneVertex-CZ4oetsD.js","./morphTargetsVertex-CSWIbCJu.js","./bonesVertex-4ci19Goy.js","./bakedVertexAnimation-CH0trvUy.js","./depthBoxBlur.fragment-MrttOjHe.js","./shadowMapFragmentSoftTransparentShadow-_6YAIAA_.js","./shadowMap.fragment-BF_AMdIU.js","./packingFunctions-DaH5YC3f.js","./clipPlaneFragment-D1llzUO6.js","./shadowMap.vertex-RiDH-s_U.js","./bakedVertexAnimation-BItR6CPA.js","./morphTargetsVertex-C-pDzpjO.js","./helperFunctions-T8yoXWZR.js","./sceneUboDeclaration-CMUgFcJV.js","./meshUboDeclaration-BLbTBNiq.js","./clipPlaneVertex-Dw9JEwrQ.js","./depthBoxBlur.fragment-BmPZ4n2e.js","./shadowMapFragmentSoftTransparentShadow-CMFxabdL.js"])))=>i.map(i=>d[i]);
import{_ as L}from"./index-VELz1aW8.js";import{aA as v,T as S,b7 as B,e as K,_ as C,b8 as Y,s as z,R as Q,O as F,V as O,M as b,aL as D,b9 as U,ba as y,ah as k,bb as j,aI as H,c as W,a5 as Z,a2 as q,b5 as $,J as M,E as J,b3 as G,b4 as ee,b2 as te,Y as se,bc as ie,bd as V,be as re}from"./index-WPyB0dpY.js";import"./svelte/svelte_svelte.js";import"./svelte/svelte_animate.js";import"./svelte/svelte_attachments.js";import"./svelte/svelte_easing.js";import"./svelte/svelte_internal_client.js";import"./svelte/svelte_internal_flags_async.js";import"./svelte/svelte_internal_flags_legacy.js";import"./svelte/svelte_internal_flags_tracing.js";import"./svelte/svelte_internal_server.js";import"./svelte/svelte_legacy.js";import"./svelte/svelte_motion.js";import"./svelte/svelte_reactivity.js";import"./svelte/svelte_reactivity_window.js";import"./svelte/svelte_server.js";import"./svelte/svelte_store.js";import"./svelte/svelte_transition.js";import"./svelte/svelte_events.js";class P extends v{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}set kernel(e){this._effectWrapper.kernel=e}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,s,i,a=null,r=S.BILINEAR_SAMPLINGMODE,o,h,d=0,f="",l=!1,g=5){const c=typeof i=="number"?l:!!i.blockCompilation,_={uniforms:B.Uniforms,samplers:B.Samplers,size:typeof i=="number"?i:void 0,camera:a,samplingMode:r,engine:o,reusable:h,textureType:d,vertexUrl:B.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:g,defines:f,...i,blockCompilation:!0};super(e,B.FragmentUrl,{effectWrapper:typeof i=="number"||!i.effectWrapper?new B(e,o,void 0,void 0,_):void 0,..._}),this._effectWrapper.options.blockCompilation=c,this.direction=t,this.onApplyObservable.add(()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height}),this.kernel=s}updateEffect(e=null,t=null,s=null,i,a,r){this._effectWrapper._updateParameters(a,r)}static _Parse(e,t,s,i){return K.Parse(()=>new P(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable,e.textureType,void 0,!1),e,s,i)}}C([Y()],P.prototype,"direction",null);C([z()],P.prototype,"kernel",null);C([z()],P.prototype,"packedFloat",null);Q("BABYLON.BlurPostProcess",P);class n{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===n.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(e===n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(e===n.FILTER_PCF||e===n.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===n.FILTER_PCF||e===n.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get usePoissonSampling(){return this.filter===n.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(n.FILTER_POISSONSAMPLING);!e&&this.filter!==n.FILTER_POISSONSAMPLING||(this.filter=e?t:n.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===n.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(n.FILTER_EXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_EXPONENTIALSHADOWMAP||(this.filter=e?t:n.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===n.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(n.FILTER_BLUREXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=e?t:n.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===n.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(n.FILTER_CLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:n.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:n.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===n.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(n.FILTER_PCF);!e&&this.filter!==n.FILTER_PCF||(this.filter=e?t:n.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===n.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(n.FILTER_PCSS);!e&&this.filter!==n.FILTER_PCSS||(this.filter=e?t:n.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return n.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(e)===-1&&this._shadowMap.renderList.push(e),t)for(const s of e.getChildMeshes())this._shadowMap.renderList.indexOf(s)===-1&&this._shadowMap.renderList.push(s);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const s=this._shadowMap.renderList.indexOf(e);if(s!==-1&&this._shadowMap.renderList.splice(s,1),t)for(const i of e.getChildren())this.removeShadowCaster(i);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,s,i,a,r=!1){this.onBeforeShadowMapRenderObservable=new F,this.onAfterShadowMapRenderObservable=new F,this.onBeforeShadowMapRenderMeshObservable=new F,this.onAfterShadowMapRenderMeshObservable=new F,this.doNotSerialize=!1,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=n.FILTER_NONE,this._filteringQuality=n.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=O.Zero(),this._viewMatrix=b.Zero(),this._projectionMatrix=b.Zero(),this._transformMatrix=b.Zero(),this._cachedPosition=new O(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new O(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=b.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=i??null,this._useRedTextureType=!!a,this._initShaderSourceAsync(r);let o=t._shadowGenerators;o||(o=t._shadowGenerators=new Map),o.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),n._SceneComponentInitialization(this._scene);const h=this._scene.getEngine().getCaps();s?h.textureFloatRender&&h.textureFloatLinearFiltering?this._textureType=1:h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?this._textureType=2:h.textureFloatRender&&h.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();this._shadowMap?.dispose(),e._features.supportDepthStencilTexture?(this._shadowMap=new D(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new D(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),this._shadowMap===null)return;this._shadowMap.wrapU=S.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=S.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(S.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(i,a,r,o)=>this._renderForShadowMap(i,a,r,o),this._shadowMap.customIsReadyFunction=(i,a,r)=>{if(!r||!i.subMeshes)return!0;let o=!0;for(const h of i.subMeshes){const d=h.getRenderingMesh(),l=this._scene.getEngine(),g=h.getMaterial();if(!g||h.verticesCount===0||this.customAllowRendering&&!this.customAllowRendering(h))continue;const c=d._getInstancesRenderList(h._id,!!h.getReplacementMesh());if(c.mustReturn)continue;const _=l.getCaps().instancedArrays&&(c.visibleInstances[h._id]!==null&&c.visibleInstances[h._id]!==void 0||d.hasThinInstances),x=g.needAlphaBlendingForMesh(d);o=this.isReady(h,_,x)&&o}return o};const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._enableGPUDebugMarkers&&(e.restoreDefaultFramebuffer(),e._debugPushGroup?.(`Shadow map generation for pass id ${e.currentRenderPassId}`))}),this._shadowMap.onBeforeRenderObservable.add(i=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=i,this._filter===n.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),V.eyeAtCamera=!1,this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),V.eyeAtCamera=!0,this._scene.updateTransformMatrix(),this._filter===n.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap){e._debugPopGroup?.();return}const i=this.getShadowMapForRendering();i&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,i.renderTarget,!0),e.unBindFramebuffer(i.renderTarget,!0)),e._enableGPUDebugMarkers&&e._debugPopGroup?.()});const t=new U(0,0,0,0),s=new U(1,1,1,1);this._shadowMap.onClearObservable.add(i=>{this._filter===n.FILTER_PCF?i.clear(s,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?i.clear(t,!0,!0,!1):i.clear(s,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(i=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=i.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let i=y.MIN_RENDERINGGROUPS;i<y.MAX_RENDERINGGROUPS;i++)this._shadowMap.setRenderingAutoClearDepthStencil(i,!1)}async _initShaderSourceAsync(e=!1){this._scene.getEngine().isWebGPU&&!e&&!n.ForceGLSL?(this._shaderLanguage=1,await Promise.all([L(()=>import("./shadowMap.fragment-BL6AKVW4.js"),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),L(()=>import("./shadowMap.vertex-D17xI9N5.js"),__vite__mapDeps([6,1,2,3,7,8,9,10,11,12,13,14,15,16]),import.meta.url),L(()=>import("./depthBoxBlur.fragment-MrttOjHe.js"),__vite__mapDeps([17,1,2,3]),import.meta.url),L(()=>import("./shadowMapFragmentSoftTransparentShadow-_6YAIAA_.js"),__vite__mapDeps([18,1,2,3]),import.meta.url)])):await Promise.all([L(()=>import("./shadowMap.fragment-BF_AMdIU.js"),__vite__mapDeps([19,1,2,3,20,21]),import.meta.url),L(()=>import("./shadowMap.vertex-RiDH-s_U.js"),__vite__mapDeps([22,1,2,3,23,24,25,26,27,28]),import.meta.url),L(()=>import("./depthBoxBlur.fragment-BmPZ4n2e.js"),__vite__mapDeps([29,1,2,3]),import.meta.url),L(()=>import("./shadowMapFragmentSoftTransparentShadow-CMFxabdL.js"),__vite__mapDeps([30,1,2,3]),import.meta.url)]),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new D(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=S.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=S.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(S.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new P(this._light.name+"KernelBlurX",new k(1,0),this.blurKernel,1,null,S.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(s=>{s.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new P(this._light.name+"KernelBlurY",new k(0,1),this.blurKernel,1,null,S.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new v(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,S.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(s=>{s.setFloat2("screenSize",t,t),s.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,s,i){let a;if(i.length)for(a=0;a<i.length;a++)this._renderSubMeshForShadowMap(i.data[a]);for(a=0;a<e.length;a++)this._renderSubMeshForShadowMap(e.data[a]);for(a=0;a<t.length;a++)this._renderSubMeshForShadowMap(t.data[a]);if(this._transparencyShadow)for(a=0;a<s.length;a++)this._renderSubMeshForShadowMap(s.data[a],!0);else for(a=0;a<s.length;a++)s.data[a].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,s){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){const s=e.getRenderingMesh(),i=e.getEffectiveMesh(),a=this._scene,r=a.getEngine(),o=e.getMaterial();if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!o||e.verticesCount===0||e._renderId===a.getRenderId())return;const h=a.useRightHandedSystem,d=i._getWorldMatrixDeterminant()<0;let f=o._getEffectiveOrientation(s);(d&&!h||!d&&h)&&(f=f===0?1:0);const l=f===0;r.setState(o.backFaceCulling,void 0,void 0,l,o.cullBackFaces);const g=s._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(g.mustReturn)return;const c=r.getCaps().instancedArrays&&(g.visibleInstances[e._id]!==null&&g.visibleInstances[e._id]!==void 0||s.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(e)))if(this.isReady(e,c,t)){e._renderId=a.getRenderId();const _=o.shadowDepthWrapper,x=_?.getEffect(e,this,r.currentRenderPassId)??e._getDrawWrapper(),u=j.GetEffect(x);r.enableEffect(x),c||s._bind(e,u,o.fillMode),this.getTransformMatrix(),u.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===H.LIGHTTYPEID_DIRECTIONALLIGHT?u.setVector3("lightDataSM",this._cachedDirection):u.setVector3("lightDataSM",this._cachedPosition.subtractToRef(this._scene.floatingOriginOffset,W.Vector3[0]));const A=this._getCamera();if(u.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(A),this.getLight().getDepthMinZ(A)+this.getLight().getDepthMaxZ(A)),t&&this.enableSoftTransparentShadow&&u.setFloat2("softTransparentShadowSM",i.visibility*o.alpha,this._opacityTexture?.getAlphaFromRGB?1:0),_)e._setMainDrawWrapperOverride(x),_.standalone?_.baseMaterial.bindForSubMesh(i.getWorldMatrix(),s,e):o.bindForSubMesh(i.getWorldMatrix(),s,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(u.setTexture("diffuseSampler",this._opacityTexture),u.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),s.useBones&&s.computeBonesUsingShaders&&s.skeleton){const m=s.skeleton;if(m.isUsingTextureForMatrices){const p=m.getTransformMatrixTexture(s);if(!p)return;u.setTexture("boneSampler",p),u.setFloat("boneTextureWidth",4*(m.bones.length+1))}else u.setMatrices("mBones",m.getTransformMatrices(s))}Z(s,u),s.morphTargetManager&&s.morphTargetManager.isUsingTextureForTargets&&s.morphTargetManager._bind(u);const E=e.getMesh().bakedVertexAnimationManager;E&&E.isEnabled&&E.bind(u,c),q(u,o,a)}!this._useUBO&&!_&&this._bindCustomEffectForRenderSubMeshForShadowMap(e,u,i),$(u,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const I=i.getWorldMatrix();c&&(i.getMeshUniformBuffer().bindToEffect(u,"Mesh"),i.transferToEffect(I)),this.forceBackFacesOnly&&r.setState(!0,0,!1,!0,o.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(s),this.onBeforeShadowMapRenderObservable.notifyObservers(u),s._processRendering(i,e,u,o.fillMode,g,c,(E,m)=>{i!==s&&!E?(s.getMeshUniformBuffer().bindToEffect(u,"Mesh"),s.transferToEffect(m)):(i.getMeshUniformBuffer().bindToEffect(u,"Mesh"),i.transferToEffect(E?m:I))}),this.forceBackFacesOnly&&r.setState(!0,0,!1,!1,o.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(u),this.onAfterShadowMapRenderMeshObservable.notifyObservers(s)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===n.FILTER_NONE||this.filter===n.FILTER_PCSS?this._shadowMap.updateSamplingMode(S.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(S.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const s={useInstances:!1,...t},i=this.getShadowMap();if(!i){e&&e(this);return}const a=i.renderList;if(!a){e&&e(this);return}const r=[];for(const d of a)r.push(...d.subMeshes);if(r.length===0){e&&e(this);return}let o=0;const h=()=>{if(!(!this._scene||!this._scene.getEngine())){for(;this.isReady(r[o],s.useInstances,r[o].getMaterial()?.needAlphaBlendingForMesh(r[o].getMesh())??!1);)if(o++,o>=r.length){e&&e(this);return}setTimeout(h,16)}};h()}async forceCompilationAsync(e){return await new Promise(t=>{this.forceCompilation(()=>{t()},e)})}_isReadyCustomDefines(e,t,s){}_prepareShadowDefines(e,t,s,i){s.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),s.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),s.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),s.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const a=e.getMesh();return s.push("#define SM_NORMALBIAS "+(this.normalBias&&a.isVerticesDataPresent(M.NormalKind)?"1":"0")),s.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===H.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),s.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),s.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&i?"1":"0")),this._isReadyCustomDefines(s,e,t),s}isReady(e,t,s){if(!this._shadersLoaded)return!1;const i=e.getMaterial(),a=i?.shadowDepthWrapper;if(this._opacityTexture=null,!i)return!1;const r=[];if(this._prepareShadowDefines(e,t,r,s),a){if(!a.isReadyForSubMesh(e,r,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const o=e._getDrawWrapper(void 0,!0);let h=o.effect,d=o.defines;const f=[M.PositionKind],l=e.getMesh();let g=!1,c=!1,_=!1;const x=!1;this.normalBias&&l.isVerticesDataPresent(M.NormalKind)&&(f.push(M.NormalKind),r.push("#define NORMAL"),g=!0,l.nonUniformScaling&&r.push("#define NONUNIFORMSCALING"));const u=i.needAlphaTestingForMesh(l);if((u||i.needAlphaBlendingForMesh(l))&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=i.opacityTexture:this._opacityTexture=i.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const p=i.alphaCutOff??n.DEFAULT_ALPHA_CUTOFF;r.push("#define ALPHATEXTURE"),u&&r.push(`#define ALPHATESTVALUE ${p}${p%1===0?".":""}`),l.isVerticesDataPresent(M.UVKind)&&(f.push(M.UVKind),r.push("#define UV1"),c=!0),l.isVerticesDataPresent(M.UV2Kind)&&this._opacityTexture.coordinatesIndex===1&&(f.push(M.UV2Kind),r.push("#define UV2"),_=!0)}const A=new J;if(l.useBones&&l.computeBonesUsingShaders&&l.skeleton){f.push(M.MatricesIndicesKind),f.push(M.MatricesWeightsKind),l.numBoneInfluencers>4&&(f.push(M.MatricesIndicesExtraKind),f.push(M.MatricesWeightsExtraKind));const p=l.skeleton;r.push("#define NUM_BONE_INFLUENCERS "+l.numBoneInfluencers),l.numBoneInfluencers>0&&A.addCPUSkinningFallback(0,l),p.isUsingTextureForMatrices?r.push("#define BONETEXTURE"):r.push("#define BonesPerMesh "+(p.bones.length+1))}else r.push("#define NUM_BONE_INFLUENCERS 0");const I=l.morphTargetManager?G(l.morphTargetManager,r,f,l,!0,g,!1,c,_,x):0;if(ee(i,this._scene,r),t&&(r.push("#define INSTANCES"),te(f),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const p of this.customShaderOptions.defines)r.indexOf(p)===-1&&r.push(p);const E=l.bakedVertexAnimationManager;E&&E.isEnabled&&(r.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&f.push("bakedVertexAnimationSettingsInstanced"));const m=r.join(`
`);if(d!==m){d=m;let p="shadowMap";const R=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],w=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],X=["Scene","Mesh"];if(se(R),this.customShaderOptions){if(p=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const T of this.customShaderOptions.attributes)f.indexOf(T)===-1&&f.push(T);if(this.customShaderOptions.uniforms)for(const T of this.customShaderOptions.uniforms)R.indexOf(T)===-1&&R.push(T);if(this.customShaderOptions.samplers)for(const T of this.customShaderOptions.samplers)w.indexOf(T)===-1&&w.push(T)}const N=this._scene.getEngine();h=N.createEffect(p,{attributes:f,uniformsNames:R,uniformBuffersNames:X,samplers:w,defines:m,fallbacks:A,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:I},shaderLanguage:this._shaderLanguage},N),o.setEffect(h,d)}if(!h.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){const s=this._scene,i=this._light;!s.shadowsEnabled||!i.shadowEnabled||(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===n.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===n.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===n.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===n.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),i.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const s=this._light,i=this._scene;if(!i.shadowsEnabled||!s.shadowEnabled)return;const a=this._getCamera(),r=this.getShadowMap();if(!r)return;if(!s.needCube()){const h=i.floatingOriginOffset,d=this.getTransformMatrix(),f=i.floatingOriginMode?ie(h,this._viewMatrix,this._projectionMatrix,W.Matrix[0]):d;t.setMatrix("lightMatrix"+e,f)}const o=this.getShadowMapForRendering();this._filter===n.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,o),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),r.getSize().width,1/r.getSize().width,this.frustumEdgeFalloff,e)):this._filter===n.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,o),t.setTexture("depthTexture"+e,o),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/r.getSize().width,this._contactHardeningLightSizeUVRatio*r.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,o),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/r.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),s._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(a),this.getLight().getDepthMinZ(a)+this.getLight().getDepthMaxZ(a),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),O.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(O.Dot(this._lightDirection,O.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),b.LookAtLHToRef(t,t.add(this._lightDirection),O.Up(),this._viewMatrix);const s=this.getShadowMap();if(s){const i=s.renderList;i&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,i)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const s of t)this._shadowMap.renderList.push(s)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();t.done!==!0;t=e.next()){const[s,i]=t.value;i===this&&this._light._shadowGenerators.delete(s)}this._light._shadowGenerators.size===0&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){const e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=this._camera?.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let s=0;s<t.renderList.length;s++){const i=t.renderList[s];e.renderList.push(i.id)}return e}static Parse(e,t,s){const i=t.getLightById(e.lightId),a=e.cameraId!==void 0?t.getCameraById(e.cameraId):null,r=s?s(e.mapSize,i,a):new n(e.mapSize,i,void 0,a),o=r.getShadowMap();if(e.renderList.length&&o){const h=new Set(e.renderList);let d=o.renderList;d||(d=o.renderList=[]);const f=t.meshes;for(const l of f)h.has(l.id)&&d.push(l)}return e.id!==void 0&&(r.id=e.id),r.forceBackFacesOnly=!!e.forceBackFacesOnly,e.darkness!==void 0&&r.setDarkness(e.darkness),e.transparencyShadow&&r.setTransparencyShadow(!0),e.frustumEdgeFalloff!==void 0&&(r.frustumEdgeFalloff=e.frustumEdgeFalloff),e.bias!==void 0&&(r.bias=e.bias),e.normalBias!==void 0&&(r.normalBias=e.normalBias),e.usePercentageCloserFiltering?r.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?r.useContactHardeningShadow=!0:e.usePoissonSampling?r.usePoissonSampling=!0:e.useExponentialShadowMap?r.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?r.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?r.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?r.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?r.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(r.useBlurExponentialShadowMap=!0),e.contactHardeningLightSizeUVRatio!==void 0&&(r.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),e.filteringQuality!==void 0&&(r.filteringQuality=e.filteringQuality),e.depthScale&&(r.depthScale=e.depthScale),e.blurScale&&(r.blurScale=e.blurScale),e.blurBoxOffset&&(r.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(r.useKernelBlur=e.useKernelBlur),e.blurKernel&&(r.blurKernel=e.blurKernel),r}}n.CLASSNAME="ShadowGenerator";n.ForceGLSL=!1;n.FILTER_NONE=0;n.FILTER_EXPONENTIALSHADOWMAP=1;n.FILTER_POISSONSAMPLING=2;n.FILTER_BLUREXPONENTIALSHADOWMAP=3;n.FILTER_CLOSEEXPONENTIALSHADOWMAP=4;n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5;n.FILTER_PCF=6;n.FILTER_PCSS=7;n.QUALITY_HIGH=0;n.QUALITY_MEDIUM=1;n.QUALITY_LOW=2;n.DEFAULT_ALPHA_CUTOFF=.5;n._SceneComponentInitialization=ne=>{throw re("ShadowGeneratorSceneComponent")};export{n as ShadowGenerator};
