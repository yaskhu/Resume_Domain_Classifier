function w(v,i,t,e){return new(t||(t=Promise))((function(s,o){function r(u){try{a(e.next(u))}catch(d){o(d)}}function n(u){try{a(e.throw(u))}catch(d){o(d)}}function a(u){var d;u.done?s(u.value):(d=u.value,d instanceof t?d:new t((function(m){m(d)}))).then(r,n)}a((e=e.apply(v,[])).next())}))}class g{constructor(){this.listeners={}}on(i,t,e){if(this.listeners[i]||(this.listeners[i]=new Set),e?.once){const s=(...o)=>{this.un(i,s),t(...o)};return this.listeners[i].add(s),()=>this.un(i,s)}return this.listeners[i].add(t),()=>this.un(i,t)}un(i,t){var e;(e=this.listeners[i])===null||e===void 0||e.delete(t)}once(i,t){return this.on(i,t,{once:!0})}unAll(){this.listeners={}}emit(i,...t){this.listeners[i]&&this.listeners[i].forEach((e=>e(...t)))}}class b extends g{constructor(i){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=i}onInit(){}_init(i){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=i,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((i=>i())),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}class y extends g{constructor(){super(...arguments),this.animationFrameId=null,this.isRunning=!1}start(){if(this.isRunning)return;this.isRunning=!0;const i=()=>{this.isRunning&&(this.emit("tick"),this.animationFrameId=requestAnimationFrame(i))};i()}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}destroy(){this.stop()}}const D=["audio/webm","audio/wav","audio/mpeg","audio/mp4","audio/mp3"];class W extends b{constructor(i){var t,e,s,o,r,n;super(Object.assign(Object.assign({},i),{audioBitsPerSecond:(t=i.audioBitsPerSecond)!==null&&t!==void 0?t:128e3,scrollingWaveform:(e=i.scrollingWaveform)!==null&&e!==void 0&&e,scrollingWaveformWindow:(s=i.scrollingWaveformWindow)!==null&&s!==void 0?s:5,continuousWaveform:(o=i.continuousWaveform)!==null&&o!==void 0&&o,renderRecordedAudio:(r=i.renderRecordedAudio)===null||r===void 0||r,mediaRecorderTimeslice:(n=i.mediaRecorderTimeslice)!==null&&n!==void 0?n:void 0})),this.stream=null,this.mediaRecorder=null,this.dataWindow=null,this.isWaveformPaused=!1,this.lastStartTime=0,this.lastDuration=0,this.duration=0,this.micStream=null,this.recordedBlobUrl=null,this.timer=new y,this.subscriptions.push(this.timer.on("tick",(()=>{const a=performance.now()-this.lastStartTime;this.duration=this.isPaused()?this.duration:this.lastDuration+a,this.emit("record-progress",this.duration)})))}static create(i){return new W(i||{})}renderMicStream(i){var t;const e=new AudioContext,s=e.createMediaStreamSource(i),o=e.createAnalyser();s.connect(o),this.options.continuousWaveform&&(o.fftSize=32);const r=o.frequencyBinCount,n=new Float32Array(r);let a=0;this.wavesurfer&&((t=this.originalOptions)!==null&&t!==void 0||(this.originalOptions=Object.assign({},this.wavesurfer.options)),this.wavesurfer.options.interact=!1,this.options.scrollingWaveform&&(this.wavesurfer.options.cursorWidth=0));const u=setInterval((()=>{var d,m,p,f;if(!this.isWaveformPaused){if(o.getFloatTimeDomainData(n),this.options.scrollingWaveform){const l=Math.floor((this.options.scrollingWaveformWindow||0)*e.sampleRate),h=Math.min(l,this.dataWindow?this.dataWindow.length+r:r),c=new Float32Array(l);if(this.dataWindow){const R=Math.max(0,l-this.dataWindow.length);c.set(this.dataWindow.slice(-h+r),R)}c.set(n,l-r),this.dataWindow=c}else if(this.options.continuousWaveform){if(!this.dataWindow){const h=this.options.continuousWaveformDuration?Math.round(100*this.options.continuousWaveformDuration):((m=(d=this.wavesurfer)===null||d===void 0?void 0:d.getWidth())!==null&&m!==void 0?m:0)*window.devicePixelRatio;this.dataWindow=new Float32Array(h)}let l=0;for(let h=0;h<r;h++){const c=Math.abs(n[h]);c>l&&(l=c)}if(a+1>this.dataWindow.length){const h=new Float32Array(2*this.dataWindow.length);h.set(this.dataWindow,0),this.dataWindow=h}this.dataWindow[a]=l,a++}else this.dataWindow=n;if(this.wavesurfer){const l=((f=(p=this.dataWindow)===null||p===void 0?void 0:p.length)!==null&&f!==void 0?f:0)/100;this.wavesurfer.load("",[this.dataWindow],this.options.scrollingWaveform?this.options.scrollingWaveformWindow:l).then((()=>{this.wavesurfer&&this.options.continuousWaveform&&(this.wavesurfer.setTime(this.getDuration()/1e3),this.wavesurfer.options.minPxPerSec||this.wavesurfer.setOptions({minPxPerSec:this.wavesurfer.getWidth()/this.wavesurfer.getDuration()}))})).catch((h=>{console.error("Error rendering real-time recording data:",h)}))}}}),10);return{onDestroy:()=>{clearInterval(u),s?.disconnect(),e?.close()},onEnd:()=>{this.isWaveformPaused=!0,this.stopMic()}}}startMic(i){return w(this,void 0,void 0,(function*(){let t;this.micStream&&this.stopMic();try{t=yield navigator.mediaDevices.getUserMedia({audio:i==null||i})}catch(s){throw new Error("Error accessing the microphone: "+s.message)}const e=this.renderMicStream(t);return this.micStream=e,this.unsubscribeDestroy=this.once("destroy",e.onDestroy),this.unsubscribeRecordEnd=this.once("record-end",e.onEnd),this.stream=t,t}))}stopMic(){var i,t,e;(i=this.micStream)===null||i===void 0||i.onDestroy(),(t=this.unsubscribeDestroy)===null||t===void 0||t.call(this),(e=this.unsubscribeRecordEnd)===null||e===void 0||e.call(this),this.micStream=null,this.unsubscribeDestroy=void 0,this.unsubscribeRecordEnd=void 0,this.stream&&(this.stream.getTracks().forEach((s=>s.stop())),this.stream=null,this.mediaRecorder=null)}startRecording(i){return w(this,void 0,void 0,(function*(){const t=this.stream||(yield this.startMic(i));this.dataWindow=null;const e=this.mediaRecorder||new MediaRecorder(t,{mimeType:this.options.mimeType||D.find((r=>MediaRecorder.isTypeSupported(r))),audioBitsPerSecond:this.options.audioBitsPerSecond});this.mediaRecorder=e,this.stopRecording();const s=[];e.ondataavailable=r=>{r.data.size>0&&s.push(r.data),this.emit("record-data-available",r.data)};const o=r=>{var n;const a=new Blob(s,{type:e.mimeType});this.emit(r,a),this.options.renderRecordedAudio&&(this.applyOriginalOptionsIfNeeded(),this.recordedBlobUrl&&URL.revokeObjectURL(this.recordedBlobUrl),this.recordedBlobUrl=URL.createObjectURL(a),(n=this.wavesurfer)===null||n===void 0||n.load(this.recordedBlobUrl))};e.onpause=()=>o("record-pause"),e.onstop=()=>o("record-end"),e.start(this.options.mediaRecorderTimeslice),this.lastStartTime=performance.now(),this.lastDuration=0,this.duration=0,this.isWaveformPaused=!1,this.timer.start(),this.emit("record-start")}))}getDuration(){return this.duration}isRecording(){var i;return((i=this.mediaRecorder)===null||i===void 0?void 0:i.state)==="recording"}isPaused(){var i;return((i=this.mediaRecorder)===null||i===void 0?void 0:i.state)==="paused"}isActive(){var i;return((i=this.mediaRecorder)===null||i===void 0?void 0:i.state)!=="inactive"}stopRecording(){var i;this.isActive()&&((i=this.mediaRecorder)===null||i===void 0||i.stop(),this.timer.stop())}pauseRecording(){var i,t;this.isRecording()&&(this.isWaveformPaused=!0,(i=this.mediaRecorder)===null||i===void 0||i.requestData(),(t=this.mediaRecorder)===null||t===void 0||t.pause(),this.timer.stop(),this.lastDuration=this.duration)}resumeRecording(){var i;this.isPaused()&&(this.isWaveformPaused=!1,(i=this.mediaRecorder)===null||i===void 0||i.resume(),this.timer.start(),this.lastStartTime=performance.now(),this.emit("record-resume"))}static getAvailableAudioDevices(){return w(this,void 0,void 0,(function*(){return navigator.mediaDevices.enumerateDevices().then((i=>i.filter((t=>t.kind==="audioinput"))))}))}destroy(){this.applyOriginalOptionsIfNeeded(),super.destroy(),this.stopRecording(),this.stopMic(),this.recordedBlobUrl&&(URL.revokeObjectURL(this.recordedBlobUrl),this.recordedBlobUrl=null)}applyOriginalOptionsIfNeeded(){this.wavesurfer&&this.originalOptions&&(this.wavesurfer.setOptions(this.originalOptions),delete this.originalOptions)}}export{W as o};
